<!-- ‚úÖ Required Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx-preview@0.4.1/dist/docx-preview.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // üåô Theme toggle
  const toggle = document.getElementById("themeToggle");
  const saved = localStorage.getItem("theme");
  if (saved === "dark") {
    document.body.classList.add("dark-mode");
    toggle.textContent = "‚òÄÔ∏è";
  }
  toggle.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const dark = document.body.classList.contains("dark-mode");
    toggle.textContent = dark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", dark ? "dark" : "light");
  });

  // ‚öôÔ∏è Converter
  window.convertToPDF = async function() {
    const input = document.getElementById("fileInput");
    const file = input.files[0];
    const status = document.getElementById("status");
    const download = document.getElementById("downloadLink");

    if (!file) {
      status.textContent = "‚ö†Ô∏è Please select a file.";
      return;
    }

    status.textContent = "‚è≥ Converting...";
    download.style.display = "none";

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    try {
      // üì∑ Image conversion
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = e => {
          pdf.addImage(e.target.result, "JPEG", 10, 10, 180, 160);
          finalizePDF(pdf, download, status);
        };
        reader.readAsDataURL(file);
        return;
      }

      // üìÑ DOCX (try visual mode first)
      if (file.name.endsWith(".docx")) {
        const arrayBuffer = await file.arrayBuffer();
        const container = document.createElement("div");
        container.style.width = "900px";
        container.style.padding = "20px";
        container.style.background = "#fff";
        container.style.color = "#000";
        container.style.fontFamily = "Arial, sans-serif";
        document.body.appendChild(container);

        let rendered = false;

        try {
          await window.docx.renderAsync(arrayBuffer, container, null, {
            className: "docx",
            useBase64URL: true,
            breakPages: true
          });
          rendered = true;
        } catch (err) {
          console.warn("‚ö†Ô∏è Visual rendering failed, switching to text mode.");
        }

        if (rendered) {
          await new Promise(r => setTimeout(r, 1000));
          const pdf = new jsPDF("p", "pt", "a4");
          await pdf.html(container, {
            callback: function (pdf) {
              finalizePDF(pdf, download, status);
              document.body.removeChild(container);
            },
            margin: [20, 20, 20, 20],
            html2canvas: { scale: 0.7, useCORS: true, allowTaint: true }
          });
          return;
        }

        // üßæ Fallback: text-based conversion using Mammoth
        try {
          const result = await window.mammoth.convertToHtml({ arrayBuffer });
          const html = result.value;
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;
          tempDiv.style.width = "750px";
          tempDiv.style.background = "#fff";
          tempDiv.style.padding = "20px";
          tempDiv.style.color = "#000";
          document.body.appendChild(tempDiv);

          const pdf = new jsPDF("p", "pt", "a4");
          await pdf.html(tempDiv, {
            callback: function (pdf) {
              finalizePDF(pdf, download, status);
              document.body.removeChild(tempDiv);
            },
            margin: [20, 20, 20, 20],
            html2canvas: { scale: 0.7 }
          });
        } catch (fallbackError) {
          throw new Error("Both rendering modes failed.");
        }

        return;
      }

      // üßæ Text / HTML / CSV
      if (file.name.endsWith(".txt") || file.name.endsWith(".html") || file.name.endsWith(".csv")) {
        const text = await file.text();
        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(12);
        const lines = pdf.splitTextToSize(text, 180);
        pdf.text(lines, 15, 20);
        finalizePDF(pdf, download, status);
        return;
      }

      status.textContent = "‚ö†Ô∏è Unsupported file type.";
    } catch (err) {
      console.error("‚ùå Conversion error:", err);
      status.innerHTML = "‚ùå Conversion failed. Please try again or use a simpler file.";
    }
  };

  function finalizePDF(pdf, download, status) {
    const blob = pdf.output("blob");
    const url = URL.createObjectURL(blob);
    download.href = url;
    download.style.display = "inline-block";
    download.textContent = "‚¨áÔ∏è Download PDF";
    status.textContent = "‚úÖ Conversion complete!";
  }
});
</script>
