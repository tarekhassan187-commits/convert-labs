<!-- ‚úÖ Required Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx-preview@0.4.1/dist/docx-preview.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("themeToggle");
  const saved = localStorage.getItem("theme");
  if (saved === "dark") {
    document.body.classList.add("dark-mode");
    toggle.textContent = "‚òÄÔ∏è";
  }
  toggle.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const dark = document.body.classList.contains("dark-mode");
    toggle.textContent = dark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", dark ? "dark" : "light");
  });

  // ‚öôÔ∏è Converter Function
  window.convertToPDF = async function() {
    const input = document.getElementById("fileInput");
    const file = input.files[0];
    const status = document.getElementById("status");
    const download = document.getElementById("downloadLink");

    if (!file) {
      status.textContent = "‚ö†Ô∏è Please select a file to convert.";
      return;
    }

    status.textContent = "‚è≥ Converting...";
    download.style.display = "none";

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    try {
      // üì∑ Image Conversion
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = e => {
          pdf.addImage(e.target.result, "JPEG", 10, 10, 180, 160);
          finalizePDF(pdf, download, status);
        };
        reader.readAsDataURL(file);
        return;
      }

      // üìÑ DOCX Conversion (layout preserved)
      if (file.name.endsWith(".docx")) {
        const arrayBuffer = await file.arrayBuffer();
        const container = document.createElement("div");
        container.style.width = "900px";
        container.style.padding = "20px";
        container.style.background = "#fff";
        container.style.color = "#000";
        container.style.fontFamily = "Arial, sans-serif";
        container.style.fontSize = "12px";
        container.style.lineHeight = "1.4";
        document.body.appendChild(container);

        try {
          await window.docx.renderAsync(arrayBuffer, container, null, {
            className: "docx",
            useBase64URL: true,
            breakPages: true
          });
        } catch (renderError) {
          console.error("DOCX render error:", renderError);
          throw new Error("Unable to render .docx properly.");
        }

        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for layout

        try {
          const pdf = new jsPDF("p", "pt", "a4");
          await pdf.html(container, {
            callback: function (pdf) {
              finalizePDF(pdf, download, status);
              document.body.removeChild(container);
            },
            margin: [20, 20, 20, 20],
            html2canvas: { scale: 0.7, useCORS: true, allowTaint: true }
          });
        } catch (renderToPDFError) {
          console.error("PDF render error:", renderToPDFError);
          throw new Error("PDF conversion failed during rendering.");
        }

        return;
      }

      // üßæ Simple Text/HTML/CSV
      if (file.name.endsWith(".txt") || file.name.endsWith(".html") || file.name.endsWith(".csv")) {
        const text = await file.text();
        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(12);
        const lines = pdf.splitTextToSize(text, 180);
        pdf.text(lines, 15, 20);
        finalizePDF(pdf, download, status);
        return;
      }

      status.textContent = "‚ö†Ô∏è Unsupported file type.";
    } catch (err) {
      console.error("General conversion error:", err);
      status.innerHTML = "‚ùå Conversion failed. Please try again or use a simpler document.";
    }
  };

  // ‚úÖ Save and show download
  function finalizePDF(pdf, download, status) {
    const blob = pdf.output("blob");
    const url = URL.createObjectURL(blob);
    download.href = url;
    download.style.display = "inline-block";
    download.textContent = "‚¨áÔ∏è Download PDF";
    status.textContent = "‚úÖ Conversion complete!";
  }
});
</script>
