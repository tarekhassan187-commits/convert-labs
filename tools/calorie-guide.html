<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>7-Day Meal Plan â€” Convert Labs</title>

  <!-- SEO / OG (minimal) -->
  <meta name="description" content="Personalized 7-day meal plan generated from your TDEE. One day unlocks every 24 hours." />
  <link rel="icon" href="https://convertlabs.online/assets/convert-labs-icon.png" />
  <meta name="theme-color" content="#1e40af" />

  <!-- site CSS -->
  <link rel="stylesheet" href="https://convertlabs.online/style.css" />

  <!-- Analytics / AdSense (copied) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2490597435056272" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z88B03WV7P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Z88B03WV7P');
  </script>

  <style>
    :root{
      --brand:#0a4d8c;
      --muted:#6c6c6c;
      --bg:#f5faff;
      --card:#fff;
      --accent:#2b8bd8;
      --radius:12px;
    }
    body{ background:var(--bg); font-family: Inter, Arial, sans-serif; color:#111; margin:0; padding:0; }
    main.tool-page { max-width:1100px; margin: 1.2rem auto; padding: 0 1rem; }
    .card { background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:0 6px 18px rgba(12,40,80,0.04); }
    .page-controls { display:flex; gap:10px; align-items:center; margin:18px 0; flex-wrap:wrap; }
    .btn { background:var(--brand); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#666; }
    .btn.ghost { background:transparent; border:1px solid var(--brand); color:var(--brand); }
    .layout { display:grid; grid-template-columns: 1fr 360px; gap:20px; align-items:start; }
    @media(max-width:980px){ .layout{ grid-template-columns:1fr; } #side{ position:static; height:auto; } }

    .day-card { padding:14px; border-radius:10px; margin-bottom:14px; position:relative; overflow:hidden; }
    .day-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .meals { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .meal { flex:1 1 220px; min-width:180px; background:#fbfdff; border-radius:10px; padding:12px; cursor:pointer; border:1px solid rgba(10,77,140,0.06); transition: transform .12s, box-shadow .12s; }
    .meal:hover{ transform: translateY(-4px); box-shadow:0 8px 22px rgba(10,77,140,0.06); }
    .meal b{ color:#083a65; display:block; margin-bottom:6px; }
    .kcal { color:var(--muted); font-size:13px; margin-top:6px; }

    /* Locked style (B): blurred / dimmed */
    .locked { filter: grayscale(80%) blur(2px) brightness(.85); pointer-events: none; position:relative; }
    .lock-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:4; background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.7)); border-radius:10px; pointer-events:none; }
    .lock-badge { background: rgba(255,255,255,0.95); color:#222; border-radius:8px; padding:8px 10px; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }

    .tracking-row { display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .small-input { width:110px; padding:8px; border-radius:8px; border:1px solid #e6e6e6; font-size:14px; }
    .progress { height:12px; background:#eee; border-radius:8px; overflow:hidden; flex:1 1 200px; }
    .progress > i { display:block; height:100%; width:0%; background: linear-gradient(90deg,var(--brand),var(--accent)); }

    #previewModal, #usdaPopup, #usdaAllModal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index:1200; padding:20px; }
    #previewBox, #usdaBox, #usdaAllBox { width:100%; max-width:980px; max-height:86vh; overflow:auto; background:var(--card); border-radius:12px; padding:18px; }

    .muted-small { color:#666; font-size:13px; }

    .form-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    select, input[type="number"], input[type="text"] { padding:8px 10px; border-radius:8px; border:1px solid #e6e6e6; font-size:14px; }

    /* CTA animations (subtle) */
    @keyframes fadeSlideUp { 0%{opacity:0;transform:translateY(12px)} 60%{opacity:1;transform:translateY(-2px)} 100%{transform:translateY(0)} }
    .generate-plan-animate { animation: fadeSlideUp .45s ease-out forwards; }
    /* confetti canvas */
    canvas#confettiCanvas { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:2000; display:none; }
  </style>
</head>
<body>

  <!-- Header (from tools.html) -->
  <header class="navbar" style="background:#1e40af;color:#fff;padding:10px 0;">
    <div class="nav-container" style="width:90%;max-width:1100px;margin:auto;display:flex;justify-content:space-between;align-items:center;">
      <div class="logo">
        <a href="https://convertlabs.online/" aria-label="Convert Labs Home" style="color:#fff;text-decoration:none;display:flex;align-items:center;gap:8px;">
          <img src="https://convertlabs.online/assets/convert-labs-icon.png" alt="Convert Labs logo" style="height:32px;" loading="lazy">
          <span style="font-weight:600;">Convert Labs</span>
        </a>
      </div>
      <nav class="nav-links">
        <ul style="list-style:none;display:flex;gap:1rem;margin:0;padding:0;">
          <li><a href="https://convertlabs.online/" style="color:#fff;text-decoration:none;">Home</a></li>
          <li><a href="https://convertlabs.online/tools/tools.html" style="color:#fff;text-decoration:none;opacity:0.9;">Tools</a></li>
          <li><a href="https://convertlabs.online/guides.html" style="color:#fff;text-decoration:none;">Blog</a></li>
          <li><a href="https://convertlabs.online/about.html" style="color:#fff;text-decoration:none;">About</a></li>
          <li><a href="https://convertlabs.online/contact.html" style="color:#fff;text-decoration:none;">Contact</a></li>
        </ul>
      </nav>
      <button id="themeToggle" class="theme-toggle" title="Switch Theme" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;">ðŸŒ™</button>
    </div>
  </header>

  <main class="tool-page" style="text-align:left;">
    <h1 style="text-align:center;margin-top:18px;">7-Day Meal Plan</h1>
    <p style="text-align:center;max-width:800px;margin:8px auto;color:var(--muted);">
      Personalized 7-day meal plans based on your TDEE. Only the current day is interactive; other days are visible but blurred and show their unlock date.
    </p>

    <!-- Controls -->
    <div style="max-width:1100px;margin:12px auto;">
      <div class="card" style="padding:12px;">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Target Calories (TDEE)</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="tdeeInput" type="number" placeholder="e.g. 2000" style="width:140px;padding:8px;border-radius:8px;border:1px solid #e6e6e6;">
              <button id="applyTdeeBtn" class="btn">Apply</button>
            </div>
            <div class="hint" style="color:#666;font-size:13px;margin-top:6px;">TDEE can be passed from <code>/tools/calorie-guide.html</code> or entered here.</div>
          </div>

          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Age</label>
            <input id="ageInput" type="number" min="1" max="120" placeholder="e.g. 29" style="width:100px;padding:8px;border-radius:8px;border:1px solid #e6e6e6;">
            <div class="hint">Age adjusts portion sizes and macros.</div>
          </div>

          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Goal</label>
            <select id="goalSelect" style="width:160px;padding:8px;border-radius:8px;">
              <option value="maintain">Maintain weight</option>
              <option value="lose">Lose weight (-300 kcal)</option>
              <option value="gain">Gain weight (+300 kcal)</option>
            </select>
          </div>

          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Diet style</label>
            <select id="dietSelect" style="width:160px;padding:8px;border-radius:8px;">
              <option value="normal">No preference</option>
              <option value="keto">Keto</option>
              <option value="carnivore">Carnivore</option>
              <option value="vegetarian">Vegetarian</option>
            </select>
            <div class="hint">Keto / Carnivore / Vegetarian rules will be applied when generating meals.</div>
          </div>

          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Protein preference</label>
            <select id="proteinSelect" style="width:160px;padding:8px;border-radius:8px;">
              <option value="any">Any</option>
              <option value="beef">Beef</option>
              <option value="chicken">Chicken</option>
              <option value="fish">Fish</option>
              <option value="plant">Plant-based</option>
            </select>
            <div class="hint">This filters lunch/dinner protein sources.</div>
          </div>
        </div>

        <div class="form-row" style="margin-top:14px;">
          <button id="generateBtn" class="btn">Generate Preview</button>
          <button id="acceptBtn" class="btn secondary">Accept & Save Plan</button>
          <button id="overwriteBtn" class="btn ghost">Overwrite Saved Plan</button>
          <button id="deleteBtn" class="btn secondary" style="display:none;">Delete Saved Plan</button>

          <div style="margin-left:auto;display:flex;gap:12px;align-items:center;">
            <div class="muted-small">TDEE final: <strong id="tdeeText">â€”</strong> kcal</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Layout -->
    <div class="layout" style="max-width:1100px;margin:0 auto;">
      <main id="main">
        <div id="mainInner"></div>
      </main>

      <aside id="side">
        <div class="card">
          <strong>Manual USDA search</strong>
          <div style="margin-top:10px;">
            <input id="manualSearchInput" placeholder="Search food name..." style="width:100%; padding:8px; border-radius:8px; border:1px solid #eee;">
            <div style="margin-top:8px; text-align:right;">
              <button id="manualSearchBtn" class="btn">Search USDA</button>
            </div>
          </div>
          <div id="manualSearchResults" style="margin-top:10px; max-height:300px; overflow:auto;"></div>
        </div>

        <div class="card" style="margin-top:12px;">
          <strong>Saved plan info</strong>
          <div id="savedInfo" style="margin-top:10px;" class="muted-small">No saved plan yet.</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <strong>Hints</strong>
          <p class="muted-small" style="margin-top:8px;">
            - Click any unlocked meal to search USDA and replace meals.<br>
            - Use "Show all results" to view full matches and choose another item.<br>
            - Only current day is interactive; locked days show unlock date.
          </p>
        </div>
      </aside>
    </div>
  </main>

  <!-- Preview / USDA modals -->
  <div id="previewModal"><div id="previewBox"></div></div>
  <div id="usdaPopup"><div id="usdaBox"></div></div>
  <div id="usdaAllModal"><div id="usdaAllBox"></div></div>

  <!-- Confetti canvas -->
  <canvas id="confettiCanvas"></canvas>

  <!-- Footer -->
  <footer class="footer" style="background:#1e40af;color:#fff;text-align:center;padding:2rem 1rem;margin-top:2rem;">
    <div style="max-width:1100px;margin:0 auto;">
      <div style="margin-bottom:10px;">
        <img src="https://convertlabs.online/assets/convert-labs-icon.png" style="width:24px;height:24px;vertical-align:middle;">
        <span style="margin-left:6px;font-weight:600;">Convert Labs</span>
      </div>
      <p style="color:#ffffff;margin-bottom:10px;">Â© 2025 Convert Labs. All rights reserved.</p>
      <nav>
        <a href="https://convertlabs.online/about.html" style="color:#fff;margin:0 6px;">About</a> |
        <a href="https://convertlabs.online/tools/tools.html" style="color:#fff;margin:0 6px;">Tools</a> |
        <a href="https://convertlabs.online/guides.html" style="color:#fff;margin:0 6px;">Blog</a> |
        <a href="https://convertlabs.online/privacy.html" style="color:#fff;margin:0 6px;">Privacy</a>
      </nav>
    </div>
  </footer>

  <style> footer.footer a:hover { text-decoration: underline; color:#ffffff; } </style>

  <!-- ============================
       SCRIPT: dataset loader + plan logic + UI
       ============================ -->
  <script>
  // CONFIG dataset paths
  const DATA_USDA = "/assets/usda_food_nutrition.json";
  const DATA_FULL = "/assets/foods-full.json";
  const DATA_LITE = "/assets/foods-lite.json";

  // progressive loader
  let indexItems = [];
  let hasUsda = false, hasFull = false, hasLite = false;

  async function safeFetchJSON(url){
    try {
      const r = await fetch(url, {cache: "no-cache"});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      if(!Array.isArray(j)) throw new Error("Not array");
      return j;
    } catch(e){
      console.warn("fetch fail", url, e && e.message);
      return null;
    }
  }

  // Load lite first (fast)
  (async function loadLite(){
    const lite = await safeFetchJSON(DATA_LITE);
    if(lite && lite.length){ indexItems = indexItems.concat(lite); hasLite = true; console.info("loaded lite", lite.length); }
  })();

  // Helper to load full and usda on demand
  async function loadFull(){
    if(hasFull) return true;
    const full = await safeFetchJSON(DATA_FULL);
    if(full && full.length){ indexItems = indexItems.concat(full); hasFull = true; console.info("loaded full", full.length); return true; }
    return false;
  }
  async function loadUsda(){
    if(hasUsda) return true;
    const big = await safeFetchJSON(DATA_USDA);
    if(big && big.length){ indexItems = indexItems.concat(big); hasUsda = true; console.info("loaded usda", big.length); return true; }
    return false;
  }

  function normalize(s){ return (s||"").toString().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }
  function scoreName(name, q){
    const n = normalize(name);
    if(!n) return 0;
    if(n === q) return 120;
    let s = 0;
    if(n.startsWith(q)) s += 50;
    if(n.includes(q)) s += 30;
    const qwords = q.split(/\W+/).filter(Boolean);
    qwords.forEach(w => { if(n.includes(w)) s += 8; });
    s += Math.max(0, 6 - n.split(" ").length);
    return s;
  }

  // SEARCH: as required, USDA primary, then full, then lite
  async function searchNutrition(query){
    const q = normalize(query).trim();
    if(!q) return [];

    // ensure usda loaded first (per your choice A)
    await loadUsda();
    let matches = indexItems
      .map(it => ({ it, name: it.name || it.food_name || it.description || "" }))
      .map(x => ({ it:x.it, score: scoreName(x.name, q), name: x.name }))
      .filter(x => x.score > 0)
      .sort((a,b)=>b.score - a.score)
      .map(x => {
        const it = x.it;
        return {
          id: it.id ?? it.fdc_id ?? it.code ?? null,
          name: it.name ?? it.food_name ?? it.description ?? "Unknown",
          serving: it.serving || it.serving_size || it.serving_description || "",
          kcal: it.kcal ?? it.calories ?? it.energy_kcal ?? it.energy ?? null,
          protein_g: it.protein_g ?? it.protein ?? null,
          carbs_g: it.carbs_g ?? it.carbohydrate ?? null,
          fat_g: it.fat_g ?? it.fat ?? null,
          raw: it,
          _score: x.score
        };
    });

    // If results exist, return (since we loaded USDA first)
    if(matches.length) return matches;

    // try full (if not already included)
    const okFull = await loadFull();
    if(okFull){
      matches = indexItems
        .map(it => ({ it, name: it.name || it.food_name || it.description || "" }))
        .map(x => ({ it:x.it, score: scoreName(x.name, q), name: x.name }))
        .filter(x => x.score > 0)
        .sort((a,b)=>b.score - a.score)
        .map(x => {
          const it = x.it;
          return {
            id: it.id ?? it.fdc_id ?? it.code ?? null,
            name: it.name ?? it.food_name ?? it.description ?? "Unknown",
            serving: it.serving || it.serving_size || it.serving_description || "",
            kcal: it.kcal ?? it.calories ?? it.energy_kcal ?? it.energy ?? null,
            protein_g: it.protein_g ?? it.protein ?? null,
            carbs_g: it.carbs_g ?? it.carbohydrate ?? null,
            fat_g: it.fat_g ?? it.fat ?? null,
            raw: it,
            _score: x.score
          };
      });
      if(matches.length) return matches;
    }

    // try lite (it may already be included)
    // ensure lite loaded
    if(!hasLite){ await loadLite(); }
    matches = indexItems
      .map(it => ({ it, name: it.name || it.food_name || it.description || "" }))
      .map(x => ({ it:x.it, score: scoreName(x.name, q), name: x.name }))
      .filter(x => x.score > 0)
      .sort((a,b)=>b.score - a.score)
      .map(x => {
        const it = x.it;
        return {
          id: it.id ?? it.fdc_id ?? it.code ?? null,
          name: it.name ?? it.food_name ?? it.description ?? "Unknown",
          serving: it.serving || it.serving_size || it.serving_description || "",
          kcal: it.kcal ?? it.calories ?? it.energy_kcal ?? it.energy ?? null,
          protein_g: it.protein_g ?? it.protein ?? null,
          carbs_g: it.carbs_g ?? it.carbohydrate ?? null,
          fat_g: it.fat_g ?? it.fat ?? null,
          raw: it,
          _score: x.score
        };
    });

    return matches;
  }

  // Expose for debugging
  window.searchNutrition = searchNutrition;

  /* ---------------------------
     Meal pools & generator (heuristic)
     --------------------------- */
  const POOLS = {
    proteins: [
      { name: "Grilled beef steak", tags:["meat","beef","animal"], kcal:350 },
      { name: "Grilled chicken breast", tags:["meat","chicken","animal"], kcal:240 },
      { name: "Baked salmon", tags:["fish","animal"], kcal:280 },
      { name: "Tuna salad", tags:["fish","animal"], kcal:260 },
      { name: "Lentil stew", tags:["plant","legume","vegetarian"], kcal:320 },
      { name: "Tofu stir-fry", tags:["plant","vegetarian"], kcal:290 },
      { name: "Egg omelette", tags:["egg","animal"], kcal:220 },
      { name: "Beef mince with veg", tags:["meat","beef","animal"], kcal:360 },
      { name: "Chicken kebab", tags:["meat","chicken","animal"], kcal:250 },
      { name: "Grilled fish fillet", tags:["fish","animal"], kcal:240 }
    ],
    sides: [
      { name: "Steamed vegetables", tags:["veg","plant","lowcarb"], kcal:60 },
      { name: "Mixed salad", tags:["veg","plant","lowcarb"], kcal:80 },
      { name: "Brown rice", tags:["grain","highcarb"], kcal:210 },
      { name: "Quinoa", tags:["grain","highcarb","plant"], kcal:200 },
      { name: "Baked potato", tags:["starch","highcarb"], kcal:160 },
      { name: "Cauliflower rice", tags:["lowcarb","veg"], kcal:25 },
      { name: "Avocado", tags:["fat","lowcarb"], kcal:160 }
    ],
    breakfasts: [
      { name: "Oatmeal with banana & milk", tags:["grain","highcarb","vegetarian"], kcal:320 },
      { name: "Greek yogurt with honey", tags:["dairy","vegetarian"], kcal:220 },
      { name: "Smoothie (banana + whey)", tags:["highcarb","animal"], kcal:300 },
      { name: "Boiled eggs & toast", tags:["egg","grain"], kcal:310 },
      { name: "Shakshuka (2 eggs)", tags:["egg","veg"], kcal:270 }
    ],
    snacks: [
      { name: "Handful of almonds", tags:["nuts","plant","lowcarb"], kcal:170 },
      { name: "Protein bar", tags:["processed","any"], kcal:210 },
      { name: "Apple", tags:["fruit","plant","highcarb"], kcal:95 },
      { name: "Greek yogurt", tags:["dairy","vegetarian"], kcal:120 },
      { name: "Carrot sticks", tags:["veg","plant"], kcal:45 }
    ]
  };

  function allowedByDiet(tags, diet){
    const t = (tags||[]).map(x=>x.toLowerCase());
    if(diet === "normal") return true;
    if(diet === "keto"){
      const forbidden = ["grain","highcarb","starch","fruit","legume","potato","bread","pasta","rice","sugar"];
      if(t.some(x=>forbidden.includes(x))) return false;
      return true;
    }
    if(diet === "carnivore"){
      const allow = ["meat","beef","chicken","fish","animal","egg","dairy"];
      const plant = ["plant","veg","vegetarian","fruit","grain","legume","nuts","seed","tofu"];
      if(t.some(x=>plant.includes(x))) return false;
      return t.some(x=>allow.includes(x));
    }
    if(diet === "vegetarian"){
      const forbidden = ["meat","beef","chicken","fish","animal"];
      if(t.some(x=>forbidden.includes(x))) return false;
      return true;
    }
    return true;
  }

  function matchesProtein(tags, pref){
    const t = (tags||[]).map(x=>x.toLowerCase());
    if(!pref || pref==="any") return true;
    if(pref==="plant") return t.includes("plant") || t.includes("legume") || t.includes("tofu") || t.includes("nuts");
    if(pref==="beef") return t.includes("beef") || t.includes("meat");
    if(pref==="chicken") return t.includes("chicken") || t.includes("meat");
    if(pref==="fish") return t.includes("fish") || t.includes("tuna") || t.includes("salmon");
    return true;
  }

  function ageCategory(age){
    const a = Number(age) || 30;
    if(a <= 12) return "child";
    if(a <= 19) return "teen";
    if(a <= 59) return "adult";
    return "senior";
  }
  function agePortionMultiplier(cat){
    if(cat === "child") return 0.7;
    if(cat === "teen") return 1.05;
    if(cat === "senior") return 0.9;
    return 1.0;
  }

  function pickFrom(pool, opts){
    const candidates = pool.filter(it => allowedByDiet(it.tags, opts.diet) && matchesProtein(it.tags, opts.protein));
    if(!candidates.length) return pool[Math.floor(Math.random()*pool.length)];
    return candidates[Math.floor(Math.random()*candidates.length)];
  }

  // Generate plan - uses exact tdee provided (no further deficit)
  function generatePlan(opts){
    const tdee = Math.max(1000, Number(opts.tdee) || 2000); // exact use
    const age = Number(opts.age) || 30;
    const diet = opts.diet || "normal";
    const protein = opts.protein || "any";
    const mult = agePortionMultiplier(ageCategory(age));

    // split percent baseline (can slightly vary by diet)
    let breakfastPct = 0.25, lunchPct = 0.35, dinnerPct = 0.30, snackPct = 0.10;
    if(diet === "keto"){ breakfastPct=0.22; lunchPct=0.36; dinnerPct=0.32; snackPct=0.10; }
    if(diet === "carnivore"){ breakfastPct=0.24; lunchPct=0.36; dinnerPct=0.32; snackPct=0.08; }
    if(diet === "vegetarian"){ breakfastPct=0.26; lunchPct=0.33; dinnerPct=0.31; snackPct=0.10; }

    const plan = [];
    for(let day=1; day<=7; day++){
      const breakfast = pickFrom(POOLS.breakfasts, {diet, protein});
      const lunchProt = pickFrom(POOLS.proteins, {diet, protein});
      const side = pickFrom(POOLS.sides, {diet, protein});
      const dinnerProt = pickFrom(POOLS.proteins, {diet, protein});
      const snack = pickFrom(POOLS.snacks, {diet, protein});

      const kcals = Math.round(tdee * mult);
      const bK = Math.round(kcals * breakfastPct);
      const lK = Math.round(kcals * lunchPct);
      const dK = Math.round(kcals * dinnerPct);
      const sK = Math.round(kcals * snackPct);

      plan.push({
        day,
        breakfast: { text: breakfast.name, kcal: bK, isCustom:false },
        lunch:     { text: `${lunchProt.name} + ${side.name}`, kcal: lK, isCustom:false },
        dinner:    { text: `${dinnerProt.name} + ${side.name}`, kcal: dK, isCustom:false },
        snack:     { text: snack.name, kcal: sK, isCustom:false },
        meta: { tdee, age, diet, protein, portionMultiplier: mult }
      });
    }
    return plan;
  }
  window.generatePlan = generatePlan;

  /* ---------------------------
     STORAGE + UI render + interactions
     --------------------------- */
  const KEY = "convertlabs_mealplan_v1";

  function savePlan(plan, startDate){
    const payload = { plan, startDate: startDate || new Date().toISOString() };
    localStorage.setItem(KEY, JSON.stringify(payload));
  }
  function loadPlan(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return null;
    try { return JSON.parse(raw); } catch(e){ return null; }
  }
  function deletePlan(){
    localStorage.removeItem(KEY);
  }

  // read URL params into form
  function applyUrlParamsToForm(){
    const p = new URLSearchParams(window.location.search);
    const tdee = p.get("tdee");
    const age = p.get("age");
    const goal = p.get("goal");
    const diet = p.get("diet");
    const protein = p.get("protein");

    if(tdee) document.getElementById("tdeeInput").value = tdee;
    if(age) document.getElementById("ageInput").value = age;
    if(goal) document.getElementById("goalSelect").value = goal;
    if(diet) document.getElementById("dietSelect").value = diet;
    if(protein) document.getElementById("proteinSelect").value = protein;

    // show display TDEE final
    const base = Number(tdee) || null;
    if(base) document.getElementById("tdeeText").innerText = base;
  }

  // render plan (visible days blurred)
  function renderPlan(plan, startDateISO){
    const container = document.getElementById("mainInner");
    container.innerHTML = "";
    const startDate = startDateISO ? new Date(startDateISO) : null;
    const now = new Date();

    // calculate unlocked day (0-based index)
    let unlocked = 0;
    if(startDate){
      const days = Math.floor((Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) - Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()))/86400000);
      unlocked = Math.max(0, Math.min(6, days));
    } else {
      unlocked = 0; // preview mode
    }

    plan.forEach((d, idx) => {
      const card = document.createElement("div"); card.className = "day-card card";
      const isLocked = idx > unlocked;
      const dayHeader = document.createElement("div"); dayHeader.className = "day-header";
      dayHeader.innerHTML = `<div><strong>Day ${d.day}</strong></div><div class="muted-small">${isLocked ? "Locked" : "Today's plan (Unlocked)"}</div>`;
      card.appendChild(dayHeader);

      const mealsWrap = document.createElement("div"); mealsWrap.className = "meals";
      ["breakfast","lunch","dinner","snack"].forEach(key => {
        const item = d[key];
        const mealDiv = document.createElement("div");
        mealDiv.className = "meal";
        mealDiv.dataset.day = d.day;
        mealDiv.dataset.key = key;
        mealDiv.innerHTML = `<b>${key.charAt(0).toUpperCase()+key.slice(1)}</b><div class="meal-text">${item.text}</div><div class="kcal">${item.kcal} kcal</div>`;
        if(isLocked){
          mealDiv.classList.add("locked");
        } else {
          // clickable: open USDA popup
          mealDiv.addEventListener("click", ()=> openUsdaPopup(d.day-1, key, item.text));
        }
        mealsWrap.appendChild(mealDiv);
      });
      card.appendChild(mealsWrap);

      if(isLocked){
        const overlay = document.createElement("div"); overlay.className = "lock-overlay";
        const unlockDate = startDate ? new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()) + (idx*86400000)) : null;
        const badgeText = unlockDate ? `Unlocks: ${unlockDate.toLocaleDateString()}` : `Locked`;
        overlay.innerHTML = `<div class="lock-badge">${badgeText}</div>`;
        card.appendChild(overlay);
      } else {
        // tracking row for unlocked day
        const trackRow = document.createElement("div"); trackRow.className = "tracking-row";
        trackRow.innerHTML = `
          <button class="btn save-day-btn">Save Day</button>
          <div><div class="muted-small">Calories eaten</div><input class="small-input input-cal" type="number" placeholder="kcal"></div>
          <div><div class="muted-small">Water (ml)</div><input class="small-input input-water" type="number" placeholder="ml"></div>
        `;
        // handler: Save Day stores simple tracking inside localStorage under KEY + "_track"
        trackRow.querySelector(".save-day-btn").addEventListener("click", ()=>{
          const cal = Number(trackRow.querySelector(".input-cal").value) || 0;
          const water = Number(trackRow.querySelector(".input-water").value) || 0;
          const trackRaw = localStorage.getItem(KEY + "_track");
          const track = trackRaw ? JSON.parse(trackRaw) : {};
          track[d.day] = { calories: cal, water };
          localStorage.setItem(KEY + "_track", JSON.stringify(track));
          alert("Day " + d.day + " progress saved.");
        });
        card.appendChild(trackRow);
      }

      container.appendChild(card);
    });
  }

  // open single-usda popup for replacing meal
  let currentEditing = { dayIndex: null, field: null }; // dayIndex 0-based
  async function openUsdaPopup(dayIndex, field, queryText){
    currentEditing = { dayIndex, field };
    const popup = document.getElementById("usdaPopup");
    const box = document.getElementById("usdaBox");
    box.innerHTML = `
      <h3>Search & replace (${field})</h3>
      <div style="margin-top:8px;"><input id="popupSearchInput" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;" value="${escapeHtml(queryText)}"></div>
      <div style="margin-top:8px;text-align:right;"><button id="popupSearchBtn" class="btn">Search</button></div>
      <div id="popupResults" style="margin-top:12px;max-height:420px;overflow:auto;"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button id="popupShowAll" class="btn ghost">Show all results</button>
        <button id="popupClose" class="btn secondary">Close</button>
      </div>
    `;
    popup.style.display = "flex";
    document.getElementById("popupClose").onclick = ()=> { popup.style.display = "none"; currentEditing = {dayIndex:null,field:null}; };
    document.getElementById("popupSearchBtn").onclick = async ()=>{
      const q = document.getElementById("popupSearchInput").value.trim();
      const resBox = document.getElementById("popupResults");
      resBox.innerHTML = "Searching...";
      const results = await searchNutrition(q);
      renderUsdaResultList(results, resBox, true);
    };
    document.getElementById("popupShowAll").onclick = async ()=>{
      const q = document.getElementById("popupSearchInput").value.trim();
      const results = await searchNutrition(q);
      // open the full modal with all results
      openUsdaAllModal(results, queryText);
    };

    // initial search
    const initialResults = await searchNutrition(queryText);
    renderUsdaResultList(initialResults, document.getElementById("popupResults"), true);
  }

  function renderUsdaResultList(results, containerEl, allowChoose){
    containerEl.innerHTML = "";
    if(!results || !results.length){ containerEl.innerHTML = "<div class='muted-small'>No matches found.</div>"; return; }
    results.slice(0,12).forEach(it=>{
      const div = document.createElement("div");
      div.style.padding = "10px";
      div.style.borderBottom = "1px solid #eee";
      div.style.cursor = "pointer";
      const kcal = it.kcal ? Math.round(it.kcal) + " kcal" : "â€” kcal";
      div.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong></div><div class="muted-small">${escapeHtml(it.serving || "")} â€¢ ${kcal}</div>`;
      if(allowChoose){
        div.onclick = ()=>{
          // replace meal in saved/current plan
          applyReplacementToPlan(currentEditing.dayIndex, currentEditing.field, it);
          document.getElementById("usdaPopup").style.display = "none";
        };
      }
      containerEl.appendChild(div);
    });
    // if there are more than shown, add a "show all" link
    if(results.length > 12){
      const more = document.createElement("div");
      more.style.padding = "10px";
      more.style.textAlign = "center";
      more.innerHTML = `<button class="btn ghost" id="moreResultsBtn">Show all ${results.length} results</button>`;
      containerEl.appendChild(more);
      more.querySelector("#moreResultsBtn").onclick = ()=> openUsdaAllModal(results, "");
    }
  }

  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // full modal listing for many results (Show All)
  function openUsdaAllModal(results, initialQuery){
    const modal = document.getElementById("usdaAllModal");
    const box = document.getElementById("usdaAllBox");
    box.innerHTML = `<h3>All results for "${escapeHtml(initialQuery)}"</h3><div id="allResultsList" style="max-height:60vh;overflow:auto;margin-top:10px;"></div><div style="margin-top:12px;text-align:right;"><button id="closeAll" class="btn secondary">Close</button></div>`;
    modal.style.display = "flex";
    document.getElementById("closeAll").onclick = ()=> modal.style.display = "none";
    const list = document.getElementById("allResultsList");
    if(!results || !results.length){ list.innerHTML = "<div class='muted-small'>No results</div>"; return; }
    results.forEach(it=>{
      const r = document.createElement("div");
      r.style.padding = "10px"; r.style.borderBottom = "1px solid #eee"; r.style.cursor = "pointer";
      const kcal = it.kcal ? Math.round(it.kcal) + " kcal" : "â€” kcal";
      r.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong></div><div class="muted-small">${escapeHtml(it.serving||"")} â€¢ ${kcal}</div>`;
      r.onclick = ()=> {
        // apply replacement (works even when called from all-results modal)
        applyReplacementToPlan(currentEditing.dayIndex, currentEditing.field, it);
        modal.style.display = "none";
        // also close small popup if open
        document.getElementById("usdaPopup").style.display = "none";
      };
      list.appendChild(r);
    });
  }

  // apply replacement to current plan in memory and save
  function applyReplacementToPlan(dayIndex, field, usdaItem){
    const stored = loadPlan();
    if(!stored || !stored.plan) {
      alert("No saved plan to edit. Accept a plan first.");
      return;
    }
    const plan = stored.plan;
    if(!plan[dayIndex]) return;
    plan[dayIndex][field].text = usdaItem.name;
    plan[dayIndex][field].kcal = usdaItem.kcal ? Math.round(usdaItem.kcal) : plan[dayIndex][field].kcal;
    plan[dayIndex][field].isCustom = true;
    // save back
    savePlan(plan, stored.startDate);
    // re-render
    renderPlan(plan, stored.startDate);
    alert("Meal updated.");
  }

  // manual search in sidebar
  document.getElementById("manualSearchBtn").addEventListener("click", async ()=>{
    const q = document.getElementById("manualSearchInput").value.trim();
    const box = document.getElementById("manualSearchResults");
    box.innerHTML = "Searching...";
    const res = await searchNutrition(q);
    box.innerHTML = "";
    if(!res || !res.length){ box.innerHTML = "<div class='muted-small'>No results</div>"; return; }
    res.slice(0,30).forEach(it=>{
      const div = document.createElement("div"); div.style.padding="8px"; div.style.borderBottom="1px solid #eee";
      const kcal = it.kcal ? Math.round(it.kcal) + " kcal" : "â€” kcal";
      div.innerHTML = `<strong>${escapeHtml(it.name)}</strong><div class="muted-small">${escapeHtml(it.serving||"")} â€¢ ${kcal}</div>`;
      box.appendChild(div);
    });
  });

  // Generate & preview
  let currentPreview = null;
  document.getElementById("generateBtn").addEventListener("click", ()=>{
    const opts = {
      tdee: Number(document.getElementById("tdeeInput").value) || null,
      age: Number(document.getElementById("ageInput").value) || 30,
      goal: document.getElementById("goalSelect").value || "maintain",
      diet: document.getElementById("dietSelect").value || "normal",
      protein: document.getElementById("proteinSelect").value || "any"
    };
    if(!opts.tdee){ alert("Please provide TDEE (target calories) before generating."); return; }
    // IMPORTANT: use exact target as passed (no extra deficit)
    currentPreview = generatePlan(opts);
    // show preview modal with friendly formatted cards
    const modal = document.getElementById("previewModal");
    const box = document.getElementById("previewBox");
    let html = `<h3>Preview â€” 7-day plan (TDEE used: ${opts.tdee} kcal)</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px;">`;
    currentPreview.forEach(d=>{
      html += `<div style="background:#fff;border-radius:10px;padding:10px;border:1px solid #eee;">
        <div style="font-weight:700;margin-bottom:6px">Day ${d.day}</div>
        <div><b>Breakfast</b>: ${escapeHtml(d.breakfast.text)} <div class="muted-small">${d.breakfast.kcal} kcal</div></div>
        <div style="margin-top:6px"><b>Lunch</b>: ${escapeHtml(d.lunch.text)} <div class="muted-small">${d.lunch.kcal} kcal</div></div>
        <div style="margin-top:6px"><b>Dinner</b>: ${escapeHtml(d.dinner.text)} <div class="muted-small">${d.dinner.kcal} kcal</div></div>
        <div style="margin-top:6px"><b>Snack</b>: ${escapeHtml(d.snack.text)} <div class="muted-small">${d.snack.kcal} kcal</div></div>
      </div>`;
    });
    html += `</div><div style="margin-top:12px;text-align:right;"><button id="previewAccept" class="btn">Accept & Save Plan</button> <button id="previewClose" class="btn ghost">Close Preview</button></div>`;
    box.innerHTML = html;
    modal.style.display = "flex";
    document.getElementById("previewClose").onclick = ()=> modal.style.display = "none";
    document.getElementById("previewAccept").onclick = ()=>{
      const startDate = new Date().toISOString();
      savePlan(currentPreview, startDate);
      modal.style.display = "none";
      renderPlan(currentPreview, startDate);
      updateSavedInfo();
      alert("Plan saved and unlock schedule started.");
    };
  });

  // Accept & Save (direct)
  document.getElementById("acceptBtn").addEventListener("click", ()=>{
    const t = Number(document.getElementById("tdeeInput").value) || null;
    if(!t){ alert("Please provide TDEE (target calories) before accepting."); return; }
    const opts = {
      tdee: t,
      age: Number(document.getElementById("ageInput").value) || 30,
      goal: document.getElementById("goalSelect").value || "maintain",
      diet: document.getElementById("dietSelect").value || "normal",
      protein: document.getElementById("proteinSelect").value || "any"
    };
    const plan = generatePlan(opts);
    const startDate = new Date().toISOString();
    savePlan(plan, startDate);
    renderPlan(plan, startDate);
    updateSavedInfo();
    alert("Plan saved.");
  });

  document.getElementById("overwriteBtn").addEventListener("click", ()=>{
    if(!confirm("Overwrite saved plan and restart unlock schedule?")) return;
    document.getElementById("acceptBtn").click();
  });

  document.getElementById("deleteBtn").addEventListener("click", ()=>{
    if(!confirm("Delete saved plan permanently?")) return;
    deletePlan();
    localStorage.removeItem(KEY + "_track");
    alert("Plan deleted.");
    document.getElementById("mainInner").innerHTML = "";
    updateSavedInfo();
  });

  document.getElementById("applyTdeeBtn").addEventListener("click", ()=>{
    const t = Number(document.getElementById("tdeeInput").value) || null;
    if(t) document.getElementById("tdeeText").innerText = t;
    else alert("Enter a valid TDEE.");
  });

  function updateSavedInfo(){
    const payload = loadPlan();
    const box = document.getElementById("savedInfo");
    if(!payload){ box.innerHTML = "No saved plan."; document.getElementById("deleteBtn").style.display = "none"; return; }
    const sd = new Date(payload.startDate);
    box.innerHTML = `<div>Plan started: <b>${sd.toLocaleString()}</b></div><div>Your current unlocked day will advance every 24 hours from this date.</div>`;
    document.getElementById("deleteBtn").style.display = "";
  }

  // Initial load
  applyUrlParamsToForm();
  const existing = loadPlan();
  if(existing){ renderPlan(existing.plan, existing.startDate); updateSavedInfo(); } else {
    // no saved plan â€” show empty placeholder
    const preview = document.createElement("div");
    preview.className = "card"; preview.style.textAlign = "center";
    preview.innerHTML = `<div style="padding:30px;color:#666;">No saved plan yet. Generate a preview or accept a plan to start unlock schedule.</div>`;
    document.getElementById("mainInner").appendChild(preview);
  }

  // USUAL helper: close modals on background click
  document.getElementById("previewModal").addEventListener("click", (e)=>{ if(e.target.id==="previewModal") document.getElementById("previewModal").style.display = "none"; });
  document.getElementById("usdaPopup").addEventListener("click", (e)=>{ if(e.target.id==="usdaPopup") document.getElementById("usdaPopup").style.display = "none"; });
  document.getElementById("usdaAllModal").addEventListener("click", (e)=>{ if(e.target.id==="usdaAllModal") document.getElementById("usdaAllModal").style.display = "none"; });

  // ---------------- Confetti (lightweight) ----------------
  function launchConfetti(){
    const canvas = document.getElementById("confettiCanvas");
    if(!canvas) return;
    canvas.style.display = "block";
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const confetti = [];
    const colors = ["#3b82f6","#10b981","#60a5fa","#a5b4fc","#facc15"];
    const count = 120;
    for(let i=0;i<count;i++){
      confetti.push({ x: Math.random()*canvas.width, y: canvas.height + Math.random()*200, r: Math.random()*6+4, color: colors[Math.floor(Math.random()*colors.length)], speed: Math.random()*3+2, rot: Math.random()*360 });
    }
    let anim;
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      confetti.forEach((c,i)=> {
        ctx.save();
        ctx.translate(c.x,c.y);
        ctx.rotate(c.rot*Math.PI/180);
        ctx.fillStyle = c.color;
        ctx.fillRect(-c.r/2, -c.r/2, c.r, c.r*0.6);
        ctx.restore();
        c.y -= c.speed;
        c.x += Math.sin(c.y*0.02)*2;
        c.rot += 4;
        if(c.y < -30) c.y = canvas.height + 30;
      });
      anim = requestAnimationFrame(draw);
    }
    draw();
    setTimeout(()=> { cancelAnimationFrame(anim); canvas.style.display = "none"; }, 2200);
  }

  // Optional: play confetti when user accepts plan
  // We call it inside applyReplacement or accept flows if desired (left out to avoid surprise).

  </script>
</body>
</html>
