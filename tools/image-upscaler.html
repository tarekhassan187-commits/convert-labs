<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Image Upscaler ‚Äî Convert Labs</title>

  <!-- Page styles (adjust path if needed) -->
  <link rel="stylesheet" href="../style.css">

  <!-- Realesrgan browser bundle (used by the page script) -->
  <script src="https://cdn.jsdelivr.net/npm/@upscalerjs/realesrgan@1.0.1/dist/browser/realesrgan.min.js" defer></script>

  <style>
    /* Page-specific small overrides */
    main { text-align:center; max-width:920px; margin:0 auto; padding:2rem 1rem; }
    input, select, button { margin:0.5rem; padding:.55rem 1rem; font-size:1rem; }
    button { background:#1e40af; color:#fff; border-radius:8px; border:0; }
    #previewContainer{display:none;margin-top:1.5rem;}
    #splitPreview{position:relative;width:100%;max-width:820px;margin:16px auto;border-radius:12px;overflow:hidden;}
    #splitPreview img{width:100%;display:block;user-select:none;}
    #splitOverlay{position:absolute;top:0;left:0;width:50%;height:100%;overflow:hidden}
    #splitOverlay img{width:100%;}
    #splitHandle{position:absolute;top:0;left:50%;width:4px;height:100%;background:#1e40af;cursor:ew-resize;z-index:10}
    .error{color:#b91c1c;font-weight:600}
    #zoomCanvas{display:none;margin:16px auto;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.12);width:90%;max-width:820px}
    header .logo{height:38px;width:38px;object-fit:contain;vertical-align:middle}
    header .brand-text{font-weight:700;margin-left:8px}
  </style>
</head>
<body>

  <!-- ====== SITE HEADER (same structure as other pages) ====== -->
  <header>
    <div class="header-content" style="display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#1f3fb0;border-radius:6px;">
      <a href="../index.html" class="brand" style="display:flex;align-items:center;color:#fff;text-decoration:none;">
        <img src="../assets/convert-labs-icon.png" alt="Convert Labs icon" class="logo">
        <span class="brand-text" style="color:#fff;font-size:1.15rem;margin-left:10px">Convert Labs</span>
      </a>

      <div style="display:flex;align-items:center;gap:10px;">
        <a href="../contact.html" class="header-btn" style="background:#fff;color:#1e40af;padding:8px 12px;border-radius:8px;text-decoration:none;">Contact Us</a>
        <button id="themeToggle" class="theme-toggle" title="Switch Theme" style="font-size:18px;padding:6px 10px;border-radius:8px;">üåô</button>
      </div>
    </div>

    <p class="tagline" style="text-align:center;margin:14px 0 0;color:#222;">AI Image Upscaler ‚Äî Enhance and enlarge your images directly in the browser</p>
  </header>

  <!-- ====== MAIN CONTENT ====== -->
  <main>
    <h1>AI Image Upscaler</h1>
    <p>Upscale your images up to 8√ó resolution directly in your browser ‚Äî free & private.</p>

    <input type="file" id="imageInput" accept="image/*" />
    <select id="scaleSelect">
      <option value="2">2√ó</option>
      <option value="4">4√ó</option>
      <option value="8">8√ó</option>
    </select>
    <button id="upscaleBtn">Upscale Now</button>

    <p id="errorMsg" class="error" style="min-height:1.25rem"></p>

    <!-- Before / After split preview -->
    <div id="previewContainer" aria-hidden="true">
      <div id="splitPreview" role="region" aria-label="Before and after preview">
        <img id="originalImage" alt="Original image (before)" />
        <div id="splitOverlay"><img id="upscaledImage" alt="Upscaled image (after)" /></div>
        <div id="splitHandle" aria-hidden="true"></div>
      </div>

      <div style="display:flex;gap:10px;justify-content:center;align-items:center;">
        <button id="downloadBtn">Download Upscaled Image</button>
        <button id="zoomToggleBtn">üîç Zoom View</button>
      </div>
    </div>

    <canvas id="zoomCanvas" aria-hidden="true"></canvas>
  </main>

  <!-- ====== FOOTER (same style as other pages) ====== -->
  <footer style="margin-top:36px;background:#153a94;color:#fff;padding:26px 0;text-align:center;">
    <div style="display:flex;align-items:center;justify-content:center;gap:12px;">
      <img src="../assets/convert-labs-icon.png" alt="Convert Labs icon" style="width:48px;height:48px;object-fit:contain">
      <strong style="font-size:1.05rem">Convert Labs</strong>
    </div>
    <p style="margin:12px 0 0;">¬© 2025 Convert Labs | <a href="../index.html" style="color:#fff;text-decoration:underline">Back to Home</a></p>
  </footer>

  <!-- ====== SITE WIDE SCRIPT (header behavior, theme toggle etc) - adjust path if needed ====== -->
  <script src="../script.js" defer></script>

  <!-- ====== PAGE-SPECIFIC SCRIPT (split slider + Realesrgan usage) ====== -->
  <script>
  // wait for site script to load (deferred), then attach page logic
  (function () {
    // basic-safe DOM references
    const fileInput = document.getElementById('imageInput');
    const upscaleBtn = document.getElementById('upscaleBtn');
    const scaleSelect = document.getElementById('scaleSelect');
    const errorMsg = document.getElementById('errorMsg');
    const originalImage = document.getElementById('originalImage');
    const upscaledImage = document.getElementById('upscaledImage');
    const previewContainer = document.getElementById('previewContainer');
    const downloadBtn = document.getElementById('downloadBtn');
    const zoomToggleBtn = document.getElementById('zoomToggleBtn');
    const splitPreview = document.getElementById('splitPreview');
    const overlay = document.getElementById('splitOverlay');
    const handle = document.getElementById('splitHandle');
    const zoomCanvas = document.getElementById('zoomCanvas');
    const zctx = zoomCanvas.getContext && zoomCanvas.getContext('2d');

    let selectedFile = null;
    let draggingSlider = false;
    let zoomEnabled = false;

    // Load preview of chosen file
    fileInput.addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      selectedFile = f;
      const reader = new FileReader();
      reader.onload = () => {
        originalImage.src = reader.result;
        previewContainer.style.display = 'none';
        errorMsg.textContent = '';
      };
      reader.readAsDataURL(f);
    });

    // Upscale handler using Realesrgan from CDN
    upscaleBtn.addEventListener('click', async () => {
      if (!selectedFile) { errorMsg.textContent = 'Please choose an image first.'; return; }
      errorMsg.textContent = 'Upscaling ‚Äî please wait...';
      try {
        // create an image bitmap from file
        const bitmap = await createImageBitmap(selectedFile);
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bitmap, 0, 0);

        const scale = parseInt(scaleSelect.value, 10);

        // choose model/scale behavior:
        // Realesrgan bundle here expects scale param = 2 or 4 typically.
        // We'll do a 2-pass approach for 8x: first x4 then x2.
        if (!window.Realesrgan) {
          throw new Error('Upscaler library not available (check CDN include).');
        }

        let resultDataUrl;
        if (scale === 8) {
          // first pass 4x
          const up4 = new window.Realesrgan({ scale: 4, model: 'x4' });
          resultDataUrl = await up4.upscale(canvas);
          // then second pass 2x on resulting image
          const img = new Image();
          img.src = resultDataUrl;
          await img.decode();
          const canvas2 = document.createElement('canvas');
          canvas2.width = img.width;
          canvas2.height = img.height;
          canvas2.getContext('2d').drawImage(img, 0, 0);
          const up2 = new window.Realesrgan({ scale: 2, model: 'x2' });
          resultDataUrl = await up2.upscale(canvas2);
        } else {
          // 2x or 4x single pass
          const up = new window.Realesrgan({ scale: scale, model: scale === 4 ? 'x4' : 'x2' });
          resultDataUrl = await up.upscale(canvas);
        }

        upscaledImage.src = resultDataUrl;
        previewContainer.style.display = 'block';
        errorMsg.textContent = '';
      } catch (err) {
        console.error(err);
        errorMsg.textContent = '‚ö†Ô∏è Error upscaling. Try a smaller file or lower scale.';
      }
    });

    // Split slider handlers
    handle.addEventListener('mousedown', () => draggingSlider = true);
    window.addEventListener('mouseup', () => draggingSlider = false);
    window.addEventListener('mousemove', e => {
      if (!draggingSlider) return;
      const rect = splitPreview.getBoundingClientRect();
      let pos = ((e.clientX - rect.left) / rect.width) * 100;
      pos = Math.max(0, Math.min(100, pos));
      overlay.style.width = pos + '%';
      handle.style.left = pos + '%';
    });

    // touch support
    handle.addEventListener('touchstart', () => draggingSlider = true);
    window.addEventListener('touchend', () => draggingSlider = false);
    window.addEventListener('touchmove', e => {
      if (!draggingSlider) return;
      const touch = e.touches[0];
      const rect = splitPreview.getBoundingClientRect();
      let pos = ((touch.clientX - rect.left) / rect.width) * 100;
      pos = Math.max(0, Math.min(100, pos));
      overlay.style.width = pos + '%';
      handle.style.left = pos + '%';
    });

    // Download upscaled
    downloadBtn.addEventListener('click', () => {
      if (!upscaledImage.src) return;
      const a = document.createElement('a');
      a.href = upscaledImage.src;
      a.download = 'upscaled.png';
      a.click();
    });

    // Zoom view
    zoomToggleBtn.addEventListener('click', () => {
      zoomEnabled = !zoomEnabled;
      zoomCanvas.style.display = zoomEnabled ? 'block' : 'none';
      zoomToggleBtn.textContent = zoomEnabled ? 'Close Zoom' : 'üîç Zoom View';
      if (zoomEnabled) initZoom();
    });

    function initZoom() {
      if (!upscaledImage.src) return;
      const img = new Image();
      img.src = upscaledImage.src;
      img.onload = () => {
        zoomCanvas.width = Math.min(img.width, 1600);
        // keep aspect ratio on height
        zoomCanvas.height = Math.round((zoomCanvas.width / img.width) * img.height);
        const ctx = zoomCanvas.getContext('2d');
        ctx.clearRect(0,0,zoomCanvas.width,zoomCanvas.height);
        ctx.drawImage(img, 0, 0, zoomCanvas.width, zoomCanvas.height);
      };

      zoomCanvas.onmousemove = (e) => {
        if (!zoomEnabled) return;
        const rect = zoomCanvas.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * zoomCanvas.width;
        const y = ((e.clientY - rect.top) / rect.height) * zoomCanvas.height;
        drawZoom(x, y);
      };

      function drawZoom(x,y) {
        const ctx = zoomCanvas.getContext('2d');
        ctx.clearRect(0,0,zoomCanvas.width,zoomCanvas.height);
        const img = new Image(); img.src = upscaledImage.src;
        img.onload = () => {
          ctx.drawImage(img, 0, 0, zoomCanvas.width, zoomCanvas.height);
          const size = 140, zoomFactor = 2;
          const sx = Math.max(0, (x/zoomCanvas.width) * img.width - (size/zoomFactor)/2);
          const sy = Math.max(0, (y/zoomCanvas.height) * img.height - (size/zoomFactor)/2);
          ctx.save();
          ctx.beginPath();
          ctx.arc(x, y, size/2, 0, Math.PI*2);
          ctx.clip();
          ctx.drawImage(img, sx, sy, (size/zoomFactor), (size/zoomFactor), x - size/2, y - size/2, size, size);
          ctx.restore();
          ctx.strokeStyle = '#1e40af';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(x, y, size/2, 0, Math.PI*2);
          ctx.stroke();
        };
      }
    }
  })();
  </script>
</body>
</html>
