<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Image Upscaler | Convert Labs</title>

  <link rel="stylesheet" href="../style.css" />
  <script src="https://cdn.jsdelivr.net/npm/upscaler@1.0.6/dist/browser/upscaler.min.js"></script>

  <style>
    main { text-align:center; max-width:980px; margin:auto; padding:2rem 1rem; }
    input, select, button { margin:0.6rem 0.4rem; padding:0.5rem 0.9rem; font-size:1rem; }
    button { background:#1e40af; color:#fff; border:none; border-radius:8px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:default; }

    #previewContainer { display:none; margin-top:1.5rem; }
    #splitPreview { position:relative; width:100%; max-width:840px; margin:auto; overflow:hidden; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.08);}
    #splitPreview img{ width:100%; display:block; user-select:none; -webkit-user-drag:none; }
    #splitOverlay { position:absolute; top:0; left:0; width:50%; height:100%; overflow:hidden; }
    #splitHandle { position:absolute; top:0; left:50%; transform:translateX(-50%); width:6px; height:100%; background:#1e40af; cursor:ew-resize; z-index:10; border-radius:3px; box-shadow:0 0 0 3px rgba(255,255,255,0.15) inset; }

    .error { color:#b91c1c; font-weight:700; margin-top:0.6rem; }

    /* progress */
    .progress-wrap { max-width:600px; margin:18px auto 0; text-align:center; }
    .progress { background:#e6e9ee; border-radius:999px; height:12px; overflow:hidden; }
    .progress > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#2563eb,#1e40af); transition:width .25s linear; }
    .progress-label { font-size:0.9rem; margin-top:8px; color:#111827; font-weight:600; display:flex; align-items:center; justify-content:center; gap:0.4rem; }

    .spinner {
      width:18px; height:18px;
      border:3px solid #cbd5e1;
      border-top-color:#1e40af;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform:rotate(360deg);} }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="header-content">
      <a href="../index.html" class="brand" aria-label="Convert Labs home">
        <img src="../assets/convert-labs-icon.png" alt="Convert Labs icon" class="logo">
        <span class="brand-text">Convert Labs</span>
      </a>
      <div class="header-controls">
        <a href="../contact.html" class="header-btn">Contact Us</a>
        <button id="themeToggle" class="theme-toggle" title="Switch Theme">üåô</button>
      </div>
    </div>
    <p class="tagline">AI Image Upscaler ‚Äî Enhance and Enlarge Your Images Instantly</p>
  </header>

  <!-- MAIN -->
  <main>
    <h1>AI Image Upscaler</h1>
    <p>Upscale your images up to 8√ó resolution directly in your browser ‚Äî free & private.</p>

    <div>
      <input id="imageInput" type="file" accept="image/*" />
      <select id="scaleSelect">
        <option value="2">2√ó</option>
        <option value="4">4√ó</option>
        <option value="8">8√ó</option>
      </select>
      <button id="upscaleBtn">Upscale Now</button>
    </div>

    <div class="progress-wrap" id="progressWrap" style="display:none;">
      <div class="progress"><i id="progressBar"></i></div>
      <div class="progress-label" id="progressLabel"><div class="spinner"></div><span>Preparing model‚Ä¶</span></div>
    </div>

    <div id="errorMsg" class="error"></div>

    <div id="previewContainer">
      <div id="splitPreview">
        <img id="originalImage" alt="Original" />
        <div id="splitOverlay"><img id="upscaledImage" alt="Upscaled" /></div>
        <div id="splitHandle"></div>
      </div>
      <button id="downloadBtn" style="margin-top:1rem;">Download Upscaled Image</button>
    </div>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-content">
      <img src="../assets/convert-labs-icon.png" alt="Convert Labs icon" class="footer-logo">
      <span class="footer-text">Convert Labs</span>
    </div>
    <p>¬© 2025 Convert Labs | <a href="../index.html">Back to Home</a></p>
  </footer>

  <script src="../script.js"></script>

  <script>
  (function(){
    const fileInput = document.getElementById('imageInput');
    const upscaleBtn = document.getElementById('upscaleBtn');
    const scaleSelect = document.getElementById('scaleSelect');
    const errorMsg = document.getElementById('errorMsg');
    const originalImage = document.getElementById('originalImage');
    const upscaledImage = document.getElementById('upscaledImage');
    const previewContainer = document.getElementById('previewContainer');
    const downloadBtn = document.getElementById('downloadBtn');
    const overlay = document.getElementById('splitOverlay');
    const handle = document.getElementById('splitHandle');
    const previewBox = document.getElementById('splitPreview');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');
    const progressLabel = document.getElementById('progressLabel');

    let selectedFile = null, dragging = false;

    fileInput.addEventListener('change', (e) => {
      selectedFile = e.target.files[0];
      if (!selectedFile) return;
      if (selectedFile.size > 4 * 1024 * 1024) {
        errorMsg.textContent = "‚ö†Ô∏è File too large. Please choose an image smaller than 4 MB.";
        fileInput.value = "";
        selectedFile = null;
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        originalImage.src = reader.result;
        previewContainer.style.display = 'none';
        errorMsg.textContent = '';
      };
      reader.readAsDataURL(selectedFile);
    });

    async function upscaleImage() {
      if (!selectedFile) {
        errorMsg.textContent = "Please choose an image first.";
        return;
      }

      errorMsg.textContent = "";
      upscaleBtn.disabled = true;
      scaleSelect.disabled = true;
      fileInput.disabled = true;
      progressWrap.style.display = 'block';
      progressBar.style.width = "5%";
      progressLabel.innerHTML = '<div class="spinner"></div><span>Loading Upscaler‚Ä¶</span>';

      try {
        const upscaler = new window.Upscaler({
  model: "https://cdn.jsdelivr.net/npm/@upscalerjs/realesrgan-x2plus@1.1.0/weights/1x/model.json"

});


        const bitmap = await createImageBitmap(selectedFile);
        let canvas = document.createElement("canvas");
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        canvas.getContext("2d").drawImage(bitmap, 0, 0);

        const scale = parseInt(scaleSelect.value);
        const passes = Math.log2(scale);

        for (let i = 0; i < passes; i++) {
          progressLabel.innerHTML = `<div class="spinner"></div><span>Upscaling pass ${i+1}/${passes}‚Ä¶</span>`;
          progressBar.style.width = `${(i/passes)*80 + 10}%`;

          const result = await upscaler.upscale(canvas);
          const img = new Image();
          img.src = result;
          await img.decode();

          const temp = document.createElement("canvas");
          temp.width = img.width;
          temp.height = img.height;
          temp.getContext("2d").drawImage(img, 0, 0);
          canvas = temp;
        }

        progressBar.style.width = "100%";
        progressLabel.innerHTML = "<span>Completed 100%</span>";

        upscaledImage.src = canvas.toDataURL("image/png");
        previewContainer.style.display = "block";
      } catch (err) {
        console.error(err);
        errorMsg.textContent = "‚ö†Ô∏è Error upscaling. Try smaller image or lower scale.";
        progressLabel.innerHTML = "<span style='color:#b91c1c;'>Failed</span>";
      } finally {
        upscaleBtn.disabled = false;
        scaleSelect.disabled = false;
        fileInput.disabled = false;
        setTimeout(() => progressWrap.style.display = "none", 1000);
      }
    }

    upscaleBtn.addEventListener("click", upscaleImage);

    // Split drag logic
    handle.addEventListener("mousedown", () => dragging = true);
    window.addEventListener("mouseup", () => dragging = false);
    window.addEventListener("mousemove", (e) => {
      if (!dragging) return;
      const rect = previewBox.getBoundingClientRect();
      let pos = ((e.clientX - rect.left) / rect.width) * 100;
      pos = Math.max(0, Math.min(100, pos));
      overlay.style.width = pos + "%";
      handle.style.left = pos + "%";
    });

    // Touch drag
    handle.addEventListener("touchstart", () => dragging = true, {passive:true});
    window.addEventListener("touchend", () => dragging = false);
    window.addEventListener("touchmove", (e) => {
      if (!dragging) return;
      const touch = e.touches[0];
      const rect = previewBox.getBoundingClientRect();
      let pos = ((touch.clientX - rect.left) / rect.width) * 100;
      pos = Math.max(0, Math.min(100, pos));
      overlay.style.width = pos + "%";
      handle.style.left = pos + "%";
    }, {passive:true});

    // Download button
    downloadBtn.addEventListener("click", () => {
      if (!upscaledImage.src) return;
      const link = document.createElement("a");
      link.href = upscaledImage.src;
      link.download = "upscaled-image.png";
      link.click();
    });

    // Reset split position on resize/load
    function resetSplit() {
      overlay.style.width = "50%";
      handle.style.left = "50%";
    }
    window.addEventListener("resize", resetSplit);
    originalImage.addEventListener("load", resetSplit);
    upscaledImage.addEventListener("load", resetSplit);
  })();
  </script>
</body>
</html>
