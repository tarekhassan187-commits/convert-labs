<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>7-Day Meal Plan â€” Convert Labs</title>
  <meta name="description" content="Personalized 7-day meal plans built from local diet JSON lists. Auto macro balancing for Balanced / Keto / Carnivore / Vegetarian plans." />
  <link rel="icon" href="https://convertlabs.online/assets/convert-labs-icon.png" />

  <!-- Google Analytics / AdSense kept (unchanged) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z88B03WV7P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Z88B03WV7P');
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2490597435056272" crossorigin="anonymous"></script>

  <!-- jsPDF still available if you later want richer PDF output -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- ===========================
       INLINE CSS (S1 - include in-file)
       =========================== -->
  <style>
    :root{
      --brand:#0a4d8c; --brand-2:#134b8b; --muted:#6c6c6c; --bg:#f5faff; --card:#fff; --accent:#2b8bd8; --radius:12px; --text:#111;
    }
    html.dark{ --bg:#071029; --card:#081226; --text:#dbeafe; --muted:#9aa9b8; --accent:#34d399; }
    *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    header{height:64px;background:var(--brand-2);color:#fff;display:flex;align-items:center;padding:0 20px;position:sticky;top:0;z-index:100}
    .brand{font-weight:700;display:flex;align-items:center;gap:10px;}
    .nav-links{display:flex;gap:20px;margin:0 auto;}
    .nav-links a{color:#fff;text-decoration:none;font-weight:500;padding:8px 12px;border-radius:6px;transition:background-color 0.2s;}
    .nav-links a:hover{background:rgba(255,255,255,0.1);}
    .container{max-width:1180px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(12,40,80,0.04);margin-bottom:16px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--brand);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid var(--brand);color:var(--brand)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .meals{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    @media(max-width:900px){.meals{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.meals{grid-template-columns:1fr}}
    .meal{background:var(--glass);border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.04);position:relative;min-height:120px}
    .meal b{display:block;color:var(--brand-2);margin-bottom:8px;font-size:15px}
    .muted-small{font-size:13px;color:var(--muted)}
    .input-grams{width:100px;padding:6px;border-radius:8px;border:1px solid #e6e6e6}
    .meal-list-item{background:var(--card);border-radius:8px;padding:8px;margin-top:8px;border:1px solid rgba(0,0,0,0.04)}
    .locked{filter:grayscale(70%);opacity:0.25;pointer-events:none}
    .lock-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:30}
    .lock-badge{background:var(--card);padding:10px 14px;border-radius:10px;font-weight:700;box-shadow:0 8px 24px rgba(12,40,80,0.04)}
    .small-muted{font-size:12px;color:var(--muted)}
    .kcal{font-weight:700;margin-top:8px}
    .modal-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1200;padding:12px}
    .modal-card{width:100%;max-width:980px;max-height:86vh;overflow:auto;background:var(--card);border-radius:12px;padding:16px}
    footer.footer{background:var(--brand-2);color:#fff;padding:20px;text-align:center;margin-top:16px}
    .list-select { width:100%; padding:8px; border:1px solid #e6e6e6; border-radius:8px; background: #fff; }
    .flex-row { display:flex; gap:8px; align-items:center; }
    .muted-note { font-size:12px; color:var(--muted); margin-top:6px; }
    .small-btn { padding:6px 8px; font-size:13px; border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <div style="flex:1"></div>
    <div class="brand">
      <img src="https://convertlabs.online/assets/convert-labs-icon.png" alt="Convert Labs" style="width:32px;height:32px;">
      <span>Convert Labs</span>
    </div>
    <nav class="nav-links">
      <a href="https://convertlabs.online/index.html">Home</a>
      <a href="https://convertlabs.online/tools/tools.html">Tools</a>
      <a href="https://convertlabs.online/guides.html">Blog</a>
      <a href="https://convertlabs.online/about.html">About</a>
      <a href="https://convertlabs.online/contact.html">Contact</a>
    </nav>
    <div style="flex:1;display:flex;justify-content:flex-end;">
      <button id="themeToggle" class="btn ghost">ðŸŒ™</button>
    </div>
  </header>

  <div class="container">
    <main class="tool-page">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div style="flex:1">
            <h2 style="margin:0 0 6px 0">7-Day Meal Plan â€” Precision Macros</h2>
            <div class="small-muted">TDEE input should be already adjusted (do not apply goal again if copying from calorie tool).</div>
          </div>
          <div style="min-width:260px;text-align:right">
            <div style="margin-bottom:6px"><button id="generateBtn" class="btn">Generate Preview</button> <button id="acceptBtn" class="btn ghost">Accept & Save</button></div>
            <div class="small-muted">Saved plan unlocks one day every 24 hours.</div>
          </div>
        </div>

        <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
          <div>
            <label style="display:block;font-weight:700;font-size:13px">TDEE (already adjusted)</label>
            <input id="tdeeInput" type="number" placeholder="e.g. 1800" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
            <div class="small-muted" style="margin-top:6px">Paste the TDEE/target from calorie tool â€” do NOT apply goal again</div>
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Age</label>
            <input id="ageInput" type="number" min="1" max="120" placeholder="30" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Goal</label>
            <select id="goalSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
              <option value="maintain">Maintain weight</option>
              <option value="lose">Lose weight</option>
              <option value="gain">Gain weight</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Diet</label>
            <select id="dietSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
              <option value="balanced">Balanced</option>
              <option value="keto">Keto</option>
              <option value="carnivore">Carnivore</option>
              <option value="vegetarian">Vegetarian (lacto-ovo)</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Protein preference</label>
            <select id="proteinSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
              <option value="any">Any</option>
              <option value="beef">Beef</option>
              <option value="chicken">Chicken</option>
              <option value="fish">Fish</option>
              <option value="plant">Plant</option>
              <option value="eggs">Eggs</option>
            </select>
            <div style="margin-top:6px"><label><input id="oneProteinPerDay" type="checkbox" checked> Strict: one protein type per day</label></div>
          </div>

          <!-- New: allow user to choose their local JSON pool list for selected diet -->
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Food list (diet pools)</label>
            <select id="foodListSelect" class="list-select" title="Choose a diet-specific list or 'auto' to use default lists">
              <!-- Options injected by JS from available lists in /assets -->
              <option value="auto">Auto (choose per diet)</option>
            </select>
            <div class="muted-note">When adding/replacing items, the search will be limited to the chosen list.</div>
          </div>

        </div>
      </div>

      <div class="grid">
        <section>
          <div id="mainInner"></div>
        </section>

        <aside>
          <div class="card">
            <strong>Saved plan</strong>
            <div id="savedInfo" style="margin-top:8px;color:var(--muted)">No saved plan.</div>
            <div style="margin-top:10px">
              <button id="exportDayBtn" class="btn" style="width:100%">Export Today's Plan (PDF)</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <strong>Day macros</strong>
            <div id="dayMacros" style="margin-top:8px;color:var(--muted)">â€”</div>
          </div>
        </aside>
      </div>

      <div id="pageDisclaimer" class="card" style="margin-top:14px">
        <strong>Nutrition Disclaimer</strong><br>
        This meal plan is automatically generated from local diet lists and heuristics. It is not individualized medical or dietitian advice. For personalized nutrition plans, consult a licensed professional.
      </div>
    </main>
  </div>

  <!-- Modals (preview + search/add/replace) -->
  <div id="previewModal" class="modal-back"><div class="modal-card" id="previewBox"></div></div>
  <div id="usdaPopup" class="modal-back"><div class="modal-card" id="usdaBox"></div></div>
<script>
/* ============================================================
   PART 2 â€” LOAD LOCAL JSON DIET LISTS + SEARCH ONLY INSIDE POOLS
   ============================================================ */

/* ---------- Utility: safe fetch of JSON ---------- */
async function loadJSON(path) {
  try {
    const res = await fetch(path);
    if (!res.ok) throw new Error("Failed to load " + path);
    return await res.json();
  } catch (err) {
    console.error("JSON load error:", err);
    return [];
  }
}

/* ---------- Local JSON diet pools (auto-loaded) ---------- */
const LOCAL_FOOD_LISTS = {
  balanced: "/assets/foods-balanced.json",
  keto: "/assets/foods-keto.json",
  carnivore: "/assets/foods-carnivore.json",
  vegetarian: "/assets/foods-vegetarian.json"
};

/* Data holders */
let BALANCED_POOL = [];
let KETO_POOL = [];
let CARNIVORE_POOL = [];
let VEGETARIAN_POOL = [];

/* ---------- Load all lists at start ---------- */
async function loadLocalFoodPools() {
  BALANCED_POOL = await loadJSON(LOCAL_FOOD_LISTS.balanced);
  KETO_POOL = await loadJSON(LOCAL_FOOD_LISTS.keto);
  CARNIVORE_POOL = await loadJSON(LOCAL_FOOD_LISTS.carnivore);
  VEGETARIAN_POOL = await loadJSON(LOCAL_FOOD_LISTS.vegetarian);

  console.log("âœ” Local diet pools loaded");
  console.log({
    balanced: BALANCED_POOL.length,
    keto: KETO_POOL.length,
    carnivore: CARNIVORE_POOL.length,
    vegetarian: VEGETARIAN_POOL.length
  });

  populateFoodListSelector();
}

/* ---------- Fill dropdown #foodListSelect dynamically ---------- */
function populateFoodListSelector() {
  const sel = document.getElementById("foodListSelect");

  sel.innerHTML = `
    <option value="auto">Auto (per diet)</option>
    <option value="balanced">Balanced Food List</option>
    <option value="keto">Keto Food List</option>
    <option value="carnivore">Carnivore Food List</option>
    <option value="vegetarian">Vegetarian Food List</option>
  `;
}

/* ---------- Get the ACTIVE pool depending on user choice ---------- */
function getActiveFoodPool() {
  const manual = document.getElementById("foodListSelect").value;
  const diet = document.getElementById("dietSelect").value;

  if (manual !== "auto") {
    // Manual override
    switch (manual) {
      case "balanced": return BALANCED_POOL;
      case "keto": return KETO_POOL;
      case "carnivore": return CARNIVORE_POOL;
      case "vegetarian": return VEGETARIAN_POOL;
      default: return BALANCED_POOL;
    }
  }

  // AUTO: match user-selected diet
  switch (diet) {
    case "balanced": return BALANCED_POOL;
    case "keto": return KETO_POOL;
    case "carnivore": return CARNIVORE_POOL;
    case "vegetarian": return VEGETARIAN_POOL;
    default: return BALANCED_POOL;
  }
}

/* ============================================================
   PART 2 â€” SEARCH INSIDE THE ACTIVE POOL ONLY
   ============================================================ */

/*
 searchLocalFoods(query, limit)
 - searches ONLY inside the selected JSON pool
 - returns array of food objects
*/
function searchLocalFoods(query, limit = 20) {
  const pool = getActiveFoodPool();
  const q = query.toLowerCase();

  const res = pool.filter(item =>
    item.name.toLowerCase().includes(q) ||
    (item.tags && item.tags.some(t => t.toLowerCase().includes(q)))
  );

  return res.slice(0, limit);
}

/*
 mapLocalItem converts local JSON item to unified format used by meal generator
*/
function mapLocalItem(item) {
  return {
    name: item.name,
    kcal_per_100g: item.kcal,
    protein_per_100g: item.protein,
    carbs_per_100g: item.carbs,
    fat_per_100g: item.fat,
    tags: item.tags || [],
    serving: item.serving || 100
  };
}

/* ---------- Exposed search function used by Add/Replace modals ---------- */
async function searchNutrition(query, limit = 20) {
  const results = searchLocalFoods(query, limit);
  return results.map(mapLocalItem);
}

/* ---------- Helpers ---------- */
function escapeHtml(s) {
  return (s || "").toString().replace(/[&<>"']/g, m =>
    ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])
  );
}

function debounce(func, wait) {
  let timeout;
  return function (...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

/* ---------- Load all food pools immediately ---------- */
loadLocalFoodPools();
<script>
/* ============================================================
   PART 3 â€” DIET RULES, MACRO SPLITS, PORTIONS & FOOD PICKING
   ============================================================ */

/* ---------- DIET TAG RULES ---------- */
function allowedByDietTags(tags, diet) {
  const t = (tags || []).map(x => x.toLowerCase());

  if (diet === "balanced") return true;

  if (diet === "keto") {
    const forbidden = ["grain", "bread", "rice", "pasta", "sugar", "fruit", "starch", "high-carb"];
    const hasForbidden = t.some(x => forbidden.includes(x));
    return !hasForbidden;
  }

  if (diet === "carnivore") {
    const forbidden = ["plant", "veg", "vegetable", "fruit", "grain", "nuts", "legume"];
    return !t.some(x => forbidden.includes(x));
  }

  if (diet === "vegetarian") {
    const forbidden = ["meat", "beef", "chicken", "pork", "fish", "seafood", "turkey"];
    return !t.some(x => forbidden.includes(x));
  }

  return true;
}

/* ---------- PROTEIN PREFERENCE ---------- */
function matchesProteinPref(tags, pref) {
  if (!pref || pref === "any") return true;
  const t = (tags || []).map(x => x.toLowerCase());

  if (pref === "beef") return t.includes("beef");
  if (pref === "chicken") return t.includes("chicken");
  if (pref === "fish") return t.includes("fish");
  if (pref === "eggs") return t.includes("eggs");
  if (pref === "plant") return t.includes("plant") || t.includes("tofu");

  return true;
}

/* ---------- AGE MULTIPLIER ---------- */
function ageCategory(age) {
  const a = Number(age) || 30;
  if (a <= 12) return "child";
  if (a <= 19) return "teen";
  if (a <= 59) return "adult";
  return "senior";
}

function agePortionMultiplier(cat) {
  if (cat === "child") return 0.70;
  if (cat === "teen") return 1.05;
  if (cat === "senior") return 0.90;
  return 1.00;
}

/* ---------- PORTION CALCULATOR ---------- */
function gramsForTarget(kcalPer100g, mealKcal) {
  if (!kcalPer100g || kcalPer100g <= 0) return 80;  
  const g = (mealKcal / kcalPer100g) * 100;
  return Math.max(20, Math.round(g));
}

/* ---------- MACRO SPLITS ---------- */
function macroSplits(diet, goal) {
  if (diet === "balanced") {
    if (goal === "lose") return { p: 0.35, c: 0.35, f: 0.30 };
    if (goal === "gain") return { p: 0.30, c: 0.45, f: 0.25 };
    return { p: 0.25, c: 0.45, f: 0.30 };
  }

  if (diet === "keto") return { p: 0.20, c: 0.05, f: 0.75 };
  if (diet === "carnivore") return { p: 0.30, c: 0.02, f: 0.68 };
  if (diet === "vegetarian") return { p: 0.30, c: 0.45, f: 0.25 };

  return { p: 0.30, c: 0.40, f: 0.30 };
}

/* ---------- FALLBACK FOOD ---------- */
function getDietFallbackFood(diet) {
  const fallback = {
    keto: { name: "Avocado", kcal_per_100g: 160, protein_per_100g: 2, carbs_per_100g: 8, fat_per_100g: 15 },
    carnivore: { name: "Ground Beef", kcal_per_100g: 250, protein_per_100g: 26, carbs_per_100g: 0, fat_per_100g: 17 },
    vegetarian: { name: "Tofu", kcal_per_100g: 144, protein_per_100g: 12, carbs_per_100g: 3, fat_per_100g: 8 },
    balanced: { name: "Chicken Breast", kcal_per_100g: 165, protein_per_100g: 31, carbs_per_100g: 0, fat_per_100g: 3.6 }
  };
  return fallback[diet] || fallback.balanced;
}

/* ============================================================
   FOOD PICKING FROM LOCAL JSON ONLY
   ============================================================ */

/*
 pickFoodByName(name, pool, opts)
 - name search preferred if supplied
 - pool is a category pool (protein / veg / dairy / fat)
 - uses only local JSON  
*/
async function pickFoodByName(name, pool, opts, usedNames = new Set()) {
  const { diet, protein } = opts;

  let list = pool || [];

  // Filter by diet rules
  list = list.filter(item =>
    allowedByDietTags(item.tags || [], diet) &&
    matchesProteinPref(item.tags || [], protein)
  );

  // Remove used foods
  list = list.filter(x => !usedNames.has(x.name));

  // If name is provided, try exact match
  if (name) {
    const exact = list.find(x => x.name.toLowerCase().includes(name.toLowerCase()));
    if (exact) return mapLocalItem(exact);
  }

  // Random pick if nothing found
  if (list.length > 0) {
    const pick = list[Math.floor(Math.random() * list.length)];
    return mapLocalItem(pick);
  }

  return getDietFallbackFood(diet);
}

/* ============================================================
   NUTRITION CALCULATION
   ============================================================ */
function calculateMealNutrition(parts) {
  return parts.reduce(
    (acc, p) => {
      const per100 = p.per100 || p.kcal_per_100g || 0;
      const ratio = p.grams / 100;
      acc.kcal += Math.round(per100 * ratio);
      acc.protein += Math.round((p.protein_per_100g || 0) * ratio);
      acc.carbs += Math.round((p.carbs_per_100g || 0) * ratio);
      acc.fat += Math.round((p.fat_per_100g || 0) * ratio);
      return acc;
    },
    { kcal: 0, protein: 0, carbs: 0, fat: 0 }
  );
}
</script>
<!-- Add / Replace Food Modals -->
<div id="foodModal" class="modal-back">
  <div class="modal-card" id="foodModalBox">
    <h3 id="foodModalTitle">Select Food</h3>

    <!-- Food Category Filter -->
    <div style="margin:12px 0">
      <label style="font-weight:600;font-size:13px">Category</label>
      <select id="foodCategorySelect"
        style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;margin-top:4px">
      </select>
    </div>

    <!-- Food selector dropdown -->
    <div style="margin:12px 0">
      <label style="font-weight:600;font-size:13px">Food Item</label>
      <select id="foodSelect"
        style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;margin-top:4px">
      </select>
    </div>

    <!-- Buttons -->
    <div style="text-align:right;margin-top:14px">
      <button id="foodModalCancel" class="btn ghost">Cancel</button>
      <button id="foodModalApply" class="btn">Apply</button>
    </div>
  </div>
</div>

<style>
/* Modal style */
.modal-back {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  z-index:20;
  align-items:center;
  justify-content:center;
}
.modal-card {
  background:var(--card);
  width:100%;
  max-width:420px;
  padding:20px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.1);
}

/* Add item rows */
.add-item-btn, .remove-item-btn {
  cursor:pointer;
  color:#2563eb;
  font-size:13px;
  background:none;
  border:none;
  padding:0;
  font-weight:600;
}
.remove-item-btn {
  color:#dc2626;
}

/* For the dropdown rows in each meal */
.meal-item-row {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:6px;
}
</style>
<script>
/* ============================================================
   PART 5 â€” FOOD LOADING ENGINE FOR ADD/REPLACE MODALS
   Loads the correct JSON food file based on the user's diet,
   Extracts categories, fills the dropdowns, etc.
   ============================================================ */

let CURRENT_DIET = null;
let FOOD_DATA = [];
let FOOD_CATEGORIES = [];

let modalMode = "add";  // "add" or "replace"
let modalDay = null;
let modalMeal = null;

/* ============================================================
   Load food JSON based on diet type
   Example files:
   /assets/foods-balanced.json
   /assets/foods-keto.json
   /assets/foods-carnivore.json
   /assets/foods-vegetarian.json
   ============================================================ */
async function loadDietFoods(diet) {
  CURRENT_DIET = diet;

  let path = "";

  if (diet === "balanced") path = "/assets/foods-balanced.json";
  else if (diet === "keto") path = "/assets/foods-keto.json";
  else if (diet === "carnivore") path = "/assets/foods-carnivore.json";
  else if (diet === "vegetarian") path = "/assets/foods-vegetarian.json";
  else path = "/assets/foods-balanced.json"; // fallback

  try {
    const res = await fetch(path);
    FOOD_DATA = await res.json();
  } catch (err) {
    console.error("Error loading food JSON:", err);
    FOOD_DATA = [];
  }

  buildCategoryList();
}

/* ============================================================
   Build a unique list of categories from JSON
   ============================================================ */
function buildCategoryList() {
  const cats = new Set();
  FOOD_DATA.forEach(item => {
    if (item.category) cats.add(item.category);
  });
  FOOD_CATEGORIES = Array.from(cats);
}

/* ============================================================
   Fill dropdowns in modal
   ============================================================ */
function populateFoodModalDropdowns() {
  const catSelect = document.getElementById("foodCategorySelect");
  const foodSelect = document.getElementById("foodSelect");

  // Reset
  catSelect.innerHTML = "";
  foodSelect.innerHTML = "";

  // Build category dropdown
  FOOD_CATEGORIES.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
    catSelect.appendChild(opt);
  });

  // Load foods for first category
  loadFoodsForCategory(FOOD_CATEGORIES[0]);

  // When category changes â†’ refresh list
  catSelect.addEventListener("change", function () {
    loadFoodsForCategory(this.value);
  });
}

/* ============================================================
   Load items into "Food Item" dropdown based on category
   ============================================================ */
function loadFoodsForCategory(cat) {
  const foodSelect = document.getElementById("foodSelect");
  foodSelect.innerHTML = "";

  const filtered = FOOD_DATA.filter(f => f.category === cat);

  filtered.forEach(food => {
    const opt = document.createElement("option");
    opt.value = food.name;
    opt.textContent = `${food.name} â€” ${food.kcal} kcal`;
    opt.dataset.kcal = food.kcal;
    opt.dataset.protein = food.protein;
    opt.dataset.carbs = food.carbs;
    opt.dataset.fat = food.fat;
    foodSelect.appendChild(opt);
  });
}

/* ============================================================
   Open modal for Add or Replace
   ============================================================ */
async function openFoodModal(mode, dayIndex, mealKey, diet) {
  modalMode = mode;
  modalDay = dayIndex;
  modalMeal = mealKey;

  // Load foods for this diet
  await loadDietFoods(diet);

  // Populate UI
  populateFoodModalDropdowns();

  // Adjust title
  const title = document.getElementById("foodModalTitle");
  title.textContent =
    mode === "add"
      ? `Add food to ${mealKey} (Day ${dayIndex + 1})`
      : `Replace item in ${mealKey} (Day ${dayIndex + 1})`;

  // Show modal
  document.getElementById("foodModal").style.display = "flex";
}

document.getElementById("foodModalCancel").onclick = function () {
  document.getElementById("foodModal").style.display = "none";
};
</script>
<script>
/* ============================================================
   PART 6 â€” APPLY ADD / REPLACE / DELETE
   ============================================================ */

function getSelectedFoodFromDropdown() {
  const foodSelect = document.getElementById("foodSelect");
  const option = foodSelect.options[foodSelect.selectedIndex];

  return {
    name: option.value,
    kcal: Number(option.dataset.kcal),
    protein: Number(option.dataset.protein),
    carbs: Number(option.dataset.carbs),
    fat: Number(option.dataset.fat)
  };
}

/* ============================================================
   ADD FOOD TO MEAL
   ============================================================ */
function applyAddFood() {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const plan = stored.plan;
  const day = plan[modalDay];
  const meal = day[modalMeal];

  const food = getSelectedFoodFromDropdown();

  // Create new part
  const newPart = {
    name: food.name,
    grams: 100,
    per100: food.kcal,
    type: "added",
    source: {
      name: food.name,
      kcal_per_100g: food.kcal,
      protein_per_100g: food.protein,
      carbs_per_100g: food.carbs,
      fat_per_100g: food.fat
    },
    kcal: Math.round(food.kcal),
    protein: Math.round(food.protein),
    carbs: Math.round(food.carbs),
    fat: Math.round(food.fat)
  };

  if (!meal.parts) meal.parts = [];
  meal.parts.push(newPart);

  recalcMeal(meal);
  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  closeFoodModal();
}

/* ============================================================
   REPLACE FIRST FOOD IN MEAL
   ============================================================ */
function applyReplaceFood() {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const plan = stored.plan;
  const day = plan[modalDay];
  const meal = day[modalMeal];

  const food = getSelectedFoodFromDropdown();

  if (!meal.parts || meal.parts.length === 0) {
    alert("Meal has no items to replace.");
    return;
  }

  const first = meal.parts[0];

  // Replace nutrition values
  first.name = food.name;
  first.source = {
    name: food.name,
    kcal_per_100g: food.kcal,
    protein_per_100g: food.protein,
    carbs_per_100g: food.carbs,
    fat_per_100g: food.fat
  };

  const ratio = first.grams / 100;
  first.kcal = Math.round(food.kcal * ratio);
  first.protein = Math.round(food.protein * ratio);
  first.carbs = Math.round(food.carbs * ratio);
  first.fat = Math.round(food.fat * ratio);

  recalcMeal(meal);
  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  closeFoodModal();
}

/* ============================================================
   DELETE ITEM FROM MEAL
   ============================================================ */
function deleteFoodItem(dayIndex, mealKey, partIndex) {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const plan = stored.plan;
  const day = plan[dayIndex];
  const meal = day[mealKey];

  if (!meal.parts) return;
  meal.parts.splice(partIndex, 1);

  recalcMeal(meal);
  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();
}

/* ============================================================
   Recalculate kcal/macros after any modification
   ============================================================ */
function recalcMeal(meal) {
  if (!meal.parts) return;

  let kcal = 0, p = 0, c = 0, f = 0;

  meal.parts.forEach(part => {
    kcal += part.kcal || 0;
    p += part.protein || 0;
    c += part.carbs || 0;
    f += part.fat || 0;
  });

  meal.kcal = kcal;
  meal.protein = p;
  meal.carbs = c;
  meal.fat = f;
}

function closeFoodModal() {
  document.getElementById("foodModal").style.display = "none";
}

/* ============================================================
   Connect modal button
   ============================================================ */
document.getElementById("foodModalAdd").onclick = function () {
  if (modalMode === "add") applyAddFood();
  else applyReplaceFood();
};
</script>
<script>

/* ============================================================
   PART 7 â€” UI Add / Replace / Delete Buttons
   ============================================================ */

let modalDay = null;
let modalMeal = null;
let modalMode = null;

/* ============================================================
   OPEN MODAL â€” with FILTERED DROPDOWN
   ============================================================ */
function openFoodModal(dayIndex, mealKey, mode) {
  modalDay = dayIndex;
  modalMeal = mealKey;
  modalMode = mode;  // "add" or "replace"

  const modal = document.getElementById("foodModal");
  const dropdown = document.getElementById("foodSelect");
  dropdown.innerHTML = "";

  // Determine diet
  const stored = loadPlan();
  const diet = stored.plan[0].meta.diet || "balanced";

  // Pick the correct JSON pool
  let pool = [];
  if (diet === "keto") pool = window.KETO_FOODS || [];
  else if (diet === "carnivore") pool = window.CARNIVORE_FOODS || [];
  else if (diet === "balanced") pool = window.BALANCED_FOODS || [];
  else if (diet === "vegetarian") pool = window.VEGETARIAN_FOODS || [];

  // Populate dropdown
  pool.forEach(item => {
    const opt = document.createElement("option");
    opt.value = item.name;
    opt.textContent = `${item.name} (${item.kcal} kcal / 100g)`;

    opt.dataset.kcal = item.kcal;
    opt.dataset.protein = item.protein;
    opt.dataset.carbs = item.carbs;
    opt.dataset.fat = item.fat;

    dropdown.appendChild(opt);
  });

  modal.style.display = "flex";
}

/* ============================================================
   RENDER DELETE BUTTON
   ============================================================ */
function renderDeleteButton(dayIdx, mealKey, partIndex, locked) {
  if (locked) return ""; // No delete button for locked days

  return `
    <button 
      class="btn ghost small" 
      style="margin-left:6px;color:#d33;border-color:#d33" 
      onclick="deleteFoodItem(${dayIdx}, '${mealKey}', ${partIndex})">
      Delete
    </button>
  `;
}

/* ============================================================
   RENDER MEAL PARTS INSIDE UI
   (This REPLACES the existing part rendering)
   ============================================================ */
function renderMealParts(dayIdx, mealKey, mealObj, locked) {
  let html = "";

  mealObj.parts.forEach((p, partIndex) => {
    html += `
      <div class="meal-list-item" style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
        <div>
          <div style="font-weight:700">${escapeHtml(p.name)}</div>
          <div class="muted-small">${p.grams || 0}g â€¢ ${p.kcal || 0} kcal</div>
          <div class="muted-small" style="font-size:11px">${p.type || "main"}</div>
        </div>

        <div style="display:flex;align-items:center;gap:4px">
          <input 
            type="number" 
            class="input-grams" 
            value="${p.grams}" 
            data-day="${dayIdx}" 
            data-meal="${mealKey}--part--${partIndex}"
            ${locked ? "disabled" : ""}
            style="width:70px"
            oninput="onGramChange(event)"
          >

          ${renderDeleteButton(dayIdx, mealKey, partIndex, locked)}
        </div>
      </div>
    `;
  });

  return html;
}

/* ============================================================
   MODIFY renderPlan() so Add/Replace UI is injected
   ============================================================ */
window.renderPlan = function(plan, startDateISO) {
  const container = document.getElementById("mainInner");
  container.innerHTML = "";

  const now = new Date();
  const start = new Date(startDateISO);
  const daysPassed = Math.floor((now - start) / 86400000);
  const unlockedIdx = Math.max(0, Math.min(6, daysPassed));

  plan.forEach((day, dayIdx) => {
    const locked = dayIdx > unlockedIdx;

    const card = document.createElement("div");
    card.className = "card";
    if (locked) card.classList.add("locked");

    let html = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <strong>Day ${day.day}${day.free ? " â€” FREE" : ""}</strong>
          <div class="muted-small">${locked ? "Locked" : "Unlocked"}</div>
        </div>

        ${
          locked
            ? ""
            : `<button class="btn ghost" onclick="suggestAdjustmentForDayWrapper(${dayIdx})">Suggest Adjustment</button>`
        }
      </div>

      <div class="meals">
        ${renderMealBlock(dayIdx, "breakfast", day.breakfast, locked)}
        ${renderMealBlock(dayIdx, "lunch", day.lunch, locked)}
        ${renderMealBlock(dayIdx, "dinner", day.dinner, locked)}
        ${renderMealBlock(dayIdx, "snack", day.snack, locked)}
      </div>
    `;

    card.innerHTML = html;
    container.appendChild(card);
  });
};

/* ============================================================
   RENDER A MEAL BLOCK (Breakfast, Lunch, Dinner, Snack)
   ============================================================ */
function renderMealBlock(dayIdx, mealKey, mealObj, locked) {
  return `
    <div class="meal card ${locked ? "locked" : ""}">
      <b style="display:block;margin-bottom:6px;">${mealKey.toUpperCase()}</b>

      <div>
        ${renderMealParts(dayIdx, mealKey, mealObj, locked)}
      </div>

      ${
        locked
          ? ""
          : `
          <button class="btn ghost" style="margin-top:8px;" onclick="openFoodModal(${dayIdx}, '${mealKey}', 'add')">
            + Add Item
          </button>

          <button class="btn ghost" style="margin-top:6px;" onclick="openFoodModal(${dayIdx}, '${mealKey}', 'replace')">
            Replace First Item
          </button>
        `
      }

      <div class="muted-small" style="margin-top:8px;">
        Total: ${mealObj.kcal || 0} kcal
      </div>
    </div>
  `;
}

</script>
<!-- ============================================================
     PART 8 â€” Add / Replace Food Modal (Diet-Filtered)
     ============================================================ -->
<div id="foodModal" 
     style="
        display:none;
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.45);
        align-items:center;
        justify-content:center;
        z-index:9999;
     "
     onclick="if(event.target.id==='foodModal') this.style.display='none'">

  <div id="foodModalBox" 
       style="
          width:95%;
          max-width:420px;
          background:var(--card);
          padding:20px;
          border-radius:14px;
          box-shadow:0 4px 22px rgba(0,0,0,0.25);
       ">
       
    <h3 style="margin-bottom:12px;">Select Food Item</h3>

    <!-- Dropdown list -->
    <select id="foodSelect" 
            style="
              width:100%;
              padding:10px;
              border-radius:8px;
              border:1px solid #ccc;
              font-size:15px;
              margin-bottom:16px;
            ">
    </select>

    <!-- Button row -->
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
      <button class="btn ghost" onclick="document.getElementById('foodModal').style.display='none'">
        Cancel
      </button>

      <button class="btn" onclick="applyFoodModalSelection()">
        Apply
      </button>
    </div>

  </div>
</div>
<script>
/* ============================================================
   PART 8 â€” Apply selection from modal (Add/Replace)
   ============================================================ */
function applyFoodModalSelection() {
  const dropdown = document.getElementById("foodSelect");
  const selected = dropdown.options[dropdown.selectedIndex];
  if (!selected) return;

  const name = selected.value;
  const kcal = Number(selected.dataset.kcal);
  const protein = Number(selected.dataset.protein);
  const carbs = Number(selected.dataset.carbs);
  const fat = Number(selected.dataset.fat);

  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const plan = stored.plan;
  const day = plan[modalDay];
  const meal = day[modalMeal];

  // Build the new food item
  const newItem = {
    name,
    per100: kcal,
    grams: 100,
    kcal: kcal,
    protein,
    carbs,
    fat,
    type: "added",
    source: {
      name,
      kcal_per_100g: kcal,
      protein_per_100g: protein,
      carbs_per_100g: carbs,
      fat_per_100g: fat
    }
  };

  if (modalMode === "add") {
    meal.parts.push(newItem);
  }

  if (modalMode === "replace") {
    // Replace FIRST item only
    if (meal.parts.length > 0) {
      const first = meal.parts[0];
      const ratio = first.grams / 100;

      first.name = name;
      first.per100 = kcal;
      first.source = newItem.source;

      // recalc
      first.kcal = Math.round(kcal * ratio);
      first.protein = Math.round(protein * ratio);
      first.carbs = Math.round(carbs * ratio);
      first.fat = Math.round(fat * ratio);
    }
  }

  // Recalculate meal kcal
  meal.kcal = meal.parts.reduce((s, x) => s + (x.kcal || 0), 0);

  // Save + re-render
  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  // Close modal
  document.getElementById("foodModal").style.display = "none";
}
</script>
<script>
/* ============================================================
   PART 9 â€” Delete food item from meal (with recalculation)
   ============================================================ */

function deleteMealItem(dayIdx, mealKey, partIdx) {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const plan = stored.plan;
  const day = plan[dayIdx];
  if (!day) return;

  const meal = day[mealKey];
  if (!meal || !meal.parts || !meal.parts[partIdx]) return;

  // Remove the item
  meal.parts.splice(partIdx, 1);

  // Recalculate meal kcal
  meal.kcal = meal.parts.reduce((s, p) => s + (p.kcal || 0), 0);

  // Save + re-render
  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();
}
</script>
<button class="btn danger small" 
        onclick="deleteMealItem(${idx}, '${mealKey}', ${pi})">
  Delete
</button>
<script>
/* ============================================================
   PART 10 â€” Load diet-based food list from JSON
   ============================================================ */

let DIET_FOOD_DATA = {
  balanced: [],
  keto: [],
  carnivore: [],
  vegetarian: []
};

async function loadDietFood(diet) {
  if (DIET_FOOD_DATA[diet] && DIET_FOOD_DATA[diet].length > 0) {
    return DIET_FOOD_DATA[diet]; // already loaded
  }

  let path = "";
  if (diet === "balanced") path = "/assets/food-balanced.json";
  if (diet === "keto") path = "/assets/food-keto.json";
  if (diet === "carnivore") path = "/assets/food-carnivore.json";
  if (diet === "vegetarian") path = "/assets/food-vegetarian.json";

  try {
    const res = await fetch(path);
    const data = await res.json();
    DIET_FOOD_DATA[diet] = data;
    return data;
  } catch (e) {
    console.error("Failed to load diet food file:", e);
    return [];
  }
}


/* ============================================================
   PART 10 â€” Dropdown renderer for Add/Replace Item modals
   ============================================================ */

async function renderDietFoodDropdown(diet) {
  const list = await loadDietFood(diet);

  if (!list || list.length === 0) {
    return `<div class='muted-small'>No food items available for this diet.</div>`;
  }

  let html = `
    <label style="font-weight:700; display:block; margin-bottom:8px;">Choose a food:</label>
    <select id="dietFoodSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
      <option value="">-- Select food --</option>
  `;

  list.forEach(item => {
    html += `
      <option value="${item.name}" 
              data-kcal="${item.kcal}" 
              data-protein="${item.protein}" 
              data-carbs="${item.carbs}" 
              data-fat="${item.fat}">
        ${item.name} â€” ${item.kcal} kcal
      </option>`;
  });

  html += `</select>
    <button class="btn" style="margin-top:10px" onclick="applyDietFoodSelection()">Add Item</button>
  `;

  return html;
}


/* ============================================================
   PART 10 â€” Insert selected food into the plan
   ============================================================ */

function applyDietFoodSelection() {
  const sel = document.getElementById("dietFoodSelect");
  if (!sel || !sel.value) return alert("Please select a food first.");

  const name = sel.value;
  const kcal = Number(sel.selectedOptions[0].dataset.kcal);
  const protein = Number(sel.selectedOptions[0].dataset.protein);
  const carbs = Number(sel.selectedOptions[0].dataset.carbs);
  const fat = Number(sel.selectedOptions[0].dataset.fat);

  // Reuse your add function
  applyAddToPlan(name, kcal, protein, carbs, fat);

  // Close modal
  document.getElementById("usdaPopup").style.display = "none";
}
</script>
<script>
function openAddItemModal(dayIdx, mealKey) {
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;

  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");

  // Get current diet
  const diet = document.getElementById("dietSelect").value || "balanced";

  // TEMP placeholder while loading
  box.innerHTML = `<h3>Add Item â€” Day ${dayIdx + 1} (${mealKey})</h3>
                   <div class="muted-small">Loading food list...</div>`;

  modal.style.display = "flex";

  // Load dropdown dynamically
  renderDietFoodDropdown(diet).then(html => {
    box.innerHTML = `
      <h3>Add Item â€” Day ${dayIdx + 1} (${mealKey})</h3>
      ${html}
      <div style="margin-top:10px; text-align:right;">
        <button class="btn ghost" onclick="closeUsdaPopup()">Close</button>
      </div>
    `;
  });
}
</script>
<script>
function openReplaceModal(dayIdx, mealKey) {
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;

  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");

  const diet = document.getElementById("dietSelect").value || "balanced";

  box.innerHTML = `<h3>Replace Item â€” Day ${dayIdx + 1} (${mealKey})</h3>
                   <div class="muted-small">Loading food list...</div>`;

  modal.style.display = "flex";

  renderDietFoodDropdown(diet).then(html => {
    box.innerHTML = `
      <h3>Replace Item â€” Day ${dayIdx + 1} (${mealKey})</h3>
      ${html.replace("Add Item", "Replace Item")}
      <div style="margin-top:10px; text-align:right;">
        <button class="btn ghost" onclick="closeUsdaPopup()">Close</button>
      </div>
    `;
  });
}
</script>
<script>
function closeUsdaPopup() {
  document.getElementById("usdaPopup").style.display = "none";
}
</script>
const right = document.createElement("div");
right.style.display = "flex";
right.style.gap = "4px";

// Gram input
const inp = document.createElement("input");
inp.type = "number";
inp.className = "input-grams";
inp.value = p.grams || 0;
inp.dataset.day = idx;
inp.dataset.meal = `${mealKey}--part--${pi}`;
inp.disabled = isLocked;
inp.addEventListener('click', e => e.stopPropagation());
inp.addEventListener('input', onGramChange);
inp.addEventListener('blur', function(e) {
  if (this._updateTimeout) {
    clearTimeout(this._updateTimeout);
    applyGramChange(Number(this.dataset.day), this.dataset.meal, this.value);
  }
});
inp.addEventListener('focus', function(e) {
  this.select();
});
right.appendChild(inp);

// DELETE BUTTON (ACTIVE ONLY IF UNLOCKED)
if (!isLocked) {
  const delBtn = document.createElement("button");
  delBtn.className = "btn ghost";
  delBtn.textContent = "âœ•";
  delBtn.style.padding = "4px 8px";
  delBtn.style.color = "#e74c3c";

  delBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    deleteMealPart(idx, mealKey, pi);
  });

  right.appendChild(delBtn);
}

pDiv.appendChild(left);
pDiv.appendChild(right);
function deleteMealPart(dayIdx, mealKey, partIndex) {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const plan = stored.plan;
  const day = plan[dayIdx];
  if (!day || !day[mealKey] || !day[mealKey].parts) return;

  // Remove the part
  day[mealKey].parts.splice(partIndex, 1);

  // Recalculate kcal
  day[mealKey].kcal = day[mealKey].parts.reduce((sum, x) => sum + (x.kcal || 0), 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();
}
async function renderDietFoodDropdown(diet) {
  const list = DIET_FOOD_LIST[diet] || [];
  if (!list.length) {
    return `<div class="muted-small">No foods found for this diet.</div>`;
  }

  let options = "";
  list.forEach(item => {
    options += `<option value="${encodeURIComponent(JSON.stringify(item))}">
                  ${item.name} â€” ${item.kcal} kcal / 100g
                </option>`;
  });

  return `
    <label style="font-size:13px;font-weight:600;">Choose food item:</label>
    <select id="dietFoodSelect" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px;">
      ${options}
    </select>

    <label style="font-size:13px;font-weight:600;margin-top:12px;display:block;">Portion (grams):</label>
    <input type="number" id="dietFoodGrams" value="100" 
           style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px;">

    <button class="btn" style="margin-top:12px;width:100%;" onclick="confirmDietFoodSelect()">Add Item</button>
  `;
}
function confirmDietFoodSelect() {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const plan = stored.plan;
  const day = plan[currentDayForModal];

  const raw = document.getElementById("dietFoodSelect").value;
  const grams = Number(document.getElementById("dietFoodGrams").value) || 100;

  const item = JSON.parse(decodeURIComponent(raw));

  const newPart = {
    name: item.name,
    per100: item.kcal,
    grams: grams,
    kcal: Math.round(item.kcal * (grams / 100)),
    protein: Math.round(item.protein * (grams / 100)),
    carbs: Math.round(item.carbs * (grams / 100)),
    fat: Math.round(item.fat * (grams / 100)),
    type: "custom",
    source: item
  };

  // Add or replace?
  const parts = day[currentMealForModal].parts;

  if (isReplaceMode) {
    parts[0] = newPart; // Replace first item
  } else {
    parts.push(newPart); // Add new one
  }

  // Update kcal
  day[currentMealForModal].kcal = parts.reduce((sum, x) => sum + (x.kcal || 0), 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  closeUsdaPopup();
}
<script>
/* ============================================================
   PART 13 â€” Load diet JSON files + Build DIET_FOOD_LIST
   ============================================================ */

let FOOD_BALANCED = [];
let FOOD_KETO = [];
let FOOD_CARNIVORE = [];
let FOOD_VEGETARIAN = [];

let DIET_FOOD_LIST = {}; // final unified food pool

// --- Helper: normalize fields to standard per-100g names
function normalizeFoodItem(item) {
  return {
    name: item.name,
    serving: item.serving || 100,

    // Standardize per-100g macros
    kcal: item.kcal || item.kcal_per_100g || 0,
    protein: item.protein || item.protein_per_100g || 0,
    carbs: item.carbs || item.carbs_per_100g || 0,
    fat: item.fat || item.fat_per_100g || 0,

    category: item.category || "",
    tags: item.tags || []
  };
}

// --- Load a single JSON file
async function loadJsonFile(path) {
  try {
    const res = await fetch(path);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    if (!Array.isArray(data)) {
      console.warn("File is not an array:", path);
      return [];
    }
    return data.map(normalizeFoodItem);

  } catch (err) {
    console.error("Failed to load:", path, err);
    return []; // safe fallback
  }
}

// --- Load all diet files
async function loadAllDietFiles() {
  FOOD_BALANCED = await loadJsonFile("/assets/foods-balanced.json");
  FOOD_KETO = await loadJsonFile("/assets/foods-keto.json");
  FOOD_CARNIVORE = await loadJsonFile("/assets/foods-carnivore.json");
  FOOD_VEGETARIAN = await loadJsonFile("/assets/foods-vegetarian.json");

  // Build unified pool
  DIET_FOOD_LIST = {
    balanced: FOOD_BALANCED,
    keto: FOOD_KETO,
    carnivore: FOOD_CARNIVORE,
    vegetarian: FOOD_VEGETARIAN
  };

  console.log("Loaded diet food lists:", DIET_FOOD_LIST);
}

// --- Call loader on startup
(async function initDietFoodSystem() {
  await loadAllDietFiles();

  // OPTIONAL PROTECTION:
  // If a diet has no foods, show warning in console (only for debugging)
  Object.keys(DIET_FOOD_LIST).forEach(key => {
    if (!DIET_FOOD_LIST[key] || DIET_FOOD_LIST[key].length === 0) {
      console.warn(`âš  Diet '${key}' has NO foods loaded`);
    }
  });
})();
</script>
<script>
/* ============================================================
   PART 14 â€” Diet-Based Food Picker (Add / Replace)
   ============================================================ */

let currentDayForModal = null;
let currentMealForModal = null;
let currentReplaceIndex = null;

// --- Build categories from diet list
function getCategoriesForDiet(diet) {
  const foods = DIET_FOOD_LIST[diet] || [];
  const cats = [...new Set(foods.map(f => f.category))];
  return cats.sort();
}

// --- Get foods for diet + category
function getFoodsForDietAndCategory(diet, category) {
  const foods = DIET_FOOD_LIST[diet] || [];
  return foods.filter(f => f.category === category);
}

/* ============================================================
   OPEN ADD ITEM MODAL
   ============================================================ */
function openAddItemModal(dayIdx, mealKey) {
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;
  currentReplaceIndex = null;

  const diet = document.getElementById("dietSelect").value;
  const categories = getCategoriesForDiet(diet);

  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");

  box.innerHTML = `
    <h3>Add Item to ${mealKey.toUpperCase()} â€“ Day ${dayIdx + 1}</h3>

    <label><b>Select Category:</b></label>
    <select id="foodCategorySelect" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;">
      <option value="">-- Choose Category --</option>
      ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
    </select>

    <label style="margin-top:14px;display:block;"><b>Select Food:</b></label>
    <select id="foodItemSelect" style="width:100%;padding:8px;border-radius:8px;" disabled>
      <option value="">-- Select Category First --</option>
    </select>

    <div style="text-align:right;margin-top:14px;">
      <button id="foodAddConfirm" class="btn" disabled>Add</button>
      <button id="usdaClose" class="btn ghost">Cancel</button>
    </div>
  `;

  modal.style.display = "flex";

  // Events
  document.getElementById("foodCategorySelect").onchange = () => loadItemsBasedOnCategory(diet);
  document.getElementById("foodAddConfirm").onclick = applyDietItemAdd;
  document.getElementById("usdaClose").onclick = () => modal.style.display = "none";
}

/* ============================================================
   OPEN REPLACE ITEM MODAL
   ============================================================ */
function openReplaceModal(dayIdx, mealKey, partIndex = 0) {
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;
  currentReplaceIndex = partIndex;

  const diet = document.getElementById("dietSelect").value;
  const categories = getCategoriesForDiet(diet);

  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");

  box.innerHTML = `
    <h3>Replace Item in ${mealKey.toUpperCase()} â€“ Day ${dayIdx + 1}</h3>

    <label><b>Select Category:</b></label>
    <select id="foodCategorySelect" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;">
      <option value="">-- Choose Category --</option>
      ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
    </select>

    <label style="margin-top:14px;display:block;"><b>Select Replacement Food:</b></label>
    <select id="foodItemSelect" style="width:100%;padding:8px;border-radius:8px;" disabled>
      <option value="">-- Select Category First --</option>
    </select>

    <div style="text-align:right;margin-top:14px;">
      <button id="foodAddConfirm" class="btn" disabled>Replace</button>
      <button id="usdaClose" class="btn ghost">Cancel</button>
    </div>
  `;

  modal.style.display = "flex";

  // Events
  document.getElementById("foodCategorySelect").onchange = () => loadItemsBasedOnCategory(diet);
  document.getElementById("foodAddConfirm").onclick = applyDietItemReplace;
  document.getElementById("usdaClose").onclick = () => modal.style.display = "none";
}

/* ============================================================
   CATEGORY â†’ ITEMS LOADER
   ============================================================ */
function loadItemsBasedOnCategory(diet) {
  const cat = document.getElementById("foodCategorySelect").value;
  const itemSelect = document.getElementById("foodItemSelect");

  if (!cat) {
    itemSelect.disabled = true;
    itemSelect.innerHTML = `<option value="">-- Select Category First --</option>`;
    document.getElementById("foodAddConfirm").disabled = true;
    return;
  }

  const foods = getFoodsForDietAndCategory(diet, cat);

  itemSelect.disabled = false;
  itemSelect.innerHTML = `
    <option value="">-- Choose Food --</option>
    ${foods.map((f, i) =>
      `<option value="${i}">${f.name} (${f.kcal} kcal)</option>`
    ).join("")}
  `;

  itemSelect.onchange = () => {
    document.getElementById("foodAddConfirm").disabled = itemSelect.value === "";
  };
}

/* ============================================================
   APPLY ADD ITEM
   ============================================================ */
function applyDietItemAdd() {
  const itemIndex = document.getElementById("foodItemSelect").value;
  if (itemIndex === "") return;

  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const diet = document.getElementById("dietSelect").value;
  const cat = document.getElementById("foodCategorySelect").value;
  const foods = getFoodsForDietAndCategory(diet, cat);

  const food = foods[itemIndex];
  const plan = stored.plan;

  const day = plan[currentDayForModal];
  const meal = day[currentMealForModal];

  if (!meal.parts) meal.parts = [];

  const newPart = {
    name: food.name,
    per100: food.kcal,
    grams: 100,
    kcal: food.kcal,
    protein: food.protein,
    carbs: food.carbs,
    fat: food.fat,
    category: food.category,
    source: food
  };

  meal.parts.push(newPart);
  meal.kcal = meal.parts.reduce((s, p) => s + p.kcal, 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  document.getElementById("usdaPopup").style.display = "none";
}

/* ============================================================
   APPLY REPLACE ITEM
   ============================================================ */
function applyDietItemReplace() {
  const itemIndex = document.getElementById("foodItemSelect").value;
  if (itemIndex === "") return;

  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const diet = document.getElementById("dietSelect").value;
  const cat = document.getElementById("foodCategorySelect").value;
  const foods = getFoodsForDietAndCategory(diet, cat);

  const food = foods[itemIndex];
  const plan = stored.plan;

  const day = plan[currentDayForModal];
  const meal = day[currentMealForModal];

  if (!meal.parts) return;

  const part = meal.parts[currentReplaceIndex];

  const ratio = part.grams / 100;

  part.name = food.name;
  part.per100 = food.kcal;
  part.source = food;
  part.kcal = Math.round(food.kcal * ratio);
  part.protein = Math.round(food.protein * ratio);
  part.carbs = Math.round(food.carbs * ratio);
  part.fat = Math.round(food.fat * ratio);

  meal.kcal = meal.parts.reduce((s, p) => s + (p.kcal || 0), 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  document.getElementById("usdaPopup").style.display = "none";
}
</script>
function confirmDietFoodSelect() {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const plan = stored.plan;
  const day = plan[currentDayForModal];

  const raw = document.getElementById("dietFoodSelect").value;
  const grams = Number(document.getElementById("dietFoodGrams").value) || 100;

  const item = JSON.parse(decodeURIComponent(raw));

  const newPart = {
    name: item.name,
    per100: item.kcal,
    grams: grams,
    kcal: Math.round(item.kcal * (grams / 100)),
    protein: Math.round(item.protein * (grams / 100)),
    carbs: Math.round(item.carbs * (grams / 100)),
    fat: Math.round(item.fat * (grams / 100)),
    type: "custom",
    source: item
  };

  // Add or replace?
  const parts = day[currentMealForModal].parts;

  if (isReplaceMode) {
    parts[0] = newPart; // Replace first item
  } else {
    parts.push(newPart); // Add new one
  }

  // Update kcal
  day[currentMealForModal].kcal = parts.reduce((sum, x) => sum + (x.kcal || 0), 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  closeUsdaPopup();
}
<script>
/* ============================================================
   PART 13 â€” Load diet JSON files + Build DIET_FOOD_LIST
   ============================================================ */

let FOOD_BALANCED = [];
let FOOD_KETO = [];
let FOOD_CARNIVORE = [];
let FOOD_VEGETARIAN = [];

let DIET_FOOD_LIST = {}; // final unified food pool

// --- Helper: normalize fields to standard per-100g names
function normalizeFoodItem(item) {
  return {
    name: item.name,
    serving: item.serving || 100,

    // Standardize per-100g macros
    kcal: item.kcal || item.kcal_per_100g || 0,
    protein: item.protein || item.protein_per_100g || 0,
    carbs: item.carbs || item.carbs_per_100g || 0,
    fat: item.fat || item.fat_per_100g || 0,

    category: item.category || "",
    tags: item.tags || []
  };
}

// --- Load a single JSON file
async function loadJsonFile(path) {
  try {
    const res = await fetch(path);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    if (!Array.isArray(data)) {
      console.warn("File is not an array:", path);
      return [];
    }
    return data.map(normalizeFoodItem);

  } catch (err) {
    console.error("Failed to load:", path, err);
    return []; // safe fallback
  }
}

// --- Load all diet files
async function loadAllDietFiles() {
  FOOD_BALANCED = await loadJsonFile("/assets/foods-balanced.json");
  FOOD_KETO = await loadJsonFile("/assets/foods-keto.json");
  FOOD_CARNIVORE = await loadJsonFile("/assets/foods-carnivore.json");
  FOOD_VEGETARIAN = await loadJsonFile("/assets/foods-vegetarian.json");

  // Build unified pool
  DIET_FOOD_LIST = {
    balanced: FOOD_BALANCED,
    keto: FOOD_KETO,
    carnivore: FOOD_CARNIVORE,
    vegetarian: FOOD_VEGETARIAN
  };

  console.log("Loaded diet food lists:", DIET_FOOD_LIST);
}

// --- Call loader on startup
(async function initDietFoodSystem() {
  await loadAllDietFiles();

  // OPTIONAL PROTECTION:
  // If a diet has no foods, show warning in console (only for debugging)
  Object.keys(DIET_FOOD_LIST).forEach(key => {
    if (!DIET_FOOD_LIST[key] || DIET_FOOD_LIST[key].length === 0) {
      console.warn(`âš  Diet '${key}' has NO foods loaded`);
    }
  });
})();
</script>
<script>
/* ============================================================
   PART 14 â€” Diet-Based Food Picker (Add / Replace)
   ============================================================ */

let currentDayForModal = null;
let currentMealForModal = null;
let currentReplaceIndex = null;

// --- Build categories from diet list
function getCategoriesForDiet(diet) {
  const foods = DIET_FOOD_LIST[diet] || [];
  const cats = [...new Set(foods.map(f => f.category))];
  return cats.sort();
}

// --- Get foods for diet + category
function getFoodsForDietAndCategory(diet, category) {
  const foods = DIET_FOOD_LIST[diet] || [];
  return foods.filter(f => f.category === category);
}

/* ============================================================
   OPEN ADD ITEM MODAL
   ============================================================ */
function openAddItemModal(dayIdx, mealKey) {
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;
  currentReplaceIndex = null;

  const diet = document.getElementById("dietSelect").value;
  const categories = getCategoriesForDiet(diet);

  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");

  box.innerHTML = `
    <h3>Add Item to ${mealKey.toUpperCase()} â€“ Day ${dayIdx + 1}</h3>

    <label><b>Select Category:</b></label>
    <select id="foodCategorySelect" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;">
      <option value="">-- Choose Category --</option>
      ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
    </select>

    <label style="margin-top:14px;display:block;"><b>Select Food:</b></label>
    <select id="foodItemSelect" style="width:100%;padding:8px;border-radius:8px;" disabled>
      <option value="">-- Select Category First --</option>
    </select>

    <div style="text-align:right;margin-top:14px;">
      <button id="foodAddConfirm" class="btn" disabled>Add</button>
      <button id="usdaClose" class="btn ghost">Cancel</button>
    </div>
  `;

  modal.style.display = "flex";

  // Events
  document.getElementById("foodCategorySelect").onchange = () => loadItemsBasedOnCategory(diet);
  document.getElementById("foodAddConfirm").onclick = applyDietItemAdd;
  document.getElementById("usdaClose").onclick = () => modal.style.display = "none";
}

/* ============================================================
   OPEN REPLACE ITEM MODAL
   ============================================================ */
function openReplaceModal(dayIdx, mealKey, partIndex = 0) {
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;
  currentReplaceIndex = partIndex;

  const diet = document.getElementById("dietSelect").value;
  const categories = getCategoriesForDiet(diet);

  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");

  box.innerHTML = `
    <h3>Replace Item in ${mealKey.toUpperCase()} â€“ Day ${dayIdx + 1}</h3>

    <label><b>Select Category:</b></label>
    <select id="foodCategorySelect" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;">
      <option value="">-- Choose Category --</option>
      ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
    </select>

    <label style="margin-top:14px;display:block;"><b>Select Replacement Food:</b></label>
    <select id="foodItemSelect" style="width:100%;padding:8px;border-radius:8px;" disabled>
      <option value="">-- Select Category First --</option>
    </select>

    <div style="text-align:right;margin-top:14px;">
      <button id="foodAddConfirm" class="btn" disabled>Replace</button>
      <button id="usdaClose" class="btn ghost">Cancel</button>
    </div>
  `;

  modal.style.display = "flex";

  // Events
  document.getElementById("foodCategorySelect").onchange = () => loadItemsBasedOnCategory(diet);
  document.getElementById("foodAddConfirm").onclick = applyDietItemReplace;
  document.getElementById("usdaClose").onclick = () => modal.style.display = "none";
}

/* ============================================================
   CATEGORY â†’ ITEMS LOADER
   ============================================================ */
function loadItemsBasedOnCategory(diet) {
  const cat = document.getElementById("foodCategorySelect").value;
  const itemSelect = document.getElementById("foodItemSelect");

  if (!cat) {
    itemSelect.disabled = true;
    itemSelect.innerHTML = `<option value="">-- Select Category First --</option>`;
    document.getElementById("foodAddConfirm").disabled = true;
    return;
  }

  const foods = getFoodsForDietAndCategory(diet, cat);

  itemSelect.disabled = false;
  itemSelect.innerHTML = `
    <option value="">-- Choose Food --</option>
    ${foods.map((f, i) =>
      `<option value="${i}">${f.name} (${f.kcal} kcal)</option>`
    ).join("")}
  `;

  itemSelect.onchange = () => {
    document.getElementById("foodAddConfirm").disabled = itemSelect.value === "";
  };
}

/* ============================================================
   APPLY ADD ITEM
   ============================================================ */
function applyDietItemAdd() {
  const itemIndex = document.getElementById("foodItemSelect").value;
  if (itemIndex === "") return;

  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const diet = document.getElementById("dietSelect").value;
  const cat = document.getElementById("foodCategorySelect").value;
  const foods = getFoodsForDietAndCategory(diet, cat);

  const food = foods[itemIndex];
  const plan = stored.plan;

  const day = plan[currentDayForModal];
  const meal = day[currentMealForModal];

  if (!meal.parts) meal.parts = [];

  const newPart = {
    name: food.name,
    per100: food.kcal,
    grams: 100,
    kcal: food.kcal,
    protein: food.protein,
    carbs: food.carbs,
    fat: food.fat,
    category: food.category,
    source: food
  };

  meal.parts.push(newPart);
  meal.kcal = meal.parts.reduce((s, p) => s + p.kcal, 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  document.getElementById("usdaPopup").style.display = "none";
}

/* ============================================================
   APPLY REPLACE ITEM
   ============================================================ */
function applyDietItemReplace() {
  const itemIndex = document.getElementById("foodItemSelect").value;
  if (itemIndex === "") return;

  const stored = loadPlan();
  if (!stored || !stored.plan) return;

  const diet = document.getElementById("dietSelect").value;
  const cat = document.getElementById("foodCategorySelect").value;
  const foods = getFoodsForDietAndCategory(diet, cat);

  const food = foods[itemIndex];
  const plan = stored.plan;

  const day = plan[currentDayForModal];
  const meal = day[currentMealForModal];

  if (!meal.parts) return;

  const part = meal.parts[currentReplaceIndex];

  const ratio = part.grams / 100;

  part.name = food.name;
  part.per100 = food.kcal;
  part.source = food;
  part.kcal = Math.round(food.kcal * ratio);
  part.protein = Math.round(food.protein * ratio);
  part.carbs = Math.round(food.carbs * ratio);
  part.fat = Math.round(food.fat * ratio);

  meal.kcal = meal.parts.reduce((s, p) => s + (p.kcal || 0), 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  document.getElementById("usdaPopup").style.display = "none";
}
</script>
<script>
/* =============================================================
   PART 18 â€” SMART MEAL ADVISOR + DIET WARNINGS
   ============================================================= */

function analyzeMealParts(parts, diet) {
  const totals = calculateMealNutrition(parts);

  const totalKcal = totals.kcal;
  const p = totals.protein;
  const c = totals.carbs;
  const f = totals.fat;

  const fatPct = totalKcal ? (f * 9) / totalKcal : 0;
  const carbPct = totalKcal ? (c * 4) / totalKcal : 0;
  const proteinPct = totalKcal ? (p * 4) / totalKcal : 0;

  const warnings = [];

  /* ---------- Diet-based rules ---------- */

  if (diet === "keto") {
    if (c > 10) warnings.push("âš  Carbs too high for keto.");
    if (fatPct < 0.60) warnings.push("Increase fats (Keto needs ~70%).");
    if (carbPct > 0.10) warnings.push("Carb ratio too high.");
  }

  if (diet === "carnivore") {
    if (c > 2) warnings.push("âš  Contains carbs â€” not carnivore-safe.");
    // Detect plants by tag
    const hasPlant = parts.some(p => {
      const tags = (p.source?.tags || p.tags || []).map(t => t.toLowerCase());
      return tags.some(t => ["veg","vegetable","fruit","grain","starch","plant","nuts","seed"].includes(t));
    });
    if (hasPlant) warnings.push("âš  Non-carnivore items detected.");
  }

  if (diet === "vegetarian") {
    const hasMeat = parts.some(p => {
      const tags = (p.source?.tags || p.tags || []).map(t => t.toLowerCase());
      return tags.some(t => ["meat","beef","chicken","fish","pork","seafood","turkey"].includes(t));
    });
    if (hasMeat) warnings.push("âš  This meal contains meat â€” not vegetarian.");
  }

  if (diet === "balanced") {
    if (fatPct > 0.55) warnings.push("Meal too high in fats for balanced diet.");
    if (carbPct < 0.25) warnings.push("Healthy carbs may be too low.");
  }

  /* ---------- Macro & Portion logic ---------- */
  if (p < 10) warnings.push("Very low protein.");
  if (totalKcal < 150) warnings.push("Portion size seems too small.");
  if (totalKcal > 900) warnings.push("Portion size seems unusually large.");

  return warnings;
}

/* =============================================================
   Patch renderPlan to inject advisor under each meal
   ============================================================= */

(function attachAdvisor() {
  const originalRender = renderPlan;

  renderPlan = function(plan, startDateISO) {
    originalRender(plan, startDateISO);

    const stored = loadPlan();
    if (!stored || !stored.plan) return;

    const diet = stored.plan[0]?.meta?.diet || "balanced";
    const cards = document.querySelectorAll(".card");

    stored.plan.forEach((day, idx) => {
      const card = cards[idx];
      if (!card) return;

      const mealDivs = card.querySelectorAll(".meal");
      ["breakfast","lunch","dinner","snack"].forEach((mealKey, mealIndex) => {
        const mealEl = mealDivs[mealIndex];
        if (!mealEl) return;

        // Remove old advisor if exists
        const old = mealEl.querySelector(".meal-advisor");
        if (old) old.remove();

        const parts = day[mealKey].parts || [];
        const issues = analyzeMealParts(parts, diet);

        const advisor = document.createElement("div");
        advisor.className = "meal-advisor";
        advisor.style.cssText = `
          margin-top:6px;
          background:rgba(255,165,0,0.10);
          padding:6px 8px;
          border-left:3px solid #ff9800;
          border-radius:6px;
          font-size:12px;
          color:var(--text);
          line-height:1.35;
        `;

        if (issues.length === 0) {
          advisor.innerHTML = `<span style="color:#27ae60">âœ” Looks good.</span>`;
        } else {
          advisor.innerHTML = issues.map(i => `â€¢ ${i}`).join("<br>");
        }

        mealEl.appendChild(advisor);
      });
    });
  };
})();
</script>
<!-- PART 19: Full-Day Nutrition Advisor -->
<script>
/* =============================
   PART 19 - Full-Day Nutrition Advisor
   - Injects "Full-Day Advisor" button into each day card after renderPlan()
   - Shows modal with color-coded analysis, macro breakdown, diet warnings and actionable suggestions
   ============================= */

function analyzeDayObject(dayObj) {
  // Calculate totals and macro kcal
  const breakfast = dayObj.breakfast.parts ? calculateMealNutrition(dayObj.breakfast.parts) : {kcal: dayObj.breakfast.kcal||0, protein: dayObj.breakfast.protein||0, carbs: dayObj.breakfast.carbs||0, fat: dayObj.breakfast.fat||0};
  const lunch = dayObj.lunch.parts ? calculateMealNutrition(dayObj.lunch.parts) : {kcal: dayObj.lunch.kcal||0, protein: dayObj.lunch.protein||0, carbs: dayObj.lunch.carbs||0, fat: dayObj.lunch.fat||0};
  const dinner = dayObj.dinner.parts ? calculateMealNutrition(dayObj.dinner.parts) : {kcal: dayObj.dinner.kcal||0, protein: dayObj.dinner.protein||0, carbs: dayObj.dinner.carbs||0, fat: dayObj.dinner.fat||0};
  const snack = dayObj.snack.parts ? calculateMealNutrition(dayObj.snack.parts) : {kcal: dayObj.snack.kcal||0, protein: dayObj.snack.protein||0, carbs: dayObj.snack.carbs||0, fat: dayObj.snack.fat||0};

  const totalKcal = breakfast.kcal + lunch.kcal + dinner.kcal + snack.kcal;
  const totalProteinG = breakfast.protein + lunch.protein + dinner.protein + snack.protein;
  const totalCarbsG = breakfast.carbs + lunch.carbs + dinner.carbs + snack.carbs;
  const totalFatG = breakfast.fat + lunch.fat + dinner.fat + snack.fat;

  const kcalFromProtein = totalProteinG * 4;
  const kcalFromCarbs = totalCarbsG * 4;
  const kcalFromFat = totalFatG * 9;
  const totalKcalComputed = kcalFromProtein + kcalFromCarbs + kcalFromFat || totalKcal;

  const macroPct = {
    p: (kcalFromProtein / totalKcalComputed) || 0,
    c: (kcalFromCarbs / totalKcalComputed) || 0,
    f: (kcalFromFat / totalKcalComputed) || 0
  };

  return {
    totals: { kcal: Math.round(totalKcal), protein: Math.round(totalProteinG), carbs: Math.round(totalCarbsG), fat: Math.round(totalFatG) },
    calorieBreakdown: { kcalFromProtein: Math.round(kcalFromProtein), kcalFromCarbs: Math.round(kcalFromCarbs), kcalFromFat: Math.round(kcalFromFat) },
    macroPct
  };
}

function dietWarnings(dayObj, analysis) {
  const warnings = [];
  const diet = (dayObj.meta && dayObj.meta.diet) || 'balanced';
  const pct = analysis.macroPct;

  // Generic calorie warning
  const diff = analysis.totals.kcal - (dayObj.meta ? dayObj.meta.target : 0);
  if (Math.abs(diff) > 250) {
    warnings.push({type:'calorie', text: `Calories are ${diff > 0 ? diff + ' kcal above' : Math.abs(diff) + ' kcal below'} target.`});
  }

  // Diet specific rules
  if (diet === 'keto') {
    // carbs should be very low
    if (pct.c > 0.08) warnings.push({type:'keto-carb', text: `Carbs are ${Math.round(pct.c*100)}% of calories â€” higher than typical keto limits.`});
    if (pct.f < 0.60) warnings.push({type:'keto-fat', text: `Fat % is ${Math.round(pct.f*100)}% â€” consider adding high-fat items (olive oil, butter, avocado).`});
  }

  if (diet === 'carnivore') {
    // carbs must be near zero and plant items avoided
    if (pct.c > 0.05) warnings.push({type:'carnivore-carb', text: `Carbs are ${Math.round(pct.c*100)}% â€” carnivore generally targets ~0-2% carbs.`});
    // check if any part has plant tags (simple check)
    const anyPlant = ['plant','veg','fruit','grain','legume','tofu','potato','rice','oat'].some(tok => {
      return JSON.stringify(dayObj).toLowerCase().includes(tok);
    });
    if (anyPlant) warnings.push({type:'carnivore-plant', text: `Some items look plant-based â€” consider replacing with animal products.`});
  }

  if (diet === 'vegetarian') {
    // Ensure adequate protein
    if (analysis.totals.protein < Math.max(45, Math.round((dayObj.meta.target || 200) * 0.25 / 4))) {
      warnings.push({type:'veg-protein', text: `Protein looks low for vegetarian plan. Consider adding tofu, tempeh, Greek yogurt or legumes.`});
    }
  }

  // very low protein warning
  if (analysis.totals.protein < 30) {
    warnings.push({type:'low-protein', text: `Total protein is ${analysis.totals.protein}g â€” this is low for most adults.`});
  }

  return warnings;
}

function suggestionListFromWarnings(warnings, dayObj, analysis) {
  const suggestions = [];
  warnings.forEach(w => {
    if (w.type === 'calorie') {
      if (w.text.includes('above')) {
        suggestions.push('Reduce portion sizes of the highest-calorie items (fatty cuts, nuts, cheese).');
        suggestions.push('Or replace one snack with a lower-calorie option (e.g., steamed veg or broth).');
      } else {
        suggestions.push('Increase portion sizes of protein-rich foods or add a nutrient-dense snack (Greek yogurt, eggs).');
      }
    }
    if (w.type === 'keto-carb') {
      suggestions.push('Swap high-carb components (fruit, rice, bread) for low-carb veg (zucchini, broccoli) or extra fats (butter, oil).');
    }
    if (w.type === 'keto-fat') {
      suggestions.push('Add a tbsp of olive oil, butter, or 1/2 avocado to one meal to raise fat percentage.');
    }
    if (w.type === 'carnivore-plant') {
      suggestions.push('Replace the plant-based part with an extra serving of meat, fish, eggs, or organ meat.');
    }
    if (w.type === 'veg-protein') {
      suggestions.push('Add higher-protein vegetarian items: extra tofu/tempeh, cottage cheese, lentils or a protein-focused snack.');
    }
    if (w.type === 'low-protein') {
      suggestions.push('Add a protein-rich snack (eggs, Greek yogurt, cottage cheese, lean meat) or increase main protein grams.');
    }
  });

  // De-duplicate suggestions
  return Array.from(new Set(suggestions)).slice(0,6);
}

function showFullDayAdvisor(dayIdx) {
  const stored = loadPlan();
  if (!stored || !stored.plan) { alert('No saved plan. Generate and save a plan first.'); return; }
  const day = stored.plan[dayIdx];
  if (!day) { alert('Day not found.'); return; }

  const analysis = analyzeDayObject(day);
  const warnings = dietWarnings(day, analysis);
  const suggestions = suggestionListFromWarnings(warnings, day, analysis);

  // Build modal (create once)
  let advModal = document.getElementById('advisorModal');
  if (!advModal) {
    advModal = document.createElement('div');
    advModal.id = 'advisorModal';
    advModal.className = 'modal-back';
    advModal.style.display='none';
    advModal.innerHTML = `<div class="modal-card" id="advisorBox" style="max-width:760px"></div>`;
    document.body.appendChild(advModal);
    advModal.addEventListener('click', (e)=>{ if(e.target.id==='advisorModal') advModal.style.display='none'; });
  }

  const box = document.getElementById('advisorBox');
  // Color helpers
  const kcalDiff = analysis.totals.kcal - (day.meta.target || 0);
  const kcalColor = kcalDiff > 0 ? '#e74c3c' : kcalDiff < 0 ? '#3498db' : '#27ae60';

  // Macro percentages formatted
  const pPct = Math.round(analysis.macroPct.p * 100);
  const cPct = Math.round(analysis.macroPct.c * 100);
  const fPct = Math.round(analysis.macroPct.f * 100);

  // Build HTML
  let html = `<h3>Full-Day Advisor â€” Day ${day.day}${day.free? ' (FREE DAY)':''}</h3>`;
  html += `<div style="display:flex;gap:12px;align-items:center;margin-top:8px">`;
  html += `<div style="flex:1"><strong>Target</strong><div class="muted-small">${day.meta.target || 'â€”'} kcal</div></div>`;
  html += `<div style="flex:1"><strong>Total</strong><div class="muted-small">${analysis.totals.kcal} kcal</div></div>`;
  html += `<div style="flex:1"><strong>Diff</strong><div style="font-weight:700;color:${kcalColor}">${kcalDiff > 0 ? '+' : ''}${kcalDiff} kcal</div></div>`;
  html += `</div>`;

  html += `<div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">`;
  html += `<div class="card"><strong>Macros (g)</strong><div class="muted-small">P ${analysis.totals.protein}g â€¢ C ${analysis.totals.carbs}g â€¢ F ${analysis.totals.fat}g</div></div>`;
  html += `<div class="card"><strong>Macro %</strong><div class="muted-small">P ${pPct}% â€¢ C ${cPct}% â€¢ F ${fPct}%</div></div>`;
  html += `</div>`;

  // Warnings
  if (warnings.length) {
    html += `<div style="margin-top:12px"><strong style="color:#ff6b6b">Warnings</strong>`;
    html += `<ul class="muted-small" style="margin-top:8px">`;
    warnings.forEach(w => { html += `<li>${w.text}</li>`; });
    html += `</ul></div>`;
  } else {
    html += `<div style="margin-top:12px"><strong style="color:#27ae60">Good job</strong><div class="muted-small">This day looks balanced for the chosen diet.</div></div>`;
  }

  // Suggestions
  if (suggestions.length) {
    html += `<div style="margin-top:12px"><strong>Suggestions</strong><div style="margin-top:6px" class="muted-small"><ol>`;
    suggestions.forEach(s => { html += `<li>${s}</li>`; });
    html += `</ol></div></div>`;
  }

  // Quick action buttons: Auto-balance (will attempt simple change), Open Replace modal for top offenders
  html += `<div style="margin-top:14px;text-align:right">`;
  html += `<button id="advisorAutoBalance" class="btn">Auto-balance</button> `;
  html += `<button id="advisorClose" class="btn ghost">Close</button>`;
  html += `</div>`;

  box.innerHTML = html;
  advModal.style.display='flex';

  document.getElementById('advisorClose').onclick = ()=> { advModal.style.display='none'; };

  document.getElementById('advisorAutoBalance').onclick = async ()=> {
    // Simple auto-balance heuristic:
    // - If calories >> target: reduce grams of highest kcal-per-gram part
    // - If calories << target: increase grams of highest protein/kcal items
    const st = loadPlan();
    if(!st || !st.plan) return alert('No saved plan.');
    const plan = st.plan;
    const d = plan[dayIdx];

    // Build parts list across meals with pointer to meal key
    const allParts = [];
    ['breakfast','lunch','dinner','snack'].forEach(mk=>{
      (d[mk].parts || []).forEach((p,pi)=>{
        const kcalPer100 = p.source && (p.source.kcal_per_100g || p.source.kcal) || p.per100 || 100;
        const kcalPerG = (kcalPer100/100) || 1;
        allParts.push({ meal:mk, idx:pi, part:p, kcalPerG });
      });
    });

    if(allParts.length===0) return alert('No editable parts found in this day.');

    const diffKcal = analysis.totals.kcal - (d.meta.target || 0);

    if (diffKcal > 80) {
      // Reduce high kcal-per-gram parts by 10-20%
      allParts.sort((a,b)=>b.kcalPerG - a.kcalPerG);
      let remaining = diffKcal;
      for(let i=0;i<allParts.length && remaining>30;i++){
        const a = allParts[i];
        const reduceKcal = Math.min(Math.round(remaining * 0.6), Math.round(a.part.grams * a.kcalPerG * 0.4)); // don't reduce >40% of that part
        if(reduceKcal<=0) continue;
        const reduceGrams = Math.max(5, Math.round(reduceKcal / a.kcalPerG));
        a.part.grams = Math.max(10, a.part.grams - reduceGrams);
        remaining -= Math.round(reduceGrams * a.kcalPerG);
      }
    } else if (diffKcal < -80) {
      // Increase protein-dense parts modestly
      allParts.sort((a,b)=>{
        const pa = (a.part.source && (a.part.source.protein_per_100g || a.part.source.protein)) || 0;
        const pb = (b.part.source && (b.part.source.protein_per_100g || b.part.source.protein)) || 0;
        return pb - pa;
      });
      let remaining = Math.abs(diffKcal);
      for(let i=0;i<allParts.length && remaining>30;i++){
        const a = allParts[i];
        // increase up to 30% for protein items
        const addKcal = Math.min(Math.round(remaining * 0.5), Math.round(a.part.grams * (a.kcalPerG) * 0.35));
        if(addKcal<=0) continue;
        const addGrams = Math.max(5, Math.round(addKcal / a.kcalPerG));
        a.part.grams = a.part.grams + addGrams;
        remaining -= Math.round(addGrams * a.kcalPerG);
      }
    } else {
      alert('Day is already near target. No auto-balance needed.');
      return;
    }

    // Recalculate per-part nutrition
    ['breakfast','lunch','dinner','snack'].forEach(mk=>{
      (d[mk].parts || []).forEach(p=>{
        const foodItem = p.source || p;
        const ratio = p.grams / 100;
        p.kcal = Math.round((foodItem.kcal_per_100g || p.per100 || 100) * ratio);
        p.protein = Math.round((foodItem.protein_per_100g || foodItem.protein || 0) * ratio);
        p.carbs = Math.round((foodItem.carbs_per_100g || foodItem.carbs || 0) * ratio);
        p.fat = Math.round((foodItem.fat_per_100g || foodItem.fat || 0) * ratio);
      });
      d[mk].kcal = (d[mk].parts || []).reduce((s,x)=>s+(x.kcal||0),0);
    });

    savePlan(plan, st.startDate);
    renderPlan(plan, st.startDate);
    updateSavedInfo();
    advModal.style.display='none';
    alert('Auto-balance applied. Review the day and adjust manually if needed.');
  };
}

// Inject advisor buttons into each day card after renderPlan
function injectAdvisorButtons() {
  const mainInner = document.getElementById('mainInner');
  if(!mainInner) return;
  // Find day cards (they are .card direct children in mainInner)
  const cards = Array.from(mainInner.querySelectorAll(':scope > .card'));
  cards.forEach((card, idx) => {
    // Avoid duplicating the button
    if (card.querySelector('.btn-advisor')) return;
    // Find header area (first child)
    const header = card.querySelector('div');
    const btn = document.createElement('button');
    btn.className = 'btn ghost btn-advisor';
    btn.style.marginLeft = '8px';
    btn.innerText = 'Full-Day Advisor';
    btn.title = 'Open full-day nutrition advisor';
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); showFullDayAdvisor(idx); });
    // Append next to existing header controls (try to locate the right side)
    const headerRight = card.querySelector('div[style*="justify-content:space-between"]') || header;
    // if a header right exists as the first child of card, append to it:
    if (header && header.querySelector && header.querySelector('div')) {
      // Append to header's right container if found
      const rightContainers = header.querySelectorAll('div');
      if (rightContainers && rightContainers.length) {
        rightContainers[rightContainers.length-1].appendChild(btn);
        return;
      }
    }
    // fallback append at top of card
    card.insertBefore(btn, card.firstChild);
  });
}

// Hook to re-inject after render (renderPlan gets called whenever plan changes)
const originalRenderPlan = renderPlan;
renderPlan = function(plan, startDateISO) {
  originalRenderPlan(plan, startDateISO);
  // small delay to ensure DOM finished building
  setTimeout(() => injectAdvisorButtons(), 80);
};

// Also inject on initial load (if any)
setTimeout(()=> injectAdvisorButtons(), 200);

/* End of PART 19 */
</script>
<!-- PART 20: Hybrid Replacement System (A3) -->
<script>
/* ===========================
   Part 20 - Hybrid Replacement System (A3)
   Drop-in: overrides add/replace flows and adds delete for user-added parts
   Files expected under /assets/: food-keto.json, food-balanced.json, food-vegetarian.json, food-carnivore.json
   =========================== */

const DIET_FILES = {
  keto: "/assets/food-keto.json",
  balanced: "/assets/food-balanced.json",
  vegetarian: "/assets/food-vegetarian.json",
  carnivore: "/assets/food-carnivore.json"
};

const dietPoolCache = {}; // { diet: { loaded: bool, items: [...] } }

/* Safe JSON loader with caching */
async function loadDietPool(diet){
  if(!diet) return null;
  if(dietPoolCache[diet] && dietPoolCache[diet].loaded) return dietPoolCache[diet].items;
  const path = DIET_FILES[diet];
  if(!path) return null;
  try{
    const r = await fetch(path, {cache: "no-cache"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    dietPoolCache[diet] = { loaded: true, items: Array.isArray(j) ? j : (j.data || []) };
    return dietPoolCache[diet].items;
  }catch(e){
    console.warn("loadDietPool failed", e);
    dietPoolCache[diet] = { loaded: false, items: [] };
    return [];
  }
}

/* Get active diet from controls or saved plan meta */
function getActiveDiet(){
  const el = document.getElementById('dietSelect');
  if(el && el.value) return el.value;
  // fallback to saved plan meta if present
  const s = loadPlan();
  if(s && s.plan && s.plan[0] && s.plan[0].meta) return s.plan[0].meta.diet || 'balanced';
  return 'balanced';
}

/* Category helpers: derive pool categories that exist in diet pool */
function listCategoriesFromPool(pool){
  const set = new Set();
  pool.forEach(item=>{
    if(item.category) set.add(item.category);
    // also include tags as categories for flexibility
    (item.tags||[]).forEach(t=> set.add(t));
  });
  return Array.from(set);
}

/* Pick category for meal part: use part.type if present, else fallback to mealKey */
function categoryForMealPart(mealKey, part){
  if(part && part.type) return part.type;               // e.g. "protein", "vegetable", "fat"
  // infer from mealKey
  if(mealKey === 'breakfast') return 'breakfast';
  if(mealKey === 'lunch' || mealKey === 'dinner') return 'protein';
  if(mealKey === 'snack') return 'snack';
  return 'protein';
}

/* Scoring function for smart suggestions (hybrid) */
function scoreCandidate(currentPart, candidate, diet){
  // currentPart has per100, grams, kcal etc (may be "firstPart" when replacing)
  // candidate is an item from diet pool (name, kcal, protein, carbs, fat, category, tags)
  // diet influences scoring (e.g., keto prefers high fat, low carbs)
  const curKcal = Number(currentPart.per100 || currentPart.kcal || currentPart.kcal_per_100g || 0);
  const candKcal = Number(candidate.kcal || candidate.kcal_per_100g || candidate.kcal || 0);
  const curProtein = Number(currentPart.protein || currentPart.protein_per_100g || 0);
  const candProtein = Number(candidate.protein || candidate.protein_per_100g || 0);
  const curCarbs = Number(currentPart.carbs || currentPart.carbs_per_100g || 0);
  const candCarbs = Number(candidate.carbs || candidate.carbs_per_100g || 0);
  const curFat = Number(currentPart.fat || currentPart.fat_per_100g || 0);
  const candFat = Number(candidate.fat || candidate.fat_per_100g || 0);

  let score = 0;

  // 1) Same category / tags match
  if(currentPart.type && candidate.category && candidate.category.toLowerCase() === currentPart.type.toLowerCase()) score += 30;
  const curTags = (currentPart.tags||[]).map(t=>t.toLowerCase());
  const candTags = (candidate.tags||[]).map(t=>t.toLowerCase());
  if(curTags.some(t=>candTags.includes(t))) score += 10;

  // 2) Calories proximity preference (prefer similar kcal but can bias down if we are over)
  const kcalDiff = Math.abs(curKcal - candKcal);
  // smaller diff => higher score
  score += Math.max(0, 30 - Math.round(kcalDiff/5));

  // 3) Macro suitability by diet
  if(diet === 'keto'){
    // prefer high fat, low carb
    score += Math.round(candFat/5);
    score -= Math.round(candCarbs/2);
  } else if(diet === 'carnivore'){
    // prefer meat/fish and minimal carbs
    if((candidate.tags||[]).some(t=>['meat','fish','pork','beef','chicken','lamb','organ'].includes(t.toLowerCase()))) score += 25;
    score -= Math.round(candCarbs*1.5);
  } else if(diet === 'vegetarian'){
    // prefer plant, dairy, legumes
    if((candidate.tags||[]).some(t=>['plant','tofu','legume','grain','dairy'].includes(t.toLowerCase()))) score += 15;
  } else {
    // balanced
    score += Math.round(candProtein/2);
    score += Math.round((candKcal/100));
  }

  // 4) Penalize items with missing nutritional data
  if(!candKcal || isNaN(candKcal)) score -= 20;

  // 5) Small randomness to avoid identical lists each time
  score += Math.random() * 6;

  return score;
}

/* Create a DOM listing for candidates with onclick hook */
function buildCandidatesHTML(candidates, onSelectFn){
  if(!candidates || candidates.length === 0) return "<div class='muted-small'>No items available in this category.</div>";
  let html = '<div style="display:grid;gap:8px">';
  candidates.forEach(c=>{
    const kcal = c.kcal || c.kcal_per_100g || 0;
    const protein = c.protein || c.protein_per_100g || 0;
    const carbs = c.carbs || c.carbs_per_100g || 0;
    const fat = c.fat || c.fat_per_100g || 0;
    // escape name
    const name = (c.name||c.title||"").replace(/['"]/g,'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    html += `<div class="meal-list-item" style="cursor:pointer;padding:10px" data-name="${name}" data-kcal="${kcal}" data-protein="${protein}" data-carbs="${carbs}" data-fat="${fat}" onclick='(${onSelectFn.name})(\"${name}\",${kcal},${protein},${carbs},${fat})'>`;
    html += `<div style="font-weight:700">${name}</div>`;
    html += `<div class="muted-small">${kcal} kcal â€¢ P:${protein}g â€¢ C:${carbs}g â€¢ F:${fat}g per 100g</div>`;
    html += `</div>`;
  });
  html += '</div>';
  return html;
}

/* Smart suggestions generator: returns top N candidates for replacement/add */
async function getSmartReplacementSuggestions(currentPart, mealKey, diet, category, limit=12){
  // currentPart: object representing the part being replaced (may be undefined for add)
  const pool = await loadDietPool(diet) || [];
  if(!pool.length) return [];

  // Filter pool by category/tag match
  let candidates = pool.filter(item=>{
    // Map categories and tags lowercase
    const cat = (item.category||"").toLowerCase();
    const tags = (item.tags||[]).map(t=>t.toLowerCase());
    if(category){
      const cLower = category.toLowerCase();
      if(cat === cLower) return true;
      if(tags.includes(cLower)) return true;
      // allow near matches: if category is "protein" accept items with protein-like tags
      if(cLower === 'protein' && (tags.includes('protein')||['protein','meat','fish','dairy','eggs','plant','legume'].includes(cat))) return true;
    }
    // fallback: include items that have the mealKey tag (e.g., breakfast)
    if((item.tags||[]).map(t=>t.toLowerCase()).includes(mealKey)) return true;
    // else accept items in same category group
    return cat === (category||"");
  });

  // If no candidates, broaden search to whole pool
  if(candidates.length === 0) candidates = pool.slice();

  // Score and sort
  const scored = candidates.map(c => ({c, score: scoreCandidate(currentPart || {}, c, diet)}))
                           .sort((a,b)=>b.score - a.score)
                           .slice(0, limit)
                           .map(x=>x.c);

  return scored;
}

/* New modal builders: add / replace that use diet pools instead of USDA by default.
   They replace the old openAddItemModal and openReplaceModal functions. */

async function openAddItemModal_v2(dayIdx, mealKey){
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;

  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");
  const diet = getActiveDiet();
  const pool = await loadDietPool(diet);
  const categories = listCategoriesFromPool(pool);
  const defaultCategory = categoryForMealPart(mealKey, null) || (categories[0]||'protein');

  box.innerHTML = `
    <h3>Add Food Item to ${mealKey.charAt(0).toUpperCase() + mealKey.slice(1)} - Day ${dayIdx + 1}</h3>
    <div style="display:flex;gap:8px;margin:12px 0">
      <select id="addPoolCategory" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e6e6">
        ${categories.map(c=>`<option value="${c}">${c.charAt(0).toUpperCase()+c.slice(1)}</option>`).join('')}
      </select>
      <input type="text" id="addSearchInput" placeholder="Search within selected category..." style="flex:2;padding:8px;border-radius:8px;border:1px solid #e6e6e6">
    </div>
    <div id="addSuggestions" style="margin:8px 0"></div>
    <div style="margin-top:12px;text-align:right">
      <button id="addCancel" class="btn ghost">Cancel</button>
    </div>
  `;

  // initial suggestions
  async function refreshAddSuggestions(){
    const cat = document.getElementById('addPoolCategory').value;
    const query = document.getElementById('addSearchInput').value.trim().toLowerCase();
    // get smart suggestions (top 8)
    const smart = await getSmartReplacementSuggestions(null, mealKey, diet, cat, 8);
    let filtered = smart;
    if(query){
      filtered = smart.filter(i => (i.name||'').toLowerCase().includes(query));
    }
    const html = buildCandidatesHTML(filtered, applyAddToPlan);
    document.getElementById('addSuggestions').innerHTML = `<div style="margin-bottom:8px"><strong>Top suggestions</strong></div>${html}`;
  }

  document.getElementById('addPoolCategory').value = defaultCategory;
  document.getElementById('addSearchInput').addEventListener('input', debounce(refreshAddSuggestions, 200));
  document.getElementById('addPoolCategory').addEventListener('change', refreshAddSuggestions);

  document.getElementById('addCancel').onclick = ()=> modal.style.display = 'none';
  modal.style.display = 'flex';
  refreshAddSuggestions();
}

async function openReplaceModal_v2(dayIdx, mealKey){
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;

  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");
  const diet = getActiveDiet();
  const pool = await loadDietPool(diet);

  // find the current part to replace - prefer the first part
  const stored = loadPlan();
  const part = stored && stored.plan && stored.plan[dayIdx] && stored.plan[dayIdx][mealKey] && stored.plan[dayIdx][mealKey].parts ? stored.plan[dayIdx][mealKey].parts[0] : null;
  const inferredCategory = categoryForMealPart(mealKey, part) || 'protein';
  const partNameLabel = part ? (part.name || 'Current item') : 'Current item';

  box.innerHTML = `
    <h3>Replace ${partNameLabel} in ${mealKey.charAt(0).toUpperCase()+mealKey.slice(1)} - Day ${dayIdx + 1}</h3>
    <div style="display:flex;gap:8px;margin:12px 0">
      <select id="repPoolCategory" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e6e6"></select>
      <input type="text" id="repSearchInput" placeholder="Search suggestions..." style="flex:2;padding:8px;border-radius:8px;border:1px solid #e6e6e6">
    </div>
    <div id="repSuggestions" style="margin:8px 0"></div>
    <div style="margin-top:12px;text-align:right">
      <button id="repCancel" class="btn ghost">Cancel</button>
    </div>
  `;

  // populate category dropdown (ensure the inferredCategory exists)
  const categories = listCategoriesFromPool(pool);
  const select = document.getElementById('repPoolCategory');
  select.innerHTML = categories.map(c=>`<option value="${c}">${c.charAt(0).toUpperCase()+c.slice(1)}</option>`).join('');
  if(categories.includes(inferredCategory)) select.value = inferredCategory;

  async function refreshReplaceSuggestions(){
    const cat = document.getElementById('repPoolCategory').value;
    const query = document.getElementById('repSearchInput').value.trim().toLowerCase();
    const smart = await getSmartReplacementSuggestions(part || {}, mealKey, diet, cat, 12);
    let filtered = smart;
    if(query){
      filtered = smart.filter(i => (i.name || '').toLowerCase().includes(query));
    }
    const html = buildCandidatesHTML(filtered, applyReplacementToPlan);
    document.getElementById('repSuggestions').innerHTML = `<div style="margin-bottom:8px"><strong>Top replacement suggestions</strong></div>${html}`;
  }

  document.getElementById('repSearchInput').addEventListener('input', debounce(refreshReplaceSuggestions, 200));
  document.getElementById('repPoolCategory').addEventListener('change', refreshReplaceSuggestions);

  document.getElementById('repCancel').onclick = ()=> modal.style.display = 'none';
  modal.style.display = 'flex';
  refreshReplaceSuggestions();
}

/* Override the global functions used by renderPlan buttons */
window.openAddItemModal = openAddItemModal_v2;
window.openReplaceModal = openReplaceModal_v2;

/* ============================
   Apply functions (add/replace) updated to work with the diet pools
   and to provide delete functionality for added items.
   ============================ */

function applyAddToPlan(name, kcal_per_100g, protein_per_100g, carbs_per_100g, fat_per_100g){
  const stored = loadPlan();
  if(!stored || !stored.plan) return;
  const plan = stored.plan;
  const day = plan[currentDayForModal];
  if(!day || !day[currentMealForModal]) return;

  // default grams: 100 or use serving if provided
  const defaultGrams = 100;

  const newPart = {
    name,
    per100: Number(kcal_per_100g) || 0,
    grams: defaultGrams,
    type: "added",
    addedId: "added_" + Date.now() + "_" + Math.floor(Math.random()*1000),
    source: {
      name,
      kcal_per_100g: Number(kcal_per_100g) || 0,
      protein_per_100g: Number(protein_per_100g) || 0,
      carbs_per_100g: Number(carbs_per_100g) || 0,
      fat_per_100g: Number(fat_per_100g) || 0
    },
    kcal: Math.round((Number(kcal_per_100g) || 0) * (defaultGrams/100)),
    protein: Math.round((Number(protein_per_100g) || 0) * (defaultGrams/100)),
    carbs: Math.round((Number(carbs_per_100g) || 0) * (defaultGrams/100)),
    fat: Math.round((Number(fat_per_100g) || 0) * (defaultGrams/100))
  };

  if(!day[currentMealForModal].parts) day[currentMealForModal].parts = [];
  day[currentMealForModal].parts.push(newPart);

  // Update meal totals
  day[currentMealForModal].kcal = day[currentMealForModal].parts.reduce((s,p)=>s + (p.kcal || 0), 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  // Close modal
  document.getElementById("usdaPopup").style.display = 'none';
}

/* Replacement: replace first part while preserving grams where possible */
function applyReplacementToPlan(name, kcal_per_100g, protein_per_100g, carbs_per_100g, fat_per_100g){
  const stored = loadPlan();
  if(!stored || !stored.plan) return;
  const plan = stored.plan;
  const day = plan[currentDayForModal];
  if(!day || !day[currentMealForModal] || !day[currentMealForModal].parts || day[currentMealForModal].parts.length === 0) return;

  const firstPart = day[currentMealForModal].parts[0];

  // Preserve grams; if none, default 100
  const grams = Math.max(1, firstPart.grams || 100);
  // Update part
  firstPart.name = name;
  firstPart.per100 = Number(kcal_per_100g) || 0;
  firstPart.source = {
    name,
    kcal_per_100g: Number(kcal_per_100g) || 0,
    protein_per_100g: Number(protein_per_100g) || 0,
    carbs_per_100g: Number(carbs_per_100g) || 0,
    fat_per_100g: Number(fat_per_100g) || 0
  };

  const ratio = grams / 100;
  firstPart.grams = grams;
  firstPart.kcal = Math.round((Number(kcal_per_100g) || 0) * ratio);
  firstPart.protein = Math.round((Number(protein_per_100g) || 0) * ratio);
  firstPart.carbs = Math.round((Number(carbs_per_100g) || 0) * ratio);
  firstPart.fat = Math.round((Number(fat_per_100g) || 0) * ratio);

  // Update meal totals
  day[currentMealForModal].kcal = day[currentMealForModal].parts.reduce((s,p)=>s + (p.kcal || 0), 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  document.getElementById("usdaPopup").style.display = 'none';
}

/* Delete function for user-added parts */
function deleteAddedPart(dayIdx, mealKey, addedId){
  const stored = loadPlan();
  if(!stored || !stored.plan) return;
  const plan = stored.plan;
  const day = plan[dayIdx];
  if(!day || !day[mealKey] || !day[mealKey].parts) return;
  const idx = day[mealKey].parts.findIndex(p => p.addedId === addedId);
  if(idx === -1) return;
  day[mealKey].parts.splice(idx, 1);
  // Recalculate meal kcal
  day[mealKey].kcal = day[mealKey].parts.reduce((s,p)=>s+(p.kcal||0), 0);
  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();
}

/* Expose deleteAddedPart to global so buttons can call it */
window.deleteAddedPart = deleteAddedPart;

/* ============================
   Small enhancement: after renderPlan finishes, attach delete buttons to added parts
   (renderPlan creates DOM from parts but doesn't create delete buttons). We'll
   add delete buttons to any meal-list-item that corresponds to an added part,
   by matching name+grams+kcal+type+addedId when possible.
   ============================ */

const attachDeleteButtonsObserver = (function(){
  let running = false;
  return function attach(){
    if(running) return;
    running = true;
    // Wait a tick for DOM to be ready
    setTimeout(()=>{
      try{
        const stored = loadPlan();
        if(!stored || !stored.plan) { running=false; return; }
        // For each visible meal-list-item DOM node, try to infer addedId from its text and attach delete if part.type === 'added'
        // We will scan the plan and map parts to identify added ones and then find corresponding DOM nodes by text
        stored.plan.forEach((d, dayIdx)=>{
          ['breakfast','lunch','dinner','snack'].forEach(mealKey=>{
            const meal = d[mealKey];
            if(!meal || !meal.parts) return;
            meal.parts.forEach((p, pi)=>{
              if(p.type === 'added' && p.addedId){
                // find the button region in the DOM corresponding to this day / meal / part index
                // our renderPlan uses input.dataset.day = idx and dataset.meal = `${mealKey}--part--${pi}`
                const selector = `input[data-day="${dayIdx}"][data-meal="${mealKey}--part--${pi}"]`;
                const inp = document.querySelector(selector);
                if(inp){
                  const pDiv = inp.closest('.meal-list-item');
                  if(pDiv && !pDiv.querySelector('.added-delete-btn')){
                    const del = document.createElement('button');
                    del.className = 'btn ghost added-delete-btn';
                    del.style.marginLeft = '8px';
                    del.style.padding = '6px 8px';
                    del.innerText = 'Delete';
                    del.addEventListener('click', (e)=>{
                      e.stopPropagation();
                      if(!confirm("Remove this added item?")) return;
                      deleteAddedPart(dayIdx, mealKey, p.addedId);
                    });
                    // append to right side next to the input
                    const right = inp.parentElement;
                    right.appendChild(del);
                  }
                }
              }
            });
          });
        });
      }catch(e){
        console.warn('attachDeleteButtonsObserver error', e);
      } finally {
        running=false;
      }
    }, 120);
  };
})();

/* Hook rendering: when renderPlan is called it re-builds DOM. We'll monkey-patch renderPlan to call attachDeleteButtonsObserver after completion.
   Only patch once. */
(function patchRenderPlanHook(){
  if(window.__renderPlanPatched) return;
  const original = window.renderPlan;
  if(typeof original !== 'function') return;
  window.renderPlan = function(plan, startDateISO){
    const res = original(plan, startDateISO);
    // attach delete buttons shortly after DOM built
    attachDeleteButtonsObserver();
    return res;
  };
  window.__renderPlanPatched = true;
})();

/* Ensure initial attach when page already has plan rendered */
setTimeout(()=>{ attachDeleteButtonsObserver(); }, 300);

/* End of Part 20 */
</script>
