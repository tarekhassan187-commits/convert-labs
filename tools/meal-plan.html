<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>7-Day Meal Plan — Convert Labs</title>
  <link rel="icon" href="https://convertlabs.online/assets/convert-labs-icon.png" />
  <meta name="description" content="Personalized 7-day meal plans generated from your TDEE and USDA nutrition data." />

  <!-- Analytics / AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2490597435056272" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z88B03WV7P"></script>
  <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Z88B03WV7P'); </script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#0a4d8c; --muted:#6c6c6c; --bg:#f5faff; --card:#fff; --accent:#2b8bd8; --radius:12px;
    }
    body{ background:var(--bg); font-family:Inter,Arial,sans-serif; color:#111; margin:0; }
    .container{ max-width:1100px; margin:18px auto; padding:0 16px; }
    header{ background:#1e40af;color:#fff;padding:10px 0; }
    .nav{ width:90%; max-width:1100px;margin:auto;display:flex;justify-content:space-between;align-items:center; }
    .brand{display:flex;gap:10px;align-items:center}
    main.tool-page { margin-top:18px; }
    .card { background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:0 6px 18px rgba(12,40,80,0.04); }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
    .btn { background:var(--brand); color:#fff; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.ghost{ background:transparent; border:1px solid var(--brand); color:var(--brand); }
    .btn.secondary{ background:#666; }
    .layout { display:grid; grid-template-columns: 1fr 320px; gap:18px; align-items:start; }
    @media(max-width:980px){ .layout{ grid-template-columns:1fr; } }

    .day-card { margin-bottom:12px; border-radius:10px; padding:12px; position:relative; }
    .day-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .meals { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:10px; }
    .meal { background:#fbfdff; border-radius:10px; padding:10px; border:1px solid rgba(10,77,140,0.06); position:relative; }
    .meal b{ display:block; color:#083a65; margin-bottom:6px; }
    .muted-small{ color:var(--muted); font-size:13px; }
    .kcal{ font-weight:600; margin-top:8px; }

    .locked { filter: grayscale(80%) blur(2px) brightness(.85); pointer-events: none; }
    .lock-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:4; background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.7)); border-radius:10px; }
    .lock-badge { background: rgba(255,255,255,0.95); color:#222; border-radius:8px; padding:8px 10px; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,0.06); }

    .input-grams { width:90px; padding:6px 8px; border-radius:8px; border:1px solid #e6e6e6; margin-top:6px; }
    .day-summary { margin-top:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    /* modal */
    .modal-back { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:1200; padding:16px; }
    .modal-card { width:100%; max-width:980px; max-height:86vh; overflow:auto; background:#fff; border-radius:12px; padding:16px; }

    /* disclaimer */
    .disclaimer { margin-top:18px; padding:12px; background:#fff7f0; border-left:4px solid #f59e0b; border-radius:8px; color:#333; }

    /* pdf button */
    .export-btn { background:#10b981; border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <a href="https://convertlabs.online/" style="display:flex;align-items:center;text-decoration:none;color:#fff;">
          <img src="https://convertlabs.online/assets/convert-labs-icon.png" alt="logo" style="height:32px;margin-right:8px;">
          <strong>Convert Labs</strong>
        </a>
      </div>
      <nav>
        <a href="https://convertlabs.online/tools/tools.html" style="color:#fff;margin-right:12px;text-decoration:none;">Tools</a>
        <a href="https://convertlabs.online/guides.html" style="color:#fff;text-decoration:none;">Blog</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <main class="tool-page">
      <h1 style="text-align:center;margin-bottom:6px;">7-Day Meal Plan</h1>
      <p style="text-align:center;color:var(--muted);margin-top:0;margin-bottom:14px;">
        Personalized 7-day meal plan based on your TDEE. Only the current day is editable; other days unlock daily.
      </p>

      <!-- Controls -->
      <div class="card">
        <div class="controls">
          <div>
            <label style="font-weight:700;display:block;font-size:13px;">TDEE (target kcal)</label>
            <input id="tdeeInput" type="number" placeholder="e.g. 1670" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:140px;">
            <div style="font-size:13px;color:var(--muted);margin-top:6px;">(Passed from calorie-guide or enter here)</div>
          </div>

          <div>
            <label style="font-weight:700;display:block;font-size:13px;">Age</label>
            <input id="ageInput" type="number" min="1" max="120" placeholder="30" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:110px;">
          </div>

          <div>
            <label style="font-weight:700;display:block;font-size:13px;">Goal</label>
            <select id="goalSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;">
              <option value="maintain">Maintain</option>
              <option value="lose">Lose (-300 kcal)</option>
              <option value="gain">Gain (+300 kcal)</option>
            </select>
          </div>

          <div>
            <label style="font-weight:700;display:block;font-size:13px;">Diet</label>
            <select id="dietSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;">
              <option value="normal">No preference</option>
              <option value="keto">Keto</option>
              <option value="carnivore">Carnivore</option>
              <option value="vegetarian">Vegetarian</option>
            </select>
          </div>

          <div>
            <label style="font-weight:700;display:block;font-size:13px;">Protein</label>
            <select id="proteinSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;">
              <option value="any">Any</option>
              <option value="beef">Beef</option>
              <option value="chicken">Chicken</option>
              <option value="fish">Fish</option>
              <option value="plant">Plant</option>
            </select>
          </div>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
            <button id="generateBtn" class="btn">Generate Preview</button>
            <button id="acceptBtn" class="btn secondary">Accept & Save</button>
            <button id="overwriteBtn" class="btn ghost">Overwrite</button>
            <button id="deleteBtn" class="btn secondary" style="display:none;">Delete</button>
          </div>
        </div>
      </div>

      <!-- layout -->
      <div class="layout" style="margin-top:14px;">
        <!-- main -->
        <div>
          <div id="mainInner"></div>
        </div>

        <!-- side -->
        <aside>
          <div class="card">
            <strong>Manual USDA search</strong>
            <div style="margin-top:10px;">
              <input id="manualSearchInput" placeholder="Search food..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee;">
              <div style="text-align:right;margin-top:8px;">
                <button id="manualSearchBtn" class="btn">Search USDA</button>
              </div>
            </div>
            <div id="manualSearchResults" style="margin-top:10px;max-height:260px;overflow:auto;"></div>
          </div>

          <div class="card" style="margin-top:12px;">
            <strong>Saved plan</strong>
            <div id="savedInfo" style="margin-top:8px;color:var(--muted);">No saved plan.</div>
            <div style="margin-top:10px;">
              <button id="exportDayBtn" class="export-btn" style="width:100%;">Export Today's Plan (PDF)</button>
            </div>
          </div>
        </aside>
      </div>

      <!-- Disclaimer (bottom of page, above footer) -->
      <div id="pageDisclaimer" class="disclaimer" style="margin-top:18px;">
        <strong>Nutrition Disclaimer</strong><br>
        This meal plan is automatically generated using USDA public-domain nutrition data and general dietary heuristics. It is not personalized medical or dietitian advice. For individualized nutrition plans, please consult a licensed nutritionist or healthcare professional.
      </div>
    </main>
  </div>

  <!-- Modals -->
  <div id="previewModal" class="modal-back"><div class="modal-card" id="previewBox"></div></div>
  <div id="usdaPopup" class="modal-back"><div class="modal-card" id="usdaBox"></div></div>
  <div id="usdaAllModal" class="modal-back"><div class="modal-card" id="usdaAllBox"></div></div>

  <!-- Confetti canvas (kept if needed) -->
  <canvas id="confettiCanvas" style="display:none;position:fixed;inset:0;z-index:2000;pointer-events:none;"></canvas>

<script>
/* ===========================
   CONFIG & DATA PATHS
   =========================== */
const DATA_USDA = "/assets/usda_food_nutrition.json";
const DATA_FULL = "/assets/foods-full.json";
const DATA_LITE = "/assets/foods-lite.json";

/* ===========================
   Utilities & dataset loader
   =========================== */
let indexItems = []; // merged search index
let hasUsda=false, hasFull=false, hasLite=false;

async function safeFetchJSON(url){
  try {
    const r = await fetch(url, {cache:"no-cache"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    if(Array.isArray(j)) return j;
    // if object with array? try to find array inside
    return Array.isArray(j.data) ? j.data : null;
  } catch(e){
    console.warn("fetch failed", url, e && e.message);
    return null;
  }
}
async function loadUsda(){
  if(hasUsda) return true;
  const j = await safeFetchJSON(DATA_USDA);
  if(j){ indexItems = j.concat(indexItems); hasUsda=true; console.info("USDA loaded", j.length); return true; }
  return false;
}
async function loadFull(){
  if(hasFull) return true;
  const j = await safeFetchJSON(DATA_FULL);
  if(j){ indexItems = indexItems.concat(j); hasFull=true; console.info("FULL loaded", j.length); return true; }
  return false;
}
async function loadLite(){
  if(hasLite) return true;
  const j = await safeFetchJSON(DATA_LITE);
  if(j){ indexItems = indexItems.concat(j); hasLite=true; console.info("LITE loaded", j.length); return true; }
  return false;
}

// preload lite ASAP (small)
loadLite();

/* Normalization & scoring */
function normalize(s){ return (s||"").toString().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }
function scoreName(name, q){
  const n = normalize(name||"");
  if(!n) return 0;
  if(n === q) return 120;
  let s=0;
  if(n.startsWith(q)) s+=50;
  if(n.includes(q)) s+=30;
  const qwords = q.split(/\W+/).filter(Boolean);
  qwords.forEach(w => { if(n.includes(w)) s+=8; });
  s += Math.max(0, 6 - n.split(" ").length);
  return s;
}

/* Search functionality: USDA primary, then fallback */
async function searchNutrition(query){
  const q = normalize(query).trim();
  if(!q) return [];
  // ensure usda loaded first for choice A
  await loadUsda();
  let matches = indexItems
    .map(it => ({ it, name: it.name || it.food_name || it.description || "" }))
    .map(x => ({ it:x.it, score: scoreName(x.name, q), name: x.name }))
    .filter(x => x.score>0)
    .sort((a,b)=>b.score-a.score)
    .map(x => mapItem(x.it, x.score));
  if(matches.length) return matches;
  // try full
  await loadFull();
  matches = indexItems
    .map(it => ({ it, name: it.name || it.food_name || it.description || "" }))
    .map(x => ({ it:x.it, score: scoreName(x.name, q), name: x.name }))
    .filter(x => x.score>0)
    .sort((a,b)=>b.score-a.score)
    .map(x => mapItem(x.it, x.score));
  if(matches.length) return matches;
  // ensure lite (may already included)
  await loadLite();
  matches = indexItems
    .map(it => ({ it, name: it.name || it.food_name || it.description || "" }))
    .map(x => ({ it:x.it, score: scoreName(x.name, q), name: x.name }))
    .filter(x => x.score>0)
    .sort((a,b)=>b.score-a.score)
    .map(x => mapItem(x.it, x.score));
  return matches;
}

/* Map raw item to common structure
   We assume your USDA and full/lite use `kcal` field as kcal per 100g (confirmed by your sample).
*/
function mapItem(it, score=0){
  const name = it.name || it.food_name || it.description || "Unknown";
  // kcal per 100g if present
  let kcal = null;
  if(typeof it.kcal === "number") kcal = it.kcal;
  else if(typeof it.calories === "number") kcal = it.calories;
  else if(it.energy_kcal) kcal = Number(it.energy_kcal);
  // fallback: if serving size and serving kcal provided
  // not required in your samples but included for safety
  if((!kcal) && it.serving_size_g && (it.kcal_per_serving || it.calories_per_serving || it.serving_kcal)){
    const serveK = it.kcal_per_serving || it.calories_per_serving || it.serving_kcal;
    kcal = (Number(serveK) / Number(it.serving_size_g)) * 100;
  }
  // as last fallback, check nested nutrients
  // (not common in your files)
  if(!kcal && it.nutrients && Array.isArray(it.nutrients)){
    const e = it.nutrients.find(n=>/(energy|kcal|calorie)/i.test(n.name || n.nutrient || ""));
    if(e && e.value) kcal = Number(e.value);
  }
  return {
    id: it.id ?? it.fdc_id ?? null,
    name,
    kcal_per_100g: (typeof kcal === "number" && !isNaN(kcal)) ? Number(kcal) : null,
    protein: it.protein ?? it.protein_g ?? null,
    carbs: it.carbs ?? it.carbs_g ?? null,
    fat: it.fat ?? it.fat_g ?? null,
    serving: it.serving || it.serving_size || null,
    raw: it,
    _score: score
  };
}

/* ===========================
   Heuristic pools (fallback)
   =========================== */
const POOLS = {
  proteins: [
    {name:"Grilled beef steak", kcal_per_100g: 250, tags:["meat","beef"]},
    {name:"Grilled chicken breast", kcal_per_100g: 165, tags:["meat","chicken"]},
    {name:"Baked salmon", kcal_per_100g: 206, tags:["fish"]},
    {name:"Tuna salad", kcal_per_100g: 200, tags:["fish"]},
    {name:"Lentil stew", kcal_per_100g: 116, tags:["plant","legume"]},
    {name:"Tofu stir-fry", kcal_per_100g: 144, tags:["plant"]},
    {name:"Egg omelette", kcal_per_100g: 154, tags:["egg"]},
  ],
  sides: [
    {name:"Steamed vegetables", kcal_per_100g:30, tags:["veg"]},
    {name:"Mixed salad", kcal_per_100g:25, tags:["veg"]},
    {name:"Brown rice", kcal_per_100g:123, tags:["grain"]},
    {name:"Quinoa", kcal_per_100g:120, tags:["grain"]},
    {name:"Baked potato", kcal_per_100g:93, tags:["starch"]},
    {name:"Cauliflower rice", kcal_per_100g:25, tags:["veg"]},
    {name:"Avocado", kcal_per_100g:160, tags:["fat"]}
  ],
  breakfasts: [
    {name:"Oatmeal with banana & milk", kcal_per_100g:124, tags:["breakfast"]},
    {name:"Greek yogurt with honey", kcal_per_100g:95, tags:["dairy"]},
    {name:"Smoothie (banana + whey)", kcal_per_100g:60, tags:["smoothie"]},
    {name:"Boiled eggs & toast", kcal_per_100g:160, tags:["egg"]},
    {name:"Shakshuka (2 eggs)", kcal_per_100g:120, tags:["egg"]}
  ],
  snacks: [
    {name:"Handful of almonds", kcal_per_100g:579, tags:["nuts"]},
    {name:"Protein bar", kcal_per_100g:400, tags:["processed"]},
    {name:"Apple", kcal_per_100g:52, tags:["fruit"]},
    {name:"Greek yogurt", kcal_per_100g:95, tags:["dairy"]},
    {name:"Carrot sticks", kcal_per_100g:41, tags:["veg"]}
  ]
};

/* helpers for diet/protein filtering */
function allowedByDietTags(tags, diet){
  const t = (tags||[]).map(s=>s.toLowerCase());
  if(diet === "normal") return true;
  if(diet === "keto"){ const forbidden=["grain","highcarb","starch","fruit","legume","potato","bread","pasta","rice","sugar"]; return !t.some(x=>forbidden.includes(x)); }
  if(diet === "carnivore"){ const plant=["plant","veg","vegetarian","fruit","grain","legume","nuts","tofu"]; return !t.some(x=>plant.includes(x)); }
  if(diet === "vegetarian"){ const forbidden=["meat","beef","chicken","fish","animal"]; return !t.some(x=>forbidden.includes(x)); }
  return true;
}
function matchesProteinTags(tags, pref){
  const t=(tags||[]).map(s=>s.toLowerCase());
  if(!pref || pref==="any") return true;
  if(pref==="plant") return t.includes("plant")||t.includes("legume")||t.includes("tofu")||t.includes("nuts");
  if(pref==="beef") return t.includes("beef")||t.includes("meat");
  if(pref==="chicken") return t.includes("chicken")||t.includes("meat");
  if(pref==="fish") return t.includes("fish");
  return true;
}

/* age portion multiplier */
function ageCategory(age){ const a=Number(age)||30; if(a<=12) return "child"; if(a<=19) return "teen"; if(a<=59) return "adult"; return "senior"; }
function agePortionMultiplier(cat){ if(cat==="child") return 0.7; if(cat==="teen") return 1.05; if(cat==="senior") return 0.9; return 1.0; }

/* pick helper that tries to find a USDA match by name first */
async function pickFoodByName(prefName, fallbackPool, opts){
  // attempt to search USDA index for the prefName
  const results = await searchNutrition(prefName || "");
  if(results && results.length){
    // pick first allowed by diet/protein
    for(const r of results){
      const tags = []; // no tags in mapItem fallback; but we can match name for protein preference
      if(allowedByDietTags(tags, opts.diet) && matchesProteinTags(tags, opts.protein)) return r;
    }
    return results[0];
  }
  // fallback pool entry
  const poolCandidates = fallbackPool.filter(p => allowedByDietTags(p.tags || [], opts.diet) && matchesProteinTags(p.tags || [], opts.protein));
  if(poolCandidates.length) return mapItem({name: poolCandidates[Math.floor(Math.random()*poolCandidates.length)].name, kcal: poolCandidates[Math.floor(Math.random()*poolCandidates.length)].kcal_per_100g}, 0);
  // ultimate fallback: search entire index
  const idx = (indexItems.length ? mapItem(indexItems[Math.floor(Math.random()*indexItems.length)]) : null);
  return idx;
}

/* compute grams from kcal_per_100g and meal kcal target */
function gramsForTarget(kcalPer100g, mealKcal){
  if(!kcalPer100g || kcalPer100g <= 0) return Math.round(100 * (mealKcal/200)); // fallback: assume 200kcal/100g -> adjust
  const grams = (mealKcal / kcalPer100g) * 100;
  return Math.max(1, Math.round(grams)); // round to 1g (your choice A)
}

/* ===========================
   Plan generation (async)
   =========================== */
// percentages (confirmed A)
const DEFAULT_SPLITS = { breakfast:0.25, lunch:0.35, dinner:0.30, snack:0.10 };
const DIET_SPLITS = {
  keto: { breakfast:0.22, lunch:0.36, dinner:0.32, snack:0.10 },
  carnivore: { breakfast:0.24, lunch:0.36, dinner:0.32, snack:0.08 },
  vegetarian: { breakfast:0.26, lunch:0.33, dinner:0.31, snack:0.10 }
};

async function generatePlanAsync(opts){
  // opts: { tdee, age, diet, protein, goal }
  // ensure usda loaded (we rely on usda)
  await loadUsda();
  await loadFull(); await loadLite();

  const tdee = Math.max(1000, Number(opts.tdee) || 2000);
  const age = Number(opts.age) || 30;
  const diet = opts.diet || "normal";
  const protein = opts.protein || "any";
  const mult = agePortionMultiplier(ageCategory(age));
  const splits = DIET_SPLITS[diet] || DEFAULT_SPLITS;
  const plan = [];

  for(let day=1; day<=7; day++){
    // target kcals per meal
    const bK = Math.round(tdee * splits.breakfast);
    const lK = Math.round(tdee * splits.lunch);
    const dK = Math.round(tdee * splits.dinner);
    const sK = Math.round(tdee * splits.snack);

    // pick items (prefer USDA search by name or pool)
    // For variety, pick random pool fallback items and try to find matching usda items
    const breakfastChoice = (await pickFoodByName(null, POOLS.breakfasts, {diet,protein})) || mapItem({name:"Breakfast item", kcal:120});
    const lunchProt = (await pickFoodByName(null, POOLS.proteins, {diet,protein})) || mapItem({name:"Protein", kcal:200});
    const sideItem = (await pickFoodByName(null, POOLS.sides, {diet,protein})) || mapItem({name:"Side", kcal:80});
    const dinnerProt = (await pickFoodByName(null, POOLS.proteins, {diet,protein})) || lunchProt;
    const snack = (await pickFoodByName(null, POOLS.snacks, {diet,protein})) || mapItem({name:"Snack", kcal:100});

    // compute grams and kcal from kcal_per_100g
    const bf_kcal_per100 = breakfastChoice.kcal_per_100g || breakfastChoice.kcal_per_100 || breakfastChoice.kcal || null;
    const lunch_p_kcal_per100 = lunchProt.kcal_per_100g || lunchProt.kcal_per_100 || lunchProt.kcal || null;
    const side_kcal_per100 = sideItem.kcal_per_100g || sideItem.kcal || null;
    const dinner_p_kcal_per100 = dinnerProt.kcal_per_100g || dinnerProt.kcal || null;
    const snack_kcal_per100 = snack.kcal_per_100g || snack.kcal || null;

    // fallback if null use pool values or generic 150 kcal/100
    const bfGram = gramsForTarget(bf_kcal_per100 || 120, bK);
    const lfGram = gramsForTarget(lunch_p_kcal_per100 || 180, lK * 0.65); // protein itself not whole lunch, allocate 65% to protein, rest to side
    const sideGram = gramsForTarget(side_kcal_per100 || 120, Math.round(lK * 0.35));
    const dinnerProtGram = gramsForTarget(dinner_p_kcal_per100 || 180, dK * 0.65);
    const dinnerSideGram = gramsForTarget(side_kcal_per100 || 120, Math.round(dK * 0.35));
    const snackGram = gramsForTarget(snack_kcal_per100 || 100, sK);

    // compute real kcal from chosen per100g values
    const bfCalories = Math.round((bf_kcal_per100 || 120) * (bfGram/100));
    const lunchProtCalories = Math.round((lunch_p_kcal_per100 || 180) * (lfGram/100));
    const lunchSideCalories = Math.round((side_kcal_per100 || 120) * (sideGram/100));
    const dinnerProtCalories = Math.round((dinner_p_kcal_per100 || 180) * (dinnerProtGram/100));
    const dinnerSideCalories = Math.round((side_kcal_per100 || 120) * (dinnerSideGram/100));
    const snackCalories = Math.round((snack_kcal_per100 || 100) * (snackGram/100));

    const lunchTotal = lunchProtCalories + lunchSideCalories;
    const dinnerTotal = dinnerProtCalories + dinnerSideCalories;

    plan.push({
      day,
      breakfast: { text: breakfastChoice.name, kcal_per_100g: bf_kcal_per100, grams: bfGram, kcal: bfCalories, source: breakfastChoice.raw || null },
      lunch: { text: lunchProt.name + " + " + sideItem.name, parts: [
        { type:"protein", name: lunchProt.name, kcal_per_100g: lunch_p_kcal_per100, grams: lfGram, kcal: lunchProtCalories, source: lunchProt.raw || null },
        { type:"side", name: sideItem.name, kcal_per_100g: side_kcal_per100, grams: sideGram, kcal: lunchSideCalories, source: sideItem.raw || null }
      ], kcal: lunchTotal },
      dinner: { text: dinnerProt.name + " + " + sideItem.name, parts:[
        { type:"protein", name: dinnerProt.name, kcal_per_100g: dinner_p_kcal_per100, grams: dinnerProtGram, kcal: dinnerProtCalories, source: dinnerProt.raw || null },
        { type:"side", name: sideItem.name, kcal_per_100g: side_kcal_per100, grams: dinnerSideGram, kcal: dinnerSideCalories, source: sideItem.raw || null }
      ], kcal: dinnerTotal },
      snack: { text: snack.name, kcal_per_100g: snack_kcal_per100, grams: snackGram, kcal: snackCalories, source: snack.raw || null },
      meta: { tdee, age, diet, protein, splits, portionMultiplier: mult }
    });
  }
  return plan;
}

/* ===========================
   Storage and rendering + interactions
   =========================== */
const KEY = "convertlabs_mealplan_v2";

function savePlan(plan, startDateISO){ localStorage.setItem(KEY, JSON.stringify({ plan, startDate:startDateISO || new Date().toISOString() })); }
function loadPlan(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){return null;} }
function deletePlan(){ localStorage.removeItem(KEY); localStorage.removeItem(KEY+"_track"); }

function applyUrlParamsToForm(){
  const p = new URLSearchParams(window.location.search);
  const tdee = p.get("tdee"); const age = p.get("age"); const goal = p.get("goal"); const diet = p.get("diet"); const protein = p.get("protein");
  if(tdee) document.getElementById("tdeeInput").value = tdee;
  if(age) document.getElementById("ageInput").value = age;
  if(goal) document.getElementById("goalSelect").value = goal;
  if(diet) document.getElementById("dietSelect").value = diet;
  if(protein) document.getElementById("proteinSelect").value = protein;
}

// Render plan with interactive grams input for unlocked day
function renderPlan(plan, startDateISO){
  const container = document.getElementById("mainInner");
  container.innerHTML = "";
  const startDate = startDateISO ? new Date(startDateISO) : null;
  const now = new Date();
  let unlocked = 0;
  if(startDate){
    const days = Math.floor((Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) - Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()))/86400000);
    unlocked = Math.max(0, Math.min(6, days));
  } else unlocked = 0;

  plan.forEach((d, idx) => {
    const card = document.createElement("div"); card.className = "day-card card";
    const isLocked = idx > unlocked;
    const header = document.createElement("div"); header.className="day-header";
    header.innerHTML = `<div><strong>Day ${d.day}</strong></div><div class="muted-small">${isLocked ? "Locked" : "Unlocked (You can edit portions)"}</div>`;
    card.appendChild(header);

    const mealsWrap = document.createElement("div"); mealsWrap.className = "meals";

    // Breakfast (single)
    const b = document.createElement("div"); b.className="meal";
    b.innerHTML = `<b>Breakfast</b><div class="meal-name">${escapeHtml(d.breakfast.text)}</div>
      <div class="muted-small">Per 100g: ${d.breakfast.kcal_per_100g ? d.breakfast.kcal_per_100g + ' kcal' : '—' }</div>
      <div style="margin-top:6px;">Weight: <input class="input-grams" type="number" value="${d.breakfast.grams}" data-day="${idx}" data-meal="breakfast"></div>
      <div class="kcal">~ <span class="kcal-val">${d.breakfast.kcal}</span> kcal</div>`;
    if(isLocked){ b.classList.add("locked"); }
    else {
      // attach event listener for grams input
      b.querySelector('.input-grams').addEventListener('input', onGramChange);
      b.addEventListener('click', ()=> openUsdaPopup(idx, 'breakfast', d.breakfast.text));
    }
    mealsWrap.appendChild(b);

    // Lunch (two parts)
    const l = document.createElement("div"); l.className = "meal";
    let lunchInner = `<b>Lunch</b><div class="meal-name">${escapeHtml(d.lunch.parts[0].name)} + ${escapeHtml(d.lunch.parts[1].name)}</div>`;
    lunchInner += `<div class="muted-small">Protein per 100g: ${d.lunch.parts[0].kcal_per_100g ? d.lunch.parts[0].kcal_per_100g + ' kcal' : '—' } &nbsp; Side per 100g: ${d.lunch.parts[1].kcal_per_100g ? d.lunch.parts[1].kcal_per_100g + ' kcal' : '—' }</div>`;
    lunchInner += `<div style="margin-top:6px;">Protein weight: <input class="input-grams" type="number" value="${d.lunch.parts[0].grams}" data-day="${idx}" data-meal="lunch-protein"></div>`;
    lunchInner += `<div style="margin-top:6px;">Side weight: <input class="input-grams" type="number" value="${d.lunch.parts[1].grams}" data-day="${idx}" data-meal="lunch-side"></div>`;
    lunchInner += `<div class="kcal">~ <span class="kcal-val">${d.lunch.kcal}</span> kcal</div>`;
    l.innerHTML = lunchInner;
    if(isLocked){ l.classList.add("locked"); }
    else {
      l.querySelectorAll('.input-grams').forEach(inp => inp.addEventListener('input', onGramChange));
      l.addEventListener('click', (e)=>{
        // avoid triggering search when clicking input
        if(e.target.tagName.toLowerCase() === 'input') return;
        openUsdaPopup(idx, 'lunch', d.lunch.text);
      });
    }
    mealsWrap.appendChild(l);

    // Dinner
    const di = document.createElement("div"); di.className="meal";
    let dinnerInner = `<b>Dinner</b><div class="meal-name">${escapeHtml(d.dinner.parts[0].name)} + ${escapeHtml(d.dinner.parts[1].name)}</div>`;
    dinnerInner += `<div class="muted-small">Protein per 100g: ${d.dinner.parts[0].kcal_per_100g ? d.dinner.parts[0].kcal_per_100g + ' kcal' : '—' } &nbsp; Side per 100g: ${d.dinner.parts[1].kcal_per_100g ? d.dinner.parts[1].kcal_per_100g + ' kcal' : '—' }</div>`;
    dinnerInner += `<div style="margin-top:6px;">Protein weight: <input class="input-grams" type="number" value="${d.dinner.parts[0].grams}" data-day="${idx}" data-meal="dinner-protein"></div>`;
    dinnerInner += `<div style="margin-top:6px;">Side weight: <input class="input-grams" type="number" value="${d.dinner.parts[1].grams}" data-day="${idx}" data-meal="dinner-side"></div>`;
    dinnerInner += `<div class="kcal">~ <span class="kcal-val">${d.dinner.kcal}</span> kcal</div>`;
    di.innerHTML = dinnerInner;
    if(isLocked){ di.classList.add("locked"); }
    else {
      di.querySelectorAll('.input-grams').forEach(inp => inp.addEventListener('input', onGramChange));
      di.addEventListener('click', (e)=> { if(e.target.tagName.toLowerCase() === 'input') return; openUsdaPopup(idx, 'dinner', d.dinner.text); });
    }
    mealsWrap.appendChild(di);

    // Snack
    const s = document.createElement("div"); s.className="meal";
    s.innerHTML = `<b>Snack</b><div class="meal-name">${escapeHtml(d.snack.text)}</div>
      <div class="muted-small">Per 100g: ${d.snack.kcal_per_100g ? d.snack.kcal_per_100g + ' kcal' : '—' }</div>
      <div style="margin-top:6px;">Weight: <input class="input-grams" type="number" value="${d.snack.grams}" data-day="${idx}" data-meal="snack"></div>
      <div class="kcal">~ <span class="kcal-val">${d.snack.kcal}</span> kcal</div>`;
    if(isLocked){ s.classList.add("locked"); }
    else {
      s.querySelector('.input-grams').addEventListener('input', onGramChange);
      s.addEventListener('click', ()=> openUsdaPopup(idx, 'snack', d.snack.text));
    }
    mealsWrap.appendChild(s);

    card.appendChild(mealsWrap);

    // day summary (only for unlocked day show totals)
    const summary = document.createElement("div"); summary.className = "day-summary";
    const totalKcal = (d.breakfast.kcal) + (d.lunch.kcal) + (d.dinner.kcal) + (d.snack.kcal);
    summary.innerHTML = `<div class="muted-small">Total for day: <strong class="day-total">${totalKcal}</strong> kcal</div>
      <div class="muted-small">Target (TDEE): <strong class="day-target">${d.meta.tdee}</strong> kcal</div>
      <div class="muted-small">Difference: <strong class="day-diff">${totalKcal - d.meta.tdee}</strong> kcal</div>`;
    card.appendChild(summary);

    // if locked overlay
    if(isLocked){
      const overlay = document.createElement("div"); overlay.className = "lock-overlay";
      const unlockDate = startDate ? new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()) + (idx*86400000)) : null;
      const badgeText = unlockDate ? `Unlocks: ${unlockDate.toLocaleDateString()}` : `Locked`;
      overlay.innerHTML = `<div class="lock-badge">${badgeText}</div>`;
      card.appendChild(overlay);
    }

    container.appendChild(card);
  });
}

// handle grams input change
function onGramChange(e){
  e.stopPropagation();
  const input = e.target;
  const dayIdx = Number(input.dataset.day);
  const mealKey = input.dataset.meal; // breakfast, lunch-protein, lunch-side, dinner-protein, dinner-side, snack
  // load stored plan
  const stored = loadPlan();
  if(!stored || !stored.plan) return;
  const plan = stored.plan;
  const p = plan[dayIdx];
  if(!p) return;

  const v = Math.max(1, Math.round(Number(input.value) || 0)); // ensure >=1
  if(mealKey === "breakfast"){
    p.breakfast.grams = v;
    const per100 = p.breakfast.kcal_per_100g || p.breakfast.kcal || 120;
    p.breakfast.kcal = Math.round((per100) * (v/100));
  } else if(mealKey === "snack"){
    p.snack.grams = v;
    const per100 = p.snack.kcal_per_100g || p.snack.kcal || 100;
    p.snack.kcal = Math.round((per100) * (v/100));
  } else if(mealKey === "lunch-protein"){
    p.lunch.parts[0].grams = v;
    const per100 = p.lunch.parts[0].kcal_per_100g || p.lunch.parts[0].kcal || 150;
    p.lunch.parts[0].kcal = Math.round(per100 * (v/100));
    p.lunch.kcal = p.lunch.parts[0].kcal + p.lunch.parts[1].kcal;
  } else if(mealKey === "lunch-side"){
    p.lunch.parts[1].grams = v;
    const per100 = p.lunch.parts[1].kcal_per_100g || p.lunch.parts[1].kcal || 100;
    p.lunch.parts[1].kcal = Math.round(per100 * (v/100));
    p.lunch.kcal = p.lunch.parts[0].kcal + p.lunch.parts[1].kcal;
  } else if(mealKey === "dinner-protein"){
    p.dinner.parts[0].grams = v;
    const per100 = p.dinner.parts[0].kcal_per_100g || p.dinner.parts[0].kcal || 150;
    p.dinner.parts[0].kcal = Math.round(per100 * (v/100));
    p.dinner.kcal = p.dinner.parts[0].kcal + p.dinner.parts[1].kcal;
  } else if(mealKey === "dinner-side"){
    p.dinner.parts[1].grams = v;
    const per100 = p.dinner.parts[1].kcal_per_100g || p.dinner.parts[1].kcal || 100;
    p.dinner.parts[1].kcal = Math.round(per100 * (v/100));
    p.dinner.kcal = p.dinner.parts[0].kcal + p.dinner.parts[1].kcal;
  }

  // save and re-render
  savePlan(plan, loadPlan().startDate);
  renderPlan(plan, loadPlan().startDate);
}

/* ===========================
   USDA Popup + Show all + Replace
   =========================== */
let currentEditing = { dayIndex: null, field: null, partIndex: null }; // field: breakfast|lunch|dinner|snack

async function openUsdaPopup(dayIndex, field, currentText){
  currentEditing = { dayIndex, field };
  const popup = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");
  box.innerHTML = `
    <h3>Search USDA — Replace ${escapeHtml(field)}</h3>
    <div style="margin-top:8px;"><input id="popupSearchInput" value="${escapeHtml(currentText)}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;"></div>
    <div style="margin-top:8px;text-align:right;"><button id="popupSearchBtn" class="btn">Search</button></div>
    <div id="popupResults" style="margin-top:12px;max-height:420px;overflow:auto;"></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
      <button id="popupShowAll" class="btn ghost">Show all results</button>
      <button id="popupClose" class="btn secondary">Close</button>
    </div>
  `;
  popup.style.display = "flex";
  document.getElementById("popupClose").onclick = ()=> { popup.style.display = "none"; currentEditing = {dayIndex:null,field:null}; };
  document.getElementById("popupSearchBtn").onclick = async ()=>{
    const q = document.getElementById("popupSearchInput").value.trim();
    const resBox = document.getElementById("popupResults");
    resBox.innerHTML = "Searching...";
    const results = await searchNutrition(q);
    renderUsdaResultList(results, resBox, true);
  };
  document.getElementById("popupShowAll").onclick = async ()=>{
    const q = document.getElementById("popupSearchInput").value.trim();
    const results = await searchNutrition(q);
    openUsdaAllModal(results, q);
  };
  // initial search
  const initRes = await searchNutrition(currentText);
  renderUsdaResultList(initRes, document.getElementById("popupResults"), true);
}

function renderUsdaResultList(results, containerEl, allowChoose){
  containerEl.innerHTML = "";
  if(!results || !results.length){ containerEl.innerHTML = "<div class='muted-small'>No matches.</div>"; return; }
  results.slice(0,12).forEach(it=>{
    const div = document.createElement("div"); div.style.padding="10px"; div.style.borderBottom="1px solid #eee"; div.style.cursor="pointer";
    const kcalText = it.kcal_per_100g ? `${it.kcal_per_100g} kcal/100g` : "kcal unknown";
    div.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong></div><div class="muted-small">${kcalText}</div>`;
    if(allowChoose){
      div.onclick = ()=> {
        applyReplacementToPlan(currentEditing.dayIndex, currentEditing.field, it);
        document.getElementById("usdaPopup").style.display = "none";
      };
    }
    containerEl.appendChild(div);
  });
  if(results.length > 12){
    const more = document.createElement("div"); more.style.textAlign="center"; more.style.padding="10px";
    more.innerHTML = `<button class="btn ghost" id="moreBtn">Show all ${results.length} results</button>`;
    containerEl.appendChild(more);
    more.querySelector("#moreBtn").onclick = ()=> openUsdaAllModal(results, "");
  }
}

function openUsdaAllModal(results, q){
  const modal = document.getElementById("usdaAllModal");
  const box = document.getElementById("usdaAllBox");
  let html = `<h3>All results for "${escapeHtml(q)}"</h3><div style="max-height:60vh;overflow:auto;margin-top:10px;">`;
  if(!results || !results.length) html += `<div class="muted-small">No results</div>`;
  else results.forEach(it => { const kcalText = it.kcal_per_100g ? `${it.kcal_per_100g} kcal/100g` : "kcal unknown"; html += `<div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;" data-name="${escapeHtml(it.name)}"><strong>${escapeHtml(it.name)}</strong><div class="muted-small">${kcalText}</div></div>`; });
  html += `</div><div style="text-align:right;margin-top:12px;"><button id="closeAll" class="btn secondary">Close</button></div>`;
  box.innerHTML = html; modal.style.display = "flex";
  box.querySelectorAll('div[style]').forEach(div => {
    const txt = div.getAttribute('data-name');
    if(!txt) return;
    div.addEventListener('click', ()=> {
      // find object by name
      const matched = results.find(r => r.name === txt);
      if(matched) { applyReplacementToPlan(currentEditing.dayIndex, currentEditing.field, matched); modal.style.display = "none"; document.getElementById("usdaPopup").style.display = "none"; }
    });
  });
  document.getElementById("closeAll").onclick = ()=> modal.style.display = "none";
}

// apply replacement: replace the relevant meal or part and recalc grams to match meal target
function applyReplacementToPlan(dayIndex, field, usdaItem){
  const stored = loadPlan();
  if(!stored || !stored.plan) { alert("No saved plan. Accept a plan first."); return; }
  const plan = stored.plan;
  const p = plan[dayIndex];
  if(!p) return;

  // get kcal per100g from usdaItem
  const per100 = usdaItem.kcal_per_100g || usdaItem.kcal_per_100 || usdaItem.kcal || null;
  const tdee = p.meta.tdee;

  // compute meal target based on splits in meta
  const splits = p.meta.splits || DEFAULT_SPLITS;
  let mealTarget = 0;
  if(field === "breakfast") mealTarget = Math.round(tdee * splits.breakfast);
  else if(field === "lunch") mealTarget = Math.round(tdee * splits.lunch);
  else if(field === "dinner") mealTarget = Math.round(tdee * splits.dinner);
  else if(field === "snack") mealTarget = Math.round(tdee * splits.snack);

  if(field === "breakfast"){
    const grams = gramsForTarget(per100 || 120, mealTarget);
    p.breakfast = { text: usdaItem.name, kcal_per_100g: per100, grams, kcal: Math.round((per100||120)*(grams/100)), source: usdaItem.raw || null };
  } else if(field === "snack"){
    const grams = gramsForTarget(per100 || 100, mealTarget);
    p.snack = { text: usdaItem.name, kcal_per_100g: per100, grams, kcal: Math.round((per100||100)*(grams/100)), source: usdaItem.raw || null };
  } else if(field === "lunch"){
    // replace protein with usdaItem and keep existing side but recalc grams
    const side = p.lunch.parts[1];
    const sidePer100 = side.kcal_per_100g || side.kcal || 100;
    // allocate meal target -> 65% protein, 35% side
    const protTarget = Math.round(mealTarget * 0.65);
    const sideTarget = Math.round(mealTarget * 0.35);
    const protGrams = gramsForTarget(per100 || 180, protTarget);
    const sideGrams = gramsForTarget(sidePer100 || 120, sideTarget);
    p.lunch.parts[0] = { type:"protein", name: usdaItem.name, kcal_per_100g: per100, grams: protGrams, kcal: Math.round((per100||180)*(protGrams/100)), source: usdaItem.raw || null };
    p.lunch.parts[1] = { type:"side", name: side.name, kcal_per_100g: sidePer100, grams: sideGrams, kcal: Math.round((sidePer100||120)*(sideGrams/100)), source: side.source || null };
    p.lunch.kcal = p.lunch.parts[0].kcal + p.lunch.parts[1].kcal;
    p.lunch.text = p.lunch.parts[0].name + " + " + p.lunch.parts[1].name;
  } else if(field === "dinner"){
    // same as lunch
    const side = p.dinner.parts[1];
    const sidePer100 = side.kcal_per_100g || side.kcal || 100;
    const protTarget = Math.round(mealTarget * 0.65);
    const sideTarget = Math.round(mealTarget * 0.35);
    const protGrams = gramsForTarget(per100 || 180, protTarget);
    const sideGrams = gramsForTarget(sidePer100 || 120, sideTarget);
    p.dinner.parts[0] = { type:"protein", name: usdaItem.name, kcal_per_100g: per100, grams: protGrams, kcal: Math.round((per100||180)*(protGrams/100)), source: usdaItem.raw || null };
    p.dinner.parts[1] = { type:"side", name: side.name, kcal_per_100g: sidePer100, grams: sideGrams, kcal: Math.round((sidePer100||120)*(sideGrams/100)), source: side.source || null };
    p.dinner.kcal = p.dinner.parts[0].kcal + p.dinner.parts[1].kcal;
    p.dinner.text = p.dinner.parts[0].name + " + " + p.dinner.parts[1].name;
  }

  // save and re-render
  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();
  alert("Meal updated and portion weights recalculated.");
}

/* ===========================
   PDF Export for Current Day (jsPDF)
   =========================== */
async function exportCurrentDayToPDF(){
  // find unlocked day index
  const stored = loadPlan();
  if(!stored || !stored.plan){ alert("No saved plan to export."); return; }
  const startDate = new Date(stored.startDate);
  const now = new Date();
  const days = Math.floor((Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) - Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()))/86400000);
  const unlocked = Math.max(0, Math.min(6, days));
  const dayObj = stored.plan[unlocked];
  if(!dayObj){ alert("No plan for today."); return; }

  // compose PDF content
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  const margin = 40; let y = 50;
  doc.setFontSize(14); doc.text("Convert Labs — Daily Meal Plan", margin, y); y+=20;
  doc.setFontSize(11); doc.text(`Date: ${new Date().toLocaleString()}`, margin, y); y+=18;
  doc.setFontSize(12); doc.text(`Target (TDEE): ${dayObj.meta.tdee} kcal`, margin, y); y+=18;
  doc.setFontSize(12); doc.text(`Day ${dayObj.day}`, margin, y); y+=18;
  doc.setFontSize(11);

  // breakfast
  doc.setFont(undefined,"bold"); doc.text("Breakfast:", margin, y); doc.setFont(undefined,"normal");
  doc.text(`${dayObj.breakfast.text} — ${dayObj.breakfast.grams} g — ${dayObj.breakfast.kcal} kcal`, margin+10, y+16); y+=34;
  // lunch parts
  doc.setFont(undefined,"bold"); doc.text("Lunch:", margin, y); doc.setFont(undefined,"normal");
  dayObj.lunch.parts.forEach(p => { doc.text(`${p.name} — ${p.grams} g — ${p.kcal} kcal`, margin+10, y+16); y+=18; });
  y+=6;
  // dinner
  doc.setFont(undefined,"bold"); doc.text("Dinner:", margin, y); doc.setFont(undefined,"normal");
  dayObj.dinner.parts.forEach(p => { doc.text(`${p.name} — ${p.grams} g — ${p.kcal} kcal`, margin+10, y+16); y+=18; });
  y+=6;
  // snack
  doc.setFont(undefined,"bold"); doc.text("Snack:", margin, y); doc.setFont(undefined,"normal");
  doc.text(`${dayObj.snack.text} — ${dayObj.snack.grams} g — ${dayObj.snack.kcal} kcal`, margin+10, y+16); y+=30;

  const total = dayObj.breakfast.kcal + dayObj.lunch.kcal + dayObj.dinner.kcal + dayObj.snack.kcal;
  doc.setFont(undefined,"bold"); doc.text(`Total kcal: ${total}`, margin, y); y+=18;
  const diff = total - dayObj.meta.tdee;
  doc.setFont(undefined,"normal"); doc.text(`Difference vs TDEE: ${diff} kcal`, margin, y); y+=18;

  // disclaimer
  doc.setFontSize(9);
  doc.text("Generated by Convert Labs. This plan uses USDA public data and heuristics; not a substitute for professional advice.", margin, y);

  const filename = `convertlabs-mealplan-day${dayObj.day}-${(new Date()).toISOString().slice(0,10)}.pdf`;
  doc.save(filename);
}

/* ===========================
   Save / Load / UI wiring
   =========================== */
document.getElementById("generateBtn").addEventListener("click", async ()=>{
  const opts = { tdee: Number(document.getElementById("tdeeInput").value) || null, age: Number(document.getElementById("ageInput").value) || 30, goal: document.getElementById("goalSelect").value || "maintain", diet: document.getElementById("dietSelect").value || "normal", protein: document.getElementById("proteinSelect").value || "any" };
  if(!opts.tdee){ alert("Enter TDEE first."); return; }
  const plan = await generatePlanAsync(opts);
  // show preview modal
  const modal = document.getElementById("previewModal"); const box = document.getElementById("previewBox");
  let html = `<h3>Preview — 7-day plan</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:10px;">`;
  plan.forEach(d=>{
    html += `<div style="background:#fff;padding:8px;border-radius:8px;border:1px solid #eee;">
      <div style="font-weight:700">Day ${d.day}</div>
      <div style="margin-top:6px;"><strong>Breakfast</strong><div class="muted-small">${d.breakfast.grams} g — ${d.breakfast.kcal} kcal</div></div>
      <div style="margin-top:6px;"><strong>Lunch</strong><div class="muted-small">${d.lunch.parts[0].grams} g + ${d.lunch.parts[1].grams} g — ${d.lunch.kcal} kcal</div></div>
      <div style="margin-top:6px;"><strong>Dinner</strong><div class="muted-small">${d.dinner.parts[0].grams} g + ${d.dinner.parts[1].grams} g — ${d.dinner.kcal} kcal</div></div>
      <div style="margin-top:6px;"><strong>Snack</strong><div class="muted-small">${d.snack.grams} g — ${d.snack.kcal} kcal</div></div>
    </div>`;
  });
  html += `</div><div style="margin-top:12px;text-align:right;"><button id="previewAccept" class="btn">Accept & Save</button> <button id="previewClose" class="btn ghost">Close</button></div>`;
  box.innerHTML = html; modal.style.display = "flex";
  document.getElementById("previewClose").onclick = ()=> modal.style.display = "none";
  document.getElementById("previewAccept").onclick = ()=> {
    savePlan(plan, new Date().toISOString());
    modal.style.display = "none";
    renderPlan(plan, loadPlan().startDate);
    updateSavedInfo();
    alert("Plan accepted and saved.");
  };
});

document.getElementById("acceptBtn").addEventListener("click", async ()=>{
  const t = Number(document.getElementById("tdeeInput").value) || null;
  if(!t){ alert("Enter TDEE first."); return; }
  const opts = { tdee: t, age: Number(document.getElementById("ageInput").value) || 30, goal: document.getElementById("goalSelect").value || "maintain", diet: document.getElementById("dietSelect").value || "normal", protein: document.getElementById("proteinSelect").value || "any" };
  const plan = await generatePlanAsync(opts);
  savePlan(plan, new Date().toISOString());
  renderPlan(plan, loadPlan().startDate);
  updateSavedInfo();
  alert("Plan generated and saved.");
});

document.getElementById("overwriteBtn").addEventListener("click", ()=> {
  if(!confirm("Overwrite existing saved plan?")) return;
  document.getElementById("acceptBtn").click();
});
document.getElementById("deleteBtn").addEventListener("click", ()=> {
  if(!confirm("Delete saved plan?")) return;
  deletePlan();
  document.getElementById("mainInner").innerHTML = "";
  updateSavedInfo();
  alert("Deleted.");
});

document.getElementById("manualSearchBtn").addEventListener("click", async ()=>{
  const q = document.getElementById("manualSearchInput").value.trim();
  const box = document.getElementById("manualSearchResults"); box.innerHTML = "Searching...";
  const res = await searchNutrition(q);
  box.innerHTML = "";
  if(!res || !res.length){ box.innerHTML = "<div class='muted-small'>No results</div>"; return; }
  res.slice(0,30).forEach(it=>{
    const d = document.createElement("div"); d.style.padding="8px"; d.style.borderBottom="1px solid #eee";
    d.innerHTML = `<strong>${escapeHtml(it.name)}</strong><div class="muted-small">${it.kcal_per_100g ? it.kcal_per_100g + " kcal/100g" : ""}</div>`;
    box.appendChild(d);
  });
});

/* Export PDF button */
document.getElementById("exportDayBtn").addEventListener("click", exportCurrentDayToPDF);

/* apply url params on load */
applyUrlParamsToForm();

/* initial saved plan load */
const stored = loadPlan();
if(stored && stored.plan){ renderPlan(stored.plan, stored.startDate); updateSavedInfo(); } else {
  document.getElementById("mainInner").innerHTML = `<div class="card" style="text-align:center;padding:28px;color:var(--muted);">No saved plan. Generate a preview or accept a plan to start the unlock schedule.</div>`;
}

/* update saved info UI */
function updateSavedInfo(){
  const s = loadPlan();
  const box = document.getElementById("savedInfo");
  if(!s){ box.innerHTML = "No saved plan."; document.getElementById("deleteBtn").style.display = "none"; return; }
  document.getElementById("deleteBtn").style.display = "";
  const sd = new Date(s.startDate);
  box.innerHTML = `Saved: <strong>${sd.toLocaleString()}</strong><div class="muted-small">Plan unlocks one day every 24 hours from this date.</div>`;
}

/* modal close on background click */
document.getElementById("previewModal").addEventListener("click", (e)=>{ if(e.target.id==="previewModal") document.getElementById("previewModal").style.display = "none"; });
document.getElementById("usdaPopup").addEventListener("click", (e)=>{ if(e.target.id==="usdaPopup") document.getElementById("usdaPopup").style.display = "none"; });
document.getElementById("usdaAllModal").addEventListener("click", (e)=>{ if(e.target.id==="usdaAllModal") document.getElementById("usdaAllModal").style.display = "none"; });

/* helper */
function escapeHtml(s){ return (s||"").toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

</script>
</body>
</html>
