<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>7-Day Meal Plan â€” Convert Labs</title>

  <!-- Meta -->
  <meta name="description" content="Personalized 7-day meal plan generated from your TDEE. One day unlocks every 24 hours." />
  <link rel="icon" href="https://convertlabs.online/assets/convert-labs-icon.png" />
  <meta name="theme-color" content="#1e40af" />

  <!-- Site CSS (ConvertLabs) -->
  <link rel="stylesheet" href="https://convertlabs.online/style.css" />

  <!-- Analytics + Ads (copied from your tools.html) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2490597435056272" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z88B03WV7P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Z88B03WV7P');
  </script>

  <!-- Small local styles to integrate the tool visually with ConvertLabs -->
  <style>
    :root{
      --brand:#0a4d8c;
      --muted:#6c6c6c;
      --bg:#f5faff;
      --card:#ffffff;
      --accent:#2b8bd8;
      --radius:12px;
    }
    body{ background:var(--bg); font-family: Inter, Arial, sans-serif; color:#111; margin:0; padding:0; }
    main.tool-page { max-width:1100px; margin: 1.2rem auto; padding: 0 1rem; }
    .page-controls { display:flex; gap:10px; align-items:center; margin:18px 0; flex-wrap:wrap; }
    .btn { background:var(--brand); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#666; }
    .btn.ghost { background:transparent; border:1px solid var(--brand); color:var(--brand); }
    .layout { display:grid; grid-template-columns: 1fr 360px; gap:20px; align-items:start; }
    @media(max-width:980px){ .layout{ grid-template-columns:1fr; } #side{ position:static; height:auto; } }

    /* Card */
    .card { background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:0 6px 18px rgba(12,40,80,0.04); }

    /* Day card & meals */
    .day-card { padding:14px; border-radius:10px; margin-bottom:14px; position:relative; }
    .day-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .meals { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .meal { flex:1 1 220px; min-width:180px; background:#fbfdff; border-radius:10px; padding:10px; cursor:pointer; border:1px solid rgba(10,77,140,0.06); transition: transform .12s, box-shadow .12s; }
    .meal:hover{ transform: translateY(-4px); box-shadow:0 8px 22px rgba(10,77,140,0.06); }
    .meal b{ color:#083a65; display:block; margin-bottom:6px; }
    .kcal { color:var(--muted); font-size:13px; margin-top:6px; }

    /* Locked style (option B: blurred / dimmed) */
    .locked { filter: grayscale(80%) blur(2px) brightness(.85); pointer-events: none; position:relative; }
    .lock-overlay {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:4;
      background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.7));
      border-radius:10px; pointer-events:none;
    }
    .lock-badge {
      background: rgba(255,255,255,0.95); color:#222; border-radius:8px; padding:8px 10px; font-weight:700;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    /* tracking */
    .tracking-row { display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .small-input { width:110px; padding:8px; border-radius:8px; border:1px solid #e6e6e6; font-size:14px; }
    .progress { height:12px; background:#eee; border-radius:8px; overflow:hidden; flex:1 1 200px; }
    .progress > i { display:block; height:100%; width:0%; background: linear-gradient(90deg,var(--brand),var(--accent)); }

    /* preview & usda popup */
    #previewModal, #usdaPopup { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index:500; padding:20px; }
    #previewBox, #usdaBox { width:100%; max-width:980px; max-height:86vh; overflow:auto; background:var(--card); border-radius:12px; padding:18px; }
    .muted-small { color:#666; font-size:13px; }

    /* form controls row */
    .form-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    select, input[type="number"], input[type="text"] { padding:8px 10px; border-radius:8px; border:1px solid #e6e6e6; font-size:14px; }

    /* small helpers */
    .hint { color:var(--muted); font-size:13px; margin-top:8px; }
  </style>
</head>
<body>

  <!-- ---------------------------
       Header (copied from your tools.html)
       --------------------------- -->
  <header class="navbar" style="background:#1e40af;color:#fff;padding:10px 0;">
    <div class="nav-container" style="width:90%;max-width:1100px;margin:auto;display:flex;justify-content:space-between;align-items:center;">
      <div class="logo">
        <a href="https://convertlabs.online/" aria-label="Convert Labs Home" style="color:#fff;text-decoration:none;display:flex;align-items:center;gap:8px;">
          <img src="https://convertlabs.online/assets/convert-labs-icon.png" alt="Convert Labs logo" style="height:32px;" loading="lazy">
          <span style="font-weight:600;">Convert Labs</span>
        </a>
      </div>
      <nav class="nav-links">
        <ul style="list-style:none;display:flex;gap:1rem;margin:0;padding:0;">
          <li><a href="https://convertlabs.online/" style="color:#fff;text-decoration:none;">Home</a></li>
          <li><a href="https://convertlabs.online/tools/tools.html" class="active" style="color:#fff;text-decoration:none;opacity:0.9;">Tools</a></li>
          <li><a href="https://convertlabs.online/guides.html" style="color:#fff;text-decoration:none;">Blog</a></li>
          <li><a href="https://convertlabs.online/about.html" style="color:#fff;text-decoration:none;">About</a></li>
          <li><a href="https://convertlabs.online/contact.html" style="color:#fff;text-decoration:none;">Contact</a></li>
        </ul>
      </nav>
      <button id="themeToggle" class="theme-toggle" title="Switch Theme" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;">ðŸŒ™</button>
    </div>
  </header>

  <!-- ======================
       Main content (part 1)
       ====================== -->
  <main class="tool-page" style="text-align:left;">
    <h1 style="text-align:center;margin-top:18px;">7-Day Meal Plan</h1>
    <p style="text-align:center;max-width:800px;margin:8px auto;color:var(--muted);">
      Personalized meal plans generated from your TDEE. Only the current day is interactive â€” other days are visible but blurred and locked.
    </p>

    <!-- Controls: TDEE / Age / Goal / Diet / Protein -->
    <div style="max-width:1100px;margin:12px auto;">
      <div class="card" style="padding:12px;">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <!-- TDEE display (reads from URL or fallback) -->
          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Target Calories (TDEE)</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="tdeeInput" type="number" placeholder="e.g. 2000" style="width:140px;padding:8px;border-radius:8px;border:1px solid #e6e6e6;">
              <button id="applyTdeeBtn" class="btn">Apply</button>
            </div>
            <div class="hint">TDEE can be passed from <code>/tools/calorie-guide.html</code> or entered here.</div>
          </div>

          <!-- Age -->
          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Age</label>
            <input id="ageInput" type="number" min="1" max="120" placeholder="e.g. 29" style="width:100px;padding:8px;border-radius:8px;border:1px solid #e6e6e6;">
            <div class="hint">Age adjusts portion sizes and macros.</div>
          </div>

          <!-- Goal -->
          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Goal</label>
            <select id="goalSelect" style="width:160px;">
              <option value="maintain">Maintain weight</option>
              <option value="lose">Lose weight (-300 kcal)</option>
              <option value="gain">Gain weight (+300 kcal)</option>
            </select>
          </div>

          <!-- Diet style (user chooses before generation) -->
          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Diet style</label>
            <select id="dietSelect" style="width:160px;">
              <option value="normal">No preference</option>
              <option value="keto">Keto</option>
              <option value="carnivore">Carnivore</option>
              <option value="vegetarian">Vegetarian</option>
            </select>
            <div class="hint">Keto / Carnivore / Vegetarian rules will be applied when generating meals.</div>
          </div>

          <!-- Protein preference -->
          <div>
            <label style="display:block;font-weight:700;font-size:13px;">Protein preference</label>
            <select id="proteinSelect" style="width:160px;">
              <option value="any">Any</option>
              <option value="beef">Beef</option>
              <option value="chicken">Chicken</option>
              <option value="fish">Fish</option>
              <option value="plant">Plant-based</option>
            </select>
            <div class="hint">This filters lunch/dinner protein sources.</div>
          </div>

        </div>

        <!-- Actions -->
        <div class="form-row" style="margin-top:14px;">
          <button id="generateBtn" class="btn">Generate Preview</button>
          <button id="acceptBtn" class="btn secondary">Accept & Save Plan</button>
          <button id="overwriteBtn" class="btn ghost">Overwrite Saved Plan</button>
          <button id="deleteBtn" class="btn secondary" style="display:none;">Delete Saved Plan</button>

          <div style="margin-left:auto;display:flex;gap:12px;align-items:center;">
            <div class="muted-small">TDEE final: <strong id="tdeeText">2000</strong> kcal</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main layout placeholder (Part 2 & Part 3 will fill the logic and render inside #mainInner) -->
    <div class="layout" style="max-width:1100px;margin:0 auto;">
      <main id="main">
        <div id="mainInner"></div>
      </main>

      <aside id="side">
        <div class="card">
          <strong>Manual USDA search</strong>
          <div style="margin-top:10px;">
            <input id="manualSearchInput" placeholder="Search food name..." style="width:100%; padding:8px; border-radius:8px; border:1px solid #eee;">
            <div style="margin-top:8px; text-align:right;">
              <button id="manualSearchBtn" class="btn">Search USDA</button>
            </div>
          </div>
          <div id="manualSearchResults" style="margin-top:10px;"></div>
        </div>

        <div class="card" style="margin-top:12px;">
          <strong>Saved plan info</strong>
          <div id="savedInfo" style="margin-top:10px;" class="muted-small">No saved plan yet.</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <strong>Hints</strong>
          <p class="muted-small" style="margin-top:8px;">
            - Click any unlocked meal to view USDA matches and choose a replacement.<br>
            - Replacing a meal updates the plan and saves it automatically.<br>
            - Only the current day is interactive; locked days show unlock date.
          </p>
        </div>
      </aside>
    </div>

  </main>

  <!-- PREVIEW & USDA POPUP placeholders (scripts in Part 3 will attach behavior) -->
  <div id="previewModal"><div id="previewBox"></div></div>
  <div id="usdaPopup"><div id="usdaBox"></div></div>

  <!-- =========================
       PART 2/3 goes here (dataset loader + diet food lists + generator)
       DO NOT paste PART 3 before PART 2.
       ========================= -->
<script>
/************************************************************************
 Part 2/3
 - Multi-dataset nutrition loader (fast â†’ full â†’ USDA)
 - Diet & protein food lists (templates) and generator that respects:
   - diet style (normal/keto/carnivore/vegetarian)
   - protein preference (any/beef/chicken/fish/plant)
   - age groups (child/teen/adult/senior)
   - goal adjustment (maintain/lose/gain applied to TDEE)
 - Exposes:
   - window.searchNutrition(query) -> Promise<[matches]>
   - window.generatePlan(options) -> 7-day plan array
************************************************************************/

/* ---------------------------
   CONFIG: dataset paths
   --------------------------- */
const DATA_LITE = "/assets/foods-lite.json";
const DATA_FULL = "/assets/foods-full.json";
const DATA_BIG  = "/assets/usda_food_nutrition.json";

/* ---------------------------
   Nutrition loader (progressive)
   --------------------------- */
let nutritionIndex = { items: [], hasLite:false, hasFull:false, hasBig:false };

async function safeFetchJSON(url) {
  try {
    const res = await fetch(url, { cache: "no-cache" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    if (!Array.isArray(json)) throw new Error("Not an array");
    return json;
  } catch (err) {
    console.warn("safeFetchJSON failed", url, err && err.message);
    return null;
  }
}

// load lite dataset immediately (fast)
(async function loadLite(){
  const lite = await safeFetchJSON(DATA_LITE);
  if (lite && lite.length) {
    nutritionIndex.items = lite.slice();
    nutritionIndex.hasLite = true;
    console.info("Nutrition: loaded lite", lite.length);
  } else {
    console.info("Nutrition: lite not found or empty");
  }
})();

async function loadFullIfNeeded() {
  if (nutritionIndex.hasFull) return true;
  const full = await safeFetchJSON(DATA_FULL);
  if (full && full.length) {
    nutritionIndex.items = nutritionIndex.items.concat(full);
    nutritionIndex.hasFull = true;
    console.info("Nutrition: loaded full", full.length);
    return true;
  }
  return false;
}

async function loadBigIfNeeded() {
  if (nutritionIndex.hasBig) return true;
  const big = await safeFetchJSON(DATA_BIG);
  if (big && big.length) {
    nutritionIndex.items = nutritionIndex.items.concat(big);
    nutritionIndex.hasBig = true;
    console.info("Nutrition: loaded big USDA", big.length);
    return true;
  }
  return false;
}

function normalizeText(s){ return (s||"").toString().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }

function scoreMatch(name, q) {
  const n = normalizeText(name||"");
  if (!n) return 0;
  if (n === q) return 120;
  let score = 0;
  if (n.startsWith(q)) score += 50;
  if (n.includes(q)) score += 30;
  const words = q.split(/\W+/).filter(Boolean);
  words.forEach(w => { if (n.includes(w)) score += 8; });
  score += Math.max(0, 6 - n.split(" ").length);
  return score;
}

/**
 * searchNutrition(query) -> returns array of matches (sorted by score)
 * Progressive fallback: search current index -> load full -> load big
 */
async function searchNutrition(query) {
  const q = normalizeText(query).trim();
  if (!q) return [];

  function searchIndex() {
    return nutritionIndex.items
      .map(it => {
        const name = it.name ?? it.food_name ?? it.description ?? "";
        return { it, score: scoreMatch(name, q), name };
      })
      .filter(x => x.score > 0)
      .sort((a,b) => b.score - a.score)
      .map(x => {
        const it = x.it;
        return {
          id: it.id ?? it.fdc_id ?? it.code ?? null,
          name: it.name ?? it.food_name ?? it.description ?? "Unknown",
          serving: it.serving || it.serving_size || it.serving_description || "",
          kcal: it.kcal ?? it.calories ?? it.energy_kcal ?? it.energy ?? null,
          protein_g: it.protein_g ?? it.protein ?? it.prot ?? null,
          carbs_g: it.carbs_g ?? it.carbohydrate ?? it.carb ?? it.carbs ?? null,
          fat_g: it.fat_g ?? it.fat ?? null,
          raw: it,
          _score: x.score
        };
      });
  }

  // 1) try current index (likely lite)
  let matches = searchIndex();
  if (matches.length) return matches;

  // 2) load full and retry
  const okFull = await loadFullIfNeeded();
  if (okFull) {
    matches = searchIndex();
    if (matches.length) return matches;
  }

  // 3) load big and retry
  const okBig = await loadBigIfNeeded();
  if (okBig) {
    matches = searchIndex();
    if (matches.length) return matches;
  }

  return [];
}
window.searchNutrition = searchNutrition;

/* ---------------------------
   Diet & protein food pools
   - We'll create sensible lists / templates to select from.
   - These are fallback templates; USDA replacements will be offered.
   --------------------------- */

/*
  Note:
  - Each pool item is { name, tags: [...], kcalEst }
  - tags help enforce diet rules and protein preference
*/

const POOLS = {
  // generic protein items
  proteins: [
    { name: "Grilled beef steak", tags:["meat","beef","animal"], kcalEst: 350 },
    { name: "Grilled chicken breast", tags:["meat","chicken","animal"], kcalEst: 240 },
    { name: "Baked salmon", tags:["fish","animal"], kcalEst: 280 },
    { name: "Tuna salad", tags:["fish","animal"], kcalEst: 260 },
    { name: "Lentil stew", tags:["plant","legume","vegetarian"], kcalEst: 320 },
    { name: "Tofu stir-fry", tags:["plant","vegetarian"], kcalEst: 290 },
    { name: "Egg omelette", tags:["egg","animal"], kcalEst: 220 },
    { name: "Beef mince with veg", tags:["meat","beef","animal"], kcalEst: 360 },
    { name: "Chicken kebab", tags:["meat","chicken","animal"], kcalEst: 250 },
    { name: "Grilled fish fillet", tags:["fish","animal"], kcalEst: 240 }
  ],
  // carbs / sides
  sides: [
    { name: "Steamed vegetables", tags:["veg","plant","lowcarb"], kcalEst: 60 },
    { name: "Mixed salad", tags:["veg","plant","lowcarb"], kcalEst: 80 },
    { name: "Brown rice", tags:["grain","highcarb"], kcalEst: 210 },
    { name: "Quinoa", tags:["grain","highcarb","plant"], kcalEst: 200 },
    { name: "Baked potato", tags:["starch","highcarb"], kcalEst: 160 },
    { name: "Cauliflower rice", tags:["lowcarb","veg"], kcalEst: 25 },
    { name: "Avocado", tags:["fat","lowcarb"], kcalEst: 160 }
  ],
  // breakfasts/snacks
  breakfasts: [
    { name: "Oatmeal with banana & milk", tags:["grain","highcarb","vegetarian"], kcalEst: 320 },
    { name: "Greek yogurt with honey", tags:["dairy","vegetarian"], kcalEst: 220 },
    { name: "Smoothie (banana + whey)", tags:["highcarb","animal"], kcalEst: 300 },
    { name: "Boiled eggs & toast", tags:["egg","grain"], kcalEst: 310 },
    { name: "Shakshuka (2 eggs)", tags:["egg","veg"], kcalEst: 270 }
  ],
  snacks: [
    { name: "Handful of almonds", tags:["nuts","plant","lowcarb"], kcalEst: 170 },
    { name: "Protein bar", tags:["processed","any"], kcalEst: 210 },
    { name: "Apple", tags:["fruit","plant","highcarb"], kcalEst: 95 },
    { name: "Greek yogurt", tags:["dairy","vegetarian"], kcalEst: 120 },
    { name: "Carrot sticks", tags:["veg","plant"], kcalEst: 45 }
  ]
};

/* ---------------------------
  Diet rule helpers
  - Check whether an item is allowed for a diet
  --------------------------- */
function allowedByDiet(itemTags, diet) {
  // normalize
  const tags = (itemTags||[]).map(t=>t.toLowerCase());
  if (diet === "normal") return true;
  if (diet === "keto") {
    // allow animal, fish, eggs, dairy, lowcarb veg, nuts, avocado
    // disallow tags: grain, highcarb, starch, fruit, legume
    const forbidden = ["grain","highcarb","starch","fruit","legume","potato","bread","pasta","rice","sugar"];
    if (tags.some(t => forbidden.includes(t))) return false;
    return true;
  }
  if (diet === "carnivore") {
    // allow only animal tags (meat, beef, chicken, fish, egg, dairy)
    const allow = ["meat","beef","chicken","fish","animal","egg","dairy"];
    // item allowed if it contains at least one allowed and does NOT contain plant indicators
    const plant = ["plant","veg","vegetarian","fruit","grain","legume","nuts","seed","tofu"];
    if (tags.some(t=>plant.includes(t))) return false;
    return tags.some(t=>allow.includes(t));
  }
  if (diet === "vegetarian") {
    // disallow meat, beef, chicken, fish
    const forbidden = ["meat","beef","chicken","fish","animal"];
    if (tags.some(t=>forbidden.includes(t))) return false;
    return true;
  }
  return true;
}

/* ---------------------------
   Protein filter helper
   --------------------------- */
function matchesProtein(tags, proteinPref) {
  const t = (tags||[]).map(x=>x.toLowerCase());
  if (!proteinPref || proteinPref === "any") return true;
  if (proteinPref === "plant") return t.includes("plant") || t.includes("legume") || t.includes("tofu") || t.includes("nuts");
  if (proteinPref === "beef") return t.includes("beef") || t.includes("meat");
  if (proteinPref === "chicken") return t.includes("chicken") || t.includes("meat");
  if (proteinPref === "fish") return t.includes("fish") || t.includes("tuna") || t.includes("salmon");
  return true;
}

/* ---------------------------
   Age category helper
   --------------------------- */
function ageCategory(age) {
  if (!age) return "adult";
  const a = Number(age);
  if (a <= 12) return "child";
  if (a <= 19) return "teen";
  if (a <= 59) return "adult";
  return "senior";
}

/* ---------------------------
   Macro/portion adjustments by age
   - Returns multiplier for kcal portions
   --------------------------- */
function agePortionMultiplier(cat) {
  // child smaller portions (0.7-0.9), teen more (1.0-1.05), adult 1.0, senior slightly smaller (0.9)
  if (cat === "child") return 0.7;
  if (cat === "teen") return 1.05;
  if (cat === "senior") return 0.9;
  return 1.0;
}

/* ---------------------------
   Meal selection utilities
   - pickFromPool(pool, filters)
   --------------------------- */
function pickFromPool(pool, { diet, protein }) {
  // pool: array of items with tags
  // filter by diet and protein preference
  const candidates = pool.filter(it => allowedByDiet(it.tags, diet) && matchesProtein(it.tags, protein));
  if (!candidates || candidates.length === 0) return null;
  return candidates[Math.floor(Math.random()*candidates.length)];
}

/* ---------------------------
   generatePlan(options)
   options:
     - tdee (number)
     - age
     - goal ('maintain'|'lose'|'gain')
     - diet ('normal'|'keto'|'carnivore'|'vegetarian')
     - protein ('any'|'beef'|'chicken'|'fish'|'plant')
   returns: array of 7 day objects:
     { day, breakfast: {text,kcal,isCustom:false}, lunch: {...}, dinner: {...}, snack: {...} }
   --------------------------- */
function generatePlan(opts) {
  const tdee = Math.max(1200, Number(opts.tdee) || 2000);
  const goal = opts.goal || "maintain";
  const age = Number(opts.age) || 30;
  const diet = opts.diet || "normal";
  const protein = opts.protein || "any";

  // adjust for goal
  let finalTdee = tdee;
  if (goal === "lose") finalTdee = Math.max(1000, tdee - 300);
  if (goal === "gain") finalTdee = tdee + 300;

  // age portion multiplier
  const mult = agePortionMultiplier(ageCategory(age));

  // calorie split baseline
  // adjust macros slightly by diet: keto -> higher fat, carnivore -> high protein, vegetarian -> moderate carbs
  let breakfastPct = 0.25, lunchPct = 0.35, dinnerPct = 0.30, snackPct = 0.10;

  if (diet === "keto") {
    // keep calories but favor fat-heavy meals: we won't change percentages drastically here
    breakfastPct = 0.22; lunchPct = 0.36; dinnerPct = 0.32; snackPct = 0.10;
  } else if (diet === "carnivore") {
    breakfastPct = 0.24; lunchPct = 0.36; dinnerPct = 0.32; snackPct = 0.08;
  } else if (diet === "vegetarian") {
    breakfastPct = 0.26; lunchPct = 0.33; dinnerPct = 0.31; snackPct = 0.10;
  }

  // build plan
  const plan = [];
  for (let day = 1; day <= 7; day++) {
    // pick breakfast
    // For breakfast: prioritize breakfasts pool, then defaults
    let breakfastItem = pickFromPool(POOLS.breakfasts, { diet, protein }) || POOLS.breakfasts[Math.floor(Math.random()*POOLS.breakfasts.length)];
    let lunchProtein = pickFromPool(POOLS.proteins, { diet, protein }) || pickFromPool(POOLS.proteins, { diet, protein:"any" }) || POOLS.proteins[0];
    // choose a side compatible with diet
    let side = pickFromPool(POOLS.sides, { diet, protein }) || POOLS.sides[0];
    // for dinner pick another protein (avoid exact duplicate)
    let dinnerProtein = pickFromPool(POOLS.proteins, { diet, protein }) || lunchProtein;
    // snack
    let snackItem = pickFromPool(POOLS.snacks, { diet, protein }) || POOLS.snacks[Math.floor(Math.random()*POOLS.snacks.length)];

    // assemble textual meals (we will allow click-to-replace with USDA)
    const breakfastText = breakfastItem.name;
    const lunchText = `${lunchProtein.name} + ${side.name}`;
    const dinnerText = `${dinnerProtein.name} + ${side.name}`;
    const snackText = snackItem.name;

    // estimate kcals with multiplier and pct
    const kcals = Math.round(finalTdee * mult);
    const bK = Math.round(kcals * breakfastPct);
    const lK = Math.round(kcals * lunchPct);
    const dK = Math.round(kcals * dinnerPct);
    const sK = Math.round(kcals * snackPct);

    plan.push({
      day,
      breakfast: { text: breakfastText, kcal: bK, isCustom:false },
      lunch:     { text: lunchText, kcal: lK, isCustom:false },
      dinner:    { text: dinnerText, kcal: dK, isCustom:false },
      snack:     { text: snackText, kcal: sK, isCustom:false },
      meta: { tdee: finalTdee, age: age, diet, protein, portionMultiplier: mult }
    });
  }

  return plan;
}

window.generatePlan = generatePlan;

/* ---------------------------
  Helper: read URL params (for Part 1 auto-fill)
  --------------------------- */
function readUrlParamsToForm() {
  const params = new URLSearchParams(window.location.search);
  const tdee = params.get("tdee");
  const age = params.get("age");
  const goal = params.get("goal");
  const diet = params.get("diet");
  const protein = params.get("protein");

  if (tdee) document.getElementById("tdeeInput").value = tdee;
  if (age) document.getElementById("ageInput").value = age;
  if (goal) document.getElementById("goalSelect").value = goal;
  if (diet) document.getElementById("dietSelect").value = diet;
  if (protein) document.getElementById("proteinSelect").value = protein;

  // compute final TDEE display (goal adjustment)
  let finalTdee = Number(tdee) || 2000;
  if (goal === "lose") finalTdee = Math.max(1000, finalTdee - 300);
  if (goal === "gain") finalTdee = finalTdee + 300;
  document.getElementById("tdeeText").innerText = finalTdee;
  document.getElementById("tdeeInput").value = tdee || "";
}
document.addEventListener("DOMContentLoaded", readUrlParamsToForm);
</script>
<script>
/**********************************************************************
 PART 3/3
 - Rendering the plan
 - Lock/unlock days
 - Meal click â†’ USDA popup â†’ replacement
 - Manual USDA search
 - Save/load/overwrite/delete
 - Tracking progress
**********************************************************************/

/* ============================================================
   Global state
============================================================ */
let CURRENT_PLAN = null;  // the generated or loaded plan
let START_DATE = null;    // when user accepted plan
let TODAY_INDEX = 0;      // 0-based index: day1 = index 0

/* ============================================================
   Render the plan into #mainInner
============================================================ */
function renderPlan() {
  if (!CURRENT_PLAN) return;

  const container = document.getElementById("mainInner");
  container.innerHTML = "";

  const now = new Date();
  const savedStart = START_DATE ? new Date(START_DATE) : null;
  let unlockIndex = 0;

  if (savedStart) {
    const diff = now.getTime() - savedStart.getTime();
    unlockIndex = Math.floor(diff / (24 * 60 * 60 * 1000));
    if (unlockIndex < 0) unlockIndex = 0;
    if (unlockIndex > 6) unlockIndex = 6;
  }

  TODAY_INDEX = unlockIndex;

  CURRENT_PLAN.forEach((dayObj, idx) => {
    const dayNum = dayObj.day;
    const isLocked = idx > unlockIndex;

    const card = document.createElement("div");
    card.className = "day-card card";
    card.style.position = "relative";

    // Header
    const header = document.createElement("div");
    header.className = "day-header";
    header.innerHTML = `
      <strong>Day ${dayNum}</strong>
      <span>${isLocked ? "ðŸ”’ Locked" : "ðŸ”¥ Unlocked"}</span>
    `;
    card.appendChild(header);

    // Meals
    const mealsWrap = document.createElement("div");
    mealsWrap.className = "meals";

    ["breakfast", "lunch", "dinner", "snack"].forEach(type => {
      const meal = dayObj[type];

      const box = document.createElement("div");
      box.className = "meal";
      box.dataset.dayIndex = idx;
      box.dataset.field = type;
      box.innerHTML = `
        <b>${type.toUpperCase()}</b>
        <div>${meal.text}</div>
        <div class="kcal">~ ${meal.kcal} kcal</div>
      `;

      if (!isLocked) {
        box.addEventListener("click", () => {
          openUsdaPopup(idx, type, meal.text);
        });
      } else {
        box.classList.add("locked");
      }

      mealsWrap.appendChild(box);
    });

    card.appendChild(mealsWrap);

    // Locked overlay
    if (isLocked) {
      const overlay = document.createElement("div");
      overlay.className = "lock-overlay";
      overlay.innerHTML = `<div class="lock-badge">Unlocks tomorrow</div>`;
      card.appendChild(overlay);
    }

    container.appendChild(card);
  });
}

/* ============================================================
   USDA Popup for replacing meals
============================================================ */
function openUsdaPopup(dayIndex, field, queryText) {
  const popup = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");
  box.innerHTML = `
    <h3>USDA Search</h3>
    <p>Meal: <strong>${field.toUpperCase()}</strong></p>
    <input id="popupSearchInput" value="${queryText}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;">
    <button id="popupSearchBtn" class="btn" style="margin-top:8px;">Search</button>
    <div id="popupResults" style="margin-top:14px;"></div>
    <button onclick="closeUsdaPopup()" class="btn secondary" style="margin-top:10px;">Close</button>
  `;

  popup.style.display = "flex";

  document.getElementById("popupSearchBtn").onclick = async () => {
    const q = document.getElementById("popupSearchInput").value.trim();
    const results = await searchNutrition(q);
    renderUsdaResults(results, dayIndex, field);
  };
}

function closeUsdaPopup() {
  document.getElementById("usdaPopup").style.display = "none";
}

function renderUsdaResults(list, dayIndex, field) {
  const box = document.getElementById("popupResults");
  box.innerHTML = "";

  if (!list.length) {
    box.innerHTML = `<div>No matches found.</div>`;
    return;
  }

  list.slice(0, 25).forEach(item => {
    const row = document.createElement("div");
    row.style.padding = "8px";
    row.style.borderBottom = "1px solid #eee";
    row.style.cursor = "pointer";

    const kcal = item.kcal ? `${Math.round(item.kcal)} kcal` : "Unknown kcal";

    row.innerHTML = `
      <div><strong>${item.name}</strong></div>
      <div class="muted-small">${item.serving}</div>
      <div class="muted-small">${kcal}</div>
    `;

    row.onclick = () => {
      CURRENT_PLAN[dayIndex][field].text = item.name;
      CURRENT_PLAN[dayIndex][field].kcal = item.kcal ? Math.round(item.kcal) : CURRENT_PLAN[dayIndex][field].kcal;
      CURRENT_PLAN[dayIndex][field].isCustom = true;

      savePlanState();
      renderPlan();
      closeUsdaPopup();
    };

    box.appendChild(row);
  });
}

/* ============================================================
   Manual USDA Search (right sidebar)
============================================================ */
async function doManualSearch() {
  const q = document.getElementById("manualSearchInput").value.trim();
  const box = document.getElementById("manualSearchResults");
  box.innerHTML = "Searching...";

  const results = await searchNutrition(q);
  if (!results.length) {
    box.innerHTML = "<div>No results.</div>";
    return;
  }

  box.innerHTML = "";
  results.slice(0, 20).forEach(item => {
    const kcal = item.kcal ? `${Math.round(item.kcal)} kcal` : "Unknown kcal";
    const div = document.createElement("div");
    div.style.padding = "6px";
    div.style.borderBottom = "1px solid #eee";
    div.innerHTML = `<strong>${item.name}</strong> <span class="muted-small">(${kcal})</span>`;
    box.appendChild(div);
  });
}

/* ============================================================
   Save / Load / Delete Saved Plan
============================================================ */
function savePlanState() {
  localStorage.setItem("mealPlanData", JSON.stringify({
    plan: CURRENT_PLAN,
    startDate: START_DATE || new Date().toISOString()
  }));
}

function loadSavedPlan() {
  const raw = localStorage.getItem("mealPlanData");
  if (!raw) return false;

  try {
    const data = JSON.parse(raw);
    CURRENT_PLAN = data.plan;
    START_DATE = data.startDate;
    renderPlan();
    updateSavedInfo();
    return true;
  } catch {
    return false;
  }
}

function deleteSavedPlan() {
  localStorage.removeItem("mealPlanData");
  CURRENT_PLAN = null;
  START_DATE = null;
  updateSavedInfo();
  document.getElementById("mainInner").innerHTML = "";
}

/* ============================================================
   UI Event: Generate Preview
============================================================ */
function generatePreview() {
  const opt = {
    tdee: Number(document.getElementById("tdeeInput").value) || 2000,
    age: Number(document.getElementById("ageInput").value) || 30,
    goal: document.getElementById("goalSelect").value,
    diet: document.getElementById("dietSelect").value,
    protein: document.getElementById("proteinSelect").value
  };

  const plan = generatePlan(opt);

  // Preview in modal
  const modal = document.getElementById("previewModal");
  const box = document.getElementById("previewBox");
  box.innerHTML = `<h3>Preview</h3><pre>${JSON.stringify(plan, null, 2)}</pre>`;
  modal.style.display = "flex";
}

function closePreview() {
  document.getElementById("previewModal").style.display = "none";
}

/* ============================================================
   Accept & Save Plan
============================================================ */
function acceptPlan() {
  const opt = {
    tdee: Number(document.getElementById("tdeeInput").value) || 2000,
    age: Number(document.getElementById("ageInput").value) || 30,
    goal: document.getElementById("goalSelect").value,
    diet: document.getElementById("dietSelect").value,
    protein: document.getElementById("proteinSelect").value
  };

  CURRENT_PLAN = generatePlan(opt);
  START_DATE = new Date().toISOString();

  savePlanState();
  renderPlan();
  updateSavedInfo();
}

/* ============================================================
   Overwrite Plan
============================================================ */
function overwritePlan() {
  const ok = confirm("Overwrite your existing saved plan?");
  if (!ok) return;
  acceptPlan();
}

/* ============================================================
   Saved plan info box
============================================================ */
function updateSavedInfo() {
  const div = document.getElementById("savedInfo");
  const raw = localStorage.getItem("mealPlanData");

  if (!raw) {
    div.innerHTML = "No saved plan.";
    document.getElementById("deleteBtn").style.display = "none";
    return;
  }

  const data = JSON.parse(raw);
  div.innerHTML = `
    <div>Plan accepted on: <b>${new Date(data.startDate).toLocaleString()}</b></div>
    <div>Your plan unlocks one day every 24 hours.</div>
  `;
  document.getElementById("deleteBtn").style.display = "";
}

/* ============================================================
   Tracking â€“ daily calories eaten
============================================================ */
// You can expand this later if needed

/* ============================================================
   Event Listeners
============================================================ */
document.getElementById("generateBtn").onclick = generatePreview;
document.getElementById("acceptBtn").onclick = acceptPlan;
document.getElementById("overwriteBtn").onclick = overwritePlan;
document.getElementById("deleteBtn").onclick = deleteSavedPlan;

document.getElementById("applyTdeeBtn").onclick = () => {
  const tdee = Number(document.getElementById("tdeeInput").value) || 2000;
  const goal = document.getElementById("goalSelect").value;
  let finalTdee = tdee;
  if (goal === "lose") finalTdee -= 300;
  if (goal === "gain") finalTdee += 300;
  document.getElementById("tdeeText").innerText = finalTdee;
};

document.getElementById("manualSearchBtn").onclick = doManualSearch;
document.getElementById("previewModal").onclick = (e)=>{ if(e.target.id==="previewModal") closePreview(); };
document.getElementById("usdaPopup").onclick = (e)=>{ if(e.target.id==="usdaPopup") closeUsdaPopup(); };

/* ============================================================
   Load saved plan on startup
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  loadSavedPlan();
});
</script>

<!-- Footer -->
<footer class="footer" style="background:#1e40af;color:#fff;text-align:center;padding:2rem 1rem;margin-top:3rem;">
  <div style="max-width:1100px;margin:0 auto;">
    <div style="margin-bottom:10px;">
      <img src="https://convertlabs.online/assets/convert-labs-icon.png" style="width:24px;height:24px;vertical-align:middle;">
      <span style="margin-left:6px;font-weight:600;">Convert Labs</span>
    </div>

    <p style="margin-bottom:10px;">Â© 2025 Convert Labs. All rights reserved.</p>

    <nav>
      <a href="https://convertlabs.online/about.html" style="color:#fff;margin:0 6px;">About</a> |
      <a href="https://convertlabs.online/tools/tools.html" style="color:#fff;margin:0 6px;">Tools</a> |
      <a href="https://convertlabs.online/guides.html" style="color:#fff;margin:0 6px;">Blog</a> |
      <a href="https://convertlabs.online/privacy.html" style="color:#fff;margin:0 6px;">Privacy</a> |
      <a href="https://convertlabs.online/terms.html" style="color:#fff;margin:0 6px;">Terms</a> |
      <a href="https://convertlabs.online/contact.html" style="color:#fff;margin:0 6px;">Contact</a>
    </nav>
  </div>
</footer>

<script src="https://convertlabs.online/script.js" defer></script>

</body>
</html>
