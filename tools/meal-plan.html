<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>7-Day Meal Plan ‚Äî Convert Labs</title>
  <meta name="description" content="Personalized 7-day meal plans built from curated nutrition data. Auto macro balancing for Balanced / Keto / Carnivore / Vegetarian plans." />
  <link rel="icon" href="https://convertlabs.online/assets/convert-labs-icon.png" />
  <!-- Google Analytics (gtag) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z88B03WV7P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Z88B03WV7P');
  </script>

  <!-- ‚úÖ Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2490597435056272" crossorigin="anonymous"></script>

  <!-- jsPDF (kept available if you later want PDF rendering) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#0a4d8c; --brand-2:#134b8b; --muted:#6c6c6c; --bg:#f5faff; --card:#fff; --accent:#2b8bd8; --radius:12px; --text:#111;
    }
    html.dark{ --bg:#071029; --card:#081226; --text:#dbeafe; --muted:#9aa9b8; --accent:#34d399; }
    *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    header{height:64px;background:var(--brand-2);color:#fff;display:flex;align-items:center;padding:0 20px;position:sticky;top:0;z-index:100}
    .brand{font-weight:700;display:flex;align-items:center;gap:10px;}
    .nav-links{display:flex;gap:20px;margin:0 auto;}
    .nav-links a{color:#fff;text-decoration:none;font-weight:500;padding:8px 12px;border-radius:6px;transition:background-color 0.2s;}
    .nav-links a:hover{background:rgba(255,255,255,0.1);}
    .container{max-width:1180px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(12,40,80,0.04);margin-bottom:16px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--brand);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid var(--brand);color:var(--brand)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .meals{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    @media(max-width:900px){.meals{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.meals{grid-template-columns:1fr}}
    .meal{background:var(--glass);border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.04);position:relative;min-height:120px}
    .meal b{display:block;color:var(--brand-2);margin-bottom:8px;font-size:15px}
    .muted-small{font-size:13px;color:var(--muted)}
    .input-grams{width:100px;padding:6px;border-radius:8px;border:1px solid #e6e6e6}
    .meal-list-item{background:var(--card);border-radius:8px;padding:8px;margin-top:8px;border:1px solid rgba(0,0,0,0.04)}
    .locked{filter:grayscale(70%);opacity:0.25;pointer-events:none}
    .lock-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:30}
    .lock-badge{background:var(--card);padding:10px 14px;border-radius:10px;font-weight:700;box-shadow:0 8px 24px rgba(12,40,80,0.04)}
    .small-muted{font-size:12px;color:var(--muted)}
    .kcal{font-weight:700;margin-top:8px}
    .modal-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1200;padding:12px}
    .modal-card{width:100%;max-width:980px;max-height:86vh;overflow:auto;background:var(--card);border-radius:12px;padding:16px}
    footer.footer{background:var(--brand-2);color:#fff;padding:20px;text-align:center;margin-top:16px}
  </style>
</head>
<body>
  <header>
    <div style="flex:1"></div>
    <div class="brand">
      <img src="https://convertlabs.online/assets/convert-labs-icon.png" alt="Convert Labs" style="width:32px;height:32px;">
      <span>Convert Labs</span>
    </div>
    <nav class="nav-links">
      <a href="https://convertlabs.online/index.html">Home</a>
      <a href="https://convertlabs.online/tools/tools.html">Tools</a>
      <a href="https://convertlabs.online/guides.html">Blog</a>
      <a href="https://convertlabs.online/about.html">About</a>
      <a href="https://convertlabs.online/contact.html">Contact</a>
    </nav>
    <div style="flex:1;display:flex;justify-content:flex-end;">
      <button id="themeToggle" class="btn ghost">üåô</button>
    </div>
  </header>

  <div class="container">
    <main class="tool-page">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div style="flex:1">
            <h2 style="margin:0 0 6px 0">7-Day Meal Plan ‚Äî Precision Macros</h2>
            <div class="small-muted">TDEE input should be already adjusted (do not apply goal again if copying from calorie tool).</div>
          </div>
          <div style="min-width:260px;text-align:right">
            <div style="margin-bottom:6px"><button id="generateBtn" class="btn">Generate Preview</button> <button id="acceptBtn" class="btn ghost">Accept & Save</button></div>
            <div class="small-muted">Saved plan unlocks one day every 24 hours.</div>
          </div>
        </div>

        <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
          <div>
            <label style="display:block;font-weight:700;font-size:13px">TDEE (already adjusted)</label>
            <input id="tdeeInput" type="number" placeholder="e.g. 1800" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
            <div class="small-muted" style="margin-top:6px">Paste the TDEE/target from calorie tool ‚Äî do NOT apply goal again</div>
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Age</label>
            <input id="ageInput" type="number" min="1" max="120" placeholder="30" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Goal</label>
            <select id="goalSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
              <option value="maintain">Maintain weight</option>
              <option value="lose">Lose weight</option>
              <option value="gain">Gain weight</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Diet</label>
            <select id="dietSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
              <option value="balanced">Balanced</option>
              <option value="keto">Keto</option>
              <option value="carnivore">Carnivore</option>
              <option value="vegetarian">Vegetarian (lacto-ovo)</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Protein preference</label>
            <select id="proteinSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
              <option value="any">Any</option>
              <option value="beef">Beef</option>
              <option value="chicken">Chicken</option>
              <option value="fish">Fish</option>
              <option value="plant">Plant</option>
              <option value="eggs">Eggs</option>
            </select>
            <div style="margin-top:6px"><label><input id="oneProteinPerDay" type="checkbox" checked> Strict: one protein type per day</label></div>
          </div>
        </div>
      </div>

      <div class="grid">
        <section>
          <div id="mainInner"></div>
        </section>

        <aside>
          <div class="card">
            <strong>Saved plan</strong>
            <div id="savedInfo" style="margin-top:8px;color:var(--muted)">No saved plan.</div>
            <div style="margin-top:10px">
              <button id="exportDayBtn" class="btn" style="width:100%">Export Today's Plan (PDF)</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <strong>Day macros</strong>
            <div id="dayMacros" style="margin-top:8px;color:var(--muted)">‚Äî</div>
          </div>
        </aside>
      </div>

      <div id="pageDisclaimer" class="card" style="margin-top:14px">
        <strong>Nutrition Disclaimer</strong><br>
        This meal plan is automatically generated using curated nutrition data and general dietary heuristics. It is not individualized medical or dietitian advice. For personalized nutrition plans, consult a licensed professional.
      </div>
    </main>
  </div>

  <!-- Modals -->
  <div id="previewModal" class="modal-back"><div class="modal-card" id="previewBox"></div></div>
  <div id="usdaPopup" class="modal-back"><div class="modal-card" id="usdaBox"></div></div>

 <!-- Footer -->
 <footer class="footer">
  <div class="container" style="max-width:1100px;margin:0 auto;text-align:center;padding:20px;">
    <div class="footer-brand" style="margin-bottom:10px;">
      <img src="https://convertlabs.online/assets/convert-labs-icon.png" alt="Convert Labs" style="width:24px;height:24px;vertical-align:middle;">
      <span style="margin-left:6px;font-weight:600;">Convert Labs</span>
    </div>

    <p style="color:#ffffff;margin-bottom:10px;">¬© 2025 Convert Labs. All rights reserved.</p>

    <div style="width:100%;max-width:700px;height:1px;background:rgba(255,255,255,0.2);margin:0 auto 10px auto;"></div>

    <nav class="footer-links" style="margin-top:8px;">
      <a href="https://convertlabs.online/about.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">About</a> |
      <a href="https://convertlabs.online/tools/tools.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Tools</a> |
      <a href="https://convertlabs.online/guides.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Blog</a> |
      <a href="https://convertlabs.online/privacy.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Privacy</a> |
      <a href="https://convertlabs.online/disclaimer.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Disclaimer</a> |
      <a href="https://convertlabs.online/terms.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Terms</a> |
      <a href="https://convertlabs.online/contact.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Contact</a>
    </nav>
  </div>
</footer>
<style>
  footer.footer a:hover { 
    text-decoration: underline; 
    color: #ffffff; 
  }
</style>
<script>
/* =============================
   CONFIG: dataset paths (we'll prefer curated JSONs placed under /assets)
   ============================= */
const DATA_USDA = "/assets/usda_food_nutrition.json";      // optional - used only as fallback
const DATA_FULL = "/assets/foods-full.json";              // optional - fallback
const DATA_LITE = "/assets/foods-lite.json";              // optional - fallback
const DATA_CURATED_BALANCED = "/assets/foods-balanced.json"; // your curated balanced foodlist (you saved it)
const KEY = "convertlabs_mealplan_v4";

/* =============================
   Progressive data loader & index
   ============================= */
let indexItems = [];
let hasUsda=false, hasFull=false, hasLite=false, hasCuratedBalanced=false;

async function safeFetchJSON(url){
  try {
    const r = await fetch(url,{cache:"no-cache"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    if(Array.isArray(j)) return j;
    if(Array.isArray(j.data)) return j.data;
    return null;
  } catch(e){
    console.warn("fetch failed", url, e && e.message);
    return null;
  }
}

/* Load curated balanced list early (since you put it at /assets/foods-balanced.json) */
async function loadCuratedBalanced(){
  if(hasCuratedBalanced) return true;
  const j = await safeFetchJSON(DATA_CURATED_BALANCED);
  if(j){ indexItems = indexItems.concat(j); hasCuratedBalanced=true; console.info("Curated Balanced loaded", j.length); return true; }
  return false;
}

async function loadLite(){
  if(hasLite) return true;
  const j = await safeFetchJSON(DATA_LITE);
  if(j){ indexItems = indexItems.concat(j); hasLite=true; console.info("LITE loaded", j.length); return true; }
  return false;
}
async function loadFull(){
  if(hasFull) return true;
  const j = await safeFetchJSON(DATA_FULL);
  if(j){ indexItems = indexItems.concat(j); hasFull=true; console.info("FULL loaded", j.length); return true; }
  return false;
}
async function loadUsda(){
  if(hasUsda) return true;
  const j = await safeFetchJSON(DATA_USDA);
  if(j){ 
    // Normalize USDA entries to common keys if necessary
    const mapped = j.map(x=>{
      return {
        id: x.id ?? x.fdc_id ?? null,
        name: x.name ?? x.description ?? x.food_name,
        kcal: (typeof x.kcal === "number") ? x.kcal : (typeof x.calories === "number" ? x.calories : (x.energy_kcal? Number(x.energy_kcal): null)),
        protein: x.protein ?? x.protein_g ?? x.protein_per_100g ?? null,
        carbs: x.carbs ?? x.carbs_g ?? x.carbs_per_100g ?? null,
        fat: x.fat ?? x.fat_g ?? x.fat_per_100g ?? null,
        raw: x
      };
    });
    indexItems = mapped.concat(indexItems);
    hasUsda = true;
    console.info("USDA loaded", mapped.length);
    return true;
  }
  return false;
}

/* Kick off curated balanced early (most important) */
loadCuratedBalanced();
/* =============================
   Utilities: normalize, scoring, mapping
   ============================= */
function normalize(s){ return (s||"").toString().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }
function scoreName(name,q){
  const n=normalize(name||"");
  if(!n) return 0;
  if(n===q) return 120;
  let s=0;
  if(n.startsWith(q)) s+=50;
  if(n.includes(q)) s+=30;
  const qwords=q.split(/\W+/).filter(Boolean);
  qwords.forEach(w=>{ if(n.includes(w)) s+=8 });
  s += Math.max(0, 6 - n.split(" ").length);
  return s;
}

function mapItem(it, score=0){
  const name = it.name || it.food_name || it.description || "Unknown";
  const kcal = (typeof it.kcal === "number") ? it.kcal : (typeof it.calories === "number" ? it.calories : (it.kcal_per_100g? it.kcal_per_100g : null));
  const protein = (typeof it.protein === "number") ? it.protein : (typeof it.protein_g === "number" ? it.protein_g : (it.protein_per_100g? it.protein_per_100g:null));
  const carbs = (typeof it.carbs === "number") ? it.carbs : (typeof it.carbs_g === "number" ? it.carbs_g : (it.carbs_per_100g? it.carbs_per_100g:null));
  const fat = (typeof it.fat === "number") ? it.fat : (typeof it.fat_g === "number" ? it.fat_g : (it.fat_per_100g? it.fat_per_100g:null));
  const desc = normalize(name);
  const tags = [];
  if(desc.match(/\b(beef|steak|burger|lamb|pork|bacon)\b/)) tags.push("meat","beef");
  if(desc.match(/\b(chicken|turkey|poultry)\b/)) tags.push("meat","chicken");
  if(desc.match(/\b(fish|salmon|tuna|trout|mackerel|seafood)\b/)) tags.push("fish");
  if(desc.match(/\b(tofu|soy|tempeh|seitan)\b/)) tags.push("plant","tofu");
  if(desc.match(/\b(egg|eggs)\b/)) tags.push("eggs");
  if(desc.match(/\b(milk|cheese|yogurt|dairy|butter|cream)\b/)) tags.push("dairy");
  if(desc.match(/\b(rice|bread|pasta|noodle|potato|grain|oat|porridge|quinoa|brown rice|sweet potato)\b/)) tags.push("grain","starch");
  if(desc.match(/\b(almond|walnut|peanut|cashew|almonds|nuts)\b/)) tags.push("nuts");
  if(desc.match(/\b(apple|banana|orange|fruit|berry|berries)\b/)) tags.push("fruit");

  return {
    id: it.id ?? it.fdc_id ?? null,
    name,
    kcal_per_100g: (typeof kcal === "number" && !isNaN(kcal)) ? Number(kcal) : null,
    protein_per_100g: (typeof protein === "number" && !isNaN(protein)) ? Number(protein) : null,
    carbs_per_100g: (typeof carbs === "number" && !isNaN(carbs)) ? Number(carbs) : null,
    fat_per_100g: (typeof fat === "number" && !isNaN(fat)) ? Number(fat) : null,
    raw: it,
    tags,
    _score: score
  };
}

/* =============================
   Search: prefer curated balanced, then USDA/full/lite
   ============================= */
async function searchNutrition(query, limit=40){
  const q = normalize(query||"").trim();
  if(!q) return [];
  // ensure curated loaded
  await loadCuratedBalanced();
  // ensure USDA loaded too as fallback
  await loadUsda();

  let pool = indexItems.slice();
  // compute scores
  const scored = pool.map(it=>({
    it,
    score: scoreName(it.name || it.food_name || it.description || "", q)
  })).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
  if(scored.length) return scored.slice(0,limit).map(x=>mapItem(x.it,x.score));
  // fallback to full/lite if necessary
  await loadFull();
  await loadLite();
  pool = indexItems.slice();
  const scored2 = pool.map(it=>({it,score:scoreName(it.name||it.food_name||it.description||"", q)})).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
  return scored2.slice(0,limit).map(x=>mapItem(x.it,x.score));
}

/* =============================
   Enhanced Food Pools for All Diet Types (curated, realistic cal values)
   ============================= */
const POOLS = {
  // CARNIVORE DIET
  carnivore_proteins: [
    {name:"Ribeye Steak", kcal_per_100g:291, protein_per_100g:25, carbs_per_100g:0, fat_per_100g:21, tags:["meat","beef"]},
    {name:"Ground Beef (80/20)", kcal_per_100g:254, protein_per_100g:25, carbs_per_100g:0, fat_per_100g:16, tags:["meat","beef"]},
    {name:"Pork Chops", kcal_per_100g:242, protein_per_100g:27, carbs_per_100g:0, fat_per_100g:14, tags:["meat","pork"]},
    {name:"Chicken Thighs", kcal_per_100g:209, protein_per_100g:26, carbs_per_100g:0, fat_per_100g:11, tags:["meat","chicken"]},
    {name:"Bacon", kcal_per_100g:541, protein_per_100g:37, carbs_per_100g:1.4, fat_per_100g:42, tags:["meat","pork"]},
    {name:"Salmon", kcal_per_100g:206, protein_per_100g:22, carbs_per_100g:0, fat_per_100g:12, tags:["fish"]},
    {name:"Eggs", kcal_per_100g:155, protein_per_100g:13, carbs_per_100g:1.1, fat_per_100g:11, tags:["eggs"]},
    {name:"Lamb Chops", kcal_per_100g:282, protein_per_100g:25, carbs_per_100g:0, fat_per_100g:20, tags:["meat","lamb"]},
    {name:"Liver", kcal_per_100g:135, protein_per_100g:20, carbs_per_100g:3.9, fat_per_100g:3.7, tags:["meat","organ"]},
    {name:"Butter", kcal_per_100g:717, protein_per_100g:0.9, carbs_per_100g:0.1, fat_per_100g:81, tags:["dairy","fat"]},
    {name:"Heavy Cream", kcal_per_100g:345, protein_per_100g:2.1, carbs_per_100g:2.9, fat_per_100g:37, tags:["dairy","fat"]}
  ],
  // (Keto, balanced, vegetarian pools follow ‚Äî kept concise here)
  keto_breakfasts: [
    {name:"Scrambled eggs with cheese", kcal_per_100g:195, protein_per_100g:14, carbs_per_100g:2, fat_per_100g:15, tags:["eggs","dairy"]},
    {name:"2-egg omelet with vegetables", kcal_per_100g:145, protein_per_100g:11, carbs_per_100g:3, fat_per_100g:10, tags:["eggs","veg"]}
  ],
  keto_lunch_proteins: [
    {name:"Turkey salad", kcal_per_100g:110, protein_per_100g:18, carbs_per_100g:3, fat_per_100g:3, tags:["meat"]},
    {name:"Tuna salad wrap", kcal_per_100g:145, protein_per_100g:16, carbs_per_100g:6, fat_per_100g:7, tags:["fish"]}
  ],
  keto_lunch_sides: [
    {name:"Mixed greens salad", kcal_per_100g:25, carbs_per_100g:4, protein_per_100g:2, fat_per_100g:0, tags:["veg"]},
    {name:"Cucumber slices with ranch", kcal_per_100g:65, carbs_per_100g:3, protein_per_100g:1, fat_per_100g:6, tags:["veg","fat"]}
  ],
  keto_dinner_proteins: [
    {name:"Hamburger patty with cheese", kcal_per_100g:280, protein_per_100g:25, carbs_per_100g:2, fat_per_100g:19, tags:["meat","beef","dairy"]},
    {name:"Chicken breast with pesto", kcal_per_100g:195, protein_per_100g:26, carbs_per_100g:2, fat_per_100g:9, tags:["meat","chicken"]}
  ],
  keto_proteins: [
    {name:"Avocado", kcal_per_100g:160, protein_per_100g:2, carbs_per_100g:9, fat_per_100g:15, tags:["fruit","fat"]},
    {name:"Olive oil", kcal_per_100g:884, protein_per_100g:0, carbs_per_100g:0, fat_per_100g:100, tags:["fat"]},
    {name:"Butter", kcal_per_100g:717, protein_per_100g:0.9, carbs_per_100g:0.1, fat_per_100g:81, tags:["dairy","fat"]},
    {name:"Heavy cream", kcal_per_100g:345, protein_per_100g:2.1, carbs_per_100g:2.9, fat_per_100g:37, tags:["dairy","fat"]}
  ],
  // Balanced pools
  balanced_breakfasts: [
    {name:"Oatmeal with berries", kcal_per_100g:124, protein_per_100g:4, carbs_per_100g:21, fat_per_100g:2, tags:["grain","fruit"]},
    {name:"Scrambled eggs with toast", kcal_per_100g:180, protein_per_100g:11, carbs_per_100g:15, fat_per_100g:9, tags:["eggs","grain"]}
  ],
  balanced_lunch_proteins: [
    {name:"Grilled chicken breast", kcal_per_100g:165, protein_per_100g:31, carbs_per_100g:0, fat_per_100g:3.6, tags:["meat","chicken"]},
    {name:"Tuna salad", kcal_per_100g:140, protein_per_100g:16, carbs_per_100g:3, fat_per_100g:7, tags:["fish"]}
  ],
  balanced_lunch_sides: [
    {name:"Mixed green salad", kcal_per_100g:25, carbs_per_100g:4, protein_per_100g:2, fat_per_100g:0, tags:["veg"]},
    {name:"Brown rice", kcal_per_100g:123, carbs_per_100g:26, protein_per_100g:3, fat_per_100g:1, tags:["grain"]}
  ],
  balanced_dinner_proteins: [
    {name:"Grilled salmon", kcal_per_100g:206, protein_per_100g:22, carbs_per_100g:0, fat_per_100g:12, tags:["fish"]},
    {name:"Lean beef steak", kcal_per_100g:250, protein_per_100g:26, carbs_per_100g:0, fat_per_100g:15, tags:["meat","beef"]}
  ],
  balanced_dinner_sides: [
    {name:"Roasted vegetables", kcal_per_100g:65, carbs_per_100g:12, protein_per_100g:2, fat_per_100g:1, tags:["veg"]},
    {name:"Quinoa pilaf", kcal_per_100g:120, carbs_per_100g:21, protein_per_100g:4, fat_per_100g:2, tags:["grain"]}
  ],
  // Vegetarian pools
  vegetarian_proteins: [
    {name:"Lentils", kcal_per_100g:116, protein_per_100g:9, carbs_per_100g:20, fat_per_100g:0.4, tags:["plant","legume"]},
    {name:"Tofu (firm)", kcal_per_100g:144, protein_per_100g:12, carbs_per_100g:3, fat_per_100g:8, tags:["plant","tofu"]}
  ],
  vegetarian_sides: [
    {name:"Steamed Broccoli", kcal_per_100g:34, carbs_per_100g:7, protein_per_100g:2.8, fat_per_100g:0.4, tags:["veg"]},
    {name:"Brown Rice", kcal_per_100g:123, carbs_per_100g:26, protein_per_100g:2.7, fat_per_100g:1, tags:["grain"]}
  ],
  vegetarian_breakfasts: [
    {name:"Greek Yogurt with Berries", kcal_per_100g:75, protein_per_100g:8, carbs_per_100g:7, fat_per_100g:2, tags:["dairy","fruit"]},
    {name:"Oatmeal with Nuts", kcal_per_100g:130, protein_per_100g:5, carbs_per_100g:20, fat_per_100g:4, tags:["grain","nuts"]}
  ],
  // Snacks & beverages
  keto_snacks: [
    {name:"Almonds", kcal_per_100g:579, protein_per_100g:21, carbs_per_100g:22, fat_per_100g:50, tags:["nuts"]},
    {name:"Cottage cheese", kcal_per_100g:98, protein_per_100g:11, carbs_per_100g:3, fat_per_100g:4, tags:["dairy"]}
  ],
  balanced_snacks: [
    {name:"Apple with peanut butter", kcal_per_100g:150, protein_per_100g:4, carbs_per_100g:18, fat_per_100g:8, tags:["fruit","nuts"]},
    {name:"Greek yogurt", kcal_per_100g:59, protein_per_100g:10, carbs_per_100g:3.6, fat_per_100g:0.4, tags:["dairy"]}
  ],
  carnivore_snacks: [
    {name:"Beef jerky", kcal_per_100g:410, protein_per_100g:33, carbs_per_100g:11, fat_per_100g:26, tags:["meat","beef"]},
    {name:"Pork rinds", kcal_per_100g:615, protein_per_100g:61, carbs_per_100g:0, fat_per_100g:41, tags:["meat","pork"]}
  ],
  beverages: [
    {name:"Water", kcal_per_100g:0, protein_per_100g:0, carbs_per_100g:0, fat_per_100g:0, tags:["beverage"]},
    {name:"Coffee", kcal_per_100g:1, protein_per_100g:0, carbs_per_100g:0, fat_per_100g:0, tags:["beverage"]},
    {name:"Milk", kcal_per_100g:61, protein_per_100g:3.3, carbs_per_100g:4.8, fat_per_100g:3.3, tags:["dairy","beverage"]}
  ]
};
/* =============================
   Enhanced Diet & Protein Filters
   ============================= */
function allowedByDietTags(tags, diet){
  const t = (tags || []).map(s => s.toLowerCase());
  
  if (diet === "balanced") return true;
  
  if (diet === "keto") {
    const forbidden = ["grain", "starch", "sugar", "fruit", "high-sugar", "rice", "bread", "pasta", "noodle", "potato", "oat", "porridge"];
    const allowedDairy = ["cheese", "butter", "cream"];
    const hasAllowedDairy = t.some(tag => allowedDairy.includes(tag));
    const hasForbidden = t.some(tag => forbidden.includes(tag));
    // If contains forbidden carbs and not allowed dairy, reject
    return !(hasForbidden && !hasAllowedDairy);
  }
  
  if (diet === "carnivore") {
    const plant = ["plant", "veg", "vegetable", "vegetarian", "fruit", "grain", "legume", "nuts", "tofu", "rice", "oat", "potato", "bread", "pasta"];
    return !t.some(x => plant.includes(x));
  }
  
  if (diet === "vegetarian") {
    const forbidden = ["meat", "beef", "chicken", "fish", "pork", "bacon", "lamb", "turkey", "poultry", "seafood"];
    return !t.some(x => forbidden.includes(x));
  }
  
  return true;
}

function matchesProteinPref(tags,pref){
  const t=(tags||[]).map(s=>s.toLowerCase());
  if(!pref || pref==="any") return true;
  if(pref==="plant") return t.includes("plant")||t.includes("tofu")||t.includes("nuts");
  if(pref==="beef") return t.includes("beef")||t.includes("meat");
  if(pref==="chicken") return t.includes("chicken")||t.includes("meat");
  if(pref==="fish") return t.includes("fish");
  if(pref==="eggs") return t.includes("eggs");
  return true;
}

/* age multiplier */
function ageCategory(age){ const a=Number(age)||30; if(a<=12) return "child"; if(a<=19) return "teen"; if(a<=59) return "adult"; return "senior"; }
function agePortionMultiplier(cat){ if(cat==="child") return 0.7; if(cat==="teen") return 1.05; if(cat==="senior") return 0.9; return 1.0; }

/* =============================
   Realistic grams calculation
   ============================= */
function gramsForTarget(kcalPer100g, mealKcal){ 
  if(!kcalPer100g || kcalPer100g <= 0) {
    // Fallback for items with unknown calories
    return Math.max(50, Math.round(100 * (mealKcal / 200)));
  }
  const grams = (mealKcal / kcalPer100g) * 100;
  return Math.max(30, Math.round(grams)); // Minimum 30g portions
}

/* =============================
   Corrected Macro Splits for Each Diet
   ============================= */
function macroSplits(diet, goal){
  if (diet === "balanced") {
    if (goal === "lose") return { p: 0.35, c: 0.35, f: 0.30 };
    if (goal === "gain") return { p: 0.30, c: 0.45, f: 0.25 };
    return { p: 0.25, c: 0.45, f: 0.30 };
  }
  if (diet === "keto") {
    if (goal === "lose") return { p: 0.25, c: 0.05, f: 0.70 };
    if (goal === "gain") return { p: 0.20, c: 0.05, f: 0.75 };
    return { p: 0.20, c: 0.05, f: 0.75 };
  }
  if (diet === "carnivore") {
    if (goal === "lose") return { p: 0.35, c: 0.02, f: 0.63 };
    if (goal === "gain") return { p: 0.30, c: 0.03, f: 0.67 };
    return { p: 0.30, c: 0.02, f: 0.68 };
  }
  if (diet === "vegetarian") {
    if (goal === "lose") return { p: 0.35, c: 0.35, f: 0.30 };
    if (goal === "gain") return { p: 0.25, c: 0.50, f: 0.25 };
    return { p: 0.30, c: 0.45, f: 0.25 };
  }
  return { p: 0.30, c: 0.40, f: 0.30 };
}

/* =============================
   Diet-aware fallback food and picker
   ============================= */
function getDietFallbackFood(diet, proteinPref) {
  const fallbacks = {
    keto: { name: "Avocado", kcal: 160, protein: 2, carbs: 9, fat: 15, tags: ["fat", "fruit"] },
    carnivore: { name: "Ground Beef", kcal: 250, protein: 26, carbs: 0, fat: 17, tags: ["meat", "beef"] },
    vegetarian: { name: "Tofu", kcal: 144, protein: 12, carbs: 3, fat: 8, tags: ["plant", "tofu"] },
    balanced: { name: "Chicken Breast", kcal: 165, protein: 31, carbs: 0, fat: 3.6, tags: ["meat", "chicken"] }
  };
  
  return mapItem(fallbacks[diet] || fallbacks.balanced);
}

async function pickFoodByName(prefName, fallbackPool, opts, usedNames){
  const { diet, protein } = opts;
  
  // Try explicit search first
  const results = prefName ? await searchNutrition(prefName) : [];
  
  if (results && results.length) {
    const filtered = results.filter(r => 
      allowedByDietTags(r.tags, diet) && 
      matchesProteinPref(r.tags, protein) && 
      !usedNames.has(r.name)
    );
    
    if (filtered.length) {
      const scored = filtered.map(item => {
        let score = item._score || 0;
        if (diet === "keto" && (item.tags.includes("fat") || (item.fat_per_100g || 0) > 15)) score += 20;
        if (diet === "carnivore" && (item.tags.includes("meat") || item.tags.includes("fish"))) score += 30;
        if (diet === "vegetarian" && !item.tags.some(t => ["meat", "fish"].includes(t))) score += 25;
        if (diet === "balanced" && item.tags.some(t => ["grain", "fruit", "veg"].includes(t))) score += 15;
        return { item, score };
      }).sort((a, b) => b.score - a.score);
      
      return scored[0].item;
    }
  }
  // Fallback to appropriate pool
  let dietAwarePool = fallbackPool || [];
  
  if (diet === "keto") {
    if (fallbackPool === POOLS.proteins) dietAwarePool = POOLS.keto_lunch_proteins;
    else if (fallbackPool === POOLS.sides) dietAwarePool = POOLS.keto_lunch_sides;
    else if (fallbackPool === POOLS.breakfasts) dietAwarePool = POOLS.keto_breakfasts;
  } else if (diet === "carnivore") {
    dietAwarePool = POOLS.carnivore_proteins;
  } else if (diet === "balanced") {
    if (fallbackPool === POOLS.proteins) dietAwarePool = POOLS.balanced_lunch_proteins;
    else if (fallbackPool === POOLS.sides) dietAwarePool = POOLS.balanced_lunch_sides;
    else if (fallbackPool === POOLS.breakfasts) dietAwarePool = POOLS.balanced_breakfasts;
  } else if (diet === "vegetarian") {
    if (fallbackPool === POOLS.proteins) dietAwarePool = POOLS.vegetarian_proteins;
    else if (fallbackPool === POOLS.sides) dietAwarePool = POOLS.vegetarian_sides;
    else if (fallbackPool === POOLS.breakfasts) dietAwarePool = POOLS.vegetarian_breakfasts;
  }
  
  const candidates = dietAwarePool.filter(p => 
    allowedByDietTags(p.tags || [], diet) && 
    matchesProteinPref(p.tags || [], protein)
  );
  
  if (candidates.length) {
    const available = candidates.filter(p => !usedNames.has(p.name));
    const pick = available.length ? 
      available[Math.floor(Math.random() * available.length)] : 
      candidates[Math.floor(Math.random() * candidates.length)];
    
    return mapItem({
      name: pick.name, 
      kcal: pick.kcal_per_100g || pick.kcal, 
      protein: pick.protein_per_100g || pick.protein, 
      carbs: pick.carbs_per_100g || pick.carbs, 
      fat: pick.fat_per_100g || pick.fat, 
      tags: pick.tags
    });
  }
  
  // Ultimate fallback
  return getDietFallbackFood(diet, protein);
}

/* =============================
   Helper: calculate nutrition for parts
   ============================= */
function calculateMealNutrition(parts) {
  return parts.reduce((acc, part) => {
    const ratio = (part.grams || 0) / 100;
    const foodItem = part.source || part;
    const kcal = Math.round((foodItem.kcal_per_100g || part.per100 || 0) * ratio);
    const protein = Math.round((foodItem.protein_per_100g || foodItem.protein || 0) * ratio);
    const carbs = Math.round((foodItem.carbs_per_100g || foodItem.carbs || 0) * ratio);
    const fat = Math.round((foodItem.fat_per_100g || foodItem.fat || 0) * ratio);
    // store per-part values for UI updates
    part.kcal = kcal; part.protein = protein; part.carbs = carbs; part.fat = fat;
    return {
      kcal: acc.kcal + kcal,
      protein: acc.protein + protein,
      carbs: acc.carbs + carbs,
      fat: acc.fat + fat
    };
  }, {kcal: 0, protein: 0, carbs: 0, fat: 0});
}

/* Helper to ensure keto macro ratios (adjusts grams of high carb/fat items)
   This mutates parts and returns them */
function adjustKetoRatios(parts, targetFatPct = 0.70, targetProteinPct = 0.25, targetCarbsPct = 0.05) {
  const current = calculateMealNutrition(parts);
  const totalKcal = current.kcal;
  if (totalKcal === 0) return parts;
  const currentFatPct = (current.fat * 9) / totalKcal;
  const currentProteinPct = (current.protein * 4) / totalKcal;
  const currentCarbsPct = (current.carbs * 4) / totalKcal;
  if (currentCarbsPct > targetCarbsPct + 0.05) {
    parts.forEach(part => {
      if ((part.carbs_per_100g || part.source?.carbs_per_100g || 0) > 5) {
        part.grams = Math.max(10, Math.round(part.grams * 0.7));
      }
    });
  }
  if (currentFatPct < targetFatPct - 0.05) {
    parts.forEach(part => {
      if ((part.fat_per_100g || part.source?.fat_per_100g || 0) > 15) {
        part.grams = Math.round(part.grams * 1.3);
      }
    });
  }
  // recalc after adjustment
  calculateMealNutrition(parts);
  return parts;
}

/* =============================
   Plan generation (core)
   ============================= */
async function generatePlanAsync(opts){
  await loadCuratedBalanced();
  await loadLite();
  await loadUsda();
  const baseInput = Math.max(800, Number(opts.tdee) || 2000);
  let targetTdee;
  if(opts.inputIsAlreadyAdjusted) targetTdee = baseInput;
  else {
    if(opts.goal === "lose") targetTdee = Math.max(800, baseInput - 300);
    else if(opts.goal === "gain") targetTdee = baseInput + 300;
    else targetTdee = baseInput;
  }

  const age = Number(opts.age) || 30;
  const diet = opts.diet || "balanced";
  const proteinPref = opts.protein || "any";
  const mult = agePortionMultiplier(ageCategory(age));
  
  let splits;
  if (diet === "keto") {
    splits = { breakfast: 0.20, lunch: 0.35, dinner: 0.35, snack: 0.10 };
  } else if (diet === "carnivore") {
    splits = { breakfast: 0.25, lunch: 0.40, dinner: 0.30, snack: 0.05 };
  } else {
    splits = { breakfast: 0.25, lunch: 0.35, dinner: 0.30, snack: 0.10 };
  }

  const plan = [];

  for(let day=1; day<=7; day++){
    const isFreeDay = (opts.freeDay === true && day === (opts.freeDayIndex || 2));
    const dailyTDEE = Math.round(targetTdee);
    const dayTarget = isFreeDay ? Math.round(dailyTDEE * 1.15) : dailyTDEE;

    const macroTarget = macroSplits(diet, opts.goal || 'maintain');

    const bK = Math.round(dayTarget * splits.breakfast);
    const lK = Math.round(dayTarget * splits.lunch);
    const dK = Math.round(dayTarget * splits.dinner);
    const sK = Math.round(dayTarget * splits.snack);

    const usedNames = new Set();
    
    // Breakfast
    const breakfastParts = [];
    const breakfastFood = await pickFoodByName(null, POOLS.balanced_breakfasts, opts, usedNames);
    if (breakfastFood) {
      const grams = gramsForTarget(breakfastFood.kcal_per_100g, bK);
      breakfastParts.push({
        name: breakfastFood.name,
        per100: breakfastFood.kcal_per_100g,
        grams: grams,
        source: breakfastFood
      });
      usedNames.add(breakfastFood.name);
    }
    
    // Lunch
    const lunchParts = [];
    const lunchProtein = await pickFoodByName(null, POOLS.balanced_lunch_proteins, opts, usedNames);
    if (lunchProtein) {
      const grams = gramsForTarget(lunchProtein.kcal_per_100g, lK * 0.6);
      lunchParts.push({
        name: lunchProtein.name,
        per100: lunchProtein.kcal_per_100g,
        grams: grams,
        source: lunchProtein
      });
      usedNames.add(lunchProtein.name);
    }
    
    const lunchSide = await pickFoodByName(null, POOLS.balanced_lunch_sides, opts, usedNames);
    if (lunchSide) {
      const grams = gramsForTarget(lunchSide.kcal_per_100g, lK * 0.4);
      lunchParts.push({
        name: lunchSide.name,
        per100: lunchSide.kcal_per_100g,
        grams: grams,
        source: lunchSide
      });
      usedNames.add(lunchSide.name);
    }
    
    // Dinner
    const dinnerParts = [];
    const dinnerProtein = await pickFoodByName(null, POOLS.balanced_dinner_proteins, opts, usedNames);
    if (dinnerProtein) {
      const grams = gramsForTarget(dinnerProtein.kcal_per_100g, dK * 0.6);
      dinnerParts.push({
        name: dinnerProtein.name,
        per100: dinnerProtein.kcal_per_100g,
        grams: grams,
        source: dinnerProtein
      });
      usedNames.add(dinnerProtein.name);
    }
    
    const dinnerSide = await pickFoodByName(null, POOLS.balanced_dinner_sides, opts, usedNames);
    if (dinnerSide) {
      const grams = gramsForTarget(dinnerSide.kcal_per_100g, dK * 0.4);
      dinnerParts.push({
        name: dinnerSide.name,
        per100: dinnerSide.kcal_per_100g,
        grams: grams,
        source: dinnerSide
      });
      usedNames.add(dinnerSide.name);
    }
    
    // Snack
    const snackParts = [];
    const snackFood = await pickFoodByName(null, POOLS.balanced_snacks, opts, usedNames);
    if (snackFood) {
      const grams = gramsForTarget(snackFood.kcal_per_100g, sK);
      snackParts.push({
        name: snackFood.name,
        per100: snackFood.kcal_per_100g,
        grams: grams,
        source: snackFood
      });
      usedNames.add(snackFood.name);
    }
    
    // Calculate nutrition for each meal
    const breakfastNutrition = calculateMealNutrition(breakfastParts);
    const lunchNutrition = calculateMealNutrition(lunchParts);
    const dinnerNutrition = calculateMealNutrition(dinnerParts);
    const snackNutrition = calculateMealNutrition(snackParts);
    
    // Adjust for keto if needed
    if (diet === "keto") {
      adjustKetoRatios(breakfastParts);
      adjustKetoRatios(lunchParts);
      adjustKetoRatios(dinnerParts);
      adjustKetoRatios(snackParts);
    }
    
    plan.push({
      day,
      free: isFreeDay,
      meta: {
        target: dayTarget,
        splits,
        macroTarget
      },
      breakfast: {
        kcal: breakfastNutrition.kcal,
        parts: breakfastParts
      },
      lunch: {
        kcal: lunchNutrition.kcal,
        parts: lunchParts
      },
      dinner: {
        kcal: dinnerNutrition.kcal,
        parts: dinnerParts
      },
      snack: {
        kcal: snackNutrition.kcal,
        parts: snackParts
      }
    });
  }
  
  return plan;
}

/* =============================
   UI Rendering
   ============================= */
function renderPlan(plan, startDate) {
  const container = document.getElementById("mainInner");
  container.innerHTML = "";
  
  if (!plan || !plan.length) {
    container.innerHTML = "<div class='card'>No plan generated yet.</div>";
    return;
  }
  
  const now = new Date();
  const daysSinceStart = Math.floor((now - new Date(startDate)) / (1000 * 60 * 60 * 24));
  const unlockedDays = Math.max(0, Math.min(6, daysSinceStart));
  
  plan.forEach((d, idx) => {
    const card = document.createElement("div");
    card.className = "card";
    
    const isLocked = idx > unlockedDays;
    
    const header = document.createElement("div");
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "center";
    header.style.marginBottom = "12px";
    
    const title = document.createElement("h3");
    title.textContent = `Day ${d.day}${d.free ? ' (FREE DAY)' : ''}`;
    title.style.margin = "0";
    
    const targetInfo = document.createElement("div");
    targetInfo.className = "muted-small";
    targetInfo.textContent = `Target: ${d.meta.target} kcal`;
    
    header.appendChild(title);
    header.appendChild(targetInfo);
    card.appendChild(header);
    
    if (isLocked) {
      const lockOverlay = document.createElement("div");
      lockOverlay.className = "lock-overlay";
      lockOverlay.innerHTML = `<div class="lock-badge">üîí Unlocks in ${idx - unlockedDays} day(s)</div>`;
      card.appendChild(lockOverlay);
      card.classList.add("locked");
    }
    
    const mealsWrap = document.createElement("div");
    mealsWrap.className = "meals";
    
    // Create meal blocks
    const meals = [
      { key: 'breakfast', label: 'Breakfast' },
      { key: 'lunch', label: 'Lunch' },
      { key: 'dinner', label: 'Dinner' },
      { key: 'snack', label: 'Snack' }
    ];
    
    meals.forEach(meal => {
      const mealBlock = document.createElement("div");
      mealBlock.className = "meal";
      
      const mealHeader = document.createElement("div");
      mealHeader.style.display = "flex";
      mealHeader.style.justifyContent = "space-between";
      mealHeader.style.alignItems = "center";
      mealHeader.style.marginBottom = "8px";
      
      const mealTitle = document.createElement("b");
      mealTitle.textContent = meal.label;
      
      const mealKcal = document.createElement("span");
      mealKcal.className = "kcal";
      mealKcal.textContent = `${d[meal.key].kcal || 0} kcal`;
      
      mealHeader.appendChild(mealTitle);
      mealHeader.appendChild(mealKcal);
      mealBlock.appendChild(mealHeader);
      
      if (d[meal.key].parts && d[meal.key].parts.length) {
        d[meal.key].parts.forEach(part => {
          const partDiv = document.createElement("div");
          partDiv.className = "meal-list-item";
          
          const partName = document.createElement("div");
          partName.textContent = part.name;
          partName.style.fontWeight = "600";
          
          const partInfo = document.createElement("div");
          partInfo.className = "muted-small";
          partInfo.textContent = `${part.grams}g ‚Äî ${part.kcal || 0} kcal`;
          
          partDiv.appendChild(partName);
          partDiv.appendChild(partInfo);
          mealBlock.appendChild(partDiv);
        });
      } else {
        const emptyMsg = document.createElement("div");
        emptyMsg.className = "muted-small";
        emptyMsg.textContent = "No items";
        mealBlock.appendChild(emptyMsg);
      }
      
      // Add action buttons if not locked
      if (!isLocked) {
        const actions = document.createElement("div");
        actions.style.marginTop = "8px";
        actions.style.display = "flex";
        actions.style.gap = "6px";
        
        const addBtn = document.createElement("button");
        addBtn.className = "btn ghost";
        addBtn.textContent = "Add";
        addBtn.style.fontSize = "12px";
        addBtn.style.padding = "4px 8px";
        addBtn.onclick = () => openAddItemModal(idx, meal.key);
        
        const replaceBtn = document.createElement("button");
        replaceBtn.className = "btn ghost";
        replaceBtn.textContent = "Replace";
        replaceBtn.style.fontSize = "12px";
        replaceBtn.style.padding = "4px 8px";
        replaceBtn.onclick = () => openReplaceModal(idx, meal.key);
        
        actions.appendChild(addBtn);
        actions.appendChild(replaceBtn);
        mealBlock.appendChild(actions);
      }
      
      mealsWrap.appendChild(mealBlock);
    });
    
    card.appendChild(mealsWrap);

    // Day summary
    const summary = document.createElement("div"); 
    summary.style.marginTop="12px";

    // Calculate totals
    const breakfastKcal = d.breakfast.parts ? d.breakfast.parts.reduce((s,x)=>s+(x.kcal||0),0) : (d.breakfast.kcal||0);
    const lunchKcal = d.lunch.parts ? d.lunch.parts.reduce((s,x)=>s+(x.kcal||0),0) : (d.lunch.kcal||0);
    const dinnerKcal = d.dinner.parts ? d.dinner.parts.reduce((s,x)=>s+(x.kcal||0),0) : (d.dinner.kcal||0);
    const snackKcal = d.snack.parts ? d.snack.parts.reduce((s,x)=>s+(x.kcal||0),0) : (d.snack.kcal||0);

    const totalKcal = breakfastKcal + lunchKcal + dinnerKcal + snackKcal;

    // Calculate macros
    const breakfastMacros = d.breakfast.parts ? calculateMealNutrition(d.breakfast.parts) : {protein:0, carbs:0, fat:0};
    const lunchMacros = d.lunch.parts ? calculateMealNutrition(d.lunch.parts) : {protein:0, carbs:0, fat:0};
    const dinnerMacros = d.dinner.parts ? calculateMealNutrition(d.dinner.parts) : {protein:0, carbs:0, fat:0};
    const snackMacros = d.snack.parts ? calculateMealNutrition(d.snack.parts) : {protein:0, carbs:0, fat:0};

    const totalProtein = breakfastMacros.protein + lunchMacros.protein + dinnerMacros.protein + snackMacros.protein;
    const totalCarbs = breakfastMacros.carbs + lunchMacros.carbs + dinnerMacros.carbs + snackMacros.carbs;
    const totalFat = breakfastMacros.fat + lunchMacros.fat + dinnerMacros.fat + snackMacros.fat;

    summary.innerHTML = `
      <div class="muted-small">Daily Total: <strong class="day-total">${totalKcal}</strong> kcal</div>
      <div class="muted-small">Target (TDEE): <strong class="day-target">${d.meta.target}</strong> kcal</div>
      <div class="muted-small">Difference: <strong class="day-diff">${totalKcal - d.meta.target}</strong> kcal</div>
      <div class="muted-small">Daily Macros: P ${Math.round(totalProtein)}g ‚Ä¢ C ${Math.round(totalCarbs)}g ‚Ä¢ F ${Math.round(totalFat)}g</div>
    `;
    card.appendChild(summary);

    container.appendChild(card);
  });
}

/* =============================
   Missing Utility Functions
   ============================= */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function searchCuratedFoods(query) {
  const q = normalize(query);
  if (!q) return [];
  
  // Search through our POOLS for matching foods
  const results = [];
  
  // Search all pools
  Object.values(POOLS).forEach(pool => {
    pool.forEach(food => {
      const name = normalize(food.name);
      if (name.includes(q)) {
        results.push({
          name: food.name,
          kcal: food.kcal_per_100g || food.kcal,
          protein: food.protein_per_100g || food.protein,
          carbs: food.carbs_per_100g || food.carbs,
          fat: food.fat_per_100g || food.fat
        });
      }
    });
  });
  
  // Also search indexItems if available
  indexItems.forEach(item => {
    const name = normalize(item.name || item.food_name || item.description || "");
    if (name.includes(q)) {
      results.push({
        name: item.name || item.food_name || item.description,
        kcal: item.kcal_per_100g || item.kcal,
        protein: item.protein_per_100g || item.protein,
        carbs: item.carbs_per_100g || item.carbs,
        fat: item.fat_per_100g || item.fat
      });
    }
  });
  
  // Remove duplicates
  const uniqueResults = [];
  const seen = new Set();
  
  results.forEach(result => {
    const key = result.name + result.kcal;
    if (!seen.has(key)) {
      seen.add(key);
      uniqueResults.push(result);
    }
  });
  
  return uniqueResults.slice(0, 20); // Limit results
}

/* =============================
   Local Storage Functions
   ============================= */
function savePlan(plan, startDate) {
  const data = {
    plan,
    startDate: startDate || new Date().toISOString(),
    version: "v4"
  };
  localStorage.setItem(KEY, JSON.stringify(data));
}

function loadPlan() {
  const stored = localStorage.getItem(KEY);
  if (!stored) return null;
  
  try {
    return JSON.parse(stored);
  } catch (e) {
    console.error("Failed to parse stored plan", e);
    return null;
  }
}

function updateSavedInfo() {
  const savedInfo = document.getElementById("savedInfo");
  const stored = loadPlan();
  
  if (stored && stored.plan) {
    const startDate = new Date(stored.startDate);
    const now = new Date();
    const days = Math.floor((Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) - 
                            Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()))/86400000);
    const unlocked = Math.max(0, Math.min(6, days));
    
    savedInfo.innerHTML = `
      <div>Plan started: ${startDate.toLocaleDateString()}</div>
      <div>Unlocked days: ${unlocked + 1}/7</div>
      <div>Next unlock: ${unlocked < 6 ? "in " + (1) + " day" : "Complete"}</div>
    `;
  } else {
    savedInfo.textContent = "No saved plan.";
  }
}

/* =============================
   Event Handlers
   ============================= */
document.addEventListener('DOMContentLoaded', function() {
  // Theme toggle
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.addEventListener('click', function() {
    document.documentElement.classList.toggle('dark');
    this.textContent = document.documentElement.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
  });
  
  // Generate Preview button
  const generateBtn = document.getElementById('generateBtn');
  generateBtn.addEventListener('click', async function() {
    const tdee = document.getElementById('tdeeInput').value;
    const age = document.getElementById('ageInput').value;
    const goal = document.getElementById('goalSelect').value;
    const diet = document.getElementById('dietSelect').value;
    const protein = document.getElementById('proteinSelect').value;
    
    if (!tdee) {
      alert("Please enter your TDEE");
      return;
    }
    
    const opts = {
      tdee: parseInt(tdee),
      age: parseInt(age),
      goal,
      diet,
      protein,
      inputIsAlreadyAdjusted: true
    };
    
    try {
      const plan = await generatePlanAsync(opts);
      renderPlan(plan, new Date().toISOString());
      
      // Show preview modal
      const modal = document.getElementById('previewModal');
      const previewBox = document.getElementById('previewBox');
      previewBox.innerHTML = `<h3>7-Day Meal Plan Preview</h3><p>Plan generated successfully! Click "Accept & Save" to save this plan.</p>`;
      modal.style.display = 'flex';
      
      // Close modal when clicking outside
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    } catch (error) {
      console.error("Error generating plan:", error);
      alert("Error generating plan. Please try again.");
    }
  });
  
  // Accept & Save button
  const acceptBtn = document.getElementById('acceptBtn');
  acceptBtn.addEventListener('click', function() {
    const tdee = document.getElementById('tdeeInput').value;
    const age = document.getElementById('ageInput').value;
    const goal = document.getElementById('goalSelect').value;
    const diet = document.getElementById('dietSelect').value;
    const protein = document.getElementById('proteinSelect').value;
    
    if (!tdee) {
      alert("Please enter your TDEE first");
      return;
    }
    
    const opts = {
      tdee: parseInt(tdee),
      age: parseInt(age),
      goal,
      diet,
      protein,
      inputIsAlreadyAdjusted: true
    };
    
    generatePlanAsync(opts).then(plan => {
      savePlan(plan, new Date().toISOString());
      updateSavedInfo();
      renderPlan(plan, new Date().toISOString());
      document.getElementById('previewModal').style.display = 'none';
      alert("Plan saved successfully!");
    }).catch(error => {
      console.error("Error saving plan:", error);
      alert("Error saving plan. Please try again.");
    });
  });
  
  // Export PDF button
  const exportBtn = document.getElementById('exportDayBtn');
  exportBtn.addEventListener('click', exportCurrentDayToPDF);
  
  // Load any saved plan on page load
  const stored = loadPlan();
  if (stored && stored.plan) {
    renderPlan(stored.plan, stored.startDate);
  }
  updateSavedInfo();
  
  // Try to get parameters from URL (for integration with calorie-guide.html)
  const urlParams = new URLSearchParams(window.location.search);
  const tdee = urlParams.get('tdee');
  const age = urlParams.get('age');
  const goal = urlParams.get('goal');
  const diet = urlParams.get('diet');
  
  if (tdee) document.getElementById('tdeeInput').value = tdee;
  if (age) document.getElementById('ageInput').value = age;
  if (goal) document.getElementById('goalSelect').value = goal;
  if (diet) document.getElementById('dietSelect').value = diet;
});

/* =============================
   Add/Replace Item Modals - FIXED
   ============================= */
let currentDayForModal = null;
let currentMealForModal = null;

function openAddItemModal(dayIdx, mealKey) {
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;
  
  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");
  
  box.innerHTML = `
    <h3>Add Food Item to ${mealKey.charAt(0).toUpperCase() + mealKey.slice(1)} - Day ${dayIdx + 1}</h3>
    <div style="margin: 12px 0">
      <input type="text" id="usdaSearchInput" placeholder="Search foods (e.g., chicken, rice, apple)" 
      style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #e6e6e6">
    </div>
    <div id="usdaResults" style="max-height: 400px; overflow-y: auto; margin: 12px 0"></div>
    <div style="text-align: right">
      <button id="usdaClose" class="btn ghost">Cancel</button>
    </div>
  `;
  
  const searchInput = document.getElementById("usdaSearchInput");
  searchInput.addEventListener('input', debounce((e) => {
    const query = e.target.value.trim();
    if (query.length < 2) {
      document.getElementById("usdaResults").innerHTML = "<div class='muted-small'>Enter at least 2 characters to search</div>";
      return;
    }

    const results = searchCuratedFoods(query);
    renderAddList(results);

  }, 300));
  
  document.getElementById("usdaClose").onclick = () => modal.style.display = 'none';
  modal.style.display = 'flex';
  
  document.getElementById("usdaResults").innerHTML = "<div class='muted-small'>Enter a food name to search</div>";
}

function renderAddList(results) {
  const container = document.getElementById("usdaResults");
  
  if (!results || results.length === 0) {
    container.innerHTML = "<div class='muted-small'>No foods found. Try a different search term.</div>";
    return;
  }
  
  let html = '<div style="display: grid; gap: 8px">';
  
  results.forEach(item => {
    html += `
      <div class="meal-list-item" style="cursor: pointer; padding: 12px" 
      onclick="applyAddToPlan('${escapeHtml(item.name)}', ${item.kcal}, ${item.protein}, ${item.carbs}, ${item.fat})">

        <div style="font-weight: 700">${escapeHtml(item.name)}</div>
        <div class="muted-small">
          ${item.kcal} kcal ‚Ä¢ P: ${item.protein}g ‚Ä¢ C: ${item.carbs}g ‚Ä¢ F: ${item.fat}g per 100g
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function applyAddToPlan(name, kcal_per_100g, protein_per_100g, carbs_per_100g, fat_per_100g) {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;
  
  const plan = stored.plan;
  const day = plan[currentDayForModal];
  
  if (!day || !day[currentMealForModal]) return;
  
  const newPart = {
    name,
    per100: kcal_per_100g,
    grams: 100,
    type: "added",
    source: {
      name,
      kcal_per_100g,
      protein_per_100g,
      carbs_per_100g,
      fat_per_100g
    },
    kcal: Math.round(kcal_per_100g),
    protein: Math.round(protein_per_100g),
    carbs: Math.round(carbs_per_100g),
    fat: Math.round(fat_per_100g)
  };
  
  if (!day[currentMealForModal].parts) {
    day[currentMealForModal].parts = [];
  }
  day[currentMealForModal].parts.push(newPart);
  
  day[currentMealForModal].kcal = day[currentMealForModal].parts.reduce((sum, part) => sum + (part.kcal || 0), 0);
  
  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();
  
  document.getElementById("usdaPopup").style.display = 'none';
}

function openReplaceModal(dayIdx, mealKey) {
  currentDayForModal = dayIdx;
  currentMealForModal = mealKey;
  
  const modal = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");
  
  box.innerHTML = `
    <h3>Replace Food Item in ${mealKey.charAt(0).toUpperCase() + mealKey.slice(1)} - Day ${dayIdx + 1}</h3>
    <div style="margin: 12px 0">
      <input type="text" id="usdaSearchInput" placeholder="Search replacement food‚Ä¶" 
      style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #e6e6e6">
    </div>
    <div id="usdaResults" style="max-height: 400px; overflow-y: auto; margin: 12px 0"></div>
    <div style="text-align: right">
      <button id="usdaClose" class="btn ghost">Cancel</button>
    </div>
  `;
  
  const searchInput = document.getElementById("usdaSearchInput");
  searchInput.addEventListener('input', debounce((e) => {
    const query = e.target.value.trim();
    if (query.length < 2) {
      document.getElementById("usdaResults").innerHTML = "<div class='muted-small'>Enter at least 2 characters to search</div>";
      return;
    }

    const results = searchCuratedFoods(query);
    renderReplaceList(results);

  }, 300));
  
  document.getElementById("usdaClose").onclick = () => modal.style.display = 'none';
  modal.style.display = 'flex';

  document.getElementById("usdaResults").innerHTML = "<div class='muted-small'>Start typing to search food items</div>";
}

function renderReplaceList(results) {
  const container = document.getElementById("usdaResults");
  
  if (!results || results.length === 0) {
    container.innerHTML = "<div class='muted-small'>No foods found for this search.</div>";
    return;
  }
  
  let html = '<div style="display:grid;gap:8px">';
  
  results.forEach(item => {
    html += `
      <div class="meal-list-item" style="cursor:pointer;padding:12px"
        onclick="applyReplacementToPlan(
          '${escapeHtml(item.name)}',
           ${item.kcal},
           ${item.protein},
           ${item.carbs},
           ${item.fat}
        )"
      >
        <div style="font-weight:700">${escapeHtml(item.name)}</div>
        <div class="muted-small">
          ${item.kcal} kcal ‚Ä¢ P ${item.protein}g ‚Ä¢ C ${item.carbs}g ‚Ä¢ F ${item.fat}g per 100g
        </div>
      </div>
    `;
  });
  
  html += "</div>";
  container.innerHTML = html;
}

function applyReplacementToPlan(name, kcal_per_100g, protein_per_100g, carbs_per_100g, fat_per_100g) {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;
  
  const plan = stored.plan;
  const day = plan[currentDayForModal];
  
  if (!day || !day[currentMealForModal] || !day[currentMealForModal].parts) return;

  // Replace FIRST part in the meal
  const first = day[currentMealForModal].parts[0];
  const grams = first.grams || 100;

  first.name = name;
  first.per100 = kcal_per_100g;
  first.source = {
    name,
    kcal_per_100g,
    protein_per_100g,
    carbs_per_100g,
    fat_per_100g
  };

  const ratio = grams / 100;
  first.kcal = Math.round(kcal_per_100g * ratio);
  first.protein = Math.round(protein_per_100g * ratio);
  first.carbs = Math.round(carbs_per_100g * ratio);
  first.fat = Math.round(fat_per_100g * ratio);

  // Update total meal kcal
  day[currentMealForModal].kcal = day[currentMealForModal].parts.reduce((sum, p) => sum + (p.kcal || 0), 0);

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();

  document.getElementById("usdaPopup").style.display = 'none';
}

/* =============================
   PDF Export ‚Äî REAL PDF using jsPDF
   ============================= */
function exportCurrentDayToPDF() {
  const stored = loadPlan();
  if (!stored || !stored.plan) {
    alert("No saved plan to export.");
    return;
  }

  const startDate = new Date(stored.startDate);
  const now = new Date();
  const days = Math.floor((Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) - 
                          Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()))/86400000);
  const unlocked = Math.max(0, Math.min(6, days));
  const day = stored.plan[unlocked];

  if (!day) {
    alert("No unlocked day to export.");
    return;
  }

  // Initialize jsPDF
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) {
    alert("PDF export requires jsPDF (missing).");
    return;
  }

  const doc = new jsPDF({ unit: 'mm', format: 'a4' });
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 14;
  const lineHeight = 7;
  let y = margin;

  // Helper to add a wrapped line and increment y
  function addWrappedText(text, opts = {}) {
    const fontSize = opts.fontSize || 11;
    doc.setFontSize(fontSize);
    const split = doc.splitTextToSize(text, pageWidth - margin * 2);
    doc.text(split, margin, y);
    y += split.length * (fontSize * 0.35) + 2;
    if (y > doc.internal.pageSize.getHeight() - margin) {
      doc.addPage();
      y = margin;
    }
  }

  // Header
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text("Convert Labs ‚Äî Daily Meal Plan", pageWidth / 2, y, { align: 'center' });
  y += lineHeight + 2;

  doc.setFontSize(11);
  doc.setFont(undefined, 'normal');
  addWrappedText(`Day ${day.day}${day.free ? ' (FREE DAY)' : ''} ‚Äî Target: ${day.meta.target} kcal`);
  addWrappedText(`Generated: ${new Date().toLocaleString()}`);
  y += 2;

  // Divider
  doc.setDrawColor(200);
  doc.setLineWidth(0.5);
  doc.line(margin, y, pageWidth - margin, y);
  y += 6;

  // Function to render meal section
  function renderMeal(title, meal) {
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    addWrappedText(`${title} (${meal.kcal || 0} kcal)`);
    doc.setFont(undefined, 'normal');

    if (meal.parts && meal.parts.length) {
      meal.parts.forEach(part => {
        const grams = part.grams || 0;
        const kcal = part.kcal || Math.round((part.per100 || (part.source && part.source.kcal_per_100g) || 0) * (grams / 100));
        const macros = [];
        if (typeof part.protein !== 'undefined') macros.push(`P ${Math.round(part.protein)}g`);
        if (typeof part.carbs !== 'undefined') macros.push(`C ${Math.round(part.carbs)}g`);
        if (typeof part.fat !== 'undefined') macros.push(`F ${Math.round(part.fat)}g`);
        const line = `‚Ä¢ ${part.name} ‚Äî ${grams}g ‚Äî ${kcal} kcal ${macros.length ? ' ‚Ä¢ ' + macros.join(' ‚Ä¢ ') : ''}`;
        addWrappedText(line, { fontSize: 10 });
      });
    } else {
      addWrappedText("No components listed.", { fontSize: 10 });
    }

    y += 4;
    if (y > doc.internal.pageSize.getHeight() - margin) {
      doc.addPage();
      y = margin;
    }
  }

  // Meals
  renderMeal("BREAKFAST", day.breakfast);
  renderMeal("LUNCH", day.lunch);
  renderMeal("DINNER", day.dinner);
  renderMeal("SNACK", day.snack);

  // Totals & macros
  // Recalculate to be safe
  const breakfastMacros = day.breakfast.parts ? calculateMealNutrition(day.breakfast.parts) : { protein:0, carbs:0, fat:0 };
  const lunchMacros = day.lunch.parts ? calculateMealNutrition(day.lunch.parts) : { protein:0, carbs:0, fat:0 };
  const dinnerMacros = day.dinner.parts ? calculateMealNutrition(day.dinner.parts) : { protein:0, carbs:0, fat:0 };
  const snackMacros = day.snack.parts ? calculateMealNutrition(day.snack.parts) : { protein:0, carbs:0, fat:0 };

  const totalProtein = breakfastMacros.protein + lunchMacros.protein + dinnerMacros.protein + snackMacros.protein;
  const totalCarbs = breakfastMacros.carbs + lunchMacros.carbs + dinnerMacros.carbs + snackMacros.carbs;
  const totalFat = breakfastMacros.fat + lunchMacros.fat + dinnerMacros.fat + snackMacros.fat;

  const totalKcal = (day.breakfast.parts ? day.breakfast.parts.reduce((s,x)=>s+(x.kcal||0),0) : (day.breakfast.kcal||0)) +
                     (day.lunch.parts ? day.lunch.parts.reduce((s,x)=>s+(x.kcal||0),0) : (day.lunch.kcal||0)) +
                     (day.dinner.parts ? day.dinner.parts.reduce((s,x)=>s+(x.kcal||0),0) : (day.dinner.kcal||0)) +
                     (day.snack.parts ? day.snack.parts.reduce((s,x)=>s+(x.kcal||0),0) : (day.snack.kcal||0));

  // Divider
  y += 4;
  doc.setDrawColor(200);
  doc.line(margin, y, pageWidth - margin, y);
  y += 8;

  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  addWrappedText("Daily Summary");
  doc.setFont(undefined, 'normal');
  addWrappedText(`Total Calories: ${totalKcal} kcal (Target: ${day.meta.target} kcal)`);
  addWrappedText(`Protein: ${Math.round(totalProtein)} g`);
  addWrappedText(`Carbs: ${Math.round(totalCarbs)} g`);
  addWrappedText(`Fat: ${Math.round(totalFat)} g`);

  // Footer / small note
  y = Math.min(y + 8, doc.internal.pageSize.getHeight() - margin - 10);
  doc.setFontSize(9);
  doc.setTextColor(120);
  addWrappedText("This plan is auto-generated and educational; not medical advice. For personalized guidance, consult a licensed dietitian.");

  // Save file
  const filename = `convertlabs-mealplan-day-${day.day}.pdf`;
  doc.save(filename);
}
</script>
</body>
  </html>
