<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>7-Day Meal Plan â€” Convert Labs</title>
  <meta name="description" content="Personalized 7-day meal plans built from USDA public-domain nutrition data. Auto macro balancing for Balanced / Keto / Carnivore / Vegetarian plans." />
  <link rel="icon" href="https://convertlabs.online/assets/convert-labs-icon.png" />
  <!-- Google Analytics (gtag) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z88B03WV7P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Z88B03WV7P');
  </script>

  <!-- âœ… Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2490597435056272" crossorigin="anonymous"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#0a4d8c; --brand-2:#134b8b; --muted:#6c6c6c; --bg:#f5faff; --card:#fff; --accent:#2b8bd8; --radius:12px; --text:#111;
    }
    html.dark{ --bg:#071029; --card:#081226; --text:#dbeafe; --muted:#9aa9b8; --accent:#34d399; }
    *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    header{height:64px;background:var(--brand-2);color:#fff;display:flex;align-items:center;padding:0 20px;position:sticky;top:0;z-index:100}
    .brand{font-weight:700;display:flex;align-items:center;gap:10px;}
    .nav-links{display:flex;gap:20px;margin:0 auto;}
    .nav-links a{color:#fff;text-decoration:none;font-weight:500;padding:8px 12px;border-radius:6px;transition:background-color 0.2s;}
    .nav-links a:hover{background:rgba(255,255,255,0.1);}
    .container{max-width:1180px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(12,40,80,0.04);margin-bottom:16px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--brand);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid var(--brand);color:var(--brand)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .meals{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    @media(max-width:900px){.meals{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.meals{grid-template-columns:1fr}}
    .meal{background:var(--glass);border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.04);position:relative;min-height:120px}
    .meal b{display:block;color:var(--brand-2);margin-bottom:8px;font-size:15px}
    .muted-small{font-size:13px;color:var(--muted)}
    .input-grams{width:100px;padding:6px;border-radius:8px;border:1px solid #e6e6e6}
    .meal-list-item{background:var(--card);border-radius:8px;padding:8px;margin-top:8px;border:1px solid rgba(0,0,0,0.04)}
    .locked{filter:grayscale(70%);opacity:0.25;pointer-events:none}
    .lock-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:30}
    .lock-badge{background:var(--card);padding:10px 14px;border-radius:10px;font-weight:700;box-shadow:0 8px 24px rgba(12,40,80,0.04)}
    .small-muted{font-size:12px;color:var(--muted)}
    .kcal{font-weight:700;margin-top:8px}
    .modal-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1200;padding:12px}
    .modal-card{width:100%;max-width:980px;max-height:86vh;overflow:auto;background:var(--card);border-radius:12px;padding:16px}
    footer.footer{background:var(--brand-2);color:#fff;padding:20px;text-align:center;margin-top:16px}
  </style>
</head>
<body>
  <header>
    <div style="flex:1"></div>
    <div class="brand">
      <img src="https://convertlabs.online/assets/convert-labs-icon.png" alt="Convert Labs" style="width:32px;height:32px;">
      <span>Convert Labs</span>
    </div>
    <nav class="nav-links">
      <a href="https://convertlabs.online/index.html">Home</a>
      <a href="https://convertlabs.online/tools/tools.html">Tools</a>
      <a href="https://convertlabs.online/guides.html">Blog</a>
      <a href="https://convertlabs.online/about.html">About</a>
      <a href="https://convertlabs.online/contact.html">Contact</a>
    </nav>
    <div style="flex:1;display:flex;justify-content:flex-end;">
      <button id="themeToggle" class="btn ghost">ðŸŒ™</button>
    </div>
  </header>

  <div class="container">
    <main class="tool-page">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div style="flex:1">
            <h2 style="margin:0 0 6px 0">7-Day Meal Plan â€” Precision Macros</h2>
            <div class="small-muted">TDEE input should be already adjusted (do not apply goal again if copying from calorie tool).</div>
          </div>
          <div style="min-width:260px;text-align:right">
            <div style="margin-bottom:6px"><button id="generateBtn" class="btn">Generate Preview</button> <button id="acceptBtn" class="btn ghost">Accept & Save</button></div>
            <div class="small-muted">Saved plan unlocks one day every 24 hours.</div>
          </div>
        </div>

        <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
          <div>
            <label style="display:block;font-weight:700;font-size:13px">TDEE (already adjusted)</label>
            <input id="tdeeInput" type="number" placeholder="e.g. 1800" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
            <div class="small-muted" style="margin-top:6px">Paste the TDEE/target from calorie tool â€” do NOT apply goal again</div>
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Age</label>
            <input id="ageInput" type="number" min="1" max="120" placeholder="30" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Goal</label>
            <select id="goalSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
              <option value="maintain">Maintain weight</option>
              <option value="lose">Lose weight</option>
              <option value="gain">Gain weight</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Diet</label>
            <select id="dietSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
              <option value="balanced">Balanced</option>
              <option value="keto">Keto</option>
              <option value="carnivore">Carnivore</option>
              <option value="vegetarian">Vegetarian (lacto-ovo)</option>
            </select>
          </div>
          <div>
            <label style="display:block;font-weight:700;font-size:13px">Protein preference</label>
            <select id="proteinSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:100%">
              <option value="any">Any</option>
              <option value="beef">Beef</option>
              <option value="chicken">Chicken</option>
              <option value="fish">Fish</option>
              <option value="plant">Plant</option>
              <option value="eggs">Eggs</option>
            </select>
            <div style="margin-top:6px"><label><input id="oneProteinPerDay" type="checkbox" checked> Strict: one protein type per day</label></div>
          </div>
        </div>
      </div>

      <!-- Meal Timing Schedule Card -->
      <div class="card">
        <h3 style="margin:0 0 12px 0">Suggested Meal Schedule</h3>
        <div class="meals">
          <div class="meal">
            <b>Breakfast</b>
            <div class="muted-small">Within 1-2 hours of waking</div>
            <div class="muted-small">6:00 - 9:45 AM</div>
          </div>
          <div class="meal">
            <b>Morning Snack</b>
            <div class="muted-small">3-4 hours after breakfast</div>
            <div class="muted-small">10:00 - 11:00 AM</div>
          </div>
          <div class="meal">
            <b>Lunch</b>
            <div class="muted-small">4-6 hours after breakfast</div>
            <div class="muted-small">Around 1:00 PM</div>
          </div>
          <div class="meal">
            <b>Afternoon Snack</b>
            <div class="muted-small">3-4 hours after lunch</div>
            <div class="muted-small">3:00 - 4:00 PM</div>
          </div>
          <div class="meal">
            <b>Dinner</b>
            <div class="muted-small">4-6 hours after lunch</div>
            <div class="muted-small">Before 7:00 PM</div>
          </div>
        </div>
        <div class="muted-small" style="margin-top:12px">
          <strong>Note:</strong> Eating earlier dinners and maintaining consistent meal timing can improve metabolism and weight management.
        </div>
      </div>

      <div class="grid">
        <section>
          <div id="mainInner"></div>
        </section>

        <aside>
          <div class="card">
            <strong>Saved plan</strong>
            <div id="savedInfo" style="margin-top:8px;color:var(--muted)">No saved plan.</div>
            <div style="margin-top:10px">
              <button id="exportDayBtn" class="btn" style="width:100%">Export Today's Plan (PDF)</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <strong>Day macros</strong>
            <div id="dayMacros" style="margin-top:8px;color:var(--muted)">â€”</div>
          </div>
        </aside>
      </div>

      <div id="pageDisclaimer" class="card" style="margin-top:14px">
        <strong>Nutrition Disclaimer</strong><br>
        This meal plan is automatically generated using USDA public-domain nutrition data and general dietary heuristics. It is not individualized medical or dietitian advice. For personalized nutrition plans, consult a licensed professional.
      </div>
    </main>
  </div>

  <!-- Modals -->
  <div id="previewModal" class="modal-back"><div class="modal-card" id="previewBox"></div></div>
  <div id="usdaPopup" class="modal-back"><div class="modal-card" id="usdaBox"></div></div>

 <!-- Footer -->
 <footer class="footer">
  <div class="container" style="max-width:1100px;margin:0 auto;text-align:center;padding:20px;">
    <div class="footer-brand" style="margin-bottom:10px;">
      <img src="https://convertlabs.online/assets/convert-labs-icon.png" alt="Convert Labs" style="width:24px;height:24px;vertical-align:middle;">
      <span style="margin-left:6px;font-weight:600;">Convert Labs</span>
    </div>

    <p style="color:#ffffff;margin-bottom:10px;">Â© 2025 Convert Labs. All rights reserved.</p>

    <div style="width:100%;max-width:700px;height:1px;background:rgba(255,255,255,0.2);margin:0 auto 10px auto;"></div>

    <nav class="footer-links" style="margin-top:8px;">
      <a href="https://convertlabs.online/about.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">About</a> |
      <a href="https://convertlabs.online/tools/tools.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Tools</a> |
      <a href="https://convertlabs.online/guides.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Blog</a> |
      <a href="https://convertlabs.online/privacy.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Privacy</a> |
      <a href="https://convertlabs.online/disclaimer.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Disclaimer</a> |
      <a href="https://convertlabs.online/terms.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Terms</a> |
      <a href="https://convertlabs.online/contact.html" style="color:#f8fafc;text-decoration:none;margin:0 6px;">Contact</a>
    </nav>
  </div>
   <section class="site-verification" style="font-size:14px; color:#f1f1f1; text-align:center; margin-top:25px; line-height:1.6;">
  <p>âœ… <strong>Domain Verification & Email Security</strong></p>
  <p>
    Convert Labs is officially verified for secure DNS and authenticated email delivery.  
    Our domain (<a href="https://convertlabs.online" target="_blank" style="color:#9dc6ff;">convertlabs.online</a>)  
    uses trusted <strong>Cloudflare</strong> infrastructure with validated DNS records.
  </p>
  <p>
    Email protection includes:
    <ul style="list-style:none; padding:0; margin:5px 0;">
      <li>âœ” <strong>SPF</strong> â€“ Approved senders: Cloudflare & Outlook Mail servers</li>
      <li>âœ” <strong>DKIM</strong> â€“ 2048-bit RSA signature verified (<em>selector: cf2024-1</em>)</li>
      <li>âœ” <strong>DMARC</strong> â€“ Active monitoring for spoofing and spam prevention</li>
    </ul>
  </p>
  <p>
    These records confirm the legitimacy of our domain and improve deliverability,  
    search engine trust, and AdSense approval readiness.
  </p>
</section>

</footer>
<style>
  footer.footer a:hover { 
    text-decoration: underline; 
    color: #ffffff; 
  }
</style>

<script>
/* =============================
   CONFIG: dataset paths
   ============================= */
const DATA_USDA = "/assets/usda_food_nutrition.json";
const DATA_FULL = "/assets/foods-full.json";
const DATA_LITE = "/assets/foods-lite.json";
const KEY = "convertlabs_mealplan_v4";

/* =============================
   Progressive data loader & index
   ============================= */
let indexItems = [];
let hasUsda=false, hasFull=false, hasLite=false;

async function safeFetchJSON(url){
  try {
    const r = await fetch(url,{cache:"no-cache"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    if(Array.isArray(j)) return j;
    if(Array.isArray(j.data)) return j.data;
    return null;
  } catch(e){
    console.warn("fetch failed", url, e && e.message);
    return null;
  }
}

async function loadLite(){
  if(hasLite) return true;
  const j = await safeFetchJSON(DATA_LITE);
  if(j){ indexItems = indexItems.concat(j); hasLite=true; console.info("LITE loaded", j.length); return true; }
  return false;
}
async function loadFull(){
  if(hasFull) return true;
  const j = await safeFetchJSON(DATA_FULL);
  if(j){ indexItems = indexItems.concat(j); hasFull=true; console.info("FULL loaded", j.length); return true; }
  return false;
}
async function loadUsda(){
  if(hasUsda) return true;
  const j = await safeFetchJSON(DATA_USDA);
  if(j){ 
    // Normalize USDA entries to common keys if necessary
    const mapped = j.map(x=>{
      return {
        id: x.id ?? x.fdc_id ?? null,
        name: x.name ?? x.description ?? x.food_name,
        kcal: (typeof x.kcal === "number") ? x.kcal : (typeof x.calories === "number" ? x.calories : (x.energy_kcal? Number(x.energy_kcal): null)),
        protein: x.protein ?? x.protein_g ?? x.protein_per_100g ?? null,
        carbs: x.carbs ?? x.carbs_g ?? x.carbs_per_100g ?? null,
        fat: x.fat ?? x.fat_g ?? x.fat_per_100g ?? null,
        raw: x
      };
    });
    indexItems = mapped.concat(indexItems);
    hasUsda = true;
    console.info("USDA loaded", mapped.length);
    return true;
  }
  return false;
}

/* Kick off lite early */
loadLite();

/* =============================
   Utilities: normalize, score, map
   ============================= */
function normalize(s){ return (s||"").toString().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }
function scoreName(name,q){
  const n=normalize(name||"");
  if(!n) return 0;
  if(n===q) return 120;
  let s=0;
  if(n.startsWith(q)) s+=50;
  if(n.includes(q)) s+=30;
  const qwords=q.split(/\W+/).filter(Boolean);
  qwords.forEach(w=>{ if(n.includes(w)) s+=8 });
  s += Math.max(0, 6 - n.split(" ").length);
  return s;
}

function mapItem(it, score=0){
  // Accept both our normalized mapping and other shapes
  const name = it.name || it.food_name || it.description || "Unknown";
  const kcal = (typeof it.kcal === "number") ? it.kcal : (typeof it.calories === "number" ? it.calories : null);
  const protein = (typeof it.protein === "number") ? it.protein : (typeof it.protein_g === "number" ? it.protein_g : null);
  const carbs = (typeof it.carbs === "number") ? it.carbs : (typeof it.carbs_g === "number" ? it.carbs_g : null);
  const fat = (typeof it.fat === "number") ? it.fat : (typeof it.fat_g === "number" ? it.fat_g : null);
  const desc = normalize(name);
  const tags = [];
  if(desc.match(/\b(beef|steak|burger|lamb|pork|bacon)\b/)) tags.push("meat","beef");
  if(desc.match(/\b(chicken|turkey|poultry)\b/)) tags.push("meat","chicken");
  if(desc.match(/\b(fish|salmon|tuna|trout|mackerel|seafood)\b/)) tags.push("fish");
  if(desc.match(/\b(tofu|soy|tempeh|seitan)\b/)) tags.push("plant","tofu");
  if(desc.match(/\b(egg|eggs)\b/)) tags.push("eggs");
  if(desc.match(/\b(milk|cheese|yogurt|dairy|butter|cream)\b/)) tags.push("dairy");
  if(desc.match(/\b(rice|bread|pasta|noodle|potato|grain|oat|porridge)\b/)) tags.push("grain","starch");
  if(desc.match(/\b(almond|walnut|peanut|cashew|almonds|nuts)\b/)) tags.push("nuts");
  if(desc.match(/\b(apple|banana|orange|fruit|berry|berries)\b/)) tags.push("fruit");

  return {
    id: it.id ?? it.fdc_id ?? null,
    name,
    kcal_per_100g: (typeof kcal === "number" && !isNaN(kcal)) ? Number(kcal) : null,
    protein_per_100g: (typeof protein === "number" && !isNaN(protein)) ? Number(protein) : null,
    carbs_per_100g: (typeof carbs === "number" && !isNaN(carbs)) ? Number(carbs) : null,
    fat_per_100g: (typeof fat === "number" && !isNaN(fat)) ? Number(fat) : null,
    raw: it,
    tags,
    _score: score
  };
}

/* =============================
   Search: prefer USDA, then full, then lite
   ============================= */
async function searchNutrition(query, limit=40){
  const q = normalize(query||"").trim();
  if(!q) return [];
  // ensure USDA loaded first (best results)
  await loadUsda();
  let pool = indexItems.slice(); // indexItems is progressively populated
  // compute scores
  const scored = pool.map(it=>({
    it,
    score: scoreName(it.name || it.food_name || it.description || "", q)
  })).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
  if(scored.length) return scored.slice(0,limit).map(x=>mapItem(x.it,x.score));
  // fallback to live full/lite if no good results
  await loadFull();
  pool = indexItems.slice();
  const scored2 = pool.map(it=>({it,score:scoreName(it.name||it.food_name||it.description||"", q)})).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
  if(scored2.length) return scored2.slice(0,limit).map(x=>mapItem(x.it,x.score));
  await loadLite();
  pool = indexItems.slice();
  const scored3 = pool.map(it=>({it,score:scoreName(it.name||it.food_name||it.description||"", q)})).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
  return scored3.slice(0,limit).map(x=>mapItem(x.it,x.score));
}

/* =============================
   Enhanced Food Pools for All Diet Types
   ============================= */
const POOLS = {
  // CARNIVORE DIET - Only animal products
  carnivore_proteins: [
    {name:"Ribeye Steak", kcal_per_100g:291, protein_per_100g:25, carbs_per_100g:0, fat_per_100g:21, tags:["meat","beef"]},
    {name:"Ground Beef (80/20)", kcal_per_100g:254, protein_per_100g:25, carbs_per_100g:0, fat_per_100g:16, tags:["meat","beef"]},
    {name:"Pork Chops", kcal_per_100g:242, protein_per_100g:27, carbs_per_100g:0, fat_per_100g:14, tags:["meat","pork"]},
    {name:"Chicken Thighs", kcal_per_100g:209, protein_per_100g:26, carbs_per_100g:0, fat_per_100g:11, tags:["meat","chicken"]},
    {name:"Bacon", kcal_per_100g:541, protein_per_100g:37, carbs_per_100g:1.4, fat_per_100g:42, tags:["meat","pork"]},
    {name:"Salmon", kcal_per_100g:206, protein_per_100g:22, carbs_per_100g:0, fat_per_100g:12, tags:["fish"]},
    {name:"Eggs", kcal_per_100g:155, protein_per_100g:13, carbs_per_100g:1.1, fat_per_100g:11, tags:["eggs"]},
    {name:"Lamb Chops", kcal_per_100g:282, protein_per_100g:25, carbs_per_100g:0, fat_per_100g:20, tags:["meat","lamb"]},
    {name:"Liver", kcal_per_100g:135, protein_per_100g:20, carbs_per_100g:3.9, fat_per_100g:3.7, tags:["meat","organ"]},
    {name:"Butter", kcal_per_100g:717, protein_per_100g:0.9, carbs_per_100g:0.1, fat_per_100g:81, tags:["dairy","fat"]},
    {name:"Heavy Cream", kcal_per_100g:345, protein_per_100g:2.1, carbs_per_100g:2.9, fat_per_100g:37, tags:["dairy","fat"]}
  ],

  // KETO DIET - Multiple components
  keto_breakfasts: [
    {name:"Scrambled eggs with cheese", kcal_per_100g:195, protein_per_100g:14, carbs_per_100g:2, fat_per_100g:15, tags:["eggs","dairy"]},
    {name:"Greek yogurt with berries", kcal_per_100g:75, protein_per_100g:8, carbs_per_100g:7, fat_per_100g:2, tags:["dairy","fruit"]},
    {name:"Breakfast burrito", kcal_per_100g:180, protein_per_100g:12, carbs_per_100g:8, fat_per_100g:12, tags:["eggs","veg"]},
    {name:"Berry smoothie", kcal_per_100g:85, protein_per_100g:6, carbs_per_100g:9, fat_per_100g:4, tags:["dairy","fruit"]},
    {name:"2-egg omelet with vegetables", kcal_per_100g:145, protein_per_100g:11, carbs_per_100g:3, fat_per_100g:10, tags:["eggs","veg"]},
    {name:"Egg nests with zucchini", kcal_per_100g:120, protein_per_100g:9, carbs_per_100g:4, fat_per_100g:8, tags:["eggs","veg"]},
    {name:"Avocado and eggs", kcal_per_100g:190, protein_per_100g:8, carbs_per_100g:6, fat_per_100g:16, tags:["eggs","fruit","fat"]}
  ],
  
  keto_lunch_proteins: [
    {name:"Turkey salad", kcal_per_100g:110, protein_per_100g:18, carbs_per_100g:3, fat_per_100g:3, tags:["meat"]},
    {name:"Tuna salad wrap", kcal_per_100g:145, protein_per_100g:16, carbs_per_100g:6, fat_per_100g:7, tags:["fish"]},
    {name:"Chicken salad", kcal_per_100g:130, protein_per_100g:20, carbs_per_100g:2, fat_per_100g:5, tags:["meat","chicken"]},
    {name:"Egg salad wrap", kcal_per_100g:180, protein_per_100g:11, carbs_per_100g:5, fat_per_100g:13, tags:["eggs"]},
    {name:"Ham and cream cheese rollups", kcal_per_100g:220, protein_per_100g:14, carbs_per_100g:3, fat_per_100g:17, tags:["meat","dairy"]},
    {name:"Cottage cheese salad", kcal_per_100g:98, protein_per_100g:11, carbs_per_100g:3, fat_per_100g:4, tags:["dairy"]}
  ],
  
  keto_lunch_sides: [
    {name:"Mixed greens salad", kcal_per_100g:25, carbs_per_100g:4, protein_per_100g:2, fat_per_100g:0, tags:["veg"]},
    {name:"Cucumber slices with ranch", kcal_per_100g:65, carbs_per_100g:3, protein_per_100g:1, fat_per_100g:6, tags:["veg","fat"]},
    {name:"Celery sticks with ranch", kcal_per_100g:70, carbs_per_100g:3, protein_per_100g:1, fat_per_100g:7, tags:["veg","fat"]},
    {name:"Pickle spear", kcal_per_100g:12, carbs_per_100g:3, protein_per_100g:0, fat_per_100g:0, tags:["veg"]},
    {name:"Side salad with vinaigrette", kcal_per_100g:45, carbs_per_100g:3, protein_per_100g:1, fat_per_100g:4, tags:["veg","fat"]}
  ],
  
  keto_dinner_proteins: [
    {name:"Hamburger patty with cheese", kcal_per_100g:280, protein_per_100g:25, carbs_per_100g:2, fat_per_100g:19, tags:["meat","beef","dairy"]},
    {name:"Chicken breast with pesto", kcal_per_100g:195, protein_per_100g:26, carbs_per_100g:2, fat_per_100g:9, tags:["meat","chicken"]},
    {name:"Meatless meatballs with sauce", kcal_per_100g:180, protein_per_100g:12, carbs_per_100g:8, fat_per_100g:11, tags:["plant"]},
    {name:"Salmon fillet", kcal_per_100g:206, protein_per_100g:22, carbs_per_100g:0, fat_per_100g:12, tags:["fish"]},
    {name:"Sausage with vegetables", kcal_per_100g:250, protein_per_100g:14, carbs_per_100g:4, fat_per_100g:20, tags:["meat"]},
    {name:"Ground beef tacos", kcal_per_100g:220, protein_per_100g:20, carbs_per_100g:5, fat_per_100g:14, tags:["meat","beef"]},
    {name:"Tofu or chicken stir fry", kcal_per_100g:150, protein_per_100g:16, carbs_per_100g:6, fat_per_100g:7, tags:["plant","chicken"]}
  ],
  
  keto_dinner_sides: [
    {name:"Roasted broccoli with parmesan", kcal_per_100g:85, carbs_per_100g:6, protein_per_100g:5, fat_per_100g:5, tags:["veg","dairy"]},
    {name:"Zucchini noodles", kcal_per_100g:35, carbs_per_100g:6, protein_per_100g:2, fat_per_100g:0, tags:["veg"]},
    {name:"Asparagus with garlic", kcal_per_100g:40, carbs_per_100g:5, protein_per_100g:3, fat_per_100g:2, tags:["veg"]},
    {name:"Spinach salad", kcal_per_100g:45, carbs_per_100g:4, protein_per_100g:3, fat_per_100g:3, tags:["veg"]},
    {name:"Sheet pan vegetables", kcal_per_100g:55, carbs_per_100g:8, protein_per_100g:2, fat_per_100g:2, tags:["veg"]},
    {name:"Cauliflower rice", kcal_per_100g:40, carbs_per_100g:7, protein_per_100g:3, fat_per_100g:1, tags:["veg"]},
    {name:"Lettuce wraps", kcal_per_100g:15, carbs_per_100g:3, protein_per_100g:1, fat_per_100g:0, tags:["veg"]}
  ],

  // KETO PROTEINS (for fat sources)
  keto_proteins: [
    {name:"Avocado", kcal_per_100g:160, protein_per_100g:2, carbs_per_100g:9, fat_per_100g:15, tags:["fruit","fat"]},
    {name:"Olive oil", kcal_per_100g:884, protein_per_100g:0, carbs_per_100g:0, fat_per_100g:100, tags:["fat"]},
    {name:"Butter", kcal_per_100g:717, protein_per_100g:0.9, carbs_per_100g:0.1, fat_per_100g:81, tags:["dairy","fat"]},
    {name:"Coconut oil", kcal_per_100g:862, protein_per_100g:0, carbs_per_100g:0, fat_per_100g:100, tags:["fat"]},
    {name:"Heavy cream", kcal_per_100g:345, protein_per_100g:2.1, carbs_per_100g:2.9, fat_per_100g:37, tags:["dairy","fat"]}
  ],

  // BALANCED DIET - Varied meals with multiple components
  balanced_breakfasts: [
    {name:"Oatmeal with berries", kcal_per_100g:124, protein_per_100g:4, carbs_per_100g:21, fat_per_100g:2, tags:["grain","fruit"]},
    {name:"Scrambled eggs with toast", kcal_per_100g:180, protein_per_100g:11, carbs_per_100g:15, fat_per_100g:9, tags:["eggs","grain"]},
    {name:"Greek yogurt with granola", kcal_per_100g:120, protein_per_100g:9, carbs_per_100g:16, fat_per_100g:3, tags:["dairy","grain"]},
    {name:"Whole wheat pancakes", kcal_per_100g:180, protein_per_100g:6, carbs_per_100g:28, fat_per_100g:5, tags:["grain"]},
    {name:"Breakfast burrito", kcal_per_100g:195, protein_per_100g:12, carbs_per_100g:20, fat_per_100g:8, tags:["eggs","grain"]},
    {name:"Cereal with milk and fruit", kcal_per_100g:110, protein_per_100g:4, carbs_per_100g:20, fat_per_100g:2, tags:["grain","dairy","fruit"]}
  ],

  balanced_lunch_proteins: [
    {name:"Grilled chicken breast", kcal_per_100g:165, protein_per_100g:31, carbs_per_100g:0, fat_per_100g:3.6, tags:["meat","chicken"]},
    {name:"Turkey sandwich", kcal_per_100g:180, protein_per_100g:15, carbs_per_100g:20, fat_per_100g:5, tags:["meat","grain"]},
    {name:"Tuna salad", kcal_per_100g:140, protein_per_100g:16, carbs_per_100g:3, fat_per_100g:7, tags:["fish"]},
    {name:"Quinoa bowl", kcal_per_100g:120, protein_per_100g:4, carbs_per_100g:21, fat_per_100g:2, tags:["grain","plant"]},
    {name:"Lentil soup", kcal_per_100g:90, protein_per_100g:6, carbs_per_100g:15, fat_per_100g:2, tags:["plant","legume"]},
    {name:"Egg salad", kcal_per_100g:180, protein_per_100g:11, carbs_per_100g:2, fat_per_100g:14, tags:["eggs"]}
  ],

  balanced_lunch_sides: [
    {name:"Mixed green salad", kcal_per_100g:25, carbs_per_100g:4, protein_per_100g:2, fat_per_100g:0, tags:["veg"]},
    {name:"Steamed vegetables", kcal_per_100g:35, carbs_per_100g:6, protein_per_100g:3, fat_per_100g:0, tags:["veg"]},
    {name:"Fruit salad", kcal_per_100g:50, carbs_per_100g:12, protein_per_100g:1, fat_per_100g:0, tags:["fruit"]},
    {name:"Whole grain bread", kcal_per_100g:250, carbs_per_100g:45, protein_per_100g:10, fat_per_100g:4, tags:["grain"]},
    {name:"Brown rice", kcal_per_100g:123, carbs_per_100g:26, protein_per_100g:3, fat_per_100g:1, tags:["grain"]},
    {name:"Sweet potato", kcal_per_100g:86, carbs_per_100g:20, protein_per_100g:1.6, fat_per_100g:0.1, tags:["veg","starch"]}
  ],

  balanced_dinner_proteins: [
    {name:"Grilled salmon", kcal_per_100g:206, protein_per_100g:22, carbs_per_100g:0, fat_per_100g:12, tags:["fish"]},
    {name:"Lean beef steak", kcal_per_100g:250, protein_per_100g:26, carbs_per_100g:0, fat_per_100g:15, tags:["meat","beef"]},
    {name:"Baked chicken", kcal_per_100g:165, protein_per_100g:31, carbs_per_100g:0, fat_per_100g:3.6, tags:["meat","chicken"]},
    {name:"Tofu stir fry", kcal_per_100g:145, protein_per_100g:12, carbs_per_100g:5, fat_per_100g:9, tags:["plant"]},
    {name:"Pork tenderloin", kcal_per_100g:143, protein_per_100g:26, carbs_per_100g:0, fat_per_100g:4, tags:["meat","pork"]},
    {name:"Lentil curry", kcal_per_100g:116, protein_per_100g:9, carbs_per_100g:20, fat_per_100g:1, tags:["plant","legume"]}
  ],

  balanced_dinner_sides: [
    {name:"Roasted vegetables", kcal_per_100g:65, carbs_per_100g:12, protein_per_100g:2, fat_per_100g:1, tags:["veg"]},
    {name:"Quinoa pilaf", kcal_per_100g:120, carbs_per_100g:21, protein_per_100g:4, fat_per_100g:2, tags:["grain"]},
    {name:"Mashed potatoes", kcal_per_100g:88, carbs_per_100g:20, protein_per_100g:2, fat_per_100g:0, tags:["starch"]},
    {name:"Steamed broccoli", kcal_per_100g:34, carbs_per_100g:7, protein_per_100g:2.8, fat_per_100g:0.4, tags:["veg"]},
    {name:"Whole wheat pasta", kcal_per_100g:124, carbs_per_100g:25, protein_per_100g:5, fat_per_100g:1, tags:["grain"]},
    {name:"Green beans almondine", kcal_per_100g:85, carbs_per_100g:8, protein_per_100g:3, fat_per_100g:5, tags:["veg","nuts"]}
  ],

  // SNACKS FOR ALL DIETS
  keto_snacks: [
    {name:"Almonds", kcal_per_100g:579, protein_per_100g:21, carbs_per_100g:22, fat_per_100g:50, tags:["nuts"]},
    {name:"Cottage cheese", kcal_per_100g:98, protein_per_100g:11, carbs_per_100g:3, fat_per_100g:4, tags:["dairy"]},
    {name:"String cheese", kcal_per_100g:280, protein_per_100g:25, carbs_per_100g:1, fat_per_100g:20, tags:["dairy"]},
    {name:"Hard boiled egg", kcal_per_100g:155, protein_per_100g:13, carbs_per_100g:1, fat_per_100g:11, tags:["eggs"]},
    {name:"Sunflower seeds", kcal_per_100g:584, protein_per_100g:21, carbs_per_100g:20, fat_per_100g:51, tags:["seeds"]}
  ],

  balanced_snacks: [
    {name:"Apple with peanut butter", kcal_per_100g:150, protein_per_100g:4, carbs_per_100g:18, fat_per_100g:8, tags:["fruit","nuts"]},
    {name:"Greek yogurt", kcal_per_100g:59, protein_per_100g:10, carbs_per_100g:3.6, fat_per_100g:0.4, tags:["dairy"]},
    {name:"Carrot sticks with hummus", kcal_per_100g:120, protein_per_100g:4, carbs_per_100g:12, fat_per_100g:7, tags:["veg","legume"]},
    {name:"Trail mix", kcal_per_100g:460, protein_per_100g:12, carbs_per_100g:45, fat_per_100g:28, tags:["nuts","fruit"]},
    {name:"Rice cakes with avocado", kcal_per_100g:180, protein_per_100g:3, carbs_per_100g:20, fat_per_100g:10, tags:["grain","fruit"]}
  ],

  carnivore_snacks: [
    {name:"Beef jerky", kcal_per_100g:410, protein_per_100g:33, carbs_per_100g:11, fat_per_100g:26, tags:["meat","beef"]},
    {name:"Hard boiled eggs", kcal_per_100g:155, protein_per_100g:13, carbs_per_100g:1.1, fat_per_100g:11, tags:["eggs"]},
    {name:"Pork rinds", kcal_per_100g:615, protein_per_100g:61, carbs_per_100g:0, fat_per_100g:41, tags:["meat","pork"]},
    {name:"Cheese slices", kcal_per_100g:400, protein_per_100g:25, carbs_per_100g:2, fat_per_100g:33, tags:["dairy"]}
  ],

  // BEVERAGES
  beverages: [
    {name:"Water", kcal_per_100g:0, protein_per_100g:0, carbs_per_100g:0, fat_per_100g:0, tags:["beverage"]},
    {name:"Coffee", kcal_per_100g:1, protein_per_100g:0, carbs_per_100g:0, fat_per_100g:0, tags:["beverage"]},
    {name:"Tea", kcal_per_100g:1, protein_per_100g:0, carbs_per_100g:0, fat_per_100g:0, tags:["beverage"]},
    {name:"Milk", kcal_per_100g:61, protein_per_100g:3.3, carbs_per_100g:4.8, fat_per_100g:3.3, tags:["dairy","beverage"]}
  ],

  // VEGETARIAN (existing pools)
  vegetarian_proteins: [
    {name:"Lentils", kcal_per_100g:116, protein_per_100g:9, carbs_per_100g:20, fat_per_100g:0.4, tags:["plant","legume"]},
    {name:"Chickpeas", kcal_per_100g:139, protein_per_100g:7, carbs_per_100g:22, fat_per_100g:2.4, tags:["plant","legume"]},
    {name:"Tofu (firm)", kcal_per_100g:144, protein_per_100g:12, carbs_per_100g:3, fat_per_100g:8, tags:["plant","tofu"]},
    {name:"Tempeh", kcal_per_100g:193, protein_per_100g:19, carbs_per_100g:9, fat_per_100g:11, tags:["plant","tofu"]},
    {name:"Edamame", kcal_per_100g:122, protein_per_100g:11, carbs_per_100g:10, fat_per_100g:5, tags:["plant","soy"]},
    {name:"Greek Yogurt", kcal_per_100g:59, protein_per_100g:10, carbs_per_100g:3.6, fat_per_100g:0.4, tags:["dairy"]},
    {name:"Cottage Cheese", kcal_per_100g:98, protein_per_100g:11, carbs_per_100g:3.4, fat_per_100g:4.3, tags:["dairy"]},
    {name:"Mozzarella", kcal_per_100g:280, protein_per_100g:28, carbs_per_100g:3.1, fat_per_100g:17, tags:["dairy","cheese"]},
    {name:"Eggs", kcal_per_100g:155, protein_per_100g:13, carbs_per_100g:1.1, fat_per_100g:11, tags:["eggs"]},
    {name:"Quinoa", kcal_per_100g:120, protein_per_100g:4.4, carbs_per_100g:21, fat_per_100g:1.9, tags:["grain","plant"]}
  ],
  vegetarian_sides: [
    {name:"Steamed Broccoli", kcal_per_100g:34, carbs_per_100g:7, protein_per_100g:2.8, fat_per_100g:0.4, tags:["veg"]},
    {name:"Roasted Vegetables", kcal_per_100g:65, carbs_per_100g:12, protein_per_100g:2, fat_per_100g:1, tags:["veg"]},
    {name:"Spinach Salad", kcal_per_100g:23, carbs_per_100g:3.6, protein_per_100g:2.9, fat_per_100g:0.4, tags:["veg"]},
    {name:"Sweet Potato", kcal_per_100g:86, carbs_per_100g:20, protein_per_100g:1.6, fat_per_100g:0.1, tags:["veg","starch"]},
    {name:"Brown Rice", kcal_per_100g:123, carbs_per_100g:26, protein_per_100g:2.7, fat_per_100g:1, tags:["grain"]}
  ],
  vegetarian_breakfasts: [
    {name:"Greek Yogurt with Berries", kcal_per_100g:75, protein_per_100g:8, carbs_per_100g:7, fat_per_100g:2, tags:["dairy","fruit"]},
    {name:"Oatmeal with Nuts", kcal_per_100g:130, protein_per_100g:5, carbs_per_100g:20, fat_per_100g:4, tags:["grain","nuts"]},
    {name:"Scrambled Eggs", kcal_per_100g:155, protein_per_100g:13, carbs_per_100g:1.1, fat_per_100g:11, tags:["eggs"]},
    {name:"Avocado Toast", kcal_per_100g:180, protein_per_100g:6, carbs_per_100g:20, fat_per_100g:9, tags:["fruit","grain"]},
    {name:"Cottage Cheese Bowl", kcal_per_100g:98, protein_per_100g:11, carbs_per_100g:3.4, fat_per_100g:4.3, tags:["dairy"]}
  ]
};

/* =============================
   Enhanced Diet & Protein Filters
   ============================= */
function allowedByDietTags(tags, diet){
  const t = (tags || []).map(s => s.toLowerCase());
  
  if (diet === "balanced") return true;
  
  if (diet === "keto") {
    const forbidden = ["grain", "starch", "sugar", "fruit", "high-sugar", "milk", "yogurt", "rice", "bread", "pasta", "noodle", "potato", "oat", "porridge"];
    // Allow high-fat dairy but not high-sugar dairy
    const allowedDairy = ["cheese", "butter", "cream"];
    const hasAllowedDairy = t.some(tag => allowedDairy.includes(tag));
    const hasForbidden = t.some(tag => forbidden.includes(tag));
    return !hasForbidden || hasAllowedDairy;
  }
  
  if (diet === "carnivore") {
    const plant = ["plant", "veg", "vegetable", "vegetarian", "fruit", "grain", "legume", "nuts", "tofu", "rice", "oat", "potato", "bread", "pasta"];
    return !t.some(x => plant.includes(x));
  }
  
  if (diet === "vegetarian") {
    const forbidden = ["meat", "beef", "chicken", "fish", "pork", "bacon", "lamb", "turkey", "poultry", "seafood"];
    return !t.some(x => forbidden.includes(x));
  }
  
  return true;
}

function matchesProteinPref(tags,pref){
  const t=(tags||[]).map(s=>s.toLowerCase());
  if(!pref || pref==="any") return true;
  if(pref==="plant") return t.includes("plant")||t.includes("tofu")||t.includes("nuts");
  if(pref==="beef") return t.includes("beef")||t.includes("meat");
  if(pref==="chicken") return t.includes("chicken")||t.includes("meat");
  if(pref==="fish") return t.includes("fish");
  if(pref==="eggs") return t.includes("eggs");
  return true;
}

/* age multiplier */
function ageCategory(age){ const a=Number(age)||30; if(a<=12) return "child"; if(a<=19) return "teen"; if(a<=59) return "adult"; return "senior"; }
function agePortionMultiplier(cat){ if(cat==="child") return 0.7; if(cat==="teen") return 1.05; if(cat==="senior") return 0.9; return 1.0; }

/* grams for target */
function gramsForTarget(kcalPer100g, mealKcal){ if(!kcalPer100g || kcalPer100g<=0) return Math.max(1,Math.round(100*(mealKcal/200))); const grams = (mealKcal / kcalPer100g) * 100; return Math.max(1,Math.round(grams)); }

/* =============================
   Corrected Macro Splits for Each Diet
   ============================= */
function macroSplits(diet, goal){
  // Return {p, c, f} as fractions of total calories
  
  if (diet === "balanced") {
    if (goal === "lose") return { p: 0.35, c: 0.35, f: 0.30 };      // 35% protein, 35% carbs, 30% fat
    if (goal === "gain") return { p: 0.30, c: 0.45, f: 0.25 };      // 30% protein, 45% carbs, 25% fat
    return { p: 0.25, c: 0.45, f: 0.30 };                          // 25% protein, 45% carbs, 30% fat (maintain)
  }
  
  if (diet === "keto") {
    // Keto: Very low carb, moderate protein, high fat
    if (goal === "lose") return { p: 0.25, c: 0.05, f: 0.70 };     // 25% protein, 5% carbs, 70% fat
    if (goal === "gain") return { p: 0.20, c: 0.05, f: 0.75 };     // 20% protein, 5% carbs, 75% fat
    return { p: 0.20, c: 0.05, f: 0.75 };                          // 20% protein, 5% carbs, 75% fat (maintain)
  }
  
  if (diet === "carnivore") {
    // Carnivore: Mostly protein and fat, minimal to no carbs
    if (goal === "lose") return { p: 0.35, c: 0.02, f: 0.63 };     // 35% protein, 2% carbs, 63% fat
    if (goal === "gain") return { p: 0.30, c: 0.03, f: 0.67 };     // 30% protein, 3% carbs, 67% fat
    return { p: 0.30, c: 0.02, f: 0.68 };                          // 30% protein, 2% carbs, 68% fat (maintain)
  }
  
  if (diet === "vegetarian") {
    // Vegetarian: Balanced with plant-based focus
    if (goal === "lose") return { p: 0.35, c: 0.35, f: 0.30 };     // 35% protein, 35% carbs, 30% fat
    if (goal === "gain") return { p: 0.25, c: 0.50, f: 0.25 };     // 25% protein, 50% carbs, 25% fat
    return { p: 0.30, c: 0.45, f: 0.25 };                          // 30% protein, 45% carbs, 25% fat (maintain)
  }
  
  return { p: 0.30, c: 0.40, f: 0.30 }; // Fallback
}

/* =============================
   Enhanced Food Picking with Diet Awareness
   ============================= */
function getDietFallbackFood(diet, proteinPref) {
  const fallbacks = {
    keto: { name: "Avocado", kcal: 160, protein: 2, carbs: 9, fat: 15, tags: ["fat", "fruit"] },
    carnivore: { name: "Ground Beef", kcal: 250, protein: 26, carbs: 0, fat: 17, tags: ["meat", "beef"] },
    vegetarian: { name: "Tofu", kcal: 144, protein: 12, carbs: 3, fat: 8, tags: ["plant", "tofu"] },
    balanced: { name: "Chicken Breast", kcal: 165, protein: 31, carbs: 0, fat: 3.6, tags: ["meat", "chicken"] }
  };
  
  return mapItem(fallbacks[diet] || fallbacks.balanced);
}

async function pickFoodByName(prefName, fallbackPool, opts, usedNames){
  const { diet, protein } = opts;
  
  // Try explicit search first
  const results = prefName ? await searchNutrition(prefName) : [];
  
  if (results && results.length) {
    // Filter by diet rules AND protein preference
    const filtered = results.filter(r => 
      allowedByDietTags(r.tags, diet) && 
      matchesProteinPref(r.tags, protein) && 
      !usedNames.has(r.name)
    );
    
    if (filtered.length) {
      // Prioritize foods that better match the diet
      const scored = filtered.map(item => {
        let score = item._score || 0;
        
        // Bonus points for diet-appropriate foods
        if (diet === "keto" && (item.tags.includes("fat") || item.fat_per_100g > 15)) score += 20;
        if (diet === "carnivore" && (item.tags.includes("meat") || item.tags.includes("fish"))) score += 30;
        if (diet === "vegetarian" && !item.tags.some(t => ["meat", "fish"].includes(t))) score += 25;
        if (diet === "balanced" && item.tags.some(t => ["grain", "fruit", "veg"].includes(t))) score += 15;
        
        return { item, score };
      }).sort((a, b) => b.score - a.score);
      
      return scored[0].item;
    }
  }
  
  // Fallback to appropriate pool
  let dietAwarePool = fallbackPool || [];
  
  // Use diet-specific pools
  if (diet === "keto") {
    if (fallbackPool === POOLS.proteins) dietAwarePool = POOLS.keto_lunch_proteins;
    else if (fallbackPool === POOLS.sides) dietAwarePool = POOLS.keto_lunch_sides;
    else if (fallbackPool === POOLS.breakfasts) dietAwarePool = POOLS.keto_breakfasts;
  } else if (diet === "carnivore") {
    dietAwarePool = POOLS.carnivore_proteins;
  } else if (diet === "balanced") {
    if (fallbackPool === POOLS.proteins) dietAwarePool = POOLS.balanced_lunch_proteins;
    else if (fallbackPool === POOLS.sides) dietAwarePool = POOLS.balanced_lunch_sides;
    else if (fallbackPool === POOLS.breakfasts) dietAwarePool = POOLS.balanced_breakfasts;
  } else if (diet === "vegetarian") {
    if (fallbackPool === POOLS.proteins) dietAwarePool = POOLS.vegetarian_proteins;
    else if (fallbackPool === POOLS.sides) dietAwarePool = POOLS.vegetarian_sides;
    else if (fallbackPool === POOLS.breakfasts) dietAwarePool = POOLS.vegetarian_breakfasts;
  }
  
  const candidates = dietAwarePool.filter(p => 
    allowedByDietTags(p.tags || [], diet) && 
    matchesProteinPref(p.tags || [], protein)
  );
  
  if (candidates.length) {
    const available = candidates.filter(p => !usedNames.has(p.name));
    const pick = available.length ? 
      available[Math.floor(Math.random() * available.length)] : 
      candidates[Math.floor(Math.random() * candidates.length)];
    
    return mapItem({
      name: pick.name, 
      kcal: pick.kcal_per_100g || pick.kcal, 
      protein: pick.protein_per_100g || pick.protein, 
      carbs: pick.carbs_per_100g || pick.carbs, 
      fat: pick.fat_per_100g || pick.fat, 
      tags: pick.tags
    });
  }
  
  // Ultimate fallback
  return getDietFallbackFood(diet, protein);
}

/* =============================
   Get parameters from calorie-guide page
   ============================= */
function getParamsFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const tdee = urlParams.get('tdee');
  const age = urlParams.get('age');
  const goal = urlParams.get('goal');
  const diet = urlParams.get('diet');
  const protein = urlParams.get('protein');
  
  if (tdee) {
    document.getElementById('tdeeInput').value = tdee;
  }
  if (age) {
    document.getElementById('ageInput').value = age;
  }
  if (goal) {
    document.getElementById('goalSelect').value = goal;
  }
  if (diet) {
    // Map from calorie-guide values to meal-plan values
    const dietMap = {
      'normal': 'balanced',
      'keto': 'keto', 
      'carnivore': 'carnivore',
      'vegetarian': 'vegetarian'
    };
    document.getElementById('dietSelect').value = dietMap[diet] || 'balanced';
  }
  if (protein) {
    document.getElementById('proteinSelect').value = protein;
  }
}

// Also check localStorage for recent values
function getParamsFromStorage() {
  try {
    const recentTDEE = localStorage.getItem('convertlabs_recent_tdee');
    const recentAge = localStorage.getItem('convertlabs_recent_age');
    const recentGoal = localStorage.getItem('convertlabs_recent_goal');
    const recentDiet = localStorage.getItem('convertlabs_recent_diet');
    const recentProtein = localStorage.getItem('convertlabs_recent_protein');
    
    if (recentTDEE && !document.getElementById('tdeeInput').value) {
      document.getElementById('tdeeInput').value = recentTDEE;
    }
    if (recentAge && !document.getElementById('ageInput').value) {
      document.getElementById('ageInput').value = recentAge;
    }
    if (recentGoal && !document.getElementById('goalSelect').value) {
      document.getElementById('goalSelect').value = recentGoal;
    }
    if (recentDiet && !document.getElementById('dietSelect').value) {
      document.getElementById('dietSelect').value = recentDiet;
    }
    if (recentProtein && !document.getElementById('proteinSelect').value) {
      document.getElementById('proteinSelect').value = recentProtein;
    }
  } catch (e) {
    console.warn('Could not access localStorage:', e);
  }
}

// Save values when generating plan
function saveCurrentParams() {
  try {
    const tdee = document.getElementById('tdeeInput').value;
    const age = document.getElementById('ageInput').value;
    const goal = document.getElementById('goalSelect').value;
    const diet = document.getElementById('dietSelect').value;
    const protein = document.getElementById('proteinSelect').value;
    
    if (tdee) localStorage.setItem('convertlabs_recent_tdee', tdee);
    if (age) localStorage.setItem('convertlabs_recent_age', age);
    if (goal) localStorage.setItem('convertlabs_recent_goal', goal);
    if (diet) localStorage.setItem('convertlabs_recent_diet', diet);
    if (protein) localStorage.setItem('convertlabs_recent_protein', protein);
  } catch (e) {
    console.warn('Could not save to localStorage:', e);
  }
}

/* =============================
   Enhanced Plan Generation for All Diet Types - FIXED
   ============================= */
const DEFAULT_SPLITS = { breakfast:0.25, lunch:0.35, dinner:0.30, snack:0.10 };

// Helper function for meal nutrition calculation
function calculateMealNutrition(parts) {
  return parts.reduce((acc, part) => {
    const ratio = part.grams / 100;
    const foodItem = part.source || part;
    return {
      kcal: acc.kcal + Math.round((part.per100 || 100) * ratio),
      protein: acc.protein + Math.round((foodItem.protein_per_100g || foodItem.protein || 0) * ratio),
      carbs: acc.carbs + Math.round((foodItem.carbs_per_100g || foodItem.carbs || 0) * ratio),
      fat: acc.fat + Math.round((foodItem.fat_per_100g || foodItem.fat || 0) * ratio)
    };
  }, {kcal: 0, protein: 0, carbs: 0, fat: 0});
}

// Helper to ensure keto macro ratios
function adjustKetoRatios(parts, targetFatPct = 0.70, targetProteinPct = 0.25, targetCarbsPct = 0.05) {
  const current = calculateMealNutrition(parts);
  const totalKcal = current.kcal;
  
  if (totalKcal === 0) return parts;
  
  const currentFatPct = (current.fat * 9) / totalKcal;
  const currentProteinPct = (current.protein * 4) / totalKcal;
  const currentCarbsPct = (current.carbs * 4) / totalKcal;
  
  // If ratios are way off, adjust high-carb items
  if (currentCarbsPct > targetCarbsPct + 0.05) {
    parts.forEach(part => {
      if (part.carbs_per_100g > 5) {
        // Reduce high-carb items
        part.grams = Math.max(10, Math.round(part.grams * 0.7));
      }
    });
  }
  
  // Increase high-fat items if needed
  if (currentFatPct < targetFatPct - 0.05) {
    parts.forEach(part => {
      if (part.fat_per_100g > 15) {
        part.grams = Math.round(part.grams * 1.3);
      }
    });
  }
  
  return parts;
}

async function generatePlanAsync(opts){
  await loadLite();
  await loadUsda();
  const baseInput = Math.max(800, Number(opts.tdee) || 2000);
  let targetTdee;
  if(opts.inputIsAlreadyAdjusted) targetTdee = baseInput;
  else {
    if(opts.goal === "lose") targetTdee = Math.max(800, baseInput - 300);
    else if(opts.goal === "gain") targetTdee = baseInput + 300;
    else targetTdee = baseInput;
  }

  const age = Number(opts.age) || 30;
  const diet = opts.diet || "balanced";
  const proteinPref = opts.protein || "any";
  const mult = agePortionMultiplier(ageCategory(age));
  
  // Adjust splits based on diet
  let splits;
  if (diet === "keto") {
    splits = { breakfast: 0.20, lunch: 0.35, dinner: 0.35, snack: 0.10 };
  } else if (diet === "carnivore") {
    splits = { breakfast: 0.25, lunch: 0.40, dinner: 0.30, snack: 0.05 };
  } else {
    splits = { breakfast: 0.25, lunch: 0.35, dinner: 0.30, snack: 0.10 };
  }

  const plan = [];

  for(let day=1; day<=7; day++){
    const isFreeDay = (opts.freeDay === true && day === (opts.freeDayIndex || 2));
    const dailyTDEE = Math.round(targetTdee);
    const dayTarget = isFreeDay ? Math.round(dailyTDEE * 1.15) : dailyTDEE;

    const macroTarget = macroSplits(diet, opts.goal || 'maintain');
    const targetP_kcal = Math.round(dayTarget * macroTarget.p);
    const targetC_kcal = Math.round(dayTarget * macroTarget.c);
    const targetF_kcal = Math.round(dayTarget * macroTarget.f);

    const bK = Math.round(dayTarget * splits.breakfast);
    const lK = Math.round(dayTarget * splits.lunch);
    const dK = Math.round(dayTarget * splits.dinner);
    const sK = Math.round(dayTarget * splits.snack);

    const usedNames = new Set();

    // DIET-SPECIFIC MEAL GENERATION
    if (diet === "carnivore") {
      // CARNIVORE DIET - Only animal products + water (RICH COMPONENTS)
      const breakfastMeat1 = await pickFoodByName(null, POOLS.carnivore_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(breakfastMeat1.name);
      const breakfastMeat2 = await pickFoodByName(null, POOLS.carnivore_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(breakfastMeat2.name);
      
      const lunchMeat1 = await pickFoodByName(null, POOLS.carnivore_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchMeat1.name);
      const lunchMeat2 = await pickFoodByName(null, POOLS.carnivore_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchMeat2.name);
      
      const dinnerMeat1 = await pickFoodByName(null, POOLS.carnivore_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerMeat1.name);
      const dinnerMeat2 = await pickFoodByName(null, POOLS.carnivore_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerMeat2.name);
      
      // Carnivore snacks
      const snack1 = await pickFoodByName(null, POOLS.carnivore_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(snack1.name);
      const snack2 = await pickFoodByName(null, POOLS.carnivore_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(snack2.name);

      // Water for all meals
      const water = POOLS.beverages.find(b => b.name === "Water");

      // Calculate portions - distribute across multiple components
      const bfGram1 = gramsForTarget(breakfastMeat1.kcal_per_100g || 250, bK * 0.6);
      const bfGram2 = gramsForTarget(breakfastMeat2.kcal_per_100g || 250, bK * 0.4);

      const lunchGram1 = gramsForTarget(lunchMeat1.kcal_per_100g || 250, lK * 0.5);
      const lunchGram2 = gramsForTarget(lunchMeat2.kcal_per_100g || 250, lK * 0.5);

      const dinnerGram1 = gramsForTarget(dinnerMeat1.kcal_per_100g || 250, dK * 0.5);
      const dinnerGram2 = gramsForTarget(dinnerMeat2.kcal_per_100g || 250, dK * 0.5);

      const snack1Gram = gramsForTarget(snack1.kcal_per_100g || 200, sK * 0.6);
      const snack2Gram = gramsForTarget(snack2.kcal_per_100g || 200, sK * 0.4);

      // Build meal parts with multiple components
      const breakfastParts = [
        {name: breakfastMeat1.name, per100: breakfastMeat1.kcal_per_100g || 250, grams: bfGram1, type: "meat", source: breakfastMeat1},
        {name: breakfastMeat2.name, per100: breakfastMeat2.kcal_per_100g || 250, grams: bfGram2, type: "meat", source: breakfastMeat2},
        {name: water.name, per100: water.kcal_per_100g, grams: 240, type: "beverage", source: water}
      ];

      const lunchParts = [
        {name: lunchMeat1.name, per100: lunchMeat1.kcal_per_100g || 250, grams: lunchGram1, type: "meat", source: lunchMeat1},
        {name: lunchMeat2.name, per100: lunchMeat2.kcal_per_100g || 250, grams: lunchGram2, type: "meat", source: lunchMeat2},
        {name: water.name, per100: water.kcal_per_100g, grams: 240, type: "beverage", source: water}
      ];

      const dinnerParts = [
        {name: dinnerMeat1.name, per100: dinnerMeat1.kcal_per_100g || 250, grams: dinnerGram1, type: "meat", source: dinnerMeat1},
        {name: dinnerMeat2.name, per100: dinnerMeat2.kcal_per_100g || 250, grams: dinnerGram2, type: "meat", source: dinnerMeat2},
        {name: water.name, per100: water.kcal_per_100g, grams: 240, type: "beverage", source: water}
      ];

      const snackParts = [
        {name: snack1.name, per100: snack1.kcal_per_100g || 200, grams: snack1Gram, type: "snack", source: snack1},
        {name: snack2.name, per100: snack2.kcal_per_100g || 200, grams: snack2Gram, type: "snack", source: snack2}
      ];

      // Calculate nutrition
      const breakfastNutrition = calculateMealNutrition(breakfastParts);
      const lunchNutrition = calculateMealNutrition(lunchParts);
      const dinnerNutrition = calculateMealNutrition(dinnerParts);
      const snackNutrition = calculateMealNutrition(snackParts);

      plan.push({
        day,
        free: !!isFreeDay,
        breakfast: { 
          text: `${breakfastMeat1.name} + ${breakfastMeat2.name} + Water`,
          parts: breakfastParts,
          kcal: breakfastNutrition.kcal
        },
        lunch: { 
          text: `${lunchMeat1.name} + ${lunchMeat2.name} + Water`,
          parts: lunchParts,
          kcal: lunchNutrition.kcal
        },
        dinner: { 
          text: `${dinnerMeat1.name} + ${dinnerMeat2.name} + Water`,
          parts: dinnerParts,
          kcal: dinnerNutrition.kcal
        },
        snack: { 
          text: `${snack1.name} + ${snack2.name}`,
          parts: snackParts,
          kcal: snackNutrition.kcal
        },
        meta: { target: dayTarget, age, diet, protein: proteinPref, splits, macroTarget }
      });

    } else if (diet === "keto") {
      // KETO DIET - Multiple components with STRICT macro control
      const breakfastMain = await pickFoodByName(null, POOLS.keto_breakfasts, {diet,protein:proteinPref}, usedNames);
      usedNames.add(breakfastMain.name);
      const breakfastFat = await pickFoodByName("avocado", POOLS.keto_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(breakfastFat.name);
      const breakfastBeverage = await pickFoodByName(null, POOLS.beverages, {diet,protein:proteinPref}, usedNames);

      const lunchProtein = await pickFoodByName(null, POOLS.keto_lunch_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchProtein.name);
      const lunchVeg = await pickFoodByName(null, POOLS.keto_lunch_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchVeg.name);
      const lunchFat = await pickFoodByName("olive oil", POOLS.keto_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchFat.name);
      const lunchDressing = await pickFoodByName(null, POOLS.keto_lunch_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchDressing.name);

      const dinnerProtein = await pickFoodByName(null, POOLS.keto_dinner_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerProtein.name);
      const dinnerVeg = await pickFoodByName(null, POOLS.keto_dinner_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerVeg.name);
      const dinnerFat = await pickFoodByName("butter", POOLS.keto_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerFat.name);
      const dinnerSauce = await pickFoodByName(null, POOLS.keto_dinner_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerSauce.name);

      const snack1 = await pickFoodByName("almonds", POOLS.keto_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(snack1.name);
      const snack2 = await pickFoodByName("cheese", POOLS.keto_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(snack2.name);

      // Calculate portions with keto macro focus (70% fat, 25% protein, 5% carbs)
      const bfMainGram = gramsForTarget(breakfastMain.kcal_per_100g || 120, bK * 0.4);
      const bfFatGram = gramsForTarget(breakfastFat.kcal_per_100g || 160, bK * 0.5);
      const beverageGram = gramsForTarget(breakfastBeverage.kcal_per_100g || 10, bK * 0.1);

      const lunchProteinGram = gramsForTarget(lunchProtein.kcal_per_100g || 150, lK * 0.25);
      const lunchVegGram = gramsForTarget(lunchVeg.kcal_per_100g || 30, lK * 0.05);
      const lunchFatGram = gramsForTarget(lunchFat.kcal_per_100g || 884, lK * 0.65);
      const lunchDressingGram = gramsForTarget(lunchDressing.kcal_per_100g || 45, lK * 0.05);

      const dinnerProteinGram = gramsForTarget(dinnerProtein.kcal_per_100g || 180, dK * 0.25);
      const dinnerVegGram = gramsForTarget(dinnerVeg.kcal_per_100g || 35, dK * 0.05);
      const dinnerFatGram = gramsForTarget(dinnerFat.kcal_per_100g || 717, dK * 0.65);
      const dinnerSauceGram = gramsForTarget(dinnerSauce.kcal_per_100g || 45, dK * 0.05);

      const snack1Gram = gramsForTarget(snack1.kcal_per_100g || 579, sK * 0.5);
      const snack2Gram = gramsForTarget(snack2.kcal_per_100g || 400, sK * 0.5);

      // Build meal structure with multiple components
      const breakfastParts = [
        {name: breakfastMain.name, per100: breakfastMain.kcal_per_100g || 120, grams: bfMainGram, type: "main", source: breakfastMain},
        {name: breakfastFat.name, per100: breakfastFat.kcal_per_100g || 160, grams: bfFatGram, type: "fat", source: breakfastFat},
        {name: breakfastBeverage.name, per100: breakfastBeverage.kcal_per_100g || 10, grams: beverageGram, type: "beverage", source: breakfastBeverage}
      ];

      const lunchParts = [
        {name: lunchProtein.name, per100: lunchProtein.kcal_per_100g || 150, grams: lunchProteinGram, type: "protein", source: lunchProtein},
        {name: lunchVeg.name, per100: lunchVeg.kcal_per_100g || 30, grams: lunchVegGram, type: "vegetable", source: lunchVeg},
        {name: lunchFat.name, per100: lunchFat.kcal_per_100g || 884, grams: lunchFatGram, type: "fat", source: lunchFat},
        {name: lunchDressing.name, per100: lunchDressing.kcal_per_100g || 45, grams: lunchDressingGram, type: "dressing", source: lunchDressing}
      ];

      const dinnerParts = [
        {name: dinnerProtein.name, per100: dinnerProtein.kcal_per_100g || 180, grams: dinnerProteinGram, type: "protein", source: dinnerProtein},
        {name: dinnerVeg.name, per100: dinnerVeg.kcal_per_100g || 35, grams: dinnerVegGram, type: "vegetable", source: dinnerVeg},
        {name: dinnerFat.name, per100: dinnerFat.kcal_per_100g || 717, grams: dinnerFatGram, type: "fat", source: dinnerFat},
        {name: dinnerSauce.name, per100: dinnerSauce.kcal_per_100g || 45, grams: dinnerSauceGram, type: "sauce", source: dinnerSauce}
      ];

      const snackParts = [
        {name: snack1.name, per100: snack1.kcal_per_100g || 579, grams: snack1Gram, type: "snack", source: snack1},
        {name: snack2.name, per100: snack2.kcal_per_100g || 400, grams: snack2Gram, type: "snack", source: snack2}
      ];

      // Apply keto ratio adjustments
      const adjustedBreakfastParts = adjustKetoRatios(breakfastParts);
      const adjustedLunchParts = adjustKetoRatios(lunchParts);
      const adjustedDinnerParts = adjustKetoRatios(dinnerParts);
      const adjustedSnackParts = adjustKetoRatios(snackParts);

      const breakfastNutrition = calculateMealNutrition(adjustedBreakfastParts);
      const lunchNutrition = calculateMealNutrition(adjustedLunchParts);
      const dinnerNutrition = calculateMealNutrition(adjustedDinnerParts);
      const snackNutrition = calculateMealNutrition(adjustedSnackParts);

      plan.push({
        day,
        free: !!isFreeDay,
        breakfast: { 
          text: `${breakfastMain.name} with ${breakfastFat.name}`,
          parts: adjustedBreakfastParts,
          kcal: breakfastNutrition.kcal
        },
        lunch: { 
          text: `${lunchProtein.name} salad with ${lunchVeg.name} and ${lunchFat.name} dressing`,
          parts: adjustedLunchParts,
          kcal: lunchNutrition.kcal
        },
        dinner: { 
          text: `${dinnerProtein.name} with ${dinnerVeg.name} and ${dinnerFat.name} sauce`,
          parts: adjustedDinnerParts,
          kcal: dinnerNutrition.kcal
        },
        snack: { 
          text: `${snack1.name} and ${snack2.name}`,
          parts: adjustedSnackParts,
          kcal: snackNutrition.kcal
        },
        meta: { target: dayTarget, age, diet, protein: proteinPref, splits, macroTarget }
      });

    } else if (diet === "balanced") {
      // BALANCED DIET - Multiple components with normal portions (RICH COMPONENTS)
      const breakfastMain = await pickFoodByName(null, POOLS.balanced_breakfasts, {diet,protein:proteinPref}, usedNames);
      usedNames.add(breakfastMain.name);
      const breakfastFruit = await pickFoodByName("berries", POOLS.balanced_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(breakfastFruit.name);
      const breakfastBeverage = await pickFoodByName("milk", POOLS.beverages, {diet,protein:proteinPref}, usedNames);
      usedNames.add(breakfastBeverage.name);

      const lunchProtein = await pickFoodByName(null, POOLS.balanced_lunch_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchProtein.name);
      const lunchGrain = await pickFoodByName("brown rice", POOLS.balanced_lunch_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchGrain.name);
      const lunchVeg = await pickFoodByName(null, POOLS.balanced_lunch_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchVeg.name);
      const lunchSalad = await pickFoodByName("mixed greens", POOLS.balanced_lunch_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchSalad.name);

      const dinnerProtein = await pickFoodByName(null, POOLS.balanced_dinner_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerProtein.name);
      const dinnerStarch = await pickFoodByName(null, POOLS.balanced_dinner_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerStarch.name);
      const dinnerVeg = await pickFoodByName(null, POOLS.balanced_dinner_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerVeg.name);
      const dinnerSauce = await pickFoodByName(null, POOLS.balanced_dinner_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerSauce.name);

      const snack1 = await pickFoodByName(null, POOLS.balanced_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(snack1.name);
      const snack2 = await pickFoodByName(null, POOLS.balanced_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(snack2.name);

      // Calculate normal portions for balanced diet
      const bfMainGram = gramsForTarget(breakfastMain.kcal_per_100g || 150, bK * 0.6);
      const bfFruitGram = gramsForTarget(breakfastFruit.kcal_per_100g || 50, bK * 0.2);
      const beverageGram = gramsForTarget(breakfastBeverage.kcal_per_100g || 61, bK * 0.2);

      const lunchProteinGram = gramsForTarget(lunchProtein.kcal_per_100g || 180, lK * 0.4);
      const lunchGrainGram = gramsForTarget(lunchGrain.kcal_per_100g || 123, lK * 0.3);
      const lunchVegGram = gramsForTarget(lunchVeg.kcal_per_100g || 35, lK * 0.2);
      const lunchSaladGram = gramsForTarget(lunchSalad.kcal_per_100g || 25, lK * 0.1);

      const dinnerProteinGram = gramsForTarget(dinnerProtein.kcal_per_100g || 200, dK * 0.4);
      const dinnerStarchGram = gramsForTarget(dinnerStarch.kcal_per_100g || 88, dK * 0.3);
      const dinnerVegGram = gramsForTarget(dinnerVeg.kcal_per_100g || 65, dK * 0.2);
      const dinnerSauceGram = gramsForTarget(dinnerSauce.kcal_per_100g || 45, dK * 0.1);

      const snack1Gram = gramsForTarget(snack1.kcal_per_100g || 120, sK * 0.6);
      const snack2Gram = gramsForTarget(snack2.kcal_per_100g || 120, sK * 0.4);

      // Build meal structure with multiple components
      const breakfastParts = [
        {name: breakfastMain.name, per100: breakfastMain.kcal_per_100g || 150, grams: bfMainGram, type: "main", source: breakfastMain},
        {name: breakfastFruit.name, per100: breakfastFruit.kcal_per_100g || 50, grams: bfFruitGram, type: "fruit", source: breakfastFruit},
        {name: breakfastBeverage.name, per100: breakfastBeverage.kcal_per_100g || 61, grams: beverageGram, type: "beverage", source: breakfastBeverage}
      ];

      const lunchParts = [
        {name: lunchProtein.name, per100: lunchProtein.kcal_per_100g || 180, grams: lunchProteinGram, type: "protein", source: lunchProtein},
        {name: lunchGrain.name, per100: lunchGrain.kcal_per_100g || 123, grams: lunchGrainGram, type: "grain", source: lunchGrain},
        {name: lunchVeg.name, per100: lunchVeg.kcal_per_100g || 35, grams: lunchVegGram, type: "vegetable", source: lunchVeg},
        {name: lunchSalad.name, per100: lunchSalad.kcal_per_100g || 25, grams: lunchSaladGram, type: "salad", source: lunchSalad}
      ];

      const dinnerParts = [
        {name: dinnerProtein.name, per100: dinnerProtein.kcal_per_100g || 200, grams: dinnerProteinGram, type: "protein", source: dinnerProtein},
        {name: dinnerStarch.name, per100: dinnerStarch.kcal_per_100g || 88, grams: dinnerStarchGram, type: "starch", source: dinnerStarch},
        {name: dinnerVeg.name, per100: dinnerVeg.kcal_per_100g || 65, grams: dinnerVegGram, type: "vegetable", source: dinnerVeg},
        {name: dinnerSauce.name, per100: dinnerSauce.kcal_per_100g || 45, grams: dinnerSauceGram, type: "sauce", source: dinnerSauce}
      ];

      const snackParts = [
        {name: snack1.name, per100: snack1.kcal_per_100g || 120, grams: snack1Gram, type: "snack", source: snack1},
        {name: snack2.name, per100: snack2.kcal_per_100g || 120, grams: snack2Gram, type: "snack", source: snack2}
      ];

      const breakfastNutrition = calculateMealNutrition(breakfastParts);
      const lunchNutrition = calculateMealNutrition(lunchParts);
      const dinnerNutrition = calculateMealNutrition(dinnerParts);
      const snackNutrition = calculateMealNutrition(snackParts);

      plan.push({
        day,
        free: !!isFreeDay,
        breakfast: { 
          text: `${breakfastMain.name} with ${breakfastFruit.name}`,
          parts: breakfastParts,
          kcal: breakfastNutrition.kcal
        },
        lunch: { 
          text: `${lunchProtein.name} with ${lunchGrain.name}, ${lunchVeg.name}, and salad`,
          parts: lunchParts,
          kcal: lunchNutrition.kcal
        },
        dinner: { 
          text: `${dinnerProtein.name} with ${dinnerStarch.name}, ${dinnerVeg.name}, and sauce`,
          parts: dinnerParts,
          kcal: dinnerNutrition.kcal
        },
        snack: { 
          text: `${snack1.name} and ${snack2.name}`,
          parts: snackParts,
          kcal: snackNutrition.kcal
        },
        meta: { target: dayTarget, age, diet, protein: proteinPref, splits, macroTarget }
      });

    } else {
      // VEGETARIAN DIET - Multiple components
      const breakfastMain = await pickFoodByName(null, POOLS.vegetarian_breakfasts, {diet,protein:proteinPref}, usedNames);
      usedNames.add(breakfastMain.name);
      const breakfastFruit = await pickFoodByName("berries", POOLS.balanced_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(breakfastFruit.name);
      const breakfastBeverage = await pickFoodByName("milk", POOLS.beverages, {diet,protein:proteinPref}, usedNames);

      const lunchProtein = await pickFoodByName(null, POOLS.vegetarian_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchProtein.name);
      const lunchGrain = await pickFoodByName("quinoa", POOLS.vegetarian_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchGrain.name);
      const lunchVeg = await pickFoodByName(null, POOLS.vegetarian_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(lunchVeg.name);

      const dinnerProtein = await pickFoodByName(null, POOLS.vegetarian_proteins, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerProtein.name);
      const dinnerStarch = await pickFoodByName("sweet potato", POOLS.vegetarian_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerStarch.name);
      const dinnerVeg = await pickFoodByName(null, POOLS.vegetarian_sides, {diet,protein:proteinPref}, usedNames);
      usedNames.add(dinnerVeg.name);

      const snack1 = await pickFoodByName(null, POOLS.balanced_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(snack1.name);
      const snack2 = await pickFoodByName(null, POOLS.balanced_snacks, {diet,protein:proteinPref}, usedNames);
      usedNames.add(snack2.name);

      // Calculate portions
      const bfMainGram = gramsForTarget(breakfastMain.kcal_per_100g || 120, bK * 0.7);
      const bfFruitGram = gramsForTarget(breakfastFruit.kcal_per_100g || 50, bK * 0.2);
      const beverageGram = gramsForTarget(breakfastBeverage.kcal_per_100g || 61, bK * 0.1);

      const lunchProteinGram = gramsForTarget(lunchProtein.kcal_per_100g || 180, lK * 0.4);
      const lunchGrainGram = gramsForTarget(lunchGrain.kcal_per_100g || 120, lK * 0.4);
      const lunchVegGram = gramsForTarget(lunchVeg.kcal_per_100g || 35, lK * 0.2);

      const dinnerProteinGram = gramsForTarget(dinnerProtein.kcal_per_100g || 200, dK * 0.4);
      const dinnerStarchGram = gramsForTarget(dinnerStarch.kcal_per_100g || 86, dK * 0.4);
      const dinnerVegGram = gramsForTarget(dinnerVeg.kcal_per_100g || 65, dK * 0.2);

      const snack1Gram = gramsForTarget(snack1.kcal_per_100g || 120, sK * 0.6);
      const snack2Gram = gramsForTarget(snack2.kcal_per_100g || 120, sK * 0.4);

      // Build meal parts
      const breakfastParts = [
        {name: breakfastMain.name, per100: breakfastMain.kcal_per_100g || 120, grams: bfMainGram, type: "main", source: breakfastMain},
        {name: breakfastFruit.name, per100: breakfastFruit.kcal_per_100g || 50, grams: bfFruitGram, type: "fruit", source: breakfastFruit},
        {name: breakfastBeverage.name, per100: breakfastBeverage.kcal_per_100g || 61, grams: beverageGram, type: "beverage", source: breakfastBeverage}
      ];

      const lunchParts = [
        {name: lunchProtein.name, per100: lunchProtein.kcal_per_100g || 180, grams: lunchProteinGram, type: "protein", source: lunchProtein},
        {name: lunchGrain.name, per100: lunchGrain.kcal_per_100g || 120, grams: lunchGrainGram, type: "grain", source: lunchGrain},
        {name: lunchVeg.name, per100: lunchVeg.kcal_per_100g || 35, grams: lunchVegGram, type: "vegetable", source: lunchVeg}
      ];

      const dinnerParts = [
        {name: dinnerProtein.name, per100: dinnerProtein.kcal_per_100g || 200, grams: dinnerProteinGram, type: "protein", source: dinnerProtein},
        {name: dinnerStarch.name, per100: dinnerStarch.kcal_per_100g || 86, grams: dinnerStarchGram, type: "starch", source: dinnerStarch},
        {name: dinnerVeg.name, per100: dinnerVeg.kcal_per_100g || 65, grams: dinnerVegGram, type: "vegetable", source: dinnerVeg}
      ];

      const snackParts = [
        {name: snack1.name, per100: snack1.kcal_per_100g || 120, grams: snack1Gram, type: "snack", source: snack1},
        {name: snack2.name, per100: snack2.kcal_per_100g || 120, grams: snack2Gram, type: "snack", source: snack2}
      ];

      const breakfastNutrition = calculateMealNutrition(breakfastParts);
      const lunchNutrition = calculateMealNutrition(lunchParts);
      const dinnerNutrition = calculateMealNutrition(dinnerParts);
      const snackNutrition = calculateMealNutrition(snackParts);

      plan.push({
        day,
        free: !!isFreeDay,
        breakfast: { 
          text: `${breakfastMain.name} with ${breakfastFruit.name}`,
          parts: breakfastParts,
          kcal: breakfastNutrition.kcal
        },
        lunch: { 
          text: `${lunchProtein.name} with ${lunchGrain.name} and ${lunchVeg.name}`,
          parts: lunchParts,
          kcal: lunchNutrition.kcal
        },
        dinner: { 
          text: `${dinnerProtein.name} with ${dinnerStarch.name} and ${dinnerVeg.name}`,
          parts: dinnerParts,
          kcal: dinnerNutrition.kcal
        },
        snack: { 
          text: `${snack1.name} and ${snack2.name}`,
          parts: snackParts,
          kcal: snackNutrition.kcal
        },
        meta: { target: dayTarget, age, diet, protein: proteinPref, splits, macroTarget }
      });
    }
  }

  return plan;
}

/* =============================
   Storage helpers
   ============================= */
function savePlan(plan, startDateISO){ try{ localStorage.setItem(KEY, JSON.stringify({ plan, startDate: startDateISO || new Date().toISOString() })); }catch(e){console.warn(e)} }
function loadPlan(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){return null;} }
function deletePlan(){ localStorage.removeItem(KEY); localStorage.removeItem(KEY+"_track"); }

/* =============================
   Fixed Input handler for grams changes
   ============================= */
let currentEditingInput = null;

function onGramChange(e){
  const input = e.target;
  currentEditingInput = input;
  
  // Use a debounce to prevent too many rapid updates
  clearTimeout(input._updateTimeout);
  input._updateTimeout = setTimeout(() => {
    applyGramChange(Number(input.dataset.day), input.dataset.meal, input.value);
    currentEditingInput = null;
  }, 800); // Wait 800ms after user stops typing
}

function applyGramChange(dayIdx, mealKey, value) {
  const stored = loadPlan();
  if(!stored || !stored.plan) return;
  const plan = stored.plan;
  const p = plan[dayIdx];
  if(!p) return;
  
  const v = Math.max(1, Math.round(Number(value) || 0));
  
  if(mealKey && mealKey.includes('--part--')){
    const [mKey, ,pi] = mealKey.split('--');
    const part = p[mKey].parts[Number(pi)];
    if(!part) return;
    part.grams = v;
    part.kcal = Math.round((part.per100 || 100) * (v/100));
    part.protein = Math.round((part.protein_per_100g||part.protein||0) * (v/100));
    part.carbs = Math.round((part.carbs_per_100g||part.carbs||0) * (v/100));
    part.fat = Math.round((part.fat_per_100g||part.fat||0) * (v/100));
    p[mKey].kcal = p[mKey].parts.reduce((s,x)=>s+(x.kcal||0),0);
  }
  
  savePlan(plan, loadPlan().startDate);
  renderPlan(plan, loadPlan().startDate);
  updateSavedInfo();
}

/* =============================
   Enhanced Saved Info with Day Macros
   ============================= */
function updateSavedInfo(){ 
  const s = loadPlan(); 
  const box = document.getElementById("savedInfo"); 
  if(!s){ 
    box.innerHTML = "No saved plan."; 
    document.getElementById("dayMacros").innerText = "";
    return; 
  } 
  const sd = new Date(s.startDate); 
  box.innerHTML = `Saved: <strong>${sd.toLocaleString()}</strong><div class="muted-small">Plan unlocks one day every 24 hours from this date.</div>`; 
  
  // Calculate and display today's macros in the sidebar
  updateDayMacrosDisplay();
}

function updateDayMacrosDisplay() {
  const stored = loadPlan();
  if (!stored || !stored.plan) return;
  
  const startDate = new Date(stored.startDate);
  const now = new Date();
  const days = Math.floor((Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) - 
                          Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()))/86400000);
  const unlocked = Math.max(0, Math.min(6, days));
  const dayObj = stored.plan[unlocked];
  
  if (!dayObj) return;
  
  // Calculate totals for the current day
  const totalKcal = (dayObj.breakfast.parts? dayObj.breakfast.parts.reduce((s,x)=>s+(x.kcal||0),0):dayObj.breakfast.kcal) + 
                   (dayObj.lunch.kcal||0) + 
                   (dayObj.dinner.kcal||0) + 
                   (dayObj.snack.kcal||0);
  
  const totalProtein = (dayObj.breakfast.parts? dayObj.breakfast.parts.reduce((s,x)=>s+(x.protein||0),0):0) + 
                      (dayObj.lunch.parts? dayObj.lunch.parts.reduce((s,x)=>s+(x.protein||0),0):0) + 
                      (dayObj.dinner.parts? dayObj.dinner.parts.reduce((s,x)=>s+(x.protein||0),0):0) + 
                      (dayObj.snack.parts? dayObj.snack.parts.reduce((s,x)=>s+(x.protein||0),0):0);
  
  const totalCarbs = (dayObj.breakfast.parts? dayObj.breakfast.parts.reduce((s,x)=>s+(x.carbs||0),0):0) + 
                    (dayObj.lunch.parts? dayObj.lunch.parts.reduce((s,x)=>s+(x.carbs||0),0):0) + 
                    (dayObj.dinner.parts? dayObj.dinner.parts.reduce((s,x)=>s+(x.carbs||0),0):0) + 
                    (dayObj.snack.parts? dayObj.snack.parts.reduce((s,x)=>s+(x.carbs||0),0):0);
  
  const totalFat = (dayObj.breakfast.parts? dayObj.breakfast.parts.reduce((s,x)=>s+(x.fat||0),0):0) + 
                  (dayObj.lunch.parts? dayObj.lunch.parts.reduce((s,x)=>s+(x.fat||0),0):0) + 
                  (dayObj.dinner.parts? dayObj.dinner.parts.reduce((s,x)=>s+(x.fat||0),0):0) + 
                  (dayObj.snack.parts? dayObj.snack.parts.reduce((s,x)=>s+(x.fat||0),0):0);
  
  const diff = totalKcal - dayObj.meta.target;
  
  // Display in the sidebar
  const dayMacrosEl = document.getElementById("dayMacros");
  dayMacrosEl.innerHTML = `
    <div style="margin-bottom: 8px;">
      <div><strong>Day ${dayObj.day}${dayObj.free ? ' (FREE DAY)' : ''}</strong></div>
      <div class="muted-small">Target: ${dayObj.meta.target} kcal</div>
    </div>
    <div style="margin-bottom: 8px;">
      <div><strong>Total: ${totalKcal} kcal</strong></div>
      <div class="muted-small" style="color: ${diff > 0 ? '#e74c3c' : diff < 0 ? '#3498db' : '#27ae50'}">
        ${diff > 0 ? '+' : ''}${diff} kcal
      </div>
    </div>
    <div>
      <div class="muted-small">Protein: ${Math.round(totalProtein)}g</div>
      <div class="muted-small">Carbs: ${Math.round(totalCarbs)}g</div>
      <div class="muted-small">Fat: ${Math.round(totalFat)}g</div>
    </div>
  `;
}

/* =============================
   Rendering: main plan -> UI - FIXED with unlock dates
   ============================= */
function renderPlan(plan, startDateISO){
  const container = document.getElementById("mainInner");
  container.innerHTML = "";
  const startDate = startDateISO ? new Date(startDateISO) : null;
  const now = new Date();
  let unlocked = 0;
  if(startDate){
    const days = Math.floor((Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) - 
                          Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()))/86400000);
    unlocked = Math.max(0, Math.min(6, days));
  } else unlocked = 0;

  plan.forEach((d, idx)=>{
    const card = document.createElement("div"); card.className = "card";
    const isLocked = idx > unlocked;
    if(isLocked) card.classList.add("locked");

    // Calculate unlock date for locked days
    let unlockDateText = "";
    if (isLocked && startDate) {
      const unlockDate = new Date(startDate);
      unlockDate.setDate(unlockDate.getDate() + idx);
      unlockDateText = `Unlocks: ${unlockDate.toLocaleDateString()}`;
    }

    const header = document.createElement("div"); header.style.display="flex"; header.style.justifyContent="space-between"; header.style.alignItems="center";
    header.innerHTML = `<div><strong>Day ${d.day}${d.free? ' â€” FREE':''}</strong><div class="muted-small">${isLocked ? `Locked - ${unlockDateText}` : "Unlocked (editable)"}</div></div><div style="text-align:right"><button class="btn ghost" data-day="${idx}" onclick="suggestAdjustmentForDayWrapper(${idx})">Suggest Adjustment</button></div>`;
    card.appendChild(header);

    const mealsWrap = document.createElement("div"); mealsWrap.className="meals";

    function makeMealBlock(mealKey, mealObj){
      const m = document.createElement("div"); m.className="meal card";
      if(isLocked) m.classList.add("locked");
      const title = document.createElement("b"); title.innerText = mealKey.charAt(0).toUpperCase()+mealKey.slice(1);
      m.appendChild(title);

      // Show all meal components
      const listWrap = document.createElement("div");
      listWrap.style.marginTop="8px";
      
      (mealObj.parts || []).forEach((p, pi)=>{
        const pDiv = document.createElement("div"); pDiv.style.marginTop="6px";
        pDiv.className = "meal-list-item";
        const left = document.createElement("div"); 
        left.innerHTML = `<div style="font-weight:700">${escapeHtml(p.name)}</div>
                         <div class="muted-small">${p.grams || 0}g â€¢ ${p.kcal || 0} kcal</div>
                         <div class="muted-small" style="font-size:11px">${p.type || 'main'}</div>`;
        const right = document.createElement("div");
        const inp = document.createElement("input"); inp.type="number"; inp.className="input-grams"; inp.value = p.grams || 0;
        inp.dataset.day = idx; inp.dataset.meal = `${mealKey}--part--${pi}`;
        inp.disabled = isLocked;
        inp.addEventListener('click', e=>e.stopPropagation());
        inp.addEventListener('input', onGramChange);
        inp.addEventListener('blur', function(e) {
          if (this._updateTimeout) {
            clearTimeout(this._updateTimeout);
            applyGramChange(Number(this.dataset.day), this.dataset.meal, this.value);
          }
        });
        inp.addEventListener('focus', function(e) {
          this.select();
        });
        right.appendChild(inp);
        pDiv.style.display="flex"; pDiv.style.justifyContent="space-between"; pDiv.style.alignItems="center";
        pDiv.appendChild(left); pDiv.appendChild(right);
        listWrap.appendChild(pDiv);
      });

      // Add item button (only for unlocked days)
      if (!isLocked) {
        const addBtn = document.createElement("button"); addBtn.className="btn ghost"; addBtn.style.marginTop="8px"; addBtn.innerText="+ Add item";
        addBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openAddItemModal(idx, mealKey); });
        listWrap.appendChild(addBtn);
      }

      m.appendChild(listWrap);

      const kcalWrap = document.createElement("div"); kcalWrap.className="kcal"; kcalWrap.style.marginTop="10px";
      kcalWrap.innerHTML = `Total: <span class="kcal-val">${mealObj.kcal || (mealObj.parts? mealObj.parts.reduce((s,x)=>s+(x.kcal||0),0):0)}</span> kcal`;
      m.appendChild(kcalWrap);

      // Macros for the entire meal
      const totalP = (mealObj.parts? mealObj.parts.reduce((s,x)=>s+(x.protein||0),0) : (mealObj.protein||0));
      const totalC = (mealObj.parts? mealObj.parts.reduce((s,x)=>s+(x.carbs||0),0) : (mealObj.carbs||0));
      const totalF = (mealObj.parts? mealObj.parts.reduce((s,x)=>s+(x.fat||0),0) : (mealObj.fat||0));
      const macros = document.createElement("div"); macros.className="muted-small"; macros.style.marginTop="8px";
      macros.innerText = `Meal Macros: P ${Math.round(totalP)}g â€¢ C ${Math.round(totalC)}g â€¢ F ${Math.round(totalF)}g`;
      m.appendChild(macros);

      // Locked overlay with date
      if(isLocked){
        const overlay = document.createElement("div"); overlay.className='lock-overlay';
        const unlockDate = startDate ? new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()) + (idx*86400000)) : null;
        overlay.innerHTML = `<div class="lock-badge">${unlockDate ? `Unlocks: ${unlockDate.toLocaleDateString()}` : 'Locked'}</div>`;
        m.appendChild(overlay);
      } else {
        const repl = document.createElement('button'); repl.className='btn ghost'; repl.style.marginTop='8px'; repl.innerText='Replace';
        repl.addEventListener('click', ()=> openReplaceModal(idx, mealKey));
        m.appendChild(repl);
      }

      return m;
    }

    mealsWrap.appendChild(makeMealBlock('breakfast', d.breakfast));
    mealsWrap.appendChild(makeMealBlock('lunch', d.lunch));
    mealsWrap.appendChild(makeMealBlock('dinner', d.dinner));
    mealsWrap.appendChild(makeMealBlock('snack', d.snack));

    card.appendChild(mealsWrap);

    // Day summary
    const summary = document.createElement("div"); summary.style.marginTop="12px";
    const totalKcal = (d.breakfast.parts? d.breakfast.parts.reduce((s,x)=>s+(x.kcal||0),0):d.breakfast.kcal) + (d.lunch.kcal||0) + (d.dinner.kcal||0) + (d.snack.kcal||0);
    summary.innerHTML = `<div class="muted-small">Daily Total: <strong class="day-total">${totalKcal}</strong> kcal</div>
      <div class="muted-small">Target (TDEE): <strong class="day-target">${d.meta.target}</strong> kcal</div>
      <div class="muted-small">Difference: <strong class="day-diff">${totalKcal - d.meta.target}</strong> kcal</div>`;
    card.appendChild(summary);

    container.appendChild(card);
  });
}

/* =============================
   Add / Replace modals
   ============================= */
let currentEditing = { dayIndex: null, field: null, partIndex: null };

async function openAddItemModal(dayIndex, field){
  currentEditing = { dayIndex, field, mode: 'add' };
  const popup = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");
  box.innerHTML = `
    <h3>Add item â€” ${escapeHtml(field)}</h3>
    <div style="margin-top:8px;"><input id="popupAddInput" placeholder="Search food (e.g. fries, avocado, rice)" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd"></div>
    <div style="margin-top:8px;text-align:right"><button id="popupAddBtn" class="btn">Search</button></div>
    <div id="popupAddResults" style="margin-top:12px;max-height:420px;overflow:auto"></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="popupAddClose" class="btn ghost">Close</button>
    </div>
  `;
  popup.style.display = "flex";
  document.getElementById("popupAddClose").onclick = ()=> { popup.style.display = "none"; currentEditing = { dayIndex:null, field:null } };
  document.getElementById("popupAddBtn").onclick = async ()=>{
    const q = document.getElementById("popupAddInput").value.trim();
    const resBox = document.getElementById("popupAddResults");
    resBox.innerHTML = "Searching...";
    const results = await searchNutrition(q);
    renderUsdaAddList(results, resBox);
  };
}

function renderUsdaAddList(results, containerEl){
  containerEl.innerHTML = "";
  if(!results || !results.length){ containerEl.innerHTML = "<div class='muted-small'>No matches found.</div>"; return; }
  results.slice(0,40).forEach(it=>{
    const div = document.createElement("div");
    div.style.padding="10px"; div.style.borderBottom="1px solid #eee"; div.style.cursor="pointer";
    const kcalText = it.kcal_per_100g ? `${it.kcal_per_100g} kcal / 100g` : "kcal unknown";
    const macros = `P ${it.protein_per_100g||'â€”'}g â€¢ C ${it.carbs_per_100g||'â€”'}g â€¢ F ${it.fat_per_100g||'â€”'}g`;
    div.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong></div><div class="muted-small">${kcalText} â€¢ ${macros}</div>`;
    div.onclick = ()=> {
      applyAddToPlan(currentEditing.dayIndex, currentEditing.field, it);
      document.getElementById("usdaPopup").style.display="none";
    };
    containerEl.appendChild(div);
  });
}

function applyAddToPlan(dayIndex, field, usdaItem){
  const stored = loadPlan();
  if(!stored || !stored.plan){ alert("No saved plan. Accept a plan first."); return; }
  const plan = stored.plan;
  const p = plan[dayIndex];
  if(!p) return;
  const per100 = usdaItem.kcal_per_100g || usdaItem.kcal || 100;
  const meal = p[field];
  const tdee = p.meta.target;
  const splits = p.meta.splits || DEFAULT_SPLITS;
  let mealTarget = 0;
  if(field === "breakfast") mealTarget = Math.round(tdee * splits.breakfast);
  else if(field === "lunch") mealTarget = Math.round(tdee * splits.lunch);
  else if(field === "dinner") mealTarget = Math.round(tdee * splits.dinner);
  else if(field === "snack") mealTarget = Math.round(tdee * splits.snack);

  const existingParts = meal.parts ? meal.parts : (meal.parts = [{name: meal.text, per100: meal.per100 || 100, grams: meal.grams || 100, kcal: meal.kcal || 0, protein: meal.protein || 0, carbs: meal.carbs || 0, fat: meal.fat || 0}]);
  const newPart = { name: usdaItem.name, per100: per100, grams: 0, kcal:0, protein:0, carbs:0, fat:0, source:usdaItem.raw||null, tags:usdaItem.tags||[] };
  existingParts.push(newPart);
  // Equal-energy share between parts
  const share = Math.round(mealTarget / existingParts.length);
  for(let i=0;i<existingParts.length;i++){
    const pr = existingParts[i];
    pr.grams = gramsForTarget(pr.per100 || 100, share);
    pr.kcal = Math.round((pr.per100 || 100) * (pr.grams/100));
    pr.protein = Math.round((pr.protein_per_100g||pr.protein||0) * (pr.grams/100));
    pr.carbs = Math.round((pr.carbs_per_100g||pr.carbs||0) * (pr.grams/100));
    pr.fat = Math.round((pr.fat_per_100g||pr.fat||0) * (pr.grams/100));
  }
  meal.kcal = existingParts.reduce((s,x)=>s+(x.kcal||0),0);
  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();
  alert("Item added and portions auto-adjusted for this meal. You can fine-tune grams if needed.");
}

async function openReplaceModal(dayIndex, field){
  currentEditing = { dayIndex, field, mode: 'replace' };
  const popup = document.getElementById("usdaPopup");
  const box = document.getElementById("usdaBox");
  box.innerHTML = `
    <h3>Search & Replace â€” ${escapeHtml(field)}</h3>
    <div style="margin-top:8px;"><input id="popupReplaceInput" placeholder="Search food to replace with..." value="" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd"></div>
    <div style="margin-top:8px;text-align:right"><button id="popupReplaceBtn" class="btn">Search</button></div>
    <div id="popupReplaceResults" style="margin-top:12px;max-height:420px;overflow:auto"></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="popupReplaceClose" class="btn ghost">Close</button>
    </div>
  `;
  popup.style.display = "flex";
  document.getElementById("popupReplaceClose").onclick = ()=> { popup.style.display = "none"; currentEditing = { dayIndex:null, field:null } };
  document.getElementById("popupReplaceBtn").onclick = async ()=>{
    const q = document.getElementById("popupReplaceInput").value.trim();
    const resBox = document.getElementById("popupReplaceResults");
    resBox.innerHTML = "Searching...";
    const results = await searchNutrition(q);
    renderUsdaReplaceList(results, resBox);
  };
}

function renderUsdaReplaceList(results, containerEl){
  containerEl.innerHTML = "";
  if(!results || !results.length){ containerEl.innerHTML = "<div class='muted-small'>No matches found.</div>"; return; }
  results.slice(0,40).forEach(it=>{
    const div = document.createElement("div");
    div.style.padding="10px"; div.style.borderBottom="1px solid #eee"; div.style.cursor="pointer";
    const kcalText = it.kcal_per_100g ? `${it.kcal_per_100g} kcal / 100g` : "kcal unknown";
    const macros = `P ${it.protein_per_100g||'â€”'}g â€¢ C ${it.carbs_per_100g||'â€”'}g â€¢ F ${it.fat_per_100g||'â€”'}g`;
    div.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong></div><div class="muted-small">${kcalText} â€¢ ${macros}</div>`;
    div.onclick = ()=> {
      applyReplacementToPlan(currentEditing.dayIndex, currentEditing.field, it);
      document.getElementById("usdaPopup").style.display="none";
    };
    containerEl.appendChild(div);
  });
}

function applyReplacementToPlan(dayIndex, field, usdaItem){
  const stored = loadPlan();
  if(!stored || !stored.plan){ alert("No saved plan. Accept a plan first."); return; }
  const plan = stored.plan;
  const p = plan[dayIndex];
  if(!p) return;
  const per100 = usdaItem.kcal_per_100g || usdaItem.kcal || null;
  const tdee = p.meta.target;
  const splits = p.meta.splits || DEFAULT_SPLITS;
  let mealTarget = 0;
  if(field === "breakfast") mealTarget = Math.round(tdee * splits.breakfast);
  else if(field === "lunch") mealTarget = Math.round(tdee * splits.lunch);
  else if(field === "dinner") mealTarget = Math.round(tdee * splits.dinner);
  else if(field === "snack") mealTarget = Math.round(tdee * splits.snack);

  if(field === "breakfast" || field === "snack"){
    const grams = gramsForTarget(per100 || 120, mealTarget);
    p[field] = { text: usdaItem.name, per100: per100, grams, kcal: Math.round((per100||120)*(grams/100)), parts:[{name:usdaItem.name, per100:per100, grams, kcal:Math.round((per100||120)*(grams/100)), protein:Math.round((usdaItem.protein_per_100g||0)*(grams/100)), carbs:Math.round((usdaItem.carbs_per_100g||0)*(grams/100)), fat:Math.round((usdaItem.fat_per_100g||0)*(grams/100)), source:usdaItem.raw||null}] };
  } else if(field === "lunch" || field === "dinner"){
    const meal = p[field];
    const side = meal.parts && meal.parts[1] ? meal.parts[1] : { name: "Steamed veg", per100: 30, grams: gramsForTarget(30, Math.round(mealTarget*0.35)), kcal:0 };
    const sidePer100 = side.per100 || side.per100 || 100;
    const protTarget = Math.round(mealTarget * 0.65);
    const sideTarget = Math.round(mealTarget * 0.35);
    const protGrams = gramsForTarget(per100||180, protTarget);
    const sideGrams = gramsForTarget(sidePer100||120, sideTarget);
    const protCalc = { type:"protein", name:usdaItem.name, per100:per100, grams:protGrams, kcal:Math.round((per100||180)*(protGrams/100)), protein:Math.round((usdaItem.protein_per_100g||0)*(protGrams/100)), carbs:Math.round((usdaItem.carbs_per_100g||0)*(protGrams/100)), fat:Math.round((usdaItem.fat_per_100g||0)*(protGrams/100)), source:usdaItem.raw||null };
    const sideCalc = { type:"side", name:side.name, per100:sidePer100, grams:sideGrams, kcal:Math.round((sidePer100||120)*(sideGrams/100)), protein:Math.round((side.protein_per_100g||side.protein||0)*(sideGrams/100)), carbs:Math.round((side.carbs_per_100g||side.carbs||0)*(sideGrams/100)), fat:Math.round((side.fat_per_100g||side.fat||0)*(sideGrams/100)), source:side.source||null };
    p[field].parts = [protCalc, sideCalc];
    p[field].kcal = protCalc.kcal + sideCalc.kcal;
    p[field].text = protCalc.name + " + " + sideCalc.name;
  }

  savePlan(plan, stored.startDate);
  renderPlan(plan, stored.startDate);
  updateSavedInfo();
  alert("Meal replaced and portion weights recalculated.");
}

/* =============================
   Suggest adjustment for day
   (uses simple greedy strategy)
   ============================= */
function suggestAdjustmentForDayWrapper(idx){
  const stored = loadPlan();
  if(!stored || !stored.plan) return;
  suggestAdjustmentForDay(stored.plan[idx], idx);
}

function suggestAdjustmentForDay(dayObj, dayIndex){
  const target = dayObj.meta.target;
  const total = (dayObj.breakfast.parts? dayObj.breakfast.parts.reduce((s,x)=>s+(x.kcal||0),0):dayObj.breakfast.kcal) + (dayObj.lunch.kcal||0) + (dayObj.dinner.kcal||0) + (dayObj.snack.kcal||0);
  const diff = total - target;
  if(Math.abs(diff) <= 10){ alert("Excellent â€” today's plan is within Â±10 kcal. No adjustment needed."); return; }

  // compute macro totals
  const p = (dayObj.breakfast.parts? dayObj.breakfast.parts.reduce((s,x)=>s+(x.protein||0),0):0) + (dayObj.lunch.parts? dayObj.lunch.parts.reduce((s,x)=>s+(x.protein||0),0):0) + (dayObj.dinner.parts? dayObj.dinner.parts.reduce((s,x)=>s+(x.protein||0),0):0) + (dayObj.snack.parts? dayObj.snack.parts.reduce((s,x)=>s+(x.protein||0),0):0);
  const c = (dayObj.breakfast.parts? dayObj.breakfast.parts.reduce((s,x)=>s+(x.carbs||0),0):0) + (dayObj.lunch.parts? dayObj.lunch.parts.reduce((s,x)=>s+(x.carbs||0),0):0) + (dayObj.dinner.parts? dayObj.dinner.parts.reduce((s,x)=>s+(x.carbs||0),0):0) + (dayObj.snack.parts? dayObj.snack.parts.reduce((s,x)=>s+(x.carbs||0),0):0);
  const f = (dayObj.breakfast.parts? dayObj.breakfast.parts.reduce((s,x)=>s+(x.fat||0),0):0) + (dayObj.lunch.parts? dayObj.lunch.parts.reduce((s,x)=>s+(x.fat||0),0):0) + (dayObj.dinner.parts? dayObj.dinner.parts.reduce((s,x)=>s+(x.fat||0),0):0) + (dayObj.snack.parts? dayObj.snack.parts.reduce((s,x)=>s+(x.fat||0),0):0);
  const pK = p*4, cK = c*4, fK = f*9;
  const macroK = [{m:'protein', kcal:pK, g:p},{m:'carbs', kcal:cK, g:c},{m:'fat', kcal:fK, g:f}].sort((a,b)=>b.kcal-a.kcal);

  const diet = dayObj.meta.diet;
  let reduceOrder = [macroK[0].m, macroK[1].m, macroK[2].m];
  if(diet === 'keto'){ reduceOrder = reduceOrder.filter(x=>x!=='fat'); reduceOrder.push('fat'); }
  if(diet === 'carnivore'){ reduceOrder = reduceOrder.filter(x=>x!=='protein'); reduceOrder.push('protein'); }

  const dayItems = [];
  [
    ...(dayObj.breakfast.parts||[]).map(p=>({type:'breakfast', name:p.name, grams:p.grams, kcal_per_100:p.per100, protein:p.protein, carbs:p.carbs, fat:p.fat})),
    ...(dayObj.lunch.parts||[]).map((p,i)=>({type:i===0?'lunch-protein':'lunch-side', name:p.name, grams:p.grams, kcal_per_100:p.per100, protein:p.protein, carbs:p.carbs, fat:p.fat})),
    ...(dayObj.dinner.parts||[]).map((p,i)=>({type:i===0?'dinner-protein':'dinner-side', name:p.name, grams:p.grams, kcal_per_100:p.per100, protein:p.protein, carbs:p.carbs, fat:p.fat})),
    ...(dayObj.snack.parts||[]).map(p=>({type:'snack', name:p.name, grams:p.grams, kcal_per_100:p.per100, protein:p.protein, carbs:p.carbs, fat:p.fat}))
  ].forEach(x=>dayItems.push(x));

  function gramsForDelta(item, deltaKcal){
    const per100 = item.kcal_per_100 || (item.kcal && item.kcal/item.grams*100) || null;
    if(!per100) return null;
    const grams = Math.round((deltaKcal / per100) * 100);
    return grams;
  }

  let adviceLines = [];
  if(diff > 0){
    let remaining = diff;
    for(const macro of reduceOrder){
      const sorted = dayItems.slice().sort((a,b)=> ( (b[macro]||0) - (a[macro]||0) ));
      for(const item of sorted){
        if(remaining <= 0) break;
        if((item[macro]||0) === 0) continue;
        const per100 = item.kcal_per_100 || 100;
        const maxRemove = Math.max(1, Math.round(item.grams * 0.4));
        const gramsNeeded = gramsForDelta(item, remaining);
        const gramsToRemove = Math.min(maxRemove, Math.abs(gramsNeeded || 0));
        if(gramsToRemove <= 0) continue;
        adviceLines.push(`Reduce ${item.name} by ${gramsToRemove} g (~${Math.round((per100)*(gramsToRemove/100))} kcal) â€” affects ${macro}`);
        remaining -= Math.round(per100*(gramsToRemove/100));
      }
      if(remaining <= 0) break;
    }
    if(remaining > 0) adviceLines.push(`Still over by ~${remaining} kcal. Consider removing a snack or replacing with lower-calorie alternatives.`);
  } else {
    let need = Math.abs(diff);
    let increaseOrder = ['protein','carbs','fat'];
    if(diet === 'keto'){ increaseOrder = ['fat','protein','carbs']; }
    for(const macro of increaseOrder){
      const sorted = dayItems.slice().sort((a,b)=> ( (b[macro]||0) - (a[macro]||0) ));
      for(const item of sorted){
        if(need <= 0) break;
        const per100 = item.kcal_per_100 || 100;
        const maxAdd = Math.max(1, Math.round(item.grams * 0.5));
        const gramsNeeded = gramsForDelta(item, need);
        const gramsToAdd = Math.min(maxAdd, Math.abs(gramsNeeded || 0));
        if(gramsToAdd <= 0) continue;
        adviceLines.push(`Increase ${item.name} by ${gramsToAdd} g (~${Math.round((per100)*(gramsToAdd/100))} kcal) â€” adds ${macro}`);
        need -= Math.round(per100*(gramsToAdd/100));
      }
      if(need <= 0) break;
    }
    if(need > 0) adviceLines.push(`Still under by ~${need} kcal. Consider adding a small snack (nuts, yogurt) to reach target.`);
  }
  const lines = adviceLines.length ? adviceLines : ["No clear single adjustment found â€” consider small changes across multiple items."];
  alert("Adjustment suggestions:\n\n" + lines.join("\n"));
}

/* =============================
   PDF Export (jsPDF)
   ============================= */
async function exportCurrentDayToPDF(){
  const stored = loadPlan();
  if(!stored || !stored.plan){ alert("No saved plan."); return; }
  const startDate = new Date(stored.startDate);
  const now = new Date();
  const days = Math.floor((Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) - Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()))/86400000);
  const unlocked = Math.max(0, Math.min(6, days));
  const dayObj = stored.plan[unlocked];
  if(!dayObj){ alert("No plan for today."); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const margin = 40; let y = 48;
  doc.setFontSize(16); doc.setFont(undefined,'bold'); doc.text("Convert Labs â€” Daily Meal Plan", margin, y); y+=18;
  doc.setFontSize(10); doc.setFont(undefined,'normal'); doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y); y+=16;
  doc.setFontSize(12); doc.setFont(undefined,'bold'); doc.text(`Day ${dayObj.day} â€” Target TDEE: ${dayObj.meta.target} kcal`, margin, y); y+=16;

  // Breakfast
  doc.setFontSize(11); doc.setFont(undefined,'bold'); doc.text("Breakfast", margin, y); y+=14;
  doc.setFont(undefined,'normal');
  dayObj.breakfast.parts.forEach(p=>{ doc.text(`${p.name} â€” ${p.grams} g â€” ${p.kcal} kcal`, margin+8, y); y+=14; doc.text(`  Macros: P ${p.protein||0} g â€¢ C ${p.carbs||0} g â€¢ F ${p.fat||0} g`, margin+20, y); y+=14; });
  y+=6;

  // Lunch
  doc.setFont(undefined,'bold'); doc.text("Lunch", margin, y); y+=14; doc.setFont(undefined,'normal');
  dayObj.lunch.parts.forEach(p=>{ doc.text(`${p.name} â€” ${p.grams} g â€” ${p.kcal} kcal`, margin+8, y); y+=14; doc.text(`  Macros: P ${p.protein||0} g â€¢ C ${p.carbs||0} g â€¢ F ${p.fat||0} g`, margin+20, y); y+=14; });
  y+=6;

  // Dinner
  doc.setFont(undefined,'bold'); doc.text("Dinner", margin, y); y+=14; doc.setFont(undefined,'normal');
  dayObj.dinner.parts.forEach(p=>{ doc.text(`${p.name} â€” ${p.grams} g â€” ${p.kcal} kcal`, margin+8, y); y+=14; doc.text(`  Macros: P ${p.protein||0} g â€¢ C ${p.carbs||0} g â€¢ F ${p.fat||0} g`, margin+20, y); y+=14; });
  y+=6;

  // Snack
  doc.setFont(undefined,'bold'); doc.text("Snack", margin, y); y+=14; doc.setFont(undefined,'normal');
  dayObj.snack.parts.forEach(p=>{ doc.text(`${p.name} â€” ${p.grams} g â€” ${p.kcal} kcal`, margin+8, y); y+=14; doc.text(`  Macros: P ${p.protein||0} g â€¢ C ${p.carbs||0} g â€¢ F ${p.fat||0} g`, margin+20, y); y+=14; });
  y+=10;

  const total = (dayObj.breakfast.parts.reduce((s,x)=>s+(x.kcal||0),0)) + dayObj.lunch.kcal + dayObj.dinner.kcal + dayObj.snack.kcal;
  doc.setFont(undefined,'bold'); doc.setFontSize(12); doc.text(`Total kcal: ${total}`, margin, y); y+=14;
  doc.setFont(undefined,'normal'); doc.setFontSize(10); doc.text(`Difference vs TDEE: ${total - dayObj.meta.target} kcal`, margin, y); y+=18;

  doc.setFontSize(9); doc.text("This plan uses USDA public-domain data and heuristics; not a substitute for professional advice.", margin, y);
  const filename = `convertlabs-mealplan-day${dayObj.day}-${(new Date()).toISOString().slice(0,10)}.pdf`;
  doc.save(filename);
}

/* =============================
   Wiring (buttons + theme)
   ============================= */
document.getElementById("generateBtn").addEventListener("click", async ()=>{
  saveCurrentParams();
  const opts = {
    tdee: Number(document.getElementById("tdeeInput").value) || null,
    age: Number(document.getElementById("ageInput").value) || 30,
    goal: document.getElementById("goalSelect").value,
    diet: document.getElementById("dietSelect").value,
    protein: document.getElementById("proteinSelect").value,
    oneProteinPerDay: document.getElementById("oneProteinPerDay").checked,
    inputIsAlreadyAdjusted: true,
    freeDay: true,
    freeDayIndex: 2
  };
  if(!opts.tdee){ alert("Enter TDEE first."); return; }
  try{
    const plan = await generatePlanAsync(opts);
    // show preview
    const modal = document.getElementById("previewModal"); const box = document.getElementById("previewBox");
    let html = `<h3>Preview â€” 7-day plan</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:10px">`;
    plan.forEach(d=>{
      html += `<div style="background:var(--card);padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)"><div style="font-weight:700">Day ${d.day}${d.free? ' â€” FREE':''}</div>
        <div style="margin-top:8px"><strong>Breakfast</strong><div class="muted-small">${d.breakfast.parts[0].grams} g â€” ${d.breakfast.parts[0].kcal} kcal</div></div>
        <div style="margin-top:8px"><strong>Lunch</strong><div class="muted-small">${d.lunch.parts[0].grams} g ${d.lunch.parts[1] ? '+ ' + d.lunch.parts[1].grams + ' g' : ''} â€” ${d.lunch.kcal} kcal</div></div>
        <div style="margin-top:8px"><strong>Dinner</strong><div class="muted-small">${d.dinner.parts[0].grams} g ${d.dinner.parts[1] ? '+ ' + d.dinner.parts[1].grams + ' g' : ''} â€” ${d.dinner.kcal} kcal</div></div>
        <div style="margin-top:8px"><strong>Snack</strong><div class="muted-small">${d.snack.parts[0].grams} g â€” ${d.snack.parts[0].kcal} kcal</div></div></div>`;
    });
    html += `</div><div style="margin-top:12px;text-align:right"><button id="previewAccept" class="btn">Accept & Save</button> <button id="previewClose" class="btn ghost">Close</button></div>`;
    box.innerHTML = html; modal.style.display = "flex";
    document.getElementById("previewClose").onclick = ()=> modal.style.display = "none";
    document.getElementById("previewAccept").onclick = ()=> { savePlan(plan, new Date().toISOString()); modal.style.display = "none"; renderPlan(plan, loadPlan().startDate); updateSavedInfo(); alert("Plan saved."); };
  }catch(err){ console.error(err); alert("Error generating plan: "+(err.message||err)); }
});

document.getElementById("acceptBtn").addEventListener("click", async ()=>{
  saveCurrentParams();
  const t = Number(document.getElementById("tdeeInput").value) || null;
  if(!t){ alert("Enter TDEE first."); return; }
  const opts = {
    tdee: t,
    age: Number(document.getElementById("ageInput').value) || 30,
    goal: document.getElementById("goalSelect").value,
    diet: document.getElementById("dietSelect").value,
    protein: document.getElementById("proteinSelect").value,
    oneProteinPerDay: document.getElementById("oneProteinPerDay").checked,
    inputIsAlreadyAdjusted: true,
    freeDay: true,
    freeDayIndex: 2
  };
  try{
    const plan = await generatePlanAsync(opts);
    savePlan(plan, new Date().toISOString());
    renderPlan(plan, loadPlan().startDate);
    updateSavedInfo();
    alert("Plan generated and saved.");
  }catch(e){ console.error(e); alert("Failed to generate and save: "+(e.message||e)); }
});

document.getElementById("exportDayBtn").addEventListener("click", exportCurrentDayToPDF);

/* Theme toggle */
const themeToggle = document.getElementById('themeToggle');
function setTheme(mode){ if(mode==='dark'){ document.documentElement.classList.add('dark'); themeToggle.textContent='â˜€ï¸'; } else { document.documentElement.classList.remove('dark'); themeToggle.textContent='ðŸŒ™'; } try{ localStorage.setItem('cl_theme', mode); }catch(e){} }
(function initTheme(){ try{ const saved = localStorage.getItem('cl_theme'); if(saved){ setTheme(saved); return; } const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; setTheme(prefersDark ? 'dark' : 'light'); }catch(e){ setTheme('light'); } })();
themeToggle.addEventListener('click', ()=> { const isDark = document.documentElement.classList.contains('dark'); setTheme(isDark? 'light' : 'dark'); });

/* Initial render if saved */
(function initLoad(){ 
  // Load parameters from URL and storage
  getParamsFromURL();
  getParamsFromStorage();
  
  const stored = loadPlan(); 
  if(stored && stored.plan){ 
    renderPlan(stored.plan, stored.startDate); 
    updateSavedInfo();
  } else { 
    document.getElementById("mainInner").innerHTML = `<div class="card" style="text-align:center;padding:28px;color:var(--muted)">No saved plan. Generate a preview or accept a plan to start unlock schedule.</div>`; 
  } 
})();

// Close modals on background click
document.getElementById("previewModal").addEventListener("click",(e)=>{ if(e.target.id==="previewModal") document.getElementById("previewModal").style.display='none'; });
document.getElementById("usdaPopup").addEventListener("click",(e)=>{ if(e.target.id==="usdaPopup") document.getElementById("usdaPopup").style.display='none'; });

// small util
function escapeHtml(s){ return (s||"").toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

</script>
</body>
</html>
